<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="MY HOME 管理员后台">
    <title>MY HOME - 管理员后台</title>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/dmego-home-page@latest/assets/css/iconfont.css">
    
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --primary-light: rgba(37, 99, 235, 0.1);
            --text-main: #1e293b;
            --text-sub: #64748b;
            --bg-base: #f1f5f9; 
            --glass-bg: rgba(255, 255, 255, 0.98);
            --glass-border: rgba(255, 255, 255, 0.8);
            --glass-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --error: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
            --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        
        body { 
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: var(--text-main); 
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .admin-top-bar {
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 24px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid #e2e8f0;
            z-index: 100;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }

        .admin-top-bar-left { display: flex; align-items: center; gap: 20px; }
        
        .back-home-btn {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 16px; border-radius: 8px;
            background: #fff; border: 1px solid #cbd5e1;
            color: var(--text-sub); font-size: 14px; font-weight: 500;
            cursor: pointer; transition: all 0.2s;
        }
        .back-home-btn:hover { border-color: var(--primary); color: var(--primary); background: #eff6ff; }

        .current-user-info { font-size: 14px; color: var(--text-sub); }
        .current-user-info span { color: var(--primary); font-weight: 600; margin-left: 5px; }

        .stats-cards { display: flex; gap: 15px; }
        .stat-card {
            background: #fff; border: 1px solid #e2e8f0;
            border-radius: 10px; padding: 8px 16px; text-align: center;
            min-width: 90px; transition: all 0.2s;
        }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border-color: #cbd5e1; }
        .stat-value { font-size: 18px; font-weight: 700; color: var(--text-main); }
        .stat-label { font-size: 12px; color: var(--text-sub); margin-top: 2px; }

        .admin-logout-btn {
            padding: 8px 16px; border-radius: 8px;
            background: #fef2f2; color: var(--error);
            border: 1px solid #fecaca;
            cursor: pointer; font-weight: 500; font-size: 13px;
            display: flex; align-items: center; gap: 6px;
            transition: all 0.2s;
        }
        .admin-logout-btn:hover { background: #fee2e2; border-color: #f87171; }

        .admin-main-container {
            display: flex; flex: 1; overflow: hidden; padding: 20px; gap: 20px; max-width: 1600px; margin: 0 auto; width: 100%;
        }

        .admin-sidebar {
            width: 240px; flex-shrink: 0; display: flex; flex-direction: column; gap: 15px;
        }

        .admin-header {
            background: #fff; border-radius: 16px; padding: 24px;
            border: 1px solid #e2e8f0; box-shadow: var(--glass-shadow);
            text-align: center;
        }
        .admin-title { font-size: 20px; font-weight: 700; color: var(--text-main); margin-bottom: 4px; }
        .admin-subtitle { font-size: 12px; color: var(--text-sub); letter-spacing: 0.5px; }

        .admin-nav-menu {
            background: #fff; border-radius: 16px; padding: 12px;
            border: 1px solid #e2e8f0; box-shadow: var(--glass-shadow);
            flex: 1; display: flex; flex-direction: column; gap: 6px;
        }
        .nav-menu-item {
            display: flex; align-items: center; gap: 12px; padding: 12px 16px;
            border-radius: 8px; color: var(--text-sub); cursor: pointer;
            transition: all 0.2s; font-weight: 500; font-size: 14px;
        }
        .nav-menu-item:hover { background: #f1f5f9; color: var(--text-main); }
        .nav-menu-item.active { background: #eff6ff; color: var(--primary); font-weight: 600; }
        .nav-menu-item i { font-size: 18px; }

        .admin-content-area {
            flex: 1; display: flex; flex-direction: column; overflow: hidden; gap: 15px;
        }

        .content-header {
            display: flex; justify-content: space-between; align-items: center;
            background: #fff; padding: 16px 24px; border-radius: 16px;
            border: 1px solid #e2e8f0; box-shadow: var(--glass-shadow);
        }
        .content-title { font-size: 18px; font-weight: 700; color: var(--text-main); }

        .btn-primary {
            padding: 10px 20px; 
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: #fff; border: none; border-radius: 8px; 
            font-weight: 500; font-size: 14px;
            cursor: pointer; display: flex; align-items: center; gap: 8px;
            transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
        }
        .btn-primary:hover { 
            transform: translateY(-1px); 
            box-shadow: 0 6px 10px -1px rgba(37, 99, 235, 0.3); 
            filter: brightness(105%);
        }
        .btn-primary:active { transform: translateY(0); }

        .admin-content {
            flex: 1; background: #fff; border-radius: 16px; padding: 24px;
            border: 1px solid #e2e8f0; box-shadow: var(--glass-shadow);
            overflow-y: auto; display: flex; flex-direction: column;
        }

        .search-box { display: flex; gap: 12px; margin-bottom: 24px; }
        .search-input {
            flex: 1; height: 42px; background: #f8fafc; border: 1px solid #cbd5e1;
            border-radius: 8px; padding: 0 16px; color: var(--text-main); outline: none;
            transition: all 0.2s;
        }
        .search-input:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px var(--primary-light); }
        
        .btn-secondary {
            padding: 0 20px; height: 42px; border-radius: 8px; font-weight: 500; font-size: 14px;
            cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;
            background: #fff; border: 1px solid #cbd5e1; color: var(--text-main);
        }
        .btn-secondary:hover { border-color: #94a3b8; background: #f8fafc; color: var(--primary); }
        
        .btn-reset { 
            padding: 0 16px; height: 42px; border-radius: 8px; background: transparent; 
            border: 1px solid transparent; color: var(--text-sub); cursor: pointer; font-weight: 500;
        }
        .btn-reset:hover { background: #f1f5f9; color: var(--text-main); }

        /* 修改：开启滚动条，限制高度，表头固定 */
        .admin-table-container { 
            border-radius: 10px; 
            border: 1px solid #e2e8f0; 
            overflow: auto; 
            max-height: 70vh; 
        }
        .admin-table { width: 100%; border-collapse: collapse; min-width: 800px; }
        .admin-table th {
            padding: 14px 20px; text-align: left; font-weight: 600; color: var(--text-main);
            background: #f8fafc; border-bottom: 1px solid #e2e8f0; font-size: 13px;
            text-transform: uppercase; letter-spacing: 0.5px;
            position: sticky; top: 0; z-index: 10; /* 表头固定 */
        }
        .admin-table td {
            padding: 16px 20px; border-bottom: 1px solid #f1f5f9;
            color: var(--text-sub); font-size: 14px; vertical-align: middle;
        }
        .admin-table tr:last-child td { border-bottom: none; }
        .admin-table tr:hover td { background: #f8fafc; }

        .admin-table.diary-table td:nth-child(2) { font-weight: 500; color: var(--text-main); }
        /* 修改：缩小内容列宽度 */
        .admin-table.diary-table td:nth-child(3) { max-width: 180px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .status-badge {
            display: inline-flex; align-items: center; padding: 4px 12px; border-radius: 20px;
            font-size: 12px; font-weight: 500; letter-spacing: 0.3px;
        }
        .status-active { background: #dcfce7; color: #15803d; }
        .status-frozen { background: #fee2e2; color: #b91c1c; }
        .status-admin { background: #dbeafe; color: #1d4ed8; }

        .action-buttons { display: flex; gap: 8px; }
        .action-btn {
            padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 500;
            cursor: pointer; border: 1px solid transparent; display: flex; align-items: center; gap: 4px;
            transition: all 0.2s;
        }
        .btn-edit { background: #eff6ff; color: #2563eb; border-color: #dbeafe; }
        .btn-edit:hover { background: #dbeafe; border-color: #bfdbfe; }
        
        .btn-delete { background: #fef2f2; color: #dc2626; border-color: #fecaca; }
        .btn-delete:hover { background: #fee2e2; border-color: #fca5a5; }
        
        .btn-freeze { background: #fffbeb; color: #d97706; border-color: #fde68a; }
        .btn-freeze:hover { background: #fef3c7; border-color: #fcd34d; }

        .pagination { display: flex; justify-content: center; gap: 8px; margin-top: 30px; }
        .page-btn {
            width: 36px; height: 36px; border-radius: 8px; border: 1px solid #e2e8f0;
            background: #fff; color: var(--text-sub); cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; font-weight: 500;
        }
        .page-btn:hover:not(.active) { border-color: var(--primary); color: var(--primary); background: #eff6ff; }
        .page-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 2px 4px rgba(37, 99, 235, 0.3); }

        .modal-mask {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
            z-index: 9999; display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: all 0.3s;
        }
        .modal-mask.show { opacity: 1; pointer-events: auto; }
        
        .modal-box {
            background: #fff; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            width: 90%; max-width: 900px; max-height: 85vh; display: flex; flex-direction: column;
            transform: scale(0.95) translateY(10px); transition: all 0.3s var(--ease-spring);
        }
        .modal-mask.show .modal-box { transform: scale(1) translateY(0); }

        .modal-header {
            padding: 20px 24px; border-bottom: 1px solid #f1f5f9;
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
        }
        .modal-title { font-size: 18px; font-weight: 700; color: var(--text-main); }
        .modal-close-btn {
            width: 32px; height: 32px; border-radius: 50%; border: none; background: #f8fafc;
            color: #64748b; cursor: pointer; font-size: 20px; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .modal-close-btn:hover { background: #fee2e2; color: #ef4444; transform: rotate(90deg); }

        .modal-body, .diary-edit-layout { padding: 24px; overflow-y: auto; }
        .diary-edit-layout { display: flex; gap: 24px; height: 100%; }
        .diary-edit-left, .diary-edit-right { flex: 1; display: flex; flex-direction: column; gap: 20px; }
        
        .form-group { margin-bottom: 0; }
        .form-label { display: block; font-size: 13px; font-weight: 600; color: #475569; margin-bottom: 8px; }
        .form-input, .form-textarea {
            width: 100%; border: 1px solid #cbd5e1; border-radius: 8px;
            padding: 10px 14px; font-size: 14px; color: var(--text-main); outline: none;
            background: #fff; transition: all 0.2s;
        }
        .form-textarea { resize: vertical; line-height: 1.6; }
        .form-input:focus, .form-textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        .media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 12px; margin-top: 8px; }
        .media-item {
            aspect-ratio: 1; background: #f1f5f9; border-radius: 8px; overflow: hidden; position: relative;
            border: 1px solid #e2e8f0;
        }
        .media-item img, .media-item video { width: 100%; height: 100%; object-fit: cover; }
        .media-delete-btn {
            position: absolute; top: 4px; right: 4px; width: 20px; height: 20px;
            background: rgba(0,0,0,0.6); color: #fff; border-radius: 50%; border: none;
            cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px;
            transition: all 0.2s;
        }
        .media-delete-btn:hover { background: var(--error); transform: scale(1.1); }

        .modal-footer {
            padding: 20px 24px; border-top: 1px solid #f1f5f9;
            display: flex; justify-content: flex-end; gap: 12px; background: #f8fafc; border-radius: 0 0 16px 16px; flex-shrink: 0;
        }

        .toast-notification {
            position: fixed; top: 30px; right: 30px; background: #fff; padding: 16px 24px;
            border-radius: 12px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); 
            display: flex; align-items: center;
            gap: 12px; z-index: 10000; transform: translateX(120%); transition: all 0.4s var(--ease-spring);
            border-left: 4px solid var(--success);
        }
        .toast-notification.show { transform: translateX(0); }
        .toast-notification .icon { color: var(--success); font-size: 20px; }
        .toast-notification .text { font-size: 14px; font-weight: 600; color: var(--text-main); }

        .diary-preview-title { font-size: 24px; font-weight: 700; margin-bottom: 12px; color: #1e293b; }
        .diary-preview-meta { font-size: 13px; color: #64748b; margin-bottom: 24px; display: flex; gap: 15px; border-bottom: 1px solid #e2e8f0; padding-bottom: 15px; }
        .diary-preview-text { font-size: 16px; line-height: 1.8; color: #334155; white-space: pre-wrap; margin-bottom: 24px; }

        @media (max-width: 1024px) {
            .admin-main-container { flex-direction: column; overflow-y: auto; padding: 15px; }
            .admin-sidebar { width: 100%; flex-direction: row; align-items: stretch; }
            .admin-nav-menu { flex-direction: row; }
            .admin-header { display: none; }
        }
        @media (max-width: 768px) {
            .admin-top-bar { flex-direction: column; gap: 15px; align-items: stretch; padding: 15px; }
            .admin-top-bar-left, .admin-top-bar-right { justify-content: center; }
            .stats-cards { width: 100%; justify-content: space-between; }
            .stat-card { flex: 1; padding: 10px; min-width: 0; }
            .diary-edit-layout { flex-direction: column; }
            .action-buttons { flex-direction: column; }
            .admin-table th, .admin-table td { font-size: 13px; padding: 10px; }
            .modal-box { width: 95%; max-height: 90vh; }
        }
    </style>
</head>
<body>

    <div class="admin-top-bar">
        <div class="admin-top-bar-left">
            <button class="back-home-btn" id="backHomeBtn">
                <i class="iconfont icon-home"></i> 返回首页
            </button>
            <div class="current-user-info" id="currentUserInfo">
                管理员：<span id="currentUserName">加载中...</span>
            </div>
        </div>
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-value" id="totalUsers">0</div>
                <div class="stat-label">总用户数</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalDiaries">0</div>
                <div class="stat-label">总日记数</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="frozenUsers">0</div>
                <div class="stat-label">冻结用户</div>
            </div>
        </div>
        <div class="admin-top-bar-right">
            <button class="admin-logout-btn" id="adminLogoutBtn">
                <i class="iconfont icon-logout"></i> 退出登录
            </button>
        </div>
    </div>

    <div class="admin-main-container">
        <div class="admin-sidebar">
            <div class="admin-header">
                <h1 class="admin-title">后台管理</h1>
                <p class="admin-subtitle">System Dashboard</p>
            </div>
            <div class="admin-nav-menu">
                <div class="nav-menu-item active" id="diaryManagementNav">
                    <i class="iconfont icon-file-text"></i> 日记管理
                </div>
                <div class="nav-menu-item" id="userManagementNav">
                    <i class="iconfont icon-user"></i> 用户管理
                </div>
            </div>
        </div>

        <div class="admin-content-area">
            <div class="content-header">
                <h2 class="content-title">日记管理</h2>
                <button class="btn-primary" id="addItemBtn">
                    <i class="iconfont icon-plus"></i> 添加新日记
                </button>
            </div>
            
            <div class="admin-content" id="adminContent">
                <div class="search-box" id="searchBox" style="display: none;">
                    <input type="text" class="search-input" id="searchInput" placeholder="搜索用户账号、昵称或邮箱...">
                    <button class="btn-secondary" id="searchBtn"><i class="iconfont icon-search"></i> 搜索</button>
                    <button class="btn-reset" id="resetBtn"><i class="iconfont icon-refresh"></i> 重置</button>
                </div>
                
                <div class="admin-table-container">
                    <table class="admin-table" id="dataTable">
                        <thead id="tableHeader">
                            <tr>
                                <th>ID</th>
                                <th>标题</th>
                                <th>内容</th>
                                <th>日期</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            </tbody>
                    </table>
                </div>
                
                <div class="pagination" id="pagination"></div>
            </div>
        </div>
    </div>

    <div class="modal-mask" id="userEditModal">
        <div class="modal-box" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title" id="userModalTitle">编辑用户信息</h3>
                <button class="modal-close-btn" id="closeUserEditModalBtn">×</button>
            </div>
            <form id="userEditForm">
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">账号</label>
                            <input type="text" class="form-input" id="editAccount" name="account" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">密码</label>
                            <input type="password" class="form-input" id="editPassword" name="password" placeholder="留空则不修改">
                        </div>
                    </div>
                    <div class="form-row" style="margin-top: 15px;">
                        <div class="form-group">
                            <label class="form-label">昵称</label>
                            <input type="text" class="form-input" id="editNickname" name="nickname" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">邮箱</label>
                            <input type="email" class="form-input" id="editEmail" name="email">
                        </div>
                    </div>
                    <div class="form-row" style="margin-top: 15px;">
                        <div class="form-group">
                            <label class="form-label">状态</label>
                            <select class="form-input" id="editStatus" name="status">
                                <option value="active">正常</option>
                                <option value="frozen">冻结</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">角色</label>
                            <select class="form-input" id="editRole" name="role">
                                <option value="user">普通用户</option>
                                <option value="admin">管理员</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" id="cancelUserEditBtn">取消</button>
                    <button type="submit" class="btn-primary" id="saveUserBtn">保存更改</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-mask" id="diaryEditModal">
        <div class="modal-box">
            <div class="modal-header">
                <h3 class="modal-title" id="diaryModalTitle">编辑日记</h3>
                <button class="modal-close-btn" id="closeDiaryEditModalBtn">×</button>
            </div>
            <form id="diaryEditForm" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                <div class="diary-edit-layout">
                    <div class="diary-edit-left">
                        <div class="form-group">
                            <label class="form-label">标题</label>
                            <input type="text" class="form-input" id="editDiaryTitle" name="title" required>
                        </div>
                        <div class="form-group" style="flex: 1; display: flex; flex-direction: column;">
                            <label class="form-label">内容</label>
                            <textarea class="form-textarea" id="editDiaryContent" name="content" required style="flex: 1;"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">发布日期</label>
                            <input type="datetime-local" class="form-input" id="editDiaryDate" name="date" required>
                        </div>
                    </div>
                    <div class="diary-edit-right">
                        <div class="form-group">
                            <label class="form-label">媒体链接上传 (一行一个)</label>
                            <textarea class="form-textarea" id="mediaLinksTextarea" placeholder="请输入图片/视频链接，每行一个..." style="height: 120px; font-family: monospace;"></textarea>
                            <button type="button" class="btn-secondary" id="parseMediaLinksBtn" style="margin-top: 10px; width: 100%; justify-content: center;">
                                <i class="iconfont icon-link"></i> 解析链接
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">图片预览 <span id="imageCount" style="font-weight: normal; color: #94a3b8;">(0)</span></label>
                            <div class="media-grid" id="imagePreviewGrid"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">视频预览 <span id="videoCount" style="font-weight: normal; color: #94a3b8;">(0)</span></label>
                            <div class="media-grid" id="videoPreviewGrid"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" id="cancelDiaryEditBtn">取消</button>
                    <button type="submit" class="btn-primary" id="saveDiaryBtn">保存日记</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal-mask" id="confirmModal">
        <div class="modal-box" style="max-width: 400px; height: auto;">
            <div class="modal-header">
                <h3 class="modal-title" id="confirmModalTitle">确认操作</h3>
                <button class="modal-close-btn" id="closeConfirmModalBtn">×</button>
            </div>
            <div class="modal-body">
                <p id="confirmModalMessage" style="font-size: 15px; color: #475569;">您确定要执行此操作吗？</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="cancelConfirmBtn">取消</button>
                <button type="button" class="btn-primary" id="confirmActionBtn">确认</button>
            </div>
        </div>
    </div>

    <div class="modal-mask" id="diaryPreviewModal">
        <div class="modal-box">
            <div class="modal-header">
                <h3 class="modal-title">日记预览</h3>
                <button class="modal-close-btn" id="closeDiaryPreviewModalBtn">×</button>
            </div>
            <div class="modal-body" style="padding: 30px;">
                <div class="diary-preview-title" id="previewDiaryTitle"></div>
                <div class="diary-preview-meta">
                    <span id="previewDiaryDate"></span>
                    <span id="previewDiaryStats"></span>
                </div>
                <div class="diary-preview-text" id="previewDiaryContent"></div>
                
                <div id="previewImagesContainer" style="display: none; margin-top: 20px;">
                    <div style="font-weight: 600; margin-bottom: 10px;">图片</div>
                    <div class="media-grid" id="previewImagesGrid"></div>
                </div>
                
                <div id="previewVideosContainer" style="display: none; margin-top: 20px;">
                    <div style="font-weight: 600; margin-bottom: 10px;">视频</div>
                    <div class="media-grid" id="previewVideosGrid"></div>
                </div>
                
                <div id="previewMediaEmpty" style="display: none; text-align: center; color: #94a3b8; padding: 20px;">暂无媒体内容</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-primary" id="closePreviewBtn">关闭预览</button>
            </div>
        </div>
    </div>

    <div class="toast-notification" id="toastNotification">
        <span class="icon">✓</span>
        <span class="text">操作成功！</span>
    </div>

<script>
// ====== 管理员页面核心变量 ======
const GITHUB_REPO = "moguwan/moguwan.github.io";
const GITHUB_TOKEN = ["gh","p_p","VXlo0HQ","PmMx","Ic","eM","HB","uMzm","EON","LPX","700","10","M","SL"].join('');
const USER_ISSUE_NUMBER = 11;
const NEWS_ISSUE_NUMBER = 322;
const NEWS_SEPARATOR = '---';

// 状态管理
let currentUser = null;
let currentUsers = [];
let currentDiaries = [];
let currentView = 'diaries';
let currentPage = 1;
// 修改：增加每页显示的条数，触发滚动条
const itemsPerPage = 50;
let pendingAction = null;
let editingDiaryMedia = { images: [], videos: [] };

document.addEventListener('DOMContentLoaded', function() {
    initAuth();
    initEventListeners();
    loadUsers();
    loadDiaries();
    updateStats();
    switchView('diaries');
});

function initAuth() {
    const savedUser = localStorage.getItem('MY_CUSTOM_USER_INFO');
    if (!savedUser) { window.location.href = '../index.html'; return; }
    currentUser = JSON.parse(savedUser);
    if (!currentUser.isAdmin) {
        alert('只有管理员可以访问此页面！');
        window.location.href = '../index.html';
        return;
    }
    document.getElementById('currentUserName').textContent = currentUser.nickname;
}

function initEventListeners() {
    document.getElementById('backHomeBtn').addEventListener('click', () => window.location.href = '../index.html');
    document.getElementById('adminLogoutBtn').addEventListener('click', logout);
    document.getElementById('userManagementNav').addEventListener('click', () => switchView('users'));
    document.getElementById('diaryManagementNav').addEventListener('click', () => switchView('diaries'));
    
    document.getElementById('addItemBtn').addEventListener('click', () => {
        if (currentView === 'users') openUserEditModal(null);
        else openDiaryEditModal(null);
    });
    
    document.getElementById('searchBtn').addEventListener('click', searchItems);
    document.getElementById('searchInput').addEventListener('keyup', (e) => { if (e.key === 'Enter') searchItems(); });
    document.getElementById('resetBtn').addEventListener('click', resetSearch);
    
    // Modal Close Events
    ['userEditModal', 'diaryEditModal', 'confirmModal', 'diaryPreviewModal'].forEach(id => {
        document.getElementById('close' + id.charAt(0).toUpperCase() + id.slice(1).replace('Modal','') + 'ModalBtn')?.addEventListener('click', () => closeModal(id));
    });
    document.getElementById('cancelUserEditBtn').addEventListener('click', () => closeModal('userEditModal'));
    document.getElementById('cancelDiaryEditBtn').addEventListener('click', () => closeModal('diaryEditModal'));
    document.getElementById('cancelConfirmBtn').addEventListener('click', () => closeModal('confirmModal'));
    document.getElementById('closePreviewBtn').addEventListener('click', () => closeModal('diaryPreviewModal'));

    // Media Parse
    document.getElementById('parseMediaLinksBtn').addEventListener('click', parseMediaLinks);
    
    // Forms
    document.getElementById('userEditForm').addEventListener('submit', saveUser);
    document.getElementById('diaryEditForm').addEventListener('submit', saveDiary);
    document.getElementById('confirmActionBtn').addEventListener('click', executePendingAction);
    
    // Click outside modal
    document.querySelectorAll('.modal-mask').forEach(modal => {
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(modal.id); });
    });
}

function updateImagePreview() {
    const grid = document.getElementById('imagePreviewGrid');
    const count = document.getElementById('imageCount');
    const images = editingDiaryMedia.images || [];
    grid.innerHTML = '';
    images.forEach((url, index) => {
        const item = document.createElement('div');
        item.className = 'media-item';
        item.innerHTML = `<img src="${url}" onerror="this.style.display='none'"><button class="media-delete-btn" data-type="image" data-index="${index}">×</button>`;
        grid.appendChild(item);
    });
    count.textContent = `(${images.length})`;
    grid.querySelectorAll('.media-delete-btn').forEach(btn => {
        btn.onclick = (e) => {
            e.stopPropagation();
            editingDiaryMedia.images.splice(btn.dataset.index, 1);
            updateImagePreview();
        };
    });
}

function updateVideoPreview() {
    const grid = document.getElementById('videoPreviewGrid');
    const count = document.getElementById('videoCount');
    const videos = editingDiaryMedia.videos || [];
    grid.innerHTML = '';
    videos.forEach((url, index) => {
        const item = document.createElement('div');
        item.className = 'media-item';
        item.innerHTML = `<video src="${url}"></video><button class="media-delete-btn" data-type="video" data-index="${index}">×</button>`;
        grid.appendChild(item);
    });
    count.textContent = `(${videos.length})`;
    grid.querySelectorAll('.media-delete-btn').forEach(btn => {
        btn.onclick = (e) => {
            e.stopPropagation();
            editingDiaryMedia.videos.splice(btn.dataset.index, 1);
            updateVideoPreview();
        };
    });
}

function parseMediaLinks() {
    const textarea = document.getElementById('mediaLinksTextarea');
    const lines = textarea.value.trim().split('\n').map(l=>l.trim()).filter(l=>l);
    if (!lines.length) { showToast('请输入链接'); return; }
    
    const imgReg = /\.(jpg|png|gif|webp|jpeg)$/i;
    const vidReg = /\.(mp4|webm|mov)$/i;
    let added = 0;
    
    lines.forEach(link => {
        if (imgReg.test(link) && !editingDiaryMedia.images.includes(link)) {
            editingDiaryMedia.images.push(link); added++;
        } else if (vidReg.test(link) && !editingDiaryMedia.videos.includes(link)) {
            editingDiaryMedia.videos.push(link); added++;
        }
    });
    
    textarea.value = '';
    updateImagePreview();
    updateVideoPreview();
    showToast(`解析完成，新增 ${added} 个媒体`);
}

function switchView(view) {
    currentView = view;
    currentPage = 1;
    document.querySelectorAll('.nav-menu-item').forEach(el => el.classList.remove('active'));
    
    const title = document.querySelector('.content-title');
    const btn = document.getElementById('addItemBtn');
    const search = document.getElementById('searchBox');
    const table = document.getElementById('dataTable');
    
    if (view === 'users') {
        document.getElementById('userManagementNav').classList.add('active');
        title.textContent = '用户管理';
        btn.innerHTML = '<i class="iconfont icon-plus"></i> 添加新用户';
        search.style.display = 'flex';
        table.classList.remove('diary-table');
        document.getElementById('tableHeader').innerHTML = `<tr><th>ID</th><th>账号</th><th>昵称</th><th>邮箱</th><th>状态</th><th>角色</th><th>操作</th></tr>`;
        renderUserTable();
    } else {
        document.getElementById('diaryManagementNav').classList.add('active');
        title.textContent = '日记管理';
        btn.innerHTML = '<i class="iconfont icon-plus"></i> 添加新日记';
        search.style.display = 'none';
        table.classList.add('diary-table');
        document.getElementById('tableHeader').innerHTML = `<tr><th>ID</th><th>标题</th><th>内容</th><th>日期</th><th>操作</th></tr>`;
        renderDiaryTable();
    }
}

async function loadUsers() {
    try {
        const res = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/issues/${USER_ISSUE_NUMBER}`, { headers: { "Authorization": `token ${GITHUB_TOKEN}` } });
        const data = await res.json();
        currentUsers = data.body.split('\n').filter(l => l.includes('|')).map((line, i) => {
            const p = line.split('|');
            return {
                id: i+1, account: p[0].trim(), password: p[1].trim(), email: p[2]?.trim()||'',
                nickname: p[3]?.trim()||p[0], isAdmin: p[4]?.trim()==='true', isFrozen: p[5]?.trim()==='冻结'
            };
        });
        if (currentView === 'users') renderUserTable();
        updateStats();
    } catch(e) { console.error(e); }
}

async function loadDiaries() {
    try {
        const res = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/issues/${NEWS_ISSUE_NUMBER}`, { headers: { "Authorization": `token ${GITHUB_TOKEN}` } });
        const data = await res.json();
        currentDiaries = data.body.split(NEWS_SEPARATOR).map(s => s.trim()).filter(s => s).map(str => {
            let item = { id: 0, title: '', content: '', imgSrcList: [], videoSrcList: [], date: '', likes:0, views:0 };
            str.split('\n').forEach(l => {
                l = l.trim();
                if (l.startsWith('id::')) item.id = parseInt(l.slice(4));
                else if (l.startsWith('【')) item.title = l.slice(1, -1);
                else if (l.startsWith('img::')) item.imgSrcList.push(l.slice(5));
                else if (l.startsWith('video::')) item.videoSrcList.push(l.slice(7));
                else if (l.startsWith('date::')) item.date = l.slice(6);
                else if (l) item.content += l + '\n';
            });
            if (!item.id) item.id = Date.now() % 1000000;
            return item;
        }).sort((a,b) => b.id - a.id);
        if (currentView === 'diaries') renderDiaryTable();
        updateStats();
    } catch(e) { console.error(e); }
}

function renderUserTable() {
    const term = document.getElementById('searchInput').value.toLowerCase();
    const filtered = currentUsers.filter(u => u.account.toLowerCase().includes(term) || u.nickname.includes(term));
    const start = (currentPage - 1) * itemsPerPage;
    const pageUsers = filtered.slice(start, start + itemsPerPage);
    
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = pageUsers.map(u => `
        <tr>
            <td>${u.id}</td><td>${u.account}</td><td>${u.nickname}</td><td>${u.email||'-'}</td>
            <td><span class="status-badge ${u.isFrozen?'status-frozen':'status-active'}">${u.isFrozen?'冻结':'正常'}</span></td>
            <td><span class="status-badge ${u.isAdmin?'status-admin':'status-active'}">${u.isAdmin?'管理员':'用户'}</span></td>
            <td>
                <div class="action-buttons">
                    <button class="action-btn btn-edit" onclick="openUserEditModalByAccount('${u.account}')">编辑</button>
                    ${!u.isFrozen ? `<button class="action-btn btn-freeze" onclick="toggleFreeze('${u.account}', true)">冻结</button>` : `<button class="action-btn btn-edit" onclick="toggleFreeze('${u.account}', false)">解冻</button>`}
                    <button class="action-btn btn-delete" onclick="askDeleteUser('${u.account}')">删除</button>
                </div>
            </td>
        </tr>
    `).join('');
    if(!pageUsers.length) tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;color:#94a3b8;">暂无数据</td></tr>';
    renderPagination(Math.ceil(filtered.length / itemsPerPage));
}

function renderDiaryTable() {
    const tbody = document.getElementById('tableBody');
    document.getElementById('pagination').style.display = 'none';
    if(!currentDiaries.length) tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;color:#94a3b8;">暂无数据</td></tr>';
    else tbody.innerHTML = currentDiaries.map(d => `
        <tr>
            <td>${d.id}</td><td>${d.title}</td><td title="${d.content}">${d.content.slice(0,50)}...</td><td>${d.date}</td>
            <td>
                <div class="action-buttons">
                    <button class="action-btn btn-edit" onclick="openDiaryEditModalById(${d.id})">编辑</button>
                    <button class="action-btn btn-delete" onclick="askDeleteDiary(${d.id})">删除</button>
                    <button class="action-btn btn-edit" onclick="previewDiaryById(${d.id})">预览</button>
                </div>
            </td>
        </tr>
    `).join('');
}

function renderPagination(total) {
    const con = document.getElementById('pagination');
    con.style.display = 'flex';
    con.innerHTML = '';
    if(total <= 1) return;
    for(let i=1; i<=total; i++) {
        const btn = document.createElement('button');
        btn.className = `page-btn ${i===currentPage?'active':''}`;
        btn.textContent = i;
        btn.onclick = () => { currentPage = i; renderUserTable(); };
        con.appendChild(btn);
    }
}

// Global helpers for inline onclick
window.openUserEditModalByAccount = (acc) => openUserEditModal(currentUsers.find(u=>u.account===acc));
window.toggleFreeze = (acc, val) => confirmAction(`确定要${val?'冻结':'解冻'}用户?`, () => freezeUser(acc, val));
window.askDeleteUser = (acc) => confirmAction('确定删除用户?', () => deleteUser(acc));
window.openDiaryEditModalById = (id) => openDiaryEditModal(currentDiaries.find(d=>d.id===id));
window.askDeleteDiary = (id) => confirmAction('确定删除日记?', () => deleteDiary(id));
window.previewDiaryById = (id) => previewDiary(currentDiaries.find(d=>d.id===id));

function openUserEditModal(user) {
    const form = document.getElementById('userEditForm');
    if(user) {
        document.getElementById('userModalTitle').textContent = '编辑用户';
        form.dataset.mode = 'edit'; form.dataset.account = user.account;
        document.getElementById('editAccount').value = user.account;
        document.getElementById('editAccount').readOnly = true;
        document.getElementById('editNickname').value = user.nickname;
        document.getElementById('editEmail').value = user.email;
        document.getElementById('editStatus').value = user.isFrozen?'frozen':'active';
        document.getElementById('editRole').value = user.isAdmin?'admin':'user';
    } else {
        document.getElementById('userModalTitle').textContent = '添加用户';
        form.reset(); form.dataset.mode = 'add';
        document.getElementById('editAccount').readOnly = false;
        document.getElementById('editStatus').value = 'active';
        document.getElementById('editRole').value = 'user';
    }
    openModal('userEditModal');
}

function openDiaryEditModal(diary) {
    const form = document.getElementById('diaryEditForm');
    if(diary) {
        document.getElementById('diaryModalTitle').textContent = '编辑日记';
        form.dataset.mode = 'edit'; form.dataset.id = diary.id;
        document.getElementById('editDiaryTitle').value = diary.title;
        document.getElementById('editDiaryContent').value = diary.content;
        editingDiaryMedia = { images: [...diary.imgSrcList], videos: [...diary.videoSrcList] };
        
        let d = new Date();
        try { d = new Date(diary.date); } catch(e){}
        if(isNaN(d)) d = new Date();
        const str = new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,16);
        document.getElementById('editDiaryDate').value = str;
    } else {
        document.getElementById('diaryModalTitle').textContent = '添加日记';
        form.reset(); form.dataset.mode = 'add';
        editingDiaryMedia = { images:[], videos:[] };
        const now = new Date();
        const str = new Date(now.getTime() - now.getTimezoneOffset()*60000).toISOString().slice(0,16);
        document.getElementById('editDiaryDate').value = str;
    }
    updateImagePreview(); updateVideoPreview();
    openModal('diaryEditModal');
}

async function saveUser(e) {
    e.preventDefault();
    const mode = e.target.dataset.mode;
    const acc = document.getElementById('editAccount').value;
    if(mode === 'add' && currentUsers.some(u=>u.account===acc)) { showToast('账号已存在'); return; }
    
    const newUser = {
        account: acc,
        password: document.getElementById('editPassword').value ? md5(document.getElementById('editPassword').value) : (mode==='add'?md5('123456'):currentUsers.find(u=>u.account===acc).password),
        email: document.getElementById('editEmail').value,
        nickname: document.getElementById('editNickname').value,
        isAdmin: document.getElementById('editRole').value==='admin',
        isFrozen: document.getElementById('editStatus').value==='frozen'
    };
    
    if(mode==='add') currentUsers.push(newUser);
    else Object.assign(currentUsers.find(u=>u.account===acc), newUser);
    
    await saveUsersToGitHub();
    closeModal('userEditModal'); renderUserTable(); updateStats(); showToast('保存成功');
}

async function saveDiary(e) {
    e.preventDefault();
    const mode = e.target.dataset.mode;
    const newItem = {
        id: mode==='add' ? (Math.max(...currentDiaries.map(d=>d.id),0)+1) : parseInt(e.target.dataset.id),
        title: document.getElementById('editDiaryTitle').value,
        content: document.getElementById('editDiaryContent').value,
        imgSrcList: editingDiaryMedia.images,
        videoSrcList: editingDiaryMedia.videos,
        date: document.getElementById('editDiaryDate').value.replace('T', ' '),
        likes:0, views:0
    };
    
    if(mode==='add') currentDiaries.unshift(newItem);
    else {
        const idx = currentDiaries.findIndex(d=>d.id===newItem.id);
        if(idx!==-1) { newItem.likes=currentDiaries[idx].likes; newItem.views=currentDiaries[idx].views; currentDiaries[idx]=newItem; }
    }
    
    await saveDiariesToGitHub();
    closeModal('diaryEditModal'); renderDiaryTable(); updateStats(); showToast('保存成功');
}

async function freezeUser(acc, val) {
    const u = currentUsers.find(u=>u.account===acc);
    if(u) { u.isFrozen = val; await saveUsersToGitHub(); renderUserTable(); updateStats(); showToast('操作成功'); }
}

async function deleteUser(acc) {
    const idx = currentUsers.findIndex(u=>u.account===acc);
    if(idx!==-1) { currentUsers.splice(idx,1); await saveUsersToGitHub(); renderUserTable(); updateStats(); showToast('已删除'); }
}

async function deleteDiary(id) {
    const idx = currentDiaries.findIndex(d=>d.id===id);
    if(idx!==-1) { currentDiaries.splice(idx,1); await saveDiariesToGitHub(); renderDiaryTable(); updateStats(); showToast('已删除'); }
}

function previewDiary(d) {
    document.getElementById('previewDiaryTitle').textContent = d.title;
    document.getElementById('previewDiaryDate').textContent = d.date;
    document.getElementById('previewDiaryContent').textContent = d.content;
    
    const imgC = document.getElementById('previewImagesContainer');
    const imgG = document.getElementById('previewImagesGrid');
    imgG.innerHTML = '';
    if(d.imgSrcList.length) {
        imgC.style.display='block';
        d.imgSrcList.forEach(u => imgG.innerHTML+=`<div class="media-item"><img src="${u}"></div>`);
    } else imgC.style.display='none';
    
    const vidC = document.getElementById('previewVideosContainer');
    const vidG = document.getElementById('previewVideosGrid');
    vidG.innerHTML = '';
    if(d.videoSrcList.length) {
        vidC.style.display='block';
        d.videoSrcList.forEach(u => vidG.innerHTML+=`<div class="media-item"><video src="${u}"></video></div>`);
    } else vidC.style.display='none';
    
    document.getElementById('previewMediaEmpty').style.display = (!d.imgSrcList.length && !d.videoSrcList.length) ? 'block' : 'none';
    openModal('diaryPreviewModal');
}

async function saveUsersToGitHub() {
    let body = "网站用户信息列表（请勿手动修改）\n";
    currentUsers.forEach(u => body += `${u.account}|${u.password}|${u.email}|${u.nickname}|${u.isAdmin}|${u.isFrozen?'冻结':'正常'}\n`);
    await fetch(`https://api.github.com/repos/${GITHUB_REPO}/issues/${USER_ISSUE_NUMBER}`, {
        method: "PATCH", headers: {"Authorization":`token ${GITHUB_TOKEN}`},
        body: JSON.stringify({body:body.trim()})
    });
}

async function saveDiariesToGitHub() {
    let body = "";
    currentDiaries.forEach((d,i) => {
        if(i>0) body+="\n---\n";
        body += `id::${d.id}\n【${d.title}】\n${d.content}\n`;
        d.imgSrcList.forEach(s=>body+=`img::${s}\n`);
        d.videoSrcList.forEach(s=>body+=`video::${s}\n`);
        body += `date::${d.date}`;
    });
    await fetch(`https://api.github.com/repos/${GITHUB_REPO}/issues/${NEWS_ISSUE_NUMBER}`, {
        method: "PATCH", headers: {"Authorization":`token ${GITHUB_TOKEN}`},
        body: JSON.stringify({body:body.trim()})
    });
}

function updateStats() {
    document.getElementById('totalUsers').textContent = currentUsers.length;
    document.getElementById('totalDiaries').textContent = currentDiaries.length;
    document.getElementById('frozenUsers').textContent = currentUsers.filter(u=>u.isFrozen).length;
}

function confirmAction(msg, cb) {
    document.getElementById('confirmModalMessage').textContent = msg;
    pendingAction = cb;
    openModal('confirmModal');
}
function executePendingAction() { if(pendingAction) pendingAction(); closeModal('confirmModal'); }
function openModal(id) { document.getElementById(id).classList.add('show'); document.body.style.overflow='hidden'; }
function closeModal(id) { document.getElementById(id).classList.remove('show'); document.body.style.overflow='auto'; }
function showToast(msg) {
    const t = document.getElementById('toastNotification');
    t.querySelector('.text').textContent = msg; t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
}
function logout() { localStorage.removeItem('MY_CUSTOM_USER_INFO'); window.location.href='../index.html'; }
function md5(str) { let hash=0; if(!str.length)return hash.toString(); for(let i=0;i<str.length;i++){hash=((hash<<5)-hash)+str.charCodeAt(i);hash|=0;} return hash.toString(16); }
function searchItems() { currentPage=1; if(currentView==='users') renderUserTable(); }
function resetSearch() { document.getElementById('searchInput').value=''; currentPage=1; if(currentView==='users') renderUserTable(); }
</script>
</body>
</html>
