<!DOCTYPE html>
<html lang="zh-CN" data-theme-mode="light">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="MY HOME 用户登录/注册">
    <title>登录/注册 - MY HOME</title>
    <link rel="preload" href="//at.alicdn.com/t/c/font_4552607_0khxww3tj3q9.woff2" as="font" type="font/woff2" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/dmego-home-page@latest/assets/css/iconfont.css">
    
    <!-- 引入EmailJS库（新增） -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <!-- 液态玻璃SVG滤镜 -->
    <svg style="display: none">
      <filter id="glass-distortion">
        <feTurbulence type="fractalNoise" baseFrequency="0.001 0.005" numOctaves="1" seed="17" result="turbulence" />
        <feComponentTransfer in="turbulence" result="mapped">
          <feFuncR type="gamma" amplitude="1" exponent="10" offset="0.5" />
          <feFuncG type="gamma" amplitude="0" exponent="1" offset="0" />
          <feFuncB type="gamma" amplitude="0" exponent="1" offset="0.5" />
        </feComponentTransfer>
        <feGaussianBlur in="turbulence" stdDeviation="3" result="softMap" />
        <feSpecularLighting in="softMap" surfaceScale="5" specularConstant="1" specularExponent="100" lighting-color="white" result="specLight">
          <fePointLight x="-200" y="-200" z="300" />
        </feSpecularLighting>
        <feComposite in="specLight" operator="arithmetic" k1="0" k2="1" k3="1" k4="0" result="litImage" />
        <feDisplacementMap in="SourceGraphic" in2="softMap" scale="200" xChannelSelector="R" yChannelSelector="G" />
      </filter>
    </svg>

    <style type="text/css">
        /* 全局重置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            overflow-x: hidden !important;
            position: relative;
            width: 100%;
            min-height: 100vh;
            font-family: "思源圆角 CN", "PingFang SC Round", "Microsoft YaHei UI Light", "圆润黑体 CN", "苹方-圆角", sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            scroll-behavior: smooth;
        }

        /* 固定白色主题样式 */
        :root {
            --bg-base: #fafcf9;
            --color-text-main: #3a4a42;
            --color-text-sub: #6b7c73;
            --color-green: #2db48d;
            --color-green-deep: #1f9c7a;
            --color-green-light: rgba(45, 180, 141, 0.1);
            --color-red: #e74c3c;
            --color-red-light: rgba(231, 76, 60, 0.1);
            --border-color: rgba(0, 0, 0, 0.08);
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(255, 255, 255, 0.95);
            --glass-shadow: 0 15px 50px rgba(45, 180, 141, 0.12);
            --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            background: linear-gradient(135deg, #f5fbf8 0%, #e8f4f0 100%);
            color: var(--color-text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0px;
            min-height: 100vh;
            position: relative;
        }

        /* 背景装饰元素 */
        .bg-circle {
            position: fixed;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(45, 180, 141, 0.08) 0%, transparent 70%);
            z-index: -1;
        }
        
        .bg-circle-1 {
            width: 300px;
            height: 300px;
            top: -100px;
            left: -100px;
        }
        
        .bg-circle-2 {
            width: 400px;
            height: 400px;
            bottom: -150px;
            right: -150px;
            background: radial-gradient(circle, rgba(31, 156, 122, 0.05) 0%, transparent 70%);
        }
        
        .bg-circle-3 {
            width: 200px;
            height: 200px;
            top: 50%;
            left: 80%;
            background: radial-gradient(circle, rgba(45, 180, 141, 0.06) 0%, transparent 70%);
        }

        /* 返回按钮样式 - 固定在左上角 */
        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--color-text-sub);
            cursor: pointer;
            font-size: 18px;
            padding: 8px 12px;
            border-radius: 8px;
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            transition: var(--transition-smooth);
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .back-btn:hover {
            color: var(--color-green);
            background: var(--color-green-light);
            border-color: rgba(45, 180, 141, 0.3);
            transform: translateX(-2px);
            box-shadow: 0 6px 16px rgba(45, 180, 141, 0.15);
        }

        .auth-container {
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: var(--glass-shadow), 
                        inset 1px 1px 0 rgba(255,255,255,0.8), 
                        inset -1px -1px 0 rgba(0,0,0,0.05);
            /* 1. 修改：把原来的 width: 100% 改成 30%（屏幕宽度的30%） */
            width: 35%;
            /* 2. 删除/注释：原来的 max-width: 520px;（这行限制了最大宽度，必须去掉） */
            /* max-width: 520px; */
            /* 3. 新增：添加最小宽度，避免屏幕过宽时30%太宽，或屏幕过窄时30%太窄 */
            min-width: 400px; 
            padding: 30px 40px; /* 内边距不变 */
            position: relative;
            overflow: hidden;
            transition: all 0.4s ease;
            z-index: 10;
            min-height: 706px; /* 保持680px，保证高度足够 */
            display: flex;
            flex-direction: column;
        }

        /* 容器装饰 */
        .auth-container::before {
            content: '';
            position: absolute;
            top: -100px;
            right: -100px;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(45, 180, 141, 0.1) 0%, transparent 70%);
            z-index: 0;
            opacity: 0.5;
        }
        
        .auth-container::after {
            content: '';
            position: absolute;
            bottom: -80px;
            left: -80px;
            width: 250px;
            height: 250px;
            background: radial-gradient(circle, rgba(31, 156, 122, 0.08) 0%, transparent 70%);
            z-index: 0;
            opacity: 0.5;
        }

        /* 标题样式 */
        .auth-header {
            text-align: center;
            position: relative;
            z-index: 1;
        }
        
        .auth-header h1 {
            font-size: 26px;
            color: var(--color-green-deep);
            margin-bottom: 8px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .auth-header p {
            color: var(--color-text-sub);
            font-size: 14px;
        }

        /* 选项卡切换 */
        .auth-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 6px;
            position: relative;
            z-index: 10;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 12px;
            padding: 4px;
            border: 1px solid var(--border-color);
        }
        
        .auth-tab {
            flex: 1;
            padding: 10px 0;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            color: var(--color-text-sub);
            transition: var(--transition-smooth);
            position: relative;
        }
        
        .auth-tab.active {
            color: var(--color-green);
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 3px 10px rgba(45, 180, 141, 0.15);
        }
        
        .auth-tab.active::after {
            content: '';
            position: absolute;
            bottom: 2px;
            left: 25%;
            width: 50%;
            height: 2px;
            background: var(--color-green);
            border-radius: 1px;
        }

        /* 修复核心：表单容器改为绝对定位，让两个表单重叠 */
        .auth-form-wrapper {
            position: relative;
            width: 100%;
            flex: 1; /* 这一行必须保留，让表单区域占满剩余空间 */
            overflow: hidden;
        }
        
        .auth-form {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 8px;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(10px);
            z-index: 1;
        }
        
        .auth-form.active {
			width: 100%;
            opacity: 1;
            visibility: visible;
            pointer-events: auto; /* 显示时响应点击 */
            transform: translateY(0);
        }
        
        .form-group {
            width: 100%;
            position: relative;
        }
        
        .form-label {
            font-size: 13px;
            color: var(--color-text-sub);
            margin-bottom: 6px;
            display: block;
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            height: 44px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 0 15px;
            color: var(--color-text-main);
            font-size: 15px;
            outline: none;
            transition: var(--transition-smooth);
        }
        
        .form-input:focus {
            border-color: var(--color-green);
            box-shadow: 0 0 0 3px rgba(45, 180, 141, 0.15);
            background: white;
        }
        
        .form-input.error {
            border-color: var(--color-red);
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }
        
        .form-input.success {
            border-color: var(--color-green);
        }
        
        .error-message {
            color: var(--color-red);
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }
        
        .error-message.show {
            display: block;
        }

        /* 新增：验证码输入容器样式 */
        .verify-code-wrapper {
            display: flex;
            gap: 10px;
            width: 100%;
        }
        
        .verify-code-input {
            flex: 1;
        }
        
        .send-code-btn {
            width: 120px;
            height: 44px;
            background: var(--color-green-light);
            color: var(--color-green);
            border: 1px solid rgba(45, 180, 141, 0.3);
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition-smooth);
        }
        
        .send-code-btn:hover {
            background: var(--color-green-light);
            border-color: var(--color-green);
        }
        
        .send-code-btn:disabled {
            background: #f0f0f0;
            color: #999;
            border-color: #ddd;
            cursor: not-allowed;
        }

        /* 密码输入容器 - 统一样式，修复按钮定位 */
        .password-input-wrapper {
            position: relative;
            width: 100%;
        }
        
        /* 密码显示/隐藏按钮 - 修复定位 */
        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%; /* 垂直居中 */
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--color-text-sub);
            cursor: pointer;
            font-size: 16px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-smooth);
            z-index: 2;
        }
        
        .password-toggle:hover {
            color: var(--color-green);
        }

        /* 按钮样式 */
        .auth-btn {
            width: 100%;
            height: 46px;
            background: linear-gradient(135deg, var(--color-green), var(--color-green-deep));
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: var(--transition-smooth);
            margin-top: 10px;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        .auth-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--color-green-deep), var(--color-green));
            transition: left 0.5s ease;
            z-index: -1;
        }
        
        .auth-btn:hover::before {
            left: 0;
        }
        
        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(56, 161, 105, 0.25);
        }
        
        .auth-btn:active {
            transform: translateY(0);
        }
        
        .auth-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* 加载动画 */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition-smooth);
        }
        
        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .loader {
            width: 40px;
            height: 40px;
            border: 4px solid var(--color-green-light);
            border-bottom-color: var(--color-green);
            border-radius: 50%;
            display: inline-block;
            animation: rotation 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: var(--color-green-deep);
            font-weight: 500;
            font-size: 14px;
        }

        /* 自定义提示框 */
        .custom-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            z-index: 2000;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 300px;
        }
        
        .custom-alert.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .custom-alert.success {
            border-left: 4px solid var(--color-green);
        }
        
        .custom-alert.error {
            border-left: 4px solid var(--color-red);
        }
        
        .custom-alert-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .custom-alert-icon {
            font-size: 18px;
        }
        
        .custom-alert.success .custom-alert-icon {
            color: var(--color-green);
        }
        
        .custom-alert.error .custom-alert-icon {
            color: var(--color-red);
        }
        
        .custom-alert-message {
            font-size: 14px;
            color: var(--color-text-main);
        }

        /* 找回密码提示 */
        .forgot-password {
            text-align: center;
            margin-top: 0px;
            font-size: 13px;
            color: var(--color-text-sub);
            position: relative;
            z-index: 1;
            /* 固定在表单底部 */
            padding-top: 0px;
        }
        
        .forgot-password a {
            color: var(--color-green);
            text-decoration: none;
            transition: var(--transition-smooth);
            position: relative;
        }
        
        .forgot-password a:hover {
            text-decoration: underline;
        }

        @media (max-width: 480px) {
            body {
                padding: 15px;
            }
            
            .auth-container {
                padding: 30px 20px;
                /* 修改：小屏幕下恢复100%宽度，避免过窄 */
                width: 100%;
                /* 小屏幕下取消最小宽度限制 */
                min-width: auto;
                max-width: 100%;
                border-radius: 18px;
                min-height: 650px;
            }
            
            /* 其他样式不变，保留 */
            .auth-form {
                gap: 14px;
            }
            
            .auth-header h1 {
                font-size: 22px;
            }
            
            .auth-btn {
                height: 42px;
                font-size: 14px;
            }
            
            .form-input {
                height: 40px;
                font-size: 14px;
            }
            
            .send-code-btn {
                width: 100px;
                height: 40px;
                font-size: 13px;
            }
            
            .back-btn {
                top: 15px;
                left: 15px;
                padding: 7px 10px;
                font-size: 13px;
            }
        }
        
        @media (max-width: 360px) {
            .auth-container {
                padding: 25px 18px;
                min-height: 620px;
            }
        }

        /* ========== 新增：首页同款开合动画样式 ========== */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ffffff;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            transition: opacity 0.6s ease, visibility 0.6s ease;
        }
        .loading-left-bg, .loading-right-bg {
            position: absolute;
            top: 0;
            width: 50%;
            height: 100%;
            background: #f5faf7;
            transition: transform 0.6s ease;
        }
        .loading-left-bg { left: 0; }
        .loading-right-bg { right: 0; }
        #loader.loaded .loading-left-bg { transform: translateX(-100%); }
        #loader.loaded .loading-right-bg { transform: translateX(100%); }
        #loader.loaded { opacity: 0; visibility: hidden; }
        .spinner-box { text-align: center; }
        .loading-taichi svg {
            width: 80px;
            height: 80px;
            fill: #2d8b69;
            transition: fill 0.3s ease;
        }
        .loading-word {
            margin-top: 20px;
            color: #3a9e7c;
            font-size: 16px;
            letter-spacing: 3px;
            transition: color 0.3s ease;
        }
        .rotate {
            transition: transform 4s linear infinite;
        }
        .rotate:hover {
            transform: rotate(360deg);
        }
    </style>
</head>
<body>
    <!-- ========== 新增：首页同款开合动画结构 ========== -->
    <div id="loader">
        <div class="loading-left-bg loading-bg"></div>
        <div class="loading-right-bg loading-bg"></div>
        <div class="spinner-box">
            <div class="loading-taichi rotate">
                <svg width="150" height="150" viewBox="0 0 1024 1024" class="icon" xmlns="https://www.w3.org/2000/svg">
                    <path d="M303.5 432A80 80 0 0 1 291.5 592A80 80 0 0 1 303.5 432z" />
                    <path d="M512 65A447 447 0 0 1 512 959L512 929A417 417 0 0 0 512 95A417 417 0 0 0 512 929L512 959A447 447 0 0 1 512 65z M512 95A417 417 0 0 1 929 512A208.5 208.5 0 0 1 720.5 720.5L720.5 592A80 80 0 0 0 720.5 432A80 80 0 0 0 720.5 592L720.5 720.5A208.5 208.5 0 0 1 512 512A208.5 208.5 0 0 0 303.5 303.5A208.5 208.5 0 0 0 95 512A417 417 0 0 1 512 95z" />
                </svg>
            </div>
            <div class="loading-word">春天是她最爱的季节...</div>
        </div>
    </div>

    <!-- 背景装饰 -->
    <div class="bg-circle bg-circle-1"></div>
    <div class="bg-circle bg-circle-2"></div>
    <div class="bg-circle bg-circle-3"></div>
    
    <!-- 返回按钮 - 固定在左上角 -->
    <div class="back-btn" id="backBtn">
        <<i class="iconfont icon-left"></i>Back
    </div>

    <!-- 加载动画 -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loader"></div>
        <div class="loading-text" id="loadingText">正在处理，请稍候...</div>
    </div>

    <!-- 自定义提示框 -->
    <div class="custom-alert" id="customAlert">
        <div class="custom-alert-content">
            <div class="custom-alert-icon"></div>
            <div class="custom-alert-message" id="alertMessage"></div>
        </div>
    </div>

    <div class="auth-container">
        <!-- 标题 -->
        <div class="auth-header">
            <h1>MY HOME</h1>
        </div>

        <!-- 登录/注册选项卡 -->
        <div class="auth-tabs">
            <div class="auth-tab active" data-target="loginForm">登录</div>
            <div class="auth-tab" data-target="registerForm">注册</div>
        </div>

        <!-- 表单容器 - 新增包裹层，避免布局冲突 -->
        <div class="auth-form-wrapper">
            <!-- 登录表单 -->
            <div class="auth-form active" id="loginForm">
                <div class="form-group">
                    <label class="form-label">账号</label>
                    <input type="text" class="form-input" id="loginAccount" placeholder="请输入注册的账号">
                </div>
                <div class="form-group">
                    <label class="form-label">密码</label>
                    <!-- 使用统一的密码容器样式 -->
                    <div class="password-input-wrapper">
                        <input type="password" class="form-input" id="loginPassword" placeholder="请输入密码">
                        <button type="button" class="password-toggle" id="loginPasswordToggle">
                            <<i class="iconfont icon-eye"></</i>
                        </button>
                    </div>
                </div>
                <button type="button" class="auth-btn" id="loginBtn">登录</button>
                
                <!-- 找回密码提示 -->
                <div class="forgot-password">
                    找回密码请联系管理员 QQ: <a href="javascript:void(0);">2926197119</a>
                </div>
            </div>

            <!-- 注册表单（新增验证码输入框） -->
            <div class="auth-form" id="registerForm">
                <div class="form-group">
                    <label class="form-label">用户名</label>
                    <input type="text" class="form-input" id="regNickname" placeholder="请设置显示的用户名">
                    <div class="error-message" id="regNicknameError"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">账号</label>
                    <input type="text" class="form-input" id="regAccount" placeholder="请设置账号（字母/数字）">
                    <div class="error-message" id="regAccountError"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">密码</label>
                    <!-- 使用统一的密码容器样式 -->
                    <div class="password-input-wrapper">
                        <input type="password" class="form-input" id="regPassword" placeholder="请设置密码（不少于6位）">
                        <button type="button" class="password-toggle" id="regPasswordToggle">
                            <<i class="iconfont icon-eye"></</i>
                        </button>
                    </div>
                    <div class="error-message" id="regPasswordError"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">确认密码</label>
                    <!-- 使用统一的密码容器样式 -->
                    <div class="password-input-wrapper">
                        <input type="password" class="form-input" id="regPasswordConfirm" placeholder="请再次输入密码">
                        <button type="button" class="password-toggle" id="regPasswordConfirmToggle">
                            <<i class="iconfont icon-eye"></</i>
                        </button>
                    </div>
                    <div class="error-message" id="regPasswordConfirmError"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">QQ邮箱</label>
                    <input type="email" class="form-input" id="regEmail" placeholder="请输入QQ邮箱（仅支持QQ邮箱）">
                    <div class="error-message" id="regEmailError"></div>
                </div>
                <!-- 新增：验证码输入框 -->
                <div class="form-group">
                    <label class="form-label">验证码</label>
                    <div class="verify-code-wrapper">
                        <input type="text" class="form-input verify-code-input" id="regVerifyCode" placeholder="请输入邮箱验证码">
                        <button type="button" class="send-code-btn" id="sendCodeBtn">发送验证码</button>
                    </div>
                    <div class="error-message" id="regVerifyCodeError"></div>
                </div>
                <button type="button" class="auth-btn" id="registerBtn">注册</button>
                
                <!-- 找回密码提示 -->
                <div class="forgot-password">
                    找回密码请联系管理员 QQ: <a href="javascript:void(0);">2926197119</a>
                </div>
            </div>
        </div>
    </div>
<script type="text/javascript">
    // GitHub配置（与首页保持一致）
    const GITHUB_REPO = "moguwan/moguwan.github.io";
    const GITHUB_TOKEN = ["gh","p_p","VXlo0HQ","PmMx","Ic","eM","HB","uMzm","EON","LPX","700","10","M","SL"].join('');
    const USER_ISSUE_NUMBER = 11; // 用户信息存储的Issue编号
    const USER_LOCAL_KEY = 'MY_CUSTOM_USER_INFO'; // 本地存储用户信息的Key
    const DEFAULT_AVATAR = "https://img.wjwj.top/2026/01/20/d6346e9c8e93165079c5ab74f856358c.png";
    
    // 当前正在加载的操作类型
    let currentLoadingType = '';
    // ========== 新增：动画状态控制变量 ==========
    let isAnimating = false;
    // 新增：验证码倒计时定时器
    let countdownTimer = null;


    // ========== 新增：初始化EmailJS（用你提供的Public Key） ==========
    emailjs.init('QPXRZfhOcviP14EGP');


    // MD5加密函数（与首页一致）
    function md5(str) {
        let hash = 0;
        if (str.length === 0) return hash.toString();
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // 转换为32位整数
        }
        return hash.toString(16);
    }

    // 显示自定义提示框（替代浏览器alert）
    function showAlert(message, type = 'success') {
        const alertElement = document.getElementById('customAlert');
        const messageElement = document.getElementById('alertMessage');
        const iconElement = alertElement.querySelector('.custom-alert-icon');
        
        // 设置消息和类型
        messageElement.textContent = message;
        alertElement.className = 'custom-alert';
        alertElement.classList.add(type);
        
        // 设置图标
        if (type === 'success') {
            iconElement.innerHTML = '<<i class="iconfont icon-check-circle"></</i>';
        } else {
            iconElement.innerHTML = '<<i class="iconfont icon-close-circle"></</i>';
        }
        
        // 显示提示框
        alertElement.classList.add('show');
        
        // 3秒后自动隐藏
        setTimeout(() => {
            alertElement.classList.remove('show');
        }, 3000);
    }

    // 显示加载动画
    function showLoading(type = '处理中') {
        currentLoadingType = type;
        document.getElementById('loadingText').textContent = type === '登录' ? '正在登录，请稍候...' : 
                                                           type === '注册' ? '正在注册，请稍候...' : 
                                                           type === '发送验证码' ? '正在发送验证码，请稍候...' :
                                                           '正在处理，请稍候...';
        document.getElementById('loadingOverlay').classList.add('active');
    }

    // 隐藏加载动画
    function hideLoading() {
        document.getElementById('loadingOverlay').classList.remove('active');
        currentLoadingType = '';
    }

    // 显示错误信息
    function showError(inputId, message) {
        const inputElement = document.getElementById(inputId);
        const errorElement = document.getElementById(inputId + 'Error');
        
        if (inputElement) {
            inputElement.classList.add('error');
            inputElement.classList.remove('success');
        }
        
        if (errorElement) {
            errorElement.textContent = message;
            errorElement.classList.add('show');
        }
    }

    // 清除错误信息
    function clearError(inputId) {
        const inputElement = document.getElementById(inputId);
        const errorElement = document.getElementById(inputId + 'Error');
        
        if (inputElement) {
            inputElement.classList.remove('error');
        }
        
        if (errorElement) {
            errorElement.textContent = '';
            errorElement.classList.remove('show');
        }
    }

    // 显示成功状态
    function showSuccess(inputId) {
        const inputElement = document.getElementById(inputId);
        
        if (inputElement) {
            inputElement.classList.remove('error');
            inputElement.classList.add('success');
        }
        
        clearError(inputId);
    }

    // ========== 修改：只验证QQ邮箱格式 ==========
    function validateEmail(email) {
        const qqEmailReg = /^[1-9]\d{4,10}@qq\.com$/;
        return qqEmailReg.test(email);
    }

    // ========== 新增：生成6位验证码 ==========
    function generateVerifyCode() {
        return Math.floor(100000 + Math.random() * 900000).toString();
    }

    // ========== 新增：发送验证码函数 ==========
    async function sendVerifyCode() {
        const email = document.getElementById('regEmail').value.trim();
        const sendBtn = document.getElementById('sendCodeBtn');
        
        // 1. 验证QQ邮箱
        if (!email) {
            showError('regEmail', 'QQ邮箱不能为空');
            return;
        } else if (!validateEmail(email)) {
            showError('regEmail', '请输入有效的QQ邮箱');
            return;
        }

        // 2. 防止重复点击
        if (sendBtn.disabled) return;
        sendBtn.disabled = true;
        showLoading('发送验证码');

        try {
            // 3. 生成验证码并存储（有效期5分钟）
            const verifyCode = generateVerifyCode();
            sessionStorage.setItem(`verifyCode_${email}`, JSON.stringify({
                code: verifyCode,
                expireTime: Date.now() + 5 * 60 * 1000
            }));

            // 4. 调用EmailJS发送邮件（替换为你的Template ID）
            const response = await emailjs.send(
                'service_9nfcx0b', // 你提供的Service ID
                'template_kn5zqc8', // 【需确认】替换为你的验证码模板ID（在EmailJS模板页复制）
                {
                    to_email: email,   // 对应模板里的{{to_email}}
                    verify_code: verifyCode // 对应模板里的{{verify_code}}
                }
            );

            hideLoading();
            if (response.status === 200) {
                showAlert('验证码已发送至您的QQ邮箱，5分钟内有效', 'success');
                
                // 5. 启动倒计时
                let countdown = 60;
                sendBtn.textContent = `${countdown}秒后重发`;
                countdownTimer = setInterval(() => {
                    countdown--;
                    sendBtn.textContent = `${countdown}秒后重发`;
                    if (countdown <= 0) {
                        clearInterval(countdownTimer);
                        sendBtn.disabled = false;
                        sendBtn.textContent = '发送验证码';
                    }
                }, 1000);
            } else {
                showAlert('验证码发送失败，请重试', 'error');
                sendBtn.disabled = false;
            }
        } catch (error) {
            hideLoading();
            console.error('发送验证码失败：', error);
            showAlert('验证码发送失败，请检查配置', 'error');
            sendBtn.disabled = false;
        }
    }

    // 切换登录/注册选项卡（带动画）
    function initTabs() {
        const tabs = document.querySelectorAll('.auth-tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // 切换选项卡激活状态
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // 切换表单显示（触发动画）
                document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
                document.getElementById(tab.dataset.target).classList.add('active');
                
                // 清除所有错误状态
                clearAllErrors();
            });
        });
    }

    // 初始化密码显示/隐藏功能
    function initPasswordToggles() {
        // 登录密码显示/隐藏
        const loginToggle = document.getElementById('loginPasswordToggle');
        const loginPassword = document.getElementById('loginPassword');
        
        loginToggle.addEventListener('click', () => {
            const type = loginPassword.getAttribute('type') === 'password' ? 'text' : 'password';
            loginPassword.setAttribute('type', type);
            
            // 切换图标
            loginToggle.innerHTML = type === 'password' ? 
                '<<i class="iconfont icon-eye"></</i>' : 
                '<<i class="iconfont icon-eye-close"></</i>';
        });
        
        // 注册密码显示/隐藏
        const regToggle = document.getElementById('regPasswordToggle');
        const regPassword = document.getElementById('regPassword');
        
        regToggle.addEventListener('click', () => {
            const type = regPassword.getAttribute('type') === 'password' ? 'text' : 'password';
            regPassword.setAttribute('type', type);
            
            // 切换图标
            regToggle.innerHTML = type === 'password' ? 
                '<<i class="iconfont icon-eye"></</i>' : 
                '<<i class="iconfont icon-eye-close"></</i>';
        });
        
        // 注册确认密码显示/隐藏
        const regConfirmToggle = document.getElementById('regPasswordConfirmToggle');
        const regPasswordConfirm = document.getElementById('regPasswordConfirm');
        
        regConfirmToggle.addEventListener('click', () => {
            const type = regPasswordConfirm.getAttribute('type') === 'password' ? 'text' : 'password';
            regPasswordConfirm.setAttribute('type', type);
            
            // 切换图标
            regConfirmToggle.innerHTML = type === 'password' ? 
                '<<i class="iconfont icon-eye"></</i>' : 
                '<<i class="iconfont icon-eye-close"></</i>';
        });
    }

    // 清除所有错误状态
    function clearAllErrors() {
        // 清除登录表单错误
        clearError('loginAccount');
        clearError('loginPassword');
        
        // 清除注册表单错误
        clearError('regNickname');
        clearError('regAccount');
        clearError('regPassword');
        clearError('regPasswordConfirm');
        clearError('regEmail');
        clearError('regVerifyCode');
    }
	async function getAllUsers() {
	    const requestHeaders = {
	        "Authorization": `token ${GITHUB_TOKEN}`,
	        "Accept": "application/vnd.github.v3+json",
	        "User-Agent": "Mozilla/5.0"
	    };
	
	    try {
	        const res = await fetch(
	            `https://api.github.com/repos/${GITHUB_REPO}/issues/${USER_ISSUE_NUMBER}`,
	            { headers: requestHeaders, method: "GET" }
	        );
	
	        if (!res.ok) return [];
	
	        const issue = await res.json();
	        // 解析用户信息（格式：账号|密码|邮箱|用户名|是否为管理员|头像链接|个性签名）
	        const userLines = issue.body.split('\n').filter(line => line.includes('|'));
	        const users = [];
	        
	        userLines.forEach(line => {
	            // 拆分字段，支持7个字段
	            const parts = line.split('|');
	            if (parts[0] && parts[1]) {
	                users.push({
	                    account: parts[0].trim(),
	                    password: parts[1].trim(),
	                    email: parts[2] ? parts[2].trim() : '',
	                    nickname: parts[3] ? parts[3].trim() : parts[0].trim(),
	                    isAdmin: parts[4] ? parts[4].trim().toLowerCase() === 'true' : false,
	                    avatar: parts[5] ? parts[5].trim() : DEFAULT_AVATAR,
	                    bio: parts[6] ? parts[6].trim() : '',
	                    createTime: new Date().toISOString()
	                });
	            }
	        });
	        return users;
	    } catch (err) {
	        console.error('读取用户信息失败：', err);
	        // 本地缓存容错
	        const localUsers = localStorage.getItem('temp_users');
	        return localUsers ? JSON.parse(localUsers) : [];
	    }
	}

    // 将新用户保存到GitHub Issue（支持完整字段）
    async function saveUserToIssue(newUser) {
        const requestHeaders = {
            "Authorization": `token ${GITHUB_TOKEN}`,
            "Accept": "application/vnd.github.v3+json",
            "User-Agent": "Mozilla/5.0"
        };
    
        try {
            // 先读取现有用户
            const users = await getAllUsers();
            users.push(newUser);
    
            // 拼接Issue内容（支持7个字段）
            let body = "网站用户信息列表（请勿手动修改）\n";
            users.forEach(user => {
                body += `${user.account}|${user.password}|${user.email}|${user.nickname}|${user.isAdmin || false}|${user.avatar || DEFAULT_AVATAR}|${user.bio || ''}\n`;
            });
    
            // 更新Issue
            const res = await fetch(
                `https://api.github.com/repos/${GITHUB_REPO}/issues/${USER_ISSUE_NUMBER}`,
                {
                    headers: requestHeaders,
                    method: "PATCH",
                    body: JSON.stringify({
                        title: "网站用户信息存储",
                        body: body.trim()
                    })
                }
            );
    
            if (res.ok) {
                // 缓存到本地
                localStorage.setItem('temp_users', JSON.stringify(users));
                return true;
            }
            return false;
        } catch (err) {
            console.error('保存用户信息失败：', err);
            return false;
        }
    }

    // ========== 修改：注册表单验证（新增验证码验证） ==========
    function validateRegisterForm() {
        const nickname = document.getElementById('regNickname').value.trim();
        const account = document.getElementById('regAccount').value.trim();
        const password = document.getElementById('regPassword').value.trim();
        const pwdConfirm = document.getElementById('regPasswordConfirm').value.trim();
        const email = document.getElementById('regEmail').value.trim();
        const verifyCode = document.getElementById('regVerifyCode').value.trim();
        
        let isValid = true;
        
        // 验证用户名
        if (!nickname) {
            showError('regNickname', '用户名不能为空');
            isValid = false;
        } else if (nickname.length < 2) {
            showError('regNickname', '用户名至少2个字符');
            isValid = false;
        } else {
            showSuccess('regNickname');
        }
        
        // 验证账号
        if (!account) {
            showError('regAccount', '账号不能为空');
            isValid = false;
        } else if (!/^[a-zA-Z0-9]+$/.test(account)) {
            showError('regAccount', '账号只能包含字母和数字');
            isValid = false;
        } else if (account.length < 4) {
            showError('regAccount', '账号至少4个字符');
            isValid = false;
        } else {
            showSuccess('regAccount');
        }
        
        // 验证密码
        if (!password) {
            showError('regPassword', '密码不能为空');
            isValid = false;
        } else if (password.length < 6) {
            showError('regPassword', '密码长度不少于6位');
            isValid = false;
        } else {
            showSuccess('regPassword');
        }
        
        // 验证确认密码
        if (!pwdConfirm) {
            showError('regPasswordConfirm', '请再次输入密码');
            isValid = false;
        } else if (password !== pwdConfirm) {
            showError('regPasswordConfirm', '两次密码输入不一致');
            isValid = false;
        } else {
            showSuccess('regPasswordConfirm');
        }
        
        // 验证QQ邮箱
        if (!email) {
            showError('regEmail', 'QQ邮箱不能为空');
            isValid = false;
        } else if (!validateEmail(email)) {
            showError('regEmail', '请输入有效的QQ邮箱');
            isValid = false;
        } else {
            showSuccess('regEmail');
        }
        
        // 验证验证码
        if (!verifyCode) {
            showError('regVerifyCode', '验证码不能为空');
            isValid = false;
        } else {
            const codeDataStr = sessionStorage.getItem(`verifyCode_${email}`);
            if (!codeDataStr) {
                showError('regVerifyCode', '请先获取验证码');
                isValid = false;
            } else {
                const codeData = JSON.parse(codeDataStr);
                if (Date.now() > codeData.expireTime) {
                    showError('regVerifyCode', '验证码已过期，请重新获取');
                    isValid = false;
                } else if (codeData.code !== verifyCode) {
                    showError('regVerifyCode', '验证码输入错误');
                    isValid = false;
                } else {
                    showSuccess('regVerifyCode');
                }
            }
        }
        
        return isValid;
    }

    // 检查账号、邮箱、用户名是否重复
    async function checkDuplicate(account, email, nickname) {
        const users = await getAllUsers();
        let duplicate = '';
        
        if (users.some(u => u.account === account)) {
            duplicate = '账号';
        } else if (users.some(u => u.email === email)) {
            duplicate = '邮箱';
        } else if (users.some(u => u.nickname === nickname)) {
            duplicate = '用户名';
        }
        
        return duplicate;
    }

    // 注册逻辑（支持完整字段）
    async function handleRegister() {
        // 表单验证
        if (!validateRegisterForm()) {
            return;
        }
        
        const nickname = document.getElementById('regNickname').value.trim();
        const account = document.getElementById('regAccount').value.trim();
        const password = document.getElementById('regPassword').value.trim();
        const email = document.getElementById('regEmail').value.trim();
        
        // 显示加载动画
        showLoading('注册');
        
        try {
            // 检查重复
            const duplicate = await checkDuplicate(account, email, nickname);
            if (duplicate) {
                hideLoading();
                showAlert(`该${duplicate}已被注册！`, 'error');
                
                // 高亮显示重复的字段
                if (duplicate === '账号') {
                    showError('regAccount', '该账号已被注册');
                } else if (duplicate === '邮箱') {
                    showError('regEmail', '该邮箱已被注册');
                } else if (duplicate === '用户名') {
                    showError('regNickname', '该用户名已被注册');
                }
                
                return;
            }
            
            // 加密密码并保存（支持完整字段）
            const encryptPwd = md5(password);
            const newUser = {
                account: account,
                password: encryptPwd,
                email: email,
                nickname: nickname,
                isAdmin: false, // 注册用户默认不是管理员
                avatar: DEFAULT_AVATAR, // 默认头像
                bio: '', // 默认空简介
                createTime: new Date().toISOString() // 创建时间
            };
    
            const success = await saveUserToIssue(newUser);
            
            hideLoading();
            
            if (success) {
                showAlert('注册成功！请登录', 'success');
                // 切换到登录表单并清空注册内容
                document.querySelectorAll('.auth-tab')[0].click();
                document.getElementById('regNickname').value = '';
                document.getElementById('regAccount').value = '';
                document.getElementById('regPassword').value = '';
                document.getElementById('regPasswordConfirm').value = '';
                document.getElementById('regEmail').value = '';
                document.getElementById('regVerifyCode').value = '';
                
                // 清除所有错误状态
                clearAllErrors();
                
                // 清除验证码倒计时
                if (countdownTimer) {
                    clearInterval(countdownTimer);
                    countdownTimer = null;
                }
                document.getElementById('sendCodeBtn').disabled = false;
                document.getElementById('sendCodeBtn').textContent = '发送验证码';
            } else {
                showAlert('注册失败，请稍后重试！', 'error');
            }
        } catch (error) {
            hideLoading();
            console.error('注册过程出错：', error);
            showAlert('注册过程出错，请检查网络连接后重试！', 'error');
        }
    }

    async function handleLogin() {
        const account = document.getElementById('loginAccount').value.trim();
        const password = document.getElementById('loginPassword').value.trim();
    
        if (!account) {
            showError('loginAccount', '账号不能为空');
            return;
        } else {
            clearError('loginAccount');
        }
        
        if (!password) {
            showError('loginPassword', '密码不能为空');
            return;
        } else {
            clearError('loginPassword');
        }
    
        // 显示加载动画
        showLoading('登录');
        
        try {
            // 验证账号密码
            const users = await getAllUsers();
            const encryptPwd = md5(password);
            const user = users.find(u => u.account === account && u.password === encryptPwd);
    
            hideLoading();
            
            if (user) {
                // 登录成功：保存完整的用户信息到本地存储
                const userInfo = {
                    account: user.account,
                    password: user.password,
                    email: user.email || '',
                    nickname: user.nickname || account,
                    isAdmin: user.isAdmin || false,
                    avatar: user.avatar || DEFAULT_AVATAR,
                    bio: user.bio || '',
                    createTime: user.createTime || new Date().toISOString(),
                    lastLoginTime: new Date().toISOString()
                };
                localStorage.setItem(USER_LOCAL_KEY, JSON.stringify(userInfo));
                
                // 显示成功消息
                showAlert('登录成功！即将跳转到首页', 'success');
                
                // 登录成功后带开合动画跳转
                setTimeout(() => {
                    if (isAnimating) return;
                    isAnimating = true;
                    
                    const loader = document.getElementById('loader');
                    loader.classList.remove('loaded');
                    document.body.style.overflow = 'hidden';
                    
                    // 延迟跳转，匹配动画时长
                    setTimeout(() => {
                        window.location.href = '../index.html';
                        isAnimating = false;
                    }, 600);
                    
                    // 兜底重置动画状态
                    setTimeout(() => {
                        isAnimating = false;
                    }, 1000);
                }, 1000);
            } else {
                showAlert('账号或密码错误！', 'error');
            }
        } catch (error) {
            hideLoading();
            console.error('登录过程出错：', error);
            showAlert('登录过程出错，请检查网络连接后重试！', 'error');
        }
    }

    // 实时验证注册表单
    function initFormValidation() {
        // 用户名验证
        document.getElementById('regNickname').addEventListener('input', function() {
            const nickname = this.value.trim();
            if (!nickname) {
                showError('regNickname', '用户名不能为空');
            } else if (nickname.length < 2) {
                showError('regNickname', '用户名至少2个字符');
            } else {
                showSuccess('regNickname');
            }
        });
        
        // 账号验证
        document.getElementById('regAccount').addEventListener('input', function() {
            const account = this.value.trim();
            if (!account) {
                showError('regAccount', '账号不能为空');
            } else if (!/^[a-zA-Z0-9]+$/.test(account)) {
                showError('regAccount', '账号只能包含字母和数字');
            } else if (account.length < 4) {
                showError('regAccount', '账号至少4个字符');
            } else {
                showSuccess('regAccount');
            }
        });
        
        // 密码验证
        document.getElementById('regPassword').addEventListener('input', function() {
            const password = this.value.trim();
            const confirmPassword = document.getElementById('regPasswordConfirm').value.trim();
            
            if (!password) {
                showError('regPassword', '密码不能为空');
            } else if (password.length < 6) {
                showError('regPassword', '密码长度不少于6位');
            } else {
                showSuccess('regPassword');
            }
            
            // 如果确认密码已输入，验证是否匹配
            if (confirmPassword && password !== confirmPassword) {
                showError('regPasswordConfirm', '两次密码输入不一致');
            } else if (confirmPassword) {
                showSuccess('regPasswordConfirm');
            }
        });
        
        // 确认密码验证
        document.getElementById('regPasswordConfirm').addEventListener('input', function() {
            const confirmPassword = this.value.trim();
            const password = document.getElementById('regPassword').value.trim();
            
            if (!confirmPassword) {
                showError('regPasswordConfirm', '请再次输入密码');
            } else if (password !== confirmPassword) {
                showError('regPasswordConfirm', '两次密码输入不一致');
            } else {
                showSuccess('regPasswordConfirm');
            }
        });
        
        // QQ邮箱验证
        document.getElementById('regEmail').addEventListener('input', function() {
            const email = this.value.trim();
            if (!email) {
                showError('regEmail', 'QQ邮箱不能为空');
            } else if (!validateEmail(email)) {
                showError('regEmail', '请输入有效的QQ邮箱');
            } else {
                showSuccess('regEmail');
            }
        });
        
        // 验证码验证
        document.getElementById('regVerifyCode').addEventListener('input', function() {
            const code = this.value.trim();
            const email = document.getElementById('regEmail').value.trim();
            
            if (code && email) {
                const codeDataStr = sessionStorage.getItem(`verifyCode_${email}`);
                if (codeDataStr) {
                    const codeData = JSON.parse(codeDataStr);
                    if (codeData.code !== code) {
                        showError('regVerifyCode', '验证码输入错误');
                    } else {
                        showSuccess('regVerifyCode');
                    }
                }
            } else if (code) {
                clearError('regVerifyCode');
            }
        });
    }

    // ========== 修改：初始化事件绑定（新增发送验证码按钮） ==========
    function initEvents() {
        // 返回按钮带开合动画跳转
        document.getElementById('backBtn').addEventListener('click', () => {
            if (isAnimating) return;
            isAnimating = true;
            
            const loader = document.getElementById('loader');
            loader.classList.remove('loaded');
            document.body.style.overflow = 'hidden';
            
            setTimeout(() => {
                window.location.href = '../index.html';
                isAnimating = false;
            }, 600);
            
            setTimeout(() => isAnimating = false, 1000);
        });
        
        // 登录按钮
        document.getElementById('loginBtn').addEventListener('click', handleLogin);
        // 注册按钮
        document.getElementById('registerBtn').addEventListener('click', handleRegister);
        // 发送验证码按钮（新增）
        document.getElementById('sendCodeBtn').addEventListener('click', sendVerifyCode);
        
        // 回车提交表单
        document.getElementById('loginForm').addEventListener('keyup', e => {
            if (e.key === 'Enter') handleLogin();
        });
        document.getElementById('registerForm').addEventListener('keyup', e => {
            if (e.key === 'Enter') handleRegister();
        });
    }
function initPage () {initTabs ();initPasswordToggles ();initFormValidation ();initEvents ();
document.getElementById ('loader').classList.add ('loaded');
const savedUser = localStorage.getItem (USER_LOCAL_KEY);if (savedUser) {try {const userInfo = JSON.parse (savedUser);document.getElementById ('loginAccount').value = userInfo.account;} catch (e) {}}}
document.addEventListener ('DOMContentLoaded', initPage);</script>
</body>
