<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>个人资料 - Mg搜索</title>
<style>
:root {
  --forest: #3D6B4F;
  --forest-dark: #2D4F3A;
  --peach: #E07A5F;
  --peach-light: #F4A261;
  --cream: #F2E8CF;
  --soft-gold: #E9C46A;
  --glass-bg: rgba(255, 253, 245, 0.78);
  --glass-border: rgba(255, 255, 255, 0.5);
  --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.12);
  --text-primary: #2D4F3A;
  --text-secondary: #5A7D6C;
  --ease-smooth: cubic-bezier(0.25, 0.46, 0.45, 0.94);
  --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
  --radius: 32px;
  --radius-lg: 48px;
  --radius-sm: 20px;
  --bg-color: #f5f3f0;
}

* { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "PingFang SC", "Helvetica Neue", sans-serif; -webkit-tap-highlight-color: transparent; -webkit-font-smoothing: antialiased; }

html, body {
  height: 100%;
  min-height: 100vh;
  background-color: var(--bg-color);
  color: var(--text-primary);
  overflow-x: hidden;
}

.chinese-bg-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: -1;
  background-image: url('https://img.wjwj.top/2026/01/28/6b1f3899b3a7eefb30f601d3003d76bf.png');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  background-attachment: fixed;
}

.liquid-glass {
  background: linear-gradient(135deg, rgba(255, 253, 245, 0.85) 0%, rgba(255, 251, 240, 0.6) 100%);
  backdrop-filter: blur(20px) saturate(200%) contrast(1.1);
  -webkit-backdrop-filter: blur(20px) saturate(200%) contrast(1.1);
  border: 1px solid rgba(255, 255, 255, 0.6);
  box-shadow: 
    0 8px 32px rgba(45, 79, 58, 0.12),
    inset 0 1px 0 rgba(255, 255, 255, 0.9),
    inset 0 -1px 0 rgba(255, 255, 255, 0.3);
  border-radius: var(--radius);
  position: relative;
  overflow: hidden;
}

.liquid-glass::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: linear-gradient(180deg, 
    rgba(255, 255, 255, 0.4) 0%, 
    transparent 40%, 
    transparent 60%, 
    rgba(242, 232, 207, 0.3) 100%);
  pointer-events: none;
  border-radius: var(--radius);
}

body {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 20px;
  position: relative;
}

.back-link {
  position: absolute;
  top: 40px;
  left: 40px;
  display: flex;
  align-items: center;
  gap: 8px;
  text-decoration: none;
  color: var(--text-secondary);
  font-weight: 600;
  font-size: 14px;
  padding: 12px 24px;
  background: rgba(255, 253, 245, 0.6);
  border-radius: var(--radius-sm);
  transition: all 0.3s var(--ease-spring);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.5);
  z-index: 10;
}

.back-link:hover {
  background: rgba(255, 255, 255, 0.9);
  transform: translateX(-4px);
  color: var(--forest);
  box-shadow: 0 4px 15px rgba(45, 79, 58, 0.1);
}

.profile-container {
  width: 100%;
  max-width: 480px;
  padding: 40px;
  animation: slideUp 0.6s var(--ease-spring);
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.profile-header {
  text-align: center;
  margin-bottom: 32px;
}

.profile-title {
  font-size: 28px;
  font-weight: 800;
  color: var(--forest-dark);
  margin-bottom: 8px;
  font-family: "PingFang SC", sans-serif;
}

.profile-subtitle {
  color: var(--text-secondary);
  font-size: 14px;
  font-weight: 500;
}

.avatar-section {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 32px;
}

.avatar-preview {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 36px;
  font-weight: 700;
  color: var(--forest);
  margin-bottom: 16px;
  border: 4px solid rgba(255, 255, 255, 0.8);
  box-shadow: 0 8px 25px rgba(45, 79, 58, 0.15);
  background-size: cover;
  background-position: center;
  transition: transform 0.4s var(--ease-spring);
}

.avatar-preview:hover {
  transform: scale(1.05);
}

.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  font-size: 13px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 8px;
  margin-left: 4px;
  font-family: "PingFang SC", sans-serif;
}

.form-input {
  width: 100%;
  padding: 16px 20px;
  border-radius: var(--radius-sm);
  border: 1px solid rgba(255, 255, 255, 0.6);
  background: rgba(255, 253, 245, 0.6);
  font-size: 15px;
  color: var(--text-primary);
  outline: none;
  transition: all 0.3s var(--ease-smooth);
  font-weight: 500;
  font-family: "PingFang SC", sans-serif;
}

.form-input:focus {
  background: rgba(255, 255, 255, 0.95);
  border-color: rgba(224, 122, 95, 0.3);
  box-shadow: 0 4px 16px rgba(45, 79, 58, 0.08), 0 0 0 4px rgba(224, 122, 95, 0.05);
  transform: translateY(-2px);
}

.form-input::placeholder {
  color: var(--text-secondary);
  opacity: 0.6;
}

.form-actions {
  display: flex;
  gap: 12px;
  margin-top: 32px;
}

.btn {
  flex: 1;
  padding: 16px;
  border-radius: var(--radius-sm);
  font-weight: 700;
  font-size: 15px;
  cursor: pointer;
  border: none;
  transition: all 0.3s var(--ease-spring);
  font-family: "PingFang SC", sans-serif;
}

.btn-secondary {
  background: rgba(255, 253, 245, 0.8);
  color: var(--text-secondary);
  box-shadow: 0 2px 8px rgba(45, 79, 58, 0.06);
  border: 1px solid rgba(255, 255, 255, 0.6);
}

.btn-secondary:hover {
  background: rgba(255, 255, 255, 0.95);
  transform: translateY(-2px);
  color: var(--text-primary);
  box-shadow: 0 4px 12px rgba(45, 79, 58, 0.1);
}

.btn-primary {
  background: var(--forest);
  color: white;
  box-shadow: 0 4px 15px rgba(45, 79, 58, 0.25);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(45, 79, 58, 0.35);
  background: var(--forest-dark);
}

.btn:disabled {
  opacity: 0.7;
  cursor: not-allowed;
  transform: none;
}

.custom-alert {
  position: fixed;
  top: 30px;
  left: 50%;
  transform: translateX(-50%) translateY(-100px);
  background: rgba(255, 253, 245, 0.95);
  backdrop-filter: blur(20px) saturate(180%);
  padding: 16px 32px;
  border-radius: 50px;
  box-shadow: 0 10px 40px rgba(45, 79, 58, 0.15);
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 600;
  font-size: 14px;
  color: var(--text-primary);
  z-index: 10000;
  opacity: 0;
  transition: all 0.5s var(--ease-spring);
  border: 1px solid rgba(255, 255, 255, 0.6);
  font-family: "PingFang SC", sans-serif;
}

.custom-alert.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
}

.custom-alert.error { color: #E07A5F; }
.custom-alert.success { color: #3D6B4F; }

@media (max-width: 768px) {
  .profile-container { width: 90%; padding: 24px; border-radius: var(--radius-sm); }
  .back-link { top: 20px; left: 20px; padding: 10px 16px; }
  .profile-title { font-size: 24px; }
}

.loading-dots:after {
  content: ' .';
  animation: dots 1s steps(5, end) infinite;
}

@keyframes dots {
  0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);}
  40% { color: white; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);}
  60% { text-shadow: .25em 0 0 white, .5em 0 0 rgba(0,0,0,0);}
  80%, 100% { text-shadow: .25em 0 0 white, .5em 0 0 white;}
}
</style>
</head>
<body>

<div class="chinese-bg-container"></div>

<a href="search.html" class="back-link liquid-glass">
  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
  返回
</a>

<div class="profile-container liquid-glass">
  <div class="profile-header">
    <h1 class="profile-title">编辑资料</h1>
    <p class="profile-subtitle">更新您的个人信息</p>
  </div>
   
  <form id="profileForm">
    <div class="avatar-section">
      <div class="avatar-preview" id="avatarPreview">U</div>
    </div>
    
    <div class="form-group">
      <label class="form-label">用户名</label>
      <input type="text" id="username" class="form-input" placeholder="输入用户名" required>
    </div>
    
    <div class="form-group">
      <label class="form-label">头像链接</label>
      <input type="text" id="avatar" class="form-input" placeholder="https://example.com/image.png">
    </div>
    
    <div class="form-group">
      <label class="form-label">个性签名</label>
      <input type="text" id="signature" class="form-input" placeholder="您的个性签名">
    </div>
    
    <div class="form-actions">
      <button type="button" class="btn btn-secondary" id="cancelBtn">取消</button>
      <button type="submit" class="btn btn-primary" id="saveBtn">保存更改</button>
    </div>
  </form>
</div>

<div class="custom-alert" id="customAlert"></div>

<script>
const USER_LOCAL_KEY = 'MOGU_CHAT_USER';
const GITHUB_TOKEN = ["gh","p_p","VXlo0HQ","PmMx","Ic","eM","HB","uMzm","EON","LPX","700","10","M","SL"].join('');
const USER_DATABASE_REPO_OWNER = 'moguwan';
const USER_DATABASE_REPO_NAME = 'moguwan.github.io';
const USER_DATABASE_ISSUE_NUMBER = 11;
const DEFAULT_AVATAR = "https://img.wjwj.top/2026/01/26/30abddc90230cef0bc9896ca3eafd0d3.gif";

const customAlert = document.getElementById('customAlert');
let alertTimer = null;
let currentUser = null;

async function getUserDatabaseFromGitHub() {
  try {
    const response = await fetch(`https://api.github.com/repos/${USER_DATABASE_REPO_OWNER}/${USER_DATABASE_REPO_NAME}/issues/${USER_DATABASE_ISSUE_NUMBER}`, {
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json' }
    });
    if (!response.ok) return [];
    const issueData = await response.json();
    const lines = (issueData.body || '').split('\n').filter(line => line.trim() !== '');
    const users = [];
    for (const line of lines) {
      const parts = line.split('|').map(p => p.trim());
      if (parts.length >= 2) {
        users.push({
          account: parts[0],
          password: parts[1],
          email: parts[2] || '',
          nickname: parts[3] || parts[0],
          isAdmin: parts[4] ? parts[4].toLowerCase() === 'true' : false,
          avatar: parts[5] && parts[5] !== '无' ? parts[5] : DEFAULT_AVATAR,
          signature: parts[6] ? parts[6] : '人生格言思密达'
        });
      }
    }
    return users;
  } catch { return []; }
}

async function updateUserDatabaseInGitHub(users) {
  try {
    const userLines = users.map(user => 
      `${user.account}|${user.password}|${user.email}|${user.nickname}|${user.isAdmin}|${user.avatar && user.avatar !== DEFAULT_AVATAR ? user.avatar : '无'}|${user.signature || '人生格言思密达'}`
    ).join('\n');
    const response = await fetch(`https://api.github.com/repos/${USER_DATABASE_REPO_OWNER}/${USER_DATABASE_REPO_NAME}/issues/${USER_DATABASE_ISSUE_NUMBER}`, {
      method: 'PATCH',
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
      body: JSON.stringify({ body: userLines })
    });
    return response.ok;
  } catch { return false; }
}

async function getCompleteUserInfoFromGitHub(account) {
  try {
    const users = await getUserDatabaseFromGitHub();
    return users.find(u => u.account === account) || null;
  } catch { return null; }
}

async function updateCurrentUserInGitHub() {
  if (!currentUser || !currentUser.account) return false;
  try {
    const users = await getUserDatabaseFromGitHub();
    const userIndex = users.findIndex(u => u.account === currentUser.account);
    if (userIndex === -1) return false;
    users[userIndex].nickname = currentUser.nickname || currentUser.account;
    users[userIndex].avatar = currentUser.avatar || '';
    users[userIndex].signature = currentUser.signature || '';
    return await updateUserDatabaseInGitHub(users);
  } catch { return false; }
}

async function checkLoginStatus() {
  const userData = localStorage.getItem(USER_LOCAL_KEY);
  if (userData) {
    try {
      currentUser = JSON.parse(userData);
      const completeUserInfo = await getCompleteUserInfoFromGitHub(currentUser.account);
      if (completeUserInfo) {
        currentUser.nickname = completeUserInfo.nickname;
        currentUser.email = completeUserInfo.email;
        currentUser.avatar = completeUserInfo.avatar;
        currentUser.signature = completeUserInfo.signature;
        currentUser.isAdmin = completeUserInfo.isAdmin;
        localStorage.setItem(USER_LOCAL_KEY, JSON.stringify(currentUser));
      }
      return true;
    } catch {
      showCustomAlert('会话错误，请重新登录', 'error');
      setTimeout(() => window.location.href = 'auth.html', 1500);
      return false;
    }
  } else {
    showCustomAlert('请先登录', 'error');
    setTimeout(() => window.location.href = 'auth.html', 1500);
    return false;
  }
}

function loadUserData() {
  if (!currentUser) return;
  document.getElementById('username').value = currentUser.nickname || currentUser.account || '';
  document.getElementById('avatar').value = currentUser.avatar === DEFAULT_AVATAR ? '' : (currentUser.avatar || '');
  document.getElementById('signature').value = currentUser.signature || '';
  updateAvatarPreview();
}

function updateAvatarPreview() {
  const preview = document.getElementById('avatarPreview');
  const url = document.getElementById('avatar').value.trim();
  const username = document.getElementById('username').value.trim() || currentUser.account;
  
  if (url) {
    preview.style.backgroundImage = `url('${url}')`;
    preview.textContent = '';
    preview.style.border = '4px solid rgba(255,255,255,0.8)';
  } else if (currentUser && currentUser.avatar) {
    preview.style.backgroundImage = `url('${currentUser.avatar}')`;
    preview.textContent = '';
    preview.style.border = '4px solid rgba(255,255,255,0.8)';
  } else {
    preview.style.backgroundImage = '';
    preview.textContent = username ? username.charAt(0).toUpperCase() : 'U';
    preview.style.border = '4px solid rgba(255,255,255,0.8)';
  }
}

function showCustomAlert(message, type = 'error') {
  customAlert.textContent = message;
  customAlert.className = `custom-alert ${type}`;
  customAlert.classList.add('show');
  if (alertTimer) clearTimeout(alertTimer);
  alertTimer = setTimeout(() => customAlert.classList.remove('show'), 3000);
}

function validateAvatarUrl(url) {
  if (!url.trim()) return true;
  try {
    const urlObj = new URL(url);
    return true;
  } catch {
    showCustomAlert('链接格式无效', 'error');
    return false;
  }
}

async function saveUserData(e) {
  e.preventDefault();
  if (!currentUser) return;
  
  const username = document.getElementById('username').value.trim();
  const avatarUrl = document.getElementById('avatar').value.trim();
  const signature = document.getElementById('signature').value.trim();
  
  if (!username) { showCustomAlert('用户名不能为空', 'error'); return; }
  if (!validateAvatarUrl(avatarUrl)) return;
  
  const saveBtn = document.getElementById('saveBtn');
  const originalText = saveBtn.textContent;
  saveBtn.innerHTML = '保存中<span class="loading-dots"></span>';
  saveBtn.disabled = true;
  
  currentUser.nickname = username;
  currentUser.avatar = avatarUrl || DEFAULT_AVATAR;
  currentUser.signature = signature || '人生格言思密达';
  
  try {
    const success = await updateCurrentUserInGitHub();
    if (!success) throw new Error('Failed to update');
    localStorage.setItem(USER_LOCAL_KEY, JSON.stringify(currentUser));
    showCustomAlert('资料更新成功！', 'success');
    setTimeout(() => window.location.href = 'search.html', 1500);
  } catch {
    showCustomAlert('网络错误，请重试', 'error');
    saveBtn.textContent = originalText;
    saveBtn.disabled = false;
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  if (await checkLoginStatus()) loadUserData();
  document.getElementById('avatar').addEventListener('input', updateAvatarPreview);
  document.getElementById('username').addEventListener('input', () => {
    if (!document.getElementById('avatar').value.trim()) updateAvatarPreview();
  });
  document.getElementById('profileForm').addEventListener('submit', saveUserData);
  document.getElementById('cancelBtn').addEventListener('click', () => window.location.href = 'search.html');
});
</script>
</body>
</html>
