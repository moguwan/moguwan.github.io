<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Profile Settings</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* CSS Styles kept same as provided */
:root {
  --primary: #6366f1;
  --primary-hover: #4f46e5;
  --bg-color: #f8fafc;
  --glass-bg: rgba(255, 255, 255, 0.75);
  --glass-border: rgba(255, 255, 255, 0.8);
  --glass-shadow: 0 10px 40px -10px rgba(0,0,0,0.05);
  --text-main: #1e293b;
  --text-sub: #64748b;
  --ease-spring: cubic-bezier(0.25, 0.8, 0.25, 1);
  --danger: #ef4444;
  --success: #10b981;
}
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif; -webkit-font-smoothing: antialiased; }
body { min-height: 100vh; display: flex; justify-content: center; align-items: center; background-color: var(--bg-color); color: var(--text-main); position: relative; overflow: hidden; }
.ambient-bg { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1; overflow: hidden; background: radial-gradient(circle at 0% 0%, #e0e7ff 0%, transparent 50%), radial-gradient(circle at 100% 100%, #f3e8ff 0%, transparent 50%); }
.orb { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.6; animation: floatOrb 20s infinite ease-in-out; }
.orb-1 { width: 400px; height: 400px; background: #818cf8; top: -100px; left: -100px; animation-delay: 0s; }
.orb-2 { width: 300px; height: 300px; background: #c084fc; bottom: 10%; right: -50px; animation-delay: -5s; }
@keyframes floatOrb { 0%, 100% { transform: translate(0, 0) scale(1); } 33% { transform: translate(30px, 50px) scale(1.1); } 66% { transform: translate(-20px, 20px) scale(0.9); } }
.back-link { position: absolute; top: 40px; left: 40px; display: flex; align-items: center; gap: 8px; text-decoration: none; color: var(--text-sub); font-weight: 600; font-size: 14px; padding: 10px 20px; background: rgba(255,255,255,0.6); border-radius: 16px; transition: all 0.3s var(--ease-spring); backdrop-filter: blur(10px); }
.back-link:hover { background: white; transform: translateX(-4px); color: var(--primary); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
.profile-container { width: 100%; max-width: 480px; background: var(--glass-bg); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid var(--glass-border); border-radius: 24px; padding: 40px; box-shadow: var(--glass-shadow); transform: translateY(0); animation: slideUp 0.6s var(--ease-spring); }
@keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
.profile-header { text-align: center; margin-bottom: 32px; }
.profile-title { font-size: 28px; font-weight: 800; background: linear-gradient(135deg, #4f46e5 0%, #9333ea 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px; }
.profile-subtitle { color: var(--text-sub); font-size: 14px; }
.avatar-section { display: flex; flex-direction: column; align-items: center; margin-bottom: 32px; }
.avatar-preview { width: 100px; height: 100px; border-radius: 50%; background: linear-gradient(135deg, #e2e8f0, #f1f5f9); display: flex; align-items: center; justify-content: center; font-size: 36px; font-weight: 700; color: #94a3b8; margin-bottom: 16px; border: 4px solid white; box-shadow: 0 8px 25px rgba(0,0,0,0.08); background-size: cover; background-position: center; transition: transform 0.4s var(--ease-spring); }
.avatar-preview:hover { transform: scale(1.05); }
.form-group { margin-bottom: 20px; }
.form-label { display: block; font-size: 13px; font-weight: 700; color: var(--text-main); margin-bottom: 8px; margin-left: 4px; }
.form-input { width: 100%; padding: 14px 18px; border-radius: 16px; border: 1px solid transparent; background: rgba(255,255,255,0.6); font-size: 14px; color: var(--text-main); outline: none; transition: all 0.3s; font-weight: 500; }
.form-input:focus { background: white; border-color: #e2e8f0; box-shadow: 0 4px 12px rgba(0,0,0,0.03); transform: translateY(-1px); }
.form-input::placeholder { color: #94a3b8; }
.form-actions { display: flex; gap: 12px; margin-top: 32px; }
.btn { flex: 1; padding: 14px; border-radius: 16px; font-weight: 600; font-size: 14px; cursor: pointer; border: none; transition: all 0.3s var(--ease-spring); }
.btn-secondary { background: white; color: var(--text-sub); box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
.btn-secondary:hover { background: #f8fafc; transform: translateY(-2px); color: var(--text-main); }
.btn-primary { background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4); }
.btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
.custom-alert { position: fixed; top: 30px; left: 50%; transform: translateX(-50%) translateY(-100px); background: white; padding: 12px 24px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px; font-weight: 600; font-size: 14px; color: var(--text-main); z-index: 10000; opacity: 0; transition: all 0.5s var(--ease-spring); }
.custom-alert.show { transform: translateX(-50%) translateY(0); opacity: 1; }
.custom-alert.error { color: var(--danger); }
.custom-alert.success { color: var(--success); }
@media (max-width: 768px) { .profile-container { width: 90%; padding: 24px; } .back-link { top: 20px; left: 20px; } }
.loading-dots:after { content: ' .'; animation: dots 1s steps(5, end) infinite; }
@keyframes dots { 0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);} 40% { color: white; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);} 60% { text-shadow: .25em 0 0 white, .5em 0 0 rgba(0,0,0,0);} 80%, 100% { text-shadow: .25em 0 0 white, .5em 0 0 white;} }
</style>
</head>
<body>

<div class="ambient-bg">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
</div>

<a href="search.html" class="back-link">
  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
  Back
</a>

<div class="profile-container">
  <div class="profile-header">
    <h1 class="profile-title">Edit Profile</h1>
    <p class="profile-subtitle">Update your personal details</p>
  </div>
   
  <form id="profileForm">
    <div class="avatar-section">
      <div class="avatar-preview" id="avatarPreview">U</div>
    </div>
    
    <div class="form-group">
      <label class="form-label">Username</label>
      <input type="text" id="username" class="form-input" placeholder="Enter username" required>
    </div>
    
    <div class="form-group">
      <label class="form-label">Avatar URL</label>
      <input type="text" id="avatar" class="form-input" placeholder="https://example.com/image.png">
    </div>
    
    <div class="form-group">
      <label class="form-label">Signature</label>
      <input type="text" id="signature" class="form-input" placeholder="Your personalized signature">
    </div>
    
    <div class="form-actions">
      <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
      <button type="submit" class="btn btn-primary" id="saveBtn">Save Changes</button>
    </div>
  </form>
</div>

<div class="custom-alert" id="customAlert"></div>

<script>
const USER_LOCAL_KEY = 'MOGU_CHAT_USER';
const GITHUB_TOKEN = ["gh","p_p","VXlo0HQ","PmMx","Ic","eM","HB","uMzm","EON","LPX","700","10","M","SL"].join('');
const USER_DATABASE_REPO_OWNER = 'moguwan';
const USER_DATABASE_REPO_NAME = 'moguwan.github.io';
const USER_DATABASE_ISSUE_NUMBER = 11;
const DEFAULT_AVATAR = "https://img.wjwj.top/2026/01/26/30abddc90230cef0bc9896ca3eafd0d3.gif";

const customAlert = document.getElementById('customAlert');
let alertTimer = null;
let currentUser = null;

async function getUserDatabaseFromGitHub() {
  try {
    const response = await fetch(`https://api.github.com/repos/${USER_DATABASE_REPO_OWNER}/${USER_DATABASE_REPO_NAME}/issues/${USER_DATABASE_ISSUE_NUMBER}`, {
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json' }
    });
    if (!response.ok) return [];
    const issueData = await response.json();
    const lines = (issueData.body || '').split('\n').filter(line => line.trim() !== '');
    const users = [];
    for (const line of lines) {
      const parts = line.split('|').map(p => p.trim());
      if (parts.length >= 2) {
        users.push({
          account: parts[0],
          password: parts[1],
          email: parts[2] || '',
          nickname: parts[3] || parts[0],
          isAdmin: parts[4] ? parts[4].toLowerCase() === 'true' : false,
          avatar: parts[5] && parts[5] !== '无' ? parts[5] : DEFAULT_AVATAR,
          signature: parts[6] ? parts[6] : '人生格言思密达'
        });
      }
    }
    return users;
  } catch { return []; }
}

async function updateUserDatabaseInGitHub(users) {
  try {
    const userLines = users.map(user => 
      `${user.account}|${user.password}|${user.email}|${user.nickname}|${user.isAdmin}|${user.avatar && user.avatar !== DEFAULT_AVATAR ? user.avatar : '无'}|${user.signature || '人生格言思密达'}`
    ).join('\n');
    const response = await fetch(`https://api.github.com/repos/${USER_DATABASE_REPO_OWNER}/${USER_DATABASE_REPO_NAME}/issues/${USER_DATABASE_ISSUE_NUMBER}`, {
      method: 'PATCH',
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
      body: JSON.stringify({ body: userLines })
    });
    return response.ok;
  } catch { return false; }
}

async function getCompleteUserInfoFromGitHub(account) {
  try {
    const users = await getUserDatabaseFromGitHub();
    return users.find(u => u.account === account) || null;
  } catch { return null; }
}

async function updateCurrentUserInGitHub() {
  if (!currentUser || !currentUser.account) return false;
  try {
    const users = await getUserDatabaseFromGitHub();
    const userIndex = users.findIndex(u => u.account === currentUser.account);
    if (userIndex === -1) return false;
    users[userIndex].nickname = currentUser.nickname || currentUser.account;
    users[userIndex].avatar = currentUser.avatar || '';
    users[userIndex].signature = currentUser.signature || '';
    return await updateUserDatabaseInGitHub(users);
  } catch { return false; }
}

async function checkLoginStatus() {
  const userData = localStorage.getItem(USER_LOCAL_KEY);
  if (userData) {
    try {
      currentUser = JSON.parse(userData);
      const completeUserInfo = await getCompleteUserInfoFromGitHub(currentUser.account);
      if (completeUserInfo) {
        // 更新本地数据，确保是最新的
        currentUser.nickname = completeUserInfo.nickname;
        currentUser.email = completeUserInfo.email;
        currentUser.avatar = completeUserInfo.avatar;
        currentUser.signature = completeUserInfo.signature;
        currentUser.isAdmin = completeUserInfo.isAdmin;
        localStorage.setItem(USER_LOCAL_KEY, JSON.stringify(currentUser));
      }
      return true;
    } catch {
      showCustomAlert('Session error, please login again', 'error');
      setTimeout(() => window.location.href = 'auth.html', 1500);
      return false;
    }
  } else {
    showCustomAlert('Please login first', 'error');
    setTimeout(() => window.location.href = 'auth.html', 1500);
    return false;
  }
}

function loadUserData() {
  if (!currentUser) return;
  document.getElementById('username').value = currentUser.nickname || currentUser.account || '';
  // 如果是默认头像，输入框留空，这样用户体验更好；否则显示当前头像URL
  document.getElementById('avatar').value = currentUser.avatar === DEFAULT_AVATAR ? '' : (currentUser.avatar || '');
  document.getElementById('signature').value = currentUser.signature || '';
  updateAvatarPreview();
}

function updateAvatarPreview() {
  const preview = document.getElementById('avatarPreview');
  const url = document.getElementById('avatar').value.trim();
  const username = document.getElementById('username').value.trim() || currentUser.account;
  
  // 逻辑修改：优先显示输入框的URL，其次显示当前用户的头像（即使是默认头像），最后才显示首字母
  if (url) {
    preview.style.backgroundImage = `url('${url}')`;
    preview.textContent = '';
    preview.style.border = '4px solid white';
  } else if (currentUser && currentUser.avatar) {
    // 删除了原本的 && currentUser.avatar !== DEFAULT_AVATAR 判断
    preview.style.backgroundImage = `url('${currentUser.avatar}')`;
    preview.textContent = '';
    preview.style.border = '4px solid white';
  } else {
    preview.style.backgroundImage = '';
    preview.textContent = username ? username.charAt(0).toUpperCase() : 'U';
    preview.style.border = '4px solid white';
  }
}

function showCustomAlert(message, type = 'error') {
  customAlert.textContent = message;
  customAlert.className = `custom-alert ${type}`;
  customAlert.classList.add('show');
  if (alertTimer) clearTimeout(alertTimer);
  alertTimer = setTimeout(() => customAlert.classList.remove('show'), 3000);
}

function validateAvatarUrl(url) {
  if (!url.trim()) return true;
  try {
    const urlObj = new URL(url);
    return true;
  } catch {
    showCustomAlert('Invalid URL format', 'error');
    return false;
  }
}

async function saveUserData(e) {
  e.preventDefault();
  if (!currentUser) return;
  
  const username = document.getElementById('username').value.trim();
  const avatarUrl = document.getElementById('avatar').value.trim();
  const signature = document.getElementById('signature').value.trim();
  
  if (!username) { showCustomAlert('Username cannot be empty', 'error'); return; }
  if (!validateAvatarUrl(avatarUrl)) return;
  
  const saveBtn = document.getElementById('saveBtn');
  const originalText = saveBtn.textContent;
  saveBtn.innerHTML = 'Saving<span class="loading-dots"></span>';
  saveBtn.disabled = true;
  
  currentUser.nickname = username;
  // 如果输入框为空，则使用默认头像；如果有值，则使用输入的值
  currentUser.avatar = avatarUrl || DEFAULT_AVATAR;
  currentUser.signature = signature || '人生格言思密达';
  
  try {
    const success = await updateCurrentUserInGitHub();
    if (!success) throw new Error('Failed to update');
    localStorage.setItem(USER_LOCAL_KEY, JSON.stringify(currentUser));
    showCustomAlert('Profile updated successfully!', 'success');
    // 稍微延迟跳转，让用户看到成功的提示
    setTimeout(() => window.location.href = 'search.html', 1500);
  } catch {
    showCustomAlert('Network error, please try again', 'error');
    saveBtn.textContent = originalText;
    saveBtn.disabled = false;
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  if (await checkLoginStatus()) loadUserData();
  document.getElementById('avatar').addEventListener('input', updateAvatarPreview);
  document.getElementById('username').addEventListener('input', () => {
    if (!document.getElementById('avatar').value.trim()) updateAvatarPreview();
  });
  document.getElementById('profileForm').addEventListener('submit', saveUserData);
  document.getElementById('cancelBtn').addEventListener('click', () => window.location.href = 'search.html');
});
</script>
</body>
</html>