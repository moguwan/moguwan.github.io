<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login - Mogu Search</title>
<style>
:root {
  --forest: #3D6B4F;
  --forest-dark: #2D4F3A;
  --peach: #E07A5F;
  --peach-light: #F4A261;
  --cream: #F2E8CF;
  --soft-gold: #E9C46A;
  --glass-bg: rgba(255, 253, 245, 0.78);
  --glass-border: rgba(255, 255, 255, 0.5);
  --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.12);
  --text-primary: #2D4F3A;
  --text-secondary: #5A7D6C;
  --ease-smooth: cubic-bezier(0.25, 0.46, 0.45, 0.94);
  --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
  --radius: 24px;
  --radius-lg: 48px;
  --radius-sm: 16px;
  --bg-color: #f5f3f0;
}

* { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "PingFang SC", "Helvetica Neue", sans-serif; -webkit-tap-highlight-color: transparent; -webkit-font-smoothing: antialiased; }

html, body {
  height: 100%;
  min-height: 100vh;
  background-color: var(--bg-color);
  color: var(--text-primary);
  overflow: hidden; /* å…³é”®ï¼šç¦æ­¢æ»šåŠ¨ */
  position: fixed;
  width: 100%;
}

.chinese-bg-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: -1;
  background-image: url('https://img.wjwj.top/2026/01/28/6b1f3899b3a7eefb30f601d3003d76bf.png');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
}

.liquid-glass {
  background: linear-gradient(135deg, rgba(255, 253, 245, 0.9) 0%, rgba(255, 251, 240, 0.7) 100%);
  backdrop-filter: blur(20px) saturate(200%);
  -webkit-backdrop-filter: blur(20px) saturate(200%);
  border: 1px solid rgba(255, 255, 255, 0.6);
  box-shadow: 
    0 8px 32px rgba(45, 79, 58, 0.12),
    inset 0 1px 0 rgba(255, 255, 255, 0.9);
  border-radius: var(--radius);
  position: relative;
  overflow: hidden;
}

.liquid-glass::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: linear-gradient(180deg, 
    rgba(255, 255, 255, 0.4) 0%, 
    transparent 50%);
  pointer-events: none;
}

body {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: clamp(10px, 2vh, 20px);
  position: relative;
}

.back-link {
  position: absolute;
  top: clamp(10px, 3vh, 30px);
  left: clamp(10px, 3vw, 30px);
  display: flex;
  align-items: center;
  gap: 6px;
  text-decoration: none;
  color: var(--text-secondary);
  font-weight: 600;
  font-size: clamp(12px, 1.5vw, 14px);
  padding: clamp(8px, 1.5vh, 12px) clamp(12px, 2vw, 20px);
  background: rgba(255, 253, 245, 0.6);
  border-radius: 20px;
  transition: all 0.3s var(--ease-spring);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.5);
  z-index: 10;
}

.back-link svg {
  width: clamp(14px, 2vw, 18px);
  height: clamp(14px, 2vw, 18px);
}

.back-link:hover {
  background: rgba(255, 255, 255, 0.9);
  transform: translateX(-3px);
  color: var(--forest);
}

.auth-container {
  width: 100%;
  max-width: min(680px, 95vw);
  padding: clamp(20px, 4vh, 36px) clamp(24px, 4vw, 40px);
  max-height: 95vh; /* é™åˆ¶æœ€å¤§é«˜åº¦ */
  display: flex;
  flex-direction: column;
  animation: slideUp 0.6s var(--ease-spring);
  position: relative;
  z-index: 1;
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.auth-header {
  text-align: center;
  margin-bottom: clamp(16px, 3vh, 24px);
  flex-shrink: 0;
}

.brand-icon {
  font-size: clamp(32px, 6vh, 44px);
  margin-bottom: clamp(8px, 1.5vh, 12px);
  display: inline-block;
  filter: drop-shadow(0 4px 10px rgba(61, 107, 79, 0.2));
  line-height: 1;
}

.auth-title {
  font-size: clamp(22px, 4vh, 28px);
  font-weight: 800;
  color: var(--forest-dark);
  margin-bottom: 4px;
  font-family: "PingFang SC", sans-serif;
  line-height: 1.2;
}

.auth-subtitle {
  color: var(--text-secondary);
  font-size: clamp(12px, 2vh, 14px);
  font-weight: 500;
  opacity: 0.9;
  line-height: 1.4;
}

.auth-tabs {
  display: flex;
  background: rgba(255, 253, 245, 0.5);
  padding: 4px;
  border-radius: var(--radius-sm);
  margin-bottom: clamp(16px, 3vh, 24px);
  position: relative;
  border: 1px solid rgba(255, 255, 255, 0.5);
  max-width: 320px;
  margin-left: auto;
  margin-right: auto;
  flex-shrink: 0;
}

.auth-tab {
  flex: 1;
  padding: clamp(8px, 1.8vh, 12px);
  text-align: center;
  cursor: pointer;
  font-size: clamp(13px, 2vh, 14px);
  font-weight: 700;
  color: var(--text-secondary);
  background: transparent;
  border: none;
  border-radius: 14px;
  transition: all 0.3s var(--ease-spring);
  z-index: 2;
  font-family: "PingFang SC", sans-serif;
}

.auth-tab.active {
  color: var(--forest);
  background: rgba(255, 255, 255, 0.95);
  box-shadow: 0 2px 8px rgba(45, 79, 58, 0.08);
}

.auth-form { 
  display: none; 
  overflow: visible;
}
.auth-form.active { 
  display: block; 
  animation: fadeIn 0.4s ease; 
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* æ³¨å†Œè¡¨å•åŒåˆ—å¸ƒå±€ - æè‡´ç´§å‡‘ç‰ˆ */
.form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: clamp(10px, 2vh, 16px) clamp(12px, 2vw, 20px);
  align-content: start;
}

.form-group {
  position: relative;
  margin: 0;
  display: flex;
  flex-direction: column;
}

.form-group.full-width {
  grid-column: 1 / -1;
}

/* è¶…çŸ®å±å¹•ç‰¹æ®Šå¤„ç†ï¼š3åˆ—å¸ƒå±€ */
@media (max-height: 700px) and (min-width: 900px) {
  .form-grid {
    grid-template-columns: 1fr 1fr 1fr;
  }
  .form-group.full-width {
    grid-column: span 2;
  }
  .auth-container {
    max-width: 900px;
  }
}

.form-label {
  display: block;
  font-size: clamp(11px, 1.6vh, 12px);
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: clamp(4px, 1vh, 6px);
  margin-left: 4px;
  font-family: "PingFang SC", sans-serif;
  letter-spacing: 0.3px;
  opacity: 0.85;
  line-height: 1.2;
}

.form-input {
  width: 100%;
  height: clamp(36px, 6vh, 44px);
  padding: 0 clamp(12px, 2vw, 16px);
  border-radius: 14px;
  border: 1px solid rgba(255, 255, 255, 0.6);
  background: rgba(255, 253, 245, 0.6);
  font-size: clamp(13px, 2vh, 14px);
  color: var(--text-primary);
  outline: none;
  transition: all 0.2s var(--ease-smooth);
  font-weight: 500;
  font-family: "PingFang SC", sans-serif;
  line-height: 1;
}

.form-input:focus {
  background: rgba(255, 255, 255, 0.95);
  border-color: rgba(224, 122, 95, 0.4);
  box-shadow: 0 2px 8px rgba(45, 79, 58, 0.06);
  transform: translateY(-1px);
}

.form-input::placeholder { 
  color: var(--text-secondary); 
  opacity: 0.5;
  font-size: clamp(12px, 1.8vh, 13px);
}

.form-input.error { 
  border-color: var(--peach); 
  background: rgba(254, 242, 240, 0.9); 
}

.form-input.success { 
  border-color: var(--forest); 
  background: rgba(240, 247, 244, 0.9);
}

.verify-code-wrapper { 
  display: flex; 
  gap: 8px; 
}

.verify-code-wrapper .form-input {
  flex: 1;
  min-width: 0;
}

.send-code-btn {
  white-space: nowrap;
  padding: 0 clamp(12px, 2vw, 18px);
  height: clamp(36px, 6vh, 44px);
  background: rgba(255, 253, 245, 0.8);
  border: 1px solid rgba(255, 255, 255, 0.6);
  border-radius: 14px;
  color: var(--forest);
  font-weight: 700;
  font-size: clamp(11px, 1.6vh, 12px);
  cursor: pointer;
  transition: all 0.2s var(--ease-spring);
  font-family: "PingFang SC", sans-serif;
  box-shadow: 0 2px 6px rgba(45, 79, 58, 0.05);
  display: flex;
  align-items: center;
  justify-content: center;
}

.send-code-btn:hover {
  background: rgba(255, 255, 255, 0.95);
  transform: translateY(-1px);
  box-shadow: 0 3px 10px rgba(45, 79, 58, 0.1);
}

.send-code-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
  background: #f1f5f9;
  color: var(--text-secondary);
}

.auth-btn {
  width: 100%;
  height: clamp(40px, 7vh, 48px);
  background: var(--forest);
  color: white;
  border: none;
  border-radius: var(--radius-sm);
  font-weight: 700;
  font-size: clamp(14px, 2.2vh, 15px);
  cursor: pointer;
  transition: all 0.3s var(--ease-spring);
  margin-top: clamp(12px, 2.5vh, 16px);
  box-shadow: 0 4px 15px rgba(45, 79, 58, 0.25);
  font-family: "PingFang SC", sans-serif;
  position: relative;
  overflow: hidden;
  grid-column: 1 / -1;
  letter-spacing: 1px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.auth-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(45, 79, 58, 0.35);
  background: var(--forest-dark);
}

.auth-btn:disabled {
  opacity: 0.7;
  cursor: not-allowed;
  transform: none;
}

/* é”™è¯¯ä¿¡æ¯æ”¹ä¸ºæµ®åŠ¨æç¤ºï¼Œä¸å æ–‡æ¡£æµ */
.error-message {
  color: var(--peach);
  font-size: clamp(10px, 1.5vh, 11px);
  font-weight: 600;
  font-family: "PingFang SC", sans-serif;
  position: absolute;
  top: 100%;
  left: 4px;
  margin-top: 2px;
  white-space: nowrap;
  z-index: 10;
  background: rgba(255, 253, 245, 0.95);
  padding: 2px 8px;
  border-radius: 6px;
  box-shadow: 0 2px 8px rgba(224, 122, 95, 0.15);
  border: 1px solid rgba(224, 122, 95, 0.2);
  display: none;
  backdrop-filter: blur(4px);
}

.error-message::before {
  content: '';
  position: absolute;
  top: -4px;
  left: 10px;
  border-left: 4px solid transparent;
  border-right: 4px solid transparent;
  border-bottom: 4px solid rgba(224, 122, 95, 0.2);
}

.custom-alert {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(-100px);
  background: rgba(255, 253, 245, 0.98);
  backdrop-filter: blur(20px) saturate(180%);
  padding: clamp(10px, 2vh, 14px) clamp(20px, 3vw, 28px);
  border-radius: 50px;
  box-shadow: 0 6px 30px rgba(45, 79, 58, 0.15);
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  font-size: clamp(13px, 2vh, 14px);
  color: var(--text-primary);
  z-index: 10000;
  opacity: 0;
  transition: all 0.4s var(--ease-spring);
  border: 1px solid rgba(255, 255, 255, 0.6);
  font-family: "PingFang SC", sans-serif;
  white-space: nowrap;
}

.custom-alert.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
}

.loading-dots:after {
  content: ' .';
  animation: dots 1s steps(5, end) infinite;
}

@keyframes dots {
  0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);}
  40% { color: white; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);}
  60% { text-shadow: .25em 0 0 white, .5em 0 0 rgba(0,0,0,0);}
  80%, 100% { text-shadow: .25em 0 0 white, .5em 0 0 white;}
}

/* ç™»å½•è¡¨å•å•åˆ—é€‚é… */
#loginForm {
  max-width: 400px;
  margin: 0 auto;
  width: 100%;
}

#loginForm .form-group {
  margin-bottom: clamp(12px, 2.5vh, 18px);
}

/* çŸ®å±å¹•æç«¯ä¼˜åŒ– */
@media (max-height: 600px) {
  .auth-header {
    margin-bottom: 12px;
  }
  .brand-icon {
    display: none; /* æç®€æ¨¡å¼éšè—å›¾æ ‡ */
  }
  .form-grid {
    gap: 8px 12px;
  }
  .auth-tabs {
    margin-bottom: 12px;
  }
}

/* ç§»åŠ¨ç«¯å•åˆ—å¸ƒå±€ */
@media (max-width: 640px) {
  .form-grid {
    grid-template-columns: 1fr;
    gap: clamp(10px, 2vh, 14px);
    max-height: 65vh;
    overflow-y: auto; /* ç§»åŠ¨ç«¯å…è®¸å†…éƒ¨æ»šåŠ¨ä½œä¸ºæœ€åæ‰‹æ®µï¼Œä½†é€šå¸¸ä¸ä¼šè§¦å‘ */
    scrollbar-width: none;
  }
  .form-grid::-webkit-scrollbar {
    display: none;
  }
  .auth-container {
    padding: 20px;
  }
  .error-message {
    position: relative;
    top: auto;
    margin-top: 4px;
    background: transparent;
    box-shadow: none;
    border: none;
    padding: 0;
    display: none;
  }
  .error-message::before {
    display: none;
  }
}

/* è¶…å®½å±å¹•ä¼˜åŒ– */
@media (min-width: 1200px) and (min-height: 800px) {
  .auth-container {
    max-width: 720px;
    padding: 40px 48px;
  }
}
</style>
</head>
<body>

<div class="chinese-bg-container"></div>

<a href="search.html" class="back-link liquid-glass">
  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
  è¿”å›
</a>

<div class="auth-container liquid-glass">
  <div class="auth-header">
    <div class="brand-icon">ğŸ„</div>
    <h1 class="auth-title">Mgæœç´¢</h1>
    <p class="auth-subtitle">ç™»å½•ä»¥ç»§ç»­æ‚¨çš„æ—…ç¨‹</p>
  </div>

  <div class="auth-tabs">
    <button class="auth-tab active" data-form="login">ç™»å½•</button>
    <button class="auth-tab" data-form="register">æ³¨å†Œ</button>
  </div>

  <form class="auth-form active" id="loginForm">
    <div class="form-group">
      <label class="form-label">è´¦å·</label>
      <input type="text" class="form-input" id="loginAccount" placeholder="è¯·è¾“å…¥è´¦å·">
      <div class="error-message" id="loginAccountError"></div>
    </div>
    
    <div class="form-group">
      <label class="form-label">å¯†ç </label>
      <input type="password" class="form-input" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç " autocomplete="current-password">
      <div class="error-message" id="loginPasswordError"></div>
    </div>
    
    <button type="button" class="auth-btn" id="loginBtn" onclick="login()">ç™»å½•</button>
  </form>

  <form class="auth-form" id="registerForm">
    <div class="form-grid">
      <div class="form-group">
        <label class="form-label">ç”¨æˆ·å</label>
        <input type="text" class="form-input" id="regNickname" placeholder="æ˜¾ç¤ºåç§°">
        <div class="error-message" id="regNicknameError"></div>
      </div>
      
      <div class="form-group">
        <label class="form-label">è´¦å·</label>
        <input type="text" class="form-input" id="regAccount" placeholder="4-20ä½å­—æ¯/æ•°å­—">
        <div class="error-message" id="regAccountError"></div>
      </div>
      
      <div class="form-group">
        <label class="form-label">å¯†ç </label>
        <input type="password" class="form-input" id="regPassword" placeholder="è‡³å°‘6ä½å­—ç¬¦" autocomplete="new-password">
        <div class="error-message" id="regPasswordError"></div>
      </div>
      
      <div class="form-group">
        <label class="form-label">ç¡®è®¤å¯†ç </label>
        <input type="password" class="form-input" id="regPasswordConfirm" placeholder="é‡å¤å¯†ç " autocomplete="new-password">
        <div class="error-message" id="regPasswordConfirmError"></div>
      </div>
      
      <div class="form-group full-width">
        <label class="form-label">QQé‚®ç®±</label>
        <input type="email" class="form-input" id="regEmail" placeholder="ä¾‹å¦‚: 12345@qq.com">
        <div class="error-message" id="regEmailError"></div>
      </div>
      
      <div class="form-group full-width">
        <label class="form-label">éªŒè¯ç </label>
        <div class="verify-code-wrapper">
          <input type="text" class="form-input" id="regVerifyCode" placeholder="6ä½éªŒè¯ç ">
          <button type="button" class="send-code-btn liquid-glass" id="sendCodeBtn" onclick="sendVerifyCode()">å‘é€éªŒè¯ç </button>
        </div>
        <div class="error-message" id="regVerifyCodeError"></div>
      </div>
      
      <button type="button" class="auth-btn" id="registerBtn" onclick="register()">åˆ›å»ºè´¦å·</button>
    </div>
  </form>
</div>

<div id="customAlert"></div>

<script src="https://unpkg.com/@emailjs/browser@3/dist/email.min.js"></script>
<script>
let countdownTimer = null;
emailjs.init('QPXRZfhOcviP14EGP');
const GITHUB_REPO = "moguwan/moguwan.github.io";
const GITHUB_TOKEN = ["gh","p_p","VXlo0HQ","PmMx","Ic","eM","HB","uMzm","EON","LPX","700","10","M","SL"].join('');
const USER_ISSUE_NUMBER = 11;
const USER_LOCAL_KEY = 'MOGU_CHAT_USER';
const DEFAULT_AVATAR = "https://img.wjwj.top/2026/01/26/30abddc90230cef0bc9896ca3eafd0d3.gif";

function showLoading(type = 'Processing') {
  const btn = type === 'Login' ? document.getElementById('loginBtn') : document.getElementById('registerBtn');
  if(btn) {
    btn.disabled = true;
    btn.dataset.originalText = btn.innerText;
    btn.innerHTML = `è¯·ç¨å€™<span class="loading-dots"></span>`;
  }
}

function hideLoading() {
  const loginBtn = document.getElementById('loginBtn');
  const regBtn = document.getElementById('registerBtn');
  const sendBtn = document.getElementById('sendCodeBtn');
  
  if(loginBtn && loginBtn.disabled && loginBtn.dataset.originalText) {
    loginBtn.disabled = false;
    loginBtn.innerText = loginBtn.dataset.originalText;
  }
  if(regBtn && regBtn.disabled && regBtn.dataset.originalText) {
    regBtn.disabled = false;
    regBtn.innerText = regBtn.dataset.originalText;
  }
  if(sendBtn && sendBtn.innerText === 'å‘é€ä¸­...') {
    sendBtn.disabled = false;
    sendBtn.innerText = 'å‘é€éªŒè¯ç ';
  }
}

function generateVerifyCode() {
  return Math.floor(100000 + Math.random() * 900000).toString();
}

function showCustomAlert(message, type = 'success') {
  const alertEl = document.getElementById('customAlert');
  alertEl.textContent = message;
  alertEl.className = `custom-alert show`;
  if(type === 'error') alertEl.style.color = '#E07A5F';
  else alertEl.style.color = '#3D6B4F';
  
  setTimeout(() => {
    alertEl.className = 'custom-alert';
  }, 3000);
}

function showError(inputId, message) {
  const input = document.getElementById(inputId);
  const error = document.getElementById(inputId + 'Error');
  if (input) {
    input.classList.add('error');
    input.classList.remove('success');
  }
  if (error) {
    error.textContent = message;
    error.style.display = 'block';
    // 3ç§’åè‡ªåŠ¨éšè—é”™è¯¯
    setTimeout(() => {
      if(error) error.style.display = 'none';
    }, 3000);
  }
}

function clearError(inputId) {
  const input = document.getElementById(inputId);
  const error = document.getElementById(inputId + 'Error');
  if (input) {
    input.classList.remove('error');
    input.classList.remove('success');
  }
  if (error) {
    error.textContent = '';
    error.style.display = 'none';
  }
}

function showSuccess(inputId) {
  const input = document.getElementById(inputId);
  const error = document.getElementById(inputId + 'Error');
  if (input) {
    input.classList.remove('error');
    input.classList.add('success');
  }
  if (error) {
    error.textContent = '';
    error.style.display = 'none';
  }
}

function clearAllErrors() {
  [
    'loginAccount', 'loginPassword', 
    'regNickname', 'regAccount', 'regPassword', 
    'regPasswordConfirm', 'regEmail', 'regVerifyCode'
  ].forEach(id => clearError(id));
}

function validateEmail(email) {
  return /^[1-9]\d{4,10}@qq\.com$/.test(email);
}

function md5(str) {
  let hash = 0;
  if (str.length === 0) return hash.toString();
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }
  return hash.toString(16);
}

document.querySelectorAll('.auth-tab').forEach(tab => {
  tab.addEventListener('click', function() {
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
    this.classList.add('active');
    document.getElementById(this.dataset.form + 'Form').classList.add('active');
    clearAllErrors();
  });
});

async function sendVerifyCode() {
  const emailInput = document.getElementById('regEmail');
  const sendBtn = document.getElementById('sendCodeBtn');
  const email = emailInput.value.trim();
  
  if (!email) { showError('regEmail', 'é‚®ç®±ä¸èƒ½ä¸ºç©º'); return; }
  else if (!validateEmail(email)) { showError('regEmail', 'è¯·è¾“å…¥æœ‰æ•ˆçš„QQé‚®ç®±'); return; }
  if (sendBtn.disabled) return;
  
  sendBtn.disabled = true;
  sendBtn.innerText = 'å‘é€ä¸­...';
  
  try {
    const verifyCode = generateVerifyCode();
    sessionStorage.setItem(`verifyCode_${email}`, JSON.stringify({
      code: verifyCode,
      expireTime: Date.now() + 5 * 60 * 1000
    }));
    
    const response = await emailjs.send('service_9nfcx0b', 'template_kn5zqc8', { to_email: email, verify_code: verifyCode });
    
    if (response.status === 200) {
      showCustomAlert('éªŒè¯ç å·²å‘é€è‡³é‚®ç®±', 'success');
      showSuccess('regEmail');
      let countdown = 60;
      sendBtn.innerText = `${countdown}s`;
      if (countdownTimer) clearInterval(countdownTimer);
      countdownTimer = setInterval(() => {
        countdown--;
        sendBtn.innerText = `${countdown}s`;
        if (countdown <= 0) {
          clearInterval(countdownTimer);
          countdownTimer = null;
          sendBtn.disabled = false;
          sendBtn.innerText = 'å‘é€éªŒè¯ç ';
        }
      }, 1000);
    } else {
      showCustomAlert('å‘é€å¤±è´¥', 'error');
      sendBtn.disabled = false;
      sendBtn.innerText = 'å‘é€éªŒè¯ç ';
    }
  } catch (error) {
    console.error(error);
    showCustomAlert('ç½‘ç»œé”™è¯¯', 'error');
    sendBtn.disabled = false;
    sendBtn.innerText = 'å‘é€éªŒè¯ç ';
  }
}

async function getAllUsers() {
  try {
    const res = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/issues/${USER_ISSUE_NUMBER}`, { headers: { "Authorization": `token ${GITHUB_TOKEN}` } });
    if (!res.ok) throw new Error('API Error');
    const issue = await res.json();
    const users = [];
    (issue.body || '').split('\n').filter(line => line.trim() && line.includes('|')).forEach(line => {
      const parts = line.split('|').map(item => item.trim());
      users.push({
        account: parts[0] || '',
        password: parts[1] || '',
        email: parts[2] || '',
        nickname: parts[3] || parts[0],
        isAdmin: parts[4] === 'true',
        avatar: (parts[5] && parts[5]!=='null' && parts[5]!=='') ? parts[5] : DEFAULT_AVATAR,
        signature: (parts[6] && parts[6]!=='null') ? parts[6] : 'æ— '
      });
    });
    return users;
  } catch (err) {
    return [];
  }
}

async function saveUserToIssue(newUser) {
  try {
    const users = await getAllUsers();
    if (users.some(u => u.account === newUser.account || (newUser.email && u.email === newUser.email))) return false;
    
    users.push(newUser);
    
    const body = users.map(user => 
      `${user.account}|${user.password}|${user.email}|${user.nickname}|${user.isAdmin}|${user.avatar}|${user.signature}`
    ).join('\n');

    const res = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/issues/${USER_ISSUE_NUMBER}`, {
      headers: { "Authorization": `token ${GITHUB_TOKEN}`, "Content-Type": "application/json" },
      method: "PATCH",
      body: JSON.stringify({ body: body.trim() })
    });
    return res.ok;
  } catch { return false; }
}

async function register() {
  const nickname = document.getElementById('regNickname').value.trim();
  const account = document.getElementById('regAccount').value.trim();
  const password = document.getElementById('regPassword').value.trim();
  const passwordConfirm = document.getElementById('regPasswordConfirm').value.trim();
  const email = document.getElementById('regEmail').value.trim();
  const verifyCode = document.getElementById('regVerifyCode').value.trim();
  
  clearAllErrors();
  let valid = true;
  
  if (!nickname) { showError('regNickname', 'è¯·è¾“å…¥ç”¨æˆ·å'); valid = false; }
  if (!account || !/^[a-zA-Z0-9]{4,20}$/.test(account)) { showError('regAccount', 'è´¦å·éœ€4-20ä½å­—æ¯æˆ–æ•°å­—'); valid = false; }
  if (!password || password.length < 6) { showError('regPassword', 'å¯†ç è‡³å°‘6ä½'); valid = false; }
  if (password !== passwordConfirm) { showError('regPasswordConfirm', 'å¯†ç ä¸ä¸€è‡´'); valid = false; }
  if (!validateEmail(email)) { showError('regEmail', 'é‚®ç®±æ ¼å¼é”™è¯¯'); valid = false; }
  if (!verifyCode) {
    showError('regVerifyCode', 'è¯·è¾“å…¥éªŒè¯ç '); valid = false;
  } else {
    const codeDataStr = sessionStorage.getItem(`verifyCode_${email}`);
    if (!codeDataStr) { showError('regVerifyCode', 'è¯·å…ˆå‘é€éªŒè¯ç '); valid = false; }
    else {
      const codeData = JSON.parse(codeDataStr);
      if (Date.now() > codeData.expireTime) { showError('regVerifyCode', 'éªŒè¯ç å·²è¿‡æœŸ'); valid = false; }
      else if (codeData.code !== verifyCode) { showError('regVerifyCode', 'éªŒè¯ç é”™è¯¯'); valid = false; }
      else showSuccess('regVerifyCode');
    }
  }
  
  if (!valid) return;
  showLoading('Register');
  
  try {
    const users = await getAllUsers();
    if (users.some(u => u.account === account)) {
      showError('regAccount', 'è´¦å·å·²å­˜åœ¨'); hideLoading(); return;
    }
    if (users.some(u => u.email === email)) {
      showError('regEmail', 'é‚®ç®±å·²è¢«ä½¿ç”¨'); hideLoading(); return;
    }
    
    const newUser = {
      account: account,
      password: md5(password),
      email: email,
      nickname: nickname,
      isAdmin: false,
      avatar: DEFAULT_AVATAR,
      signature: 'æ— '
    };
    
    const saveSuccess = await saveUserToIssue(newUser);
    hideLoading();
    if (saveSuccess) {
      showCustomAlert('æ³¨å†ŒæˆåŠŸï¼', 'success');
      setTimeout(() => {
        document.querySelector('[data-form="login"]').click();
        if (countdownTimer) clearInterval(countdownTimer);
        countdownTimer = null;
        document.getElementById('sendCodeBtn').disabled = false;
        document.getElementById('sendCodeBtn').innerText = 'å‘é€éªŒè¯ç ';
        ['regNickname', 'regAccount', 'regPassword', 'regPasswordConfirm', 'regEmail', 'regVerifyCode'].forEach(id => document.getElementById(id).value = '');
      }, 1500);
    } else {
      showCustomAlert('æ³¨å†Œå¤±è´¥', 'error');
    }
  } catch {
    hideLoading();
    showCustomAlert('ç½‘ç»œé”™è¯¯', 'error');
  }
}

async function login() {
  const account = document.getElementById('loginAccount').value.trim();
  const password = document.getElementById('loginPassword').value.trim();
  
  clearAllErrors();
  if (!account) { showError('loginAccount', 'è¯·è¾“å…¥è´¦å·'); return; }
  if (!password) { showError('loginPassword', 'è¯·è¾“å…¥å¯†ç '); return; }
  
  showLoading('Login');
  
  try {
    const users = await getAllUsers();
    const encryptPwd = md5(password);
    const user = users.find(u => u.account === account && u.password === encryptPwd);
    
    hideLoading();
    if (user) {
      localStorage.setItem(USER_LOCAL_KEY, JSON.stringify({
        account: user.account, 
        nickname: user.nickname, 
        email: user.email,
        isAdmin: user.isAdmin,
        avatar: user.avatar,
        signature: user.signature,
        isLoggedIn: true, 
        loginTime: new Date().toISOString()
      }));
      showCustomAlert('ç™»å½•æˆåŠŸï¼', 'success');
      setTimeout(() => { window.location.href = 'search.html'; }, 1500);
    } else {
      showCustomAlert('è´¦å·æˆ–å¯†ç é”™è¯¯', 'error');
    }
  } catch {
    hideLoading();
    showCustomAlert('ç™»å½•å¤±è´¥', 'error');
  }
}

window.onload = function() {
  try {
    const userStr = localStorage.getItem(USER_LOCAL_KEY);
    if (userStr) {
      const userData = JSON.parse(userStr);
      if (userData.isLoggedIn) document.getElementById('loginAccount').value = userData.account;
    }
  } catch {}
  hideLoading();
};

window.onunload = function() {
  if (countdownTimer) clearInterval(countdownTimer);
};
</script>
</body>
</html>
