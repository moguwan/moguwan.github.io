<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login - Mogu Search</title>
<style>
:root {
  --forest: #3D6B4F;
  --forest-dark: #2D4F3A;
  --peach: #E07A5F;
  --peach-light: #F4A261;
  --cream: #F2E8CF;
  --soft-gold: #E9C46A;
  --glass-bg: rgba(255, 253, 245, 0.78);
  --glass-border: rgba(255, 255, 255, 0.5);
  --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.12);
  --text-primary: #2D4F3A;
  --text-secondary: #5A7D6C;
  --ease-smooth: cubic-bezier(0.25, 0.46, 0.45, 0.94);
  --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
  --radius: 32px;
  --radius-lg: 48px;
  --radius-sm: 20px;
  --bg-color: #f5f3f0;
}

* { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "PingFang SC", "Helvetica Neue", sans-serif; -webkit-tap-highlight-color: transparent; -webkit-font-smoothing: antialiased; }

html, body {
  height: 100%;
  min-height: 100vh;
  background-color: var(--bg-color);
  color: var(--text-primary);
  overflow-x: hidden;
}

.chinese-bg-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: -1;
  background-image: url('https://img.wjwj.top/2026/01/28/6b1f3899b3a7eefb30f601d3003d76bf.png');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  background-attachment: fixed;
}

.liquid-glass {
  background: linear-gradient(135deg, rgba(255, 253, 245, 0.85) 0%, rgba(255, 251, 240, 0.6) 100%);
  backdrop-filter: blur(20px) saturate(200%) contrast(1.1);
  -webkit-backdrop-filter: blur(20px) saturate(200%) contrast(1.1);
  border: 1px solid rgba(255, 255, 255, 0.6);
  box-shadow: 
    0 8px 32px rgba(45, 79, 58, 0.12),
    inset 0 1px 0 rgba(255, 255, 255, 0.9),
    inset 0 -1px 0 rgba(255, 255, 255, 0.3);
  border-radius: var(--radius);
  position: relative;
  overflow: hidden;
}

.liquid-glass::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: linear-gradient(180deg, 
    rgba(255, 255, 255, 0.4) 0%, 
    transparent 40%, 
    transparent 60%, 
    rgba(242, 232, 207, 0.3) 100%);
  pointer-events: none;
  border-radius: var(--radius);
}

body {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 20px;
  position: relative;
}

.back-link {
  position: absolute;
  top: 40px;
  left: 40px;
  display: flex;
  align-items: center;
  gap: 8px;
  text-decoration: none;
  color: var(--text-secondary);
  font-weight: 600;
  font-size: 14px;
  padding: 12px 24px;
  background: rgba(255, 253, 245, 0.6);
  border-radius: var(--radius-sm);
  transition: all 0.3s var(--ease-spring);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.5);
  z-index: 10;
}

.back-link:hover {
  background: rgba(255, 255, 255, 0.9);
  transform: translateX(-4px);
  color: var(--forest);
  box-shadow: 0 4px 15px rgba(45, 79, 58, 0.1);
}

.auth-container {
  width: 100%;
  max-width: 440px;
  padding: 40px;
  animation: slideUp 0.6s var(--ease-spring);
  position: relative;
  z-index: 1;
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.auth-header {
  text-align: center;
  margin-bottom: 32px;
}

.brand-icon {
  font-size: 48px;
  margin-bottom: 16px;
  display: inline-block;
  filter: drop-shadow(0 4px 10px rgba(61, 107, 79, 0.2));
}

.auth-title {
  font-size: 28px;
  font-weight: 800;
  color: var(--forest-dark);
  margin-bottom: 8px;
  font-family: "PingFang SC", sans-serif;
}

.auth-subtitle {
  color: var(--text-secondary);
  font-size: 14px;
  font-weight: 500;
}

.auth-tabs {
  display: flex;
  background: rgba(255, 253, 245, 0.5);
  padding: 4px;
  border-radius: var(--radius-sm);
  margin-bottom: 24px;
  position: relative;
  border: 1px solid rgba(255, 255, 255, 0.5);
}

.auth-tab {
  flex: 1;
  padding: 12px;
  text-align: center;
  cursor: pointer;
  font-size: 14px;
  font-weight: 700;
  color: var(--text-secondary);
  background: transparent;
  border: none;
  border-radius: 16px;
  transition: all 0.3s var(--ease-spring);
  z-index: 2;
  font-family: "PingFang SC", sans-serif;
}

.auth-tab.active {
  color: var(--forest);
  background: rgba(255, 255, 255, 0.9);
  box-shadow: 0 4px 12px rgba(45, 79, 58, 0.08);
}

.auth-form { display: none; }
.auth-form.active { display: block; animation: fadeIn 0.4s ease; }

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}

.form-group { margin-bottom: 20px; }
.form-label {
  display: block;
  font-size: 13px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 8px;
  margin-left: 4px;
  font-family: "PingFang SC", sans-serif;
}

.form-input {
  width: 100%;
  padding: 16px 20px;
  border-radius: var(--radius-sm);
  border: 1px solid rgba(255, 255, 255, 0.6);
  background: rgba(255, 253, 245, 0.6);
  font-size: 15px;
  color: var(--text-primary);
  outline: none;
  transition: all 0.3s var(--ease-smooth);
  font-weight: 500;
  font-family: "PingFang SC", sans-serif;
}

.form-input:focus {
  background: rgba(255, 255, 255, 0.95);
  border-color: rgba(224, 122, 95, 0.3);
  box-shadow: 0 4px 16px rgba(45, 79, 58, 0.08), 0 0 0 4px rgba(224, 122, 95, 0.05);
  transform: translateY(-2px);
}

.form-input::placeholder { color: var(--text-secondary); opacity: 0.6; }
.form-input.error { border-color: var(--peach); background: #fef2f0; }
.form-input.success { border-color: var(--forest); }

.verify-code-wrapper { display: flex; gap: 12px; }

.send-code-btn {
  white-space: nowrap;
  padding: 0 20px;
  background: rgba(255, 253, 245, 0.8);
  border: 1px solid rgba(255, 255, 255, 0.6);
  border-radius: var(--radius-sm);
  color: var(--forest);
  font-weight: 700;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.3s var(--ease-spring);
  font-family: "PingFang SC", sans-serif;
  box-shadow: 0 2px 8px rgba(45, 79, 58, 0.05);
}

.send-code-btn:hover {
  background: rgba(255, 255, 255, 0.95);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(45, 79, 58, 0.1);
}

.send-code-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
  background: #f1f5f9;
  color: var(--text-secondary);
}

.auth-btn {
  width: 100%;
  padding: 16px;
  background: var(--forest);
  color: white;
  border: none;
  border-radius: var(--radius-sm);
  font-weight: 700;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.3s var(--ease-spring);
  margin-top: 10px;
  box-shadow: 0 4px 15px rgba(45, 79, 58, 0.25);
  font-family: "PingFang SC", sans-serif;
  position: relative;
  overflow: hidden;
}

.auth-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(45, 79, 58, 0.35);
  background: var(--forest-dark);
}

.auth-btn:disabled {
  opacity: 0.7;
  cursor: not-allowed;
  transform: none;
}

.error-message {
  color: var(--peach);
  font-size: 12px;
  margin-top: 6px;
  margin-left: 4px;
  display: none;
  font-weight: 600;
  font-family: "PingFang SC", sans-serif;
}

.custom-alert {
  position: fixed;
  top: 30px;
  left: 50%;
  transform: translateX(-50%) translateY(-100px);
  background: rgba(255, 253, 245, 0.95);
  backdrop-filter: blur(20px) saturate(180%);
  padding: 16px 32px;
  border-radius: 50px;
  box-shadow: 0 10px 40px rgba(45, 79, 58, 0.15);
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 600;
  font-size: 14px;
  color: var(--text-primary);
  z-index: 10000;
  opacity: 0;
  transition: all 0.5s var(--ease-spring);
  border: 1px solid rgba(255, 255, 255, 0.6);
  font-family: "PingFang SC", sans-serif;
}

.custom-alert.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
}

.loading-dots:after {
  content: ' .';
  animation: dots 1s steps(5, end) infinite;
}

@keyframes dots {
  0%, 20% { color: rgba(0,0,0,0); text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);}
  40% { color: white; text-shadow: .25em 0 0 rgba(0,0,0,0), .5em 0 0 rgba(0,0,0,0);}
  60% { text-shadow: .25em 0 0 white, .5em 0 0 rgba(0,0,0,0);}
  80%, 100% { text-shadow: .25em 0 0 white, .5em 0 0 white;}
}

@media (max-width: 768px) {
  .auth-container { width: 90%; padding: 24px; border-radius: var(--radius-sm); }
  .back-link { top: 20px; left: 20px; padding: 10px 16px; }
  .auth-title { font-size: 24px; }
}
</style>
</head>
<body>

<div class="chinese-bg-container"></div>

<a href="search.html" class="back-link liquid-glass">
  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
  ËøîÂõû
</a>

<div class="auth-container liquid-glass">
  <div class="auth-header">
    <div class="brand-icon">üçÑ</div>
    <h1 class="auth-title">MgÊêúÁ¥¢</h1>
    <p class="auth-subtitle">ÁôªÂΩï‰ª•ÁªßÁª≠ÊÇ®ÁöÑÊóÖÁ®ã</p>
  </div>

  <div class="auth-tabs">
    <button class="auth-tab active" data-form="login">ÁôªÂΩï</button>
    <button class="auth-tab" data-form="register">Ê≥®ÂÜå</button>
  </div>

  <form class="auth-form active" id="loginForm">
    <div class="form-group">
      <label class="form-label">Ë¥¶Âè∑</label>
      <input type="text" class="form-input" id="loginAccount" placeholder="ËØ∑ËæìÂÖ•Ë¥¶Âè∑">
      <div class="error-message" id="loginAccountError"></div>
    </div>
    
    <div class="form-group">
      <label class="form-label">ÂØÜÁ†Å</label>
      <input type="password" class="form-input" id="loginPassword" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å" autocomplete="current-password">
      <div class="error-message" id="loginPasswordError"></div>
    </div>
    
    <button type="button" class="auth-btn" id="loginBtn" onclick="login()">ÁôªÂΩï</button>
  </form>

  <form class="auth-form" id="registerForm">
    <div class="form-group">
      <label class="form-label">Áî®Êà∑Âêç</label>
      <input type="text" class="form-input" id="regNickname" placeholder="ÊòæÁ§∫ÂêçÁß∞">
      <div class="error-message" id="regNicknameError"></div>
    </div>
    
    <div class="form-group">
      <label class="form-label">Ë¥¶Âè∑</label>
      <input type="text" class="form-input" id="regAccount" placeholder="4-20‰ΩçÂ≠óÊØç/Êï∞Â≠ó">
      <div class="error-message" id="regAccountError"></div>
    </div>
    
    <div class="form-group">
      <label class="form-label">ÂØÜÁ†Å</label>
      <input type="password" class="form-input" id="regPassword" placeholder="Ëá≥Â∞ë6‰ΩçÂ≠óÁ¨¶" autocomplete="current-password">
      <div class="error-message" id="regPasswordError"></div>
    </div>
    
    <div class="form-group">
      <label class="form-label">Á°ÆËÆ§ÂØÜÁ†Å</label>
      <input type="password" class="form-input" id="regPasswordConfirm" placeholder="ÈáçÂ§çÂØÜÁ†Å" autocomplete="current-password">
      <div class="error-message" id="regPasswordConfirmError"></div>
    </div>
    
    <div class="form-group">
      <label class="form-label">QQÈÇÆÁÆ±</label>
      <input type="email" class="form-input" id="regEmail" placeholder="‰æãÂ¶Ç: 12345@qq.com">
      <div class="error-message" id="regEmailError"></div>
    </div>
    
    <div class="form-group">
      <label class="form-label">È™åËØÅÁ†Å</label>
      <div class="verify-code-wrapper">
        <input type="text" class="form-input" id="regVerifyCode" placeholder="È™åËØÅÁ†Å">
        <button type="button" class="send-code-btn liquid-glass" id="sendCodeBtn" onclick="sendVerifyCode()">ÂèëÈÄÅÈ™åËØÅÁ†Å</button>
      </div>
      <div class="error-message" id="regVerifyCodeError"></div>
    </div>
    
    <button type="button" class="auth-btn" id="registerBtn" onclick="register()">ÂàõÂª∫Ë¥¶Âè∑</button>
  </form>
</div>

<div id="customAlert"></div>

<script src="https://unpkg.com/@emailjs/browser@3/dist/email.min.js"></script>
<script>
let countdownTimer = null;
emailjs.init('QPXRZfhOcviP14EGP');
const GITHUB_REPO = "moguwan/moguwan.github.io";
const GITHUB_TOKEN = ["gh","p_p","VXlo0HQ","PmMx","Ic","eM","HB","uMzm","EON","LPX","700","10","M","SL"].join('');
const USER_ISSUE_NUMBER = 11;
const USER_LOCAL_KEY = 'MOGU_CHAT_USER';
const DEFAULT_AVATAR = "https://img.wjwj.top/2026/01/26/30abddc90230cef0bc9896ca3eafd0d3.gif";

function showLoading(type = 'Processing') {
  const btn = type === 'Login' ? document.getElementById('loginBtn') : document.getElementById('registerBtn');
  if(btn) {
    btn.disabled = true;
    btn.dataset.originalText = btn.innerText;
    btn.innerHTML = `ËØ∑Á®çÂÄô<span class="loading-dots"></span>`;
  }
}

function hideLoading() {
  const loginBtn = document.getElementById('loginBtn');
  const regBtn = document.getElementById('registerBtn');
  const sendBtn = document.getElementById('sendCodeBtn');
  
  if(loginBtn && loginBtn.disabled && loginBtn.dataset.originalText) {
    loginBtn.disabled = false;
    loginBtn.innerText = loginBtn.dataset.originalText;
  }
  if(regBtn && regBtn.disabled && regBtn.dataset.originalText) {
    regBtn.disabled = false;
    regBtn.innerText = regBtn.dataset.originalText;
  }
  if(sendBtn && sendBtn.innerText === 'ÂèëÈÄÅ‰∏≠...') {
    sendBtn.disabled = false;
    sendBtn.innerText = 'ÂèëÈÄÅÈ™åËØÅÁ†Å';
  }
}

function generateVerifyCode() {
  return Math.floor(100000 + Math.random() * 900000).toString();
}

function showCustomAlert(message, type = 'success') {
  const alertEl = document.getElementById('customAlert');
  alertEl.textContent = message;
  alertEl.className = `custom-alert show`;
  if(type === 'error') alertEl.style.color = '#E07A5F';
  else alertEl.style.color = '#3D6B4F';
  
  setTimeout(() => {
    alertEl.className = 'custom-alert';
  }, 3000);
}

function showError(inputId, message) {
  const input = document.getElementById(inputId);
  const error = document.getElementById(inputId + 'Error');
  if (input) {
    input.classList.add('error');
    input.classList.remove('success');
  }
  if (error) {
    error.textContent = message;
    error.style.display = 'block';
  }
}

function clearError(inputId) {
  const input = document.getElementById(inputId);
  const error = document.getElementById(inputId + 'Error');
  if (input) {
    input.classList.remove('error');
    input.classList.remove('success');
  }
  if (error) {
    error.textContent = '';
    error.style.display = 'none';
  }
}

function showSuccess(inputId) {
  const input = document.getElementById(inputId);
  const error = document.getElementById(inputId + 'Error');
  if (input) {
    input.classList.remove('error');
    input.classList.add('success');
  }
  if (error) {
    error.textContent = '';
    error.style.display = 'none';
  }
}

function clearAllErrors() {
  [
    'loginAccount', 'loginPassword', 
    'regNickname', 'regAccount', 'regPassword', 
    'regPasswordConfirm', 'regEmail', 'regVerifyCode'
  ].forEach(id => clearError(id));
}

function validateEmail(email) {
  return /^[1-9]\d{4,10}@qq\.com$/.test(email);
}

function md5(str) {
  let hash = 0;
  if (str.length === 0) return hash.toString();
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }
  return hash.toString(16);
}

document.querySelectorAll('.auth-tab').forEach(tab => {
  tab.addEventListener('click', function() {
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
    this.classList.add('active');
    document.getElementById(this.dataset.form + 'Form').classList.add('active');
    clearAllErrors();
  });
});

async function sendVerifyCode() {
  const emailInput = document.getElementById('regEmail');
  const sendBtn = document.getElementById('sendCodeBtn');
  const email = emailInput.value.trim();
  
  if (!email) { showError('regEmail', 'ÈÇÆÁÆ±‰∏çËÉΩ‰∏∫Á©∫'); return; }
  else if (!validateEmail(email)) { showError('regEmail', 'ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑQQÈÇÆÁÆ±'); return; }
  if (sendBtn.disabled) return;
  
  sendBtn.disabled = true;
  sendBtn.innerText = 'ÂèëÈÄÅ‰∏≠...';
  
  try {
    const verifyCode = generateVerifyCode();
    sessionStorage.setItem(`verifyCode_${email}`, JSON.stringify({
      code: verifyCode,
      expireTime: Date.now() + 5 * 60 * 1000
    }));
    
    const response = await emailjs.send('service_9nfcx0b', 'template_kn5zqc8', { to_email: email, verify_code: verifyCode });
    
    if (response.status === 200) {
      showCustomAlert('È™åËØÅÁ†ÅÂ∑≤ÂèëÈÄÅËá≥ÈÇÆÁÆ±', 'success');
      showSuccess('regEmail');
      let countdown = 60;
      sendBtn.innerText = `${countdown}s`;
      if (countdownTimer) clearInterval(countdownTimer);
      countdownTimer = setInterval(() => {
        countdown--;
        sendBtn.innerText = `${countdown}s`;
        if (countdown <= 0) {
          clearInterval(countdownTimer);
          countdownTimer = null;
          sendBtn.disabled = false;
          sendBtn.innerText = 'ÂèëÈÄÅÈ™åËØÅÁ†Å';
        }
      }, 1000);
    } else {
      showCustomAlert('ÂèëÈÄÅÂ§±Ë¥•', 'error');
      sendBtn.disabled = false;
      sendBtn.innerText = 'ÂèëÈÄÅÈ™åËØÅÁ†Å';
    }
  } catch (error) {
    console.error(error);
    showCustomAlert('ÁΩëÁªúÈîôËØØ', 'error');
    sendBtn.disabled = false;
    sendBtn.innerText = 'ÂèëÈÄÅÈ™åËØÅÁ†Å';
  }
}

async function getAllUsers() {
  try {
    const res = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/issues/${USER_ISSUE_NUMBER}`, { headers: { "Authorization": `token ${GITHUB_TOKEN}` } });
    if (!res.ok) throw new Error('API Error');
    const issue = await res.json();
    const users = [];
    (issue.body || '').split('\n').filter(line => line.trim() && line.includes('|')).forEach(line => {
      const parts = line.split('|').map(item => item.trim());
      users.push({
        account: parts[0] || '',
        password: parts[1] || '',
        email: parts[2] || '',
        nickname: parts[3] || parts[0],
        isAdmin: parts[4] === 'true',
        avatar: (parts[5] && parts[5]!=='null' && parts[5]!=='') ? parts[5] : DEFAULT_AVATAR,
        signature: (parts[6] && parts[6]!=='null') ? parts[6] : 'Êó†'
      });
    });
    return users;
  } catch (err) {
    return [];
  }
}

async function saveUserToIssue(newUser) {
  try {
    const users = await getAllUsers();
    if (users.some(u => u.account === newUser.account || (newUser.email && u.email === newUser.email))) return false;
    
    users.push(newUser);
    
    const body = users.map(user => 
      `${user.account}|${user.password}|${user.email}|${user.nickname}|${user.isAdmin}|${user.avatar}|${user.signature}`
    ).join('\n');

    const res = await fetch(`https://api.github.com/repos/${GITHUB_REPO}/issues/${USER_ISSUE_NUMBER}`, {
      headers: { "Authorization": `token ${GITHUB_TOKEN}`, "Content-Type": "application/json" },
      method: "PATCH",
      body: JSON.stringify({ body: body.trim() })
    });
    return res.ok;
  } catch { return false; }
}

async function register() {
  const nickname = document.getElementById('regNickname').value.trim();
  const account = document.getElementById('regAccount').value.trim();
  const password = document.getElementById('regPassword').value.trim();
  const passwordConfirm = document.getElementById('regPasswordConfirm').value.trim();
  const email = document.getElementById('regEmail').value.trim();
  const verifyCode = document.getElementById('regVerifyCode').value.trim();
  
  clearAllErrors();
  let valid = true;
  
  if (!nickname) { showError('regNickname', 'ËØ∑ËæìÂÖ•Áî®Êà∑Âêç'); valid = false; }
  if (!account || !/^[a-zA-Z0-9]{4,20}$/.test(account)) { showError('regAccount', 'Ë¥¶Âè∑ÈúÄ4-20‰ΩçÂ≠óÊØçÊàñÊï∞Â≠ó'); valid = false; }
  if (!password || password.length < 6) { showError('regPassword', 'ÂØÜÁ†ÅËá≥Â∞ë6‰Ωç'); valid = false; }
  if (password !== passwordConfirm) { showError('regPasswordConfirm', 'ÂØÜÁ†Å‰∏ç‰∏ÄËá¥'); valid = false; }
  if (!validateEmail(email)) { showError('regEmail', 'ÈÇÆÁÆ±Ê†ºÂºèÈîôËØØ'); valid = false; }
  if (!verifyCode) {
    showError('regVerifyCode', 'ËØ∑ËæìÂÖ•È™åËØÅÁ†Å'); valid = false;
  } else {
    const codeDataStr = sessionStorage.getItem(`verifyCode_${email}`);
    if (!codeDataStr) { showError('regVerifyCode', 'ËØ∑ÂÖàÂèëÈÄÅÈ™åËØÅÁ†Å'); valid = false; }
    else {
      const codeData = JSON.parse(codeDataStr);
      if (Date.now() > codeData.expireTime) { showError('regVerifyCode', 'È™åËØÅÁ†ÅÂ∑≤ËøáÊúü'); valid = false; }
      else if (codeData.code !== verifyCode) { showError('regVerifyCode', 'È™åËØÅÁ†ÅÈîôËØØ'); valid = false; }
      else showSuccess('regVerifyCode');
    }
  }
  
  if (!valid) return;
  showLoading('Register');
  
  try {
    const users = await getAllUsers();
    if (users.some(u => u.account === account)) {
      showError('regAccount', 'Ë¥¶Âè∑Â∑≤Â≠òÂú®'); hideLoading(); return;
    }
    if (users.some(u => u.email === email)) {
      showError('regEmail', 'ÈÇÆÁÆ±Â∑≤Ë¢´‰ΩøÁî®'); hideLoading(); return;
    }
    
    const newUser = {
      account: account,
      password: md5(password),
      email: email,
      nickname: nickname,
      isAdmin: false,
      avatar: DEFAULT_AVATAR,
      signature: 'Êó†'
    };
    
    const saveSuccess = await saveUserToIssue(newUser);
    hideLoading();
    if (saveSuccess) {
      showCustomAlert('Ê≥®ÂÜåÊàêÂäüÔºÅ', 'success');
      setTimeout(() => {
        document.querySelector('[data-form="login"]').click();
        if (countdownTimer) clearInterval(countdownTimer);
        countdownTimer = null;
        document.getElementById('sendCodeBtn').disabled = false;
        document.getElementById('sendCodeBtn').innerText = 'ÂèëÈÄÅÈ™åËØÅÁ†Å';
        ['regNickname', 'regAccount', 'regPassword', 'regPasswordConfirm', 'regEmail', 'regVerifyCode'].forEach(id => document.getElementById(id).value = '');
      }, 1500);
    } else {
      showCustomAlert('Ê≥®ÂÜåÂ§±Ë¥•', 'error');
    }
  } catch {
    hideLoading();
    showCustomAlert('ÁΩëÁªúÈîôËØØ', 'error');
  }
}

async function login() {
  const account = document.getElementById('loginAccount').value.trim();
  const password = document.getElementById('loginPassword').value.trim();
  
  clearAllErrors();
  if (!account) { showError('loginAccount', 'ËØ∑ËæìÂÖ•Ë¥¶Âè∑'); return; }
  if (!password) { showError('loginPassword', 'ËØ∑ËæìÂÖ•ÂØÜÁ†Å'); return; }
  
  showLoading('Login');
  
  try {
    const users = await getAllUsers();
    const encryptPwd = md5(password);
    const user = users.find(u => u.account === account && u.password === encryptPwd);
    
    hideLoading();
    if (user) {
      localStorage.setItem(USER_LOCAL_KEY, JSON.stringify({
        account: user.account, 
        nickname: user.nickname, 
        email: user.email,
        isAdmin: user.isAdmin,
        avatar: user.avatar,
        signature: user.signature,
        isLoggedIn: true, 
        loginTime: new Date().toISOString()
      }));
      showCustomAlert('ÁôªÂΩïÊàêÂäüÔºÅ', 'success');
      setTimeout(() => { window.location.href = 'search.html'; }, 1500);
    } else {
      showCustomAlert('Ë¥¶Âè∑ÊàñÂØÜÁ†ÅÈîôËØØ', 'error');
    }
  } catch {
    hideLoading();
    showCustomAlert('ÁôªÂΩïÂ§±Ë¥•', 'error');
  }
}

window.onload = function() {
  try {
    const userStr = localStorage.getItem(USER_LOCAL_KEY);
    if (userStr) {
      const userData = JSON.parse(userStr);
      if (userData.isLoggedIn) document.getElementById('loginAccount').value = userData.account;
    }
  } catch {}
  hideLoading();
};

window.onunload = function() {
  if (countdownTimer) clearInterval(countdownTimer);
};
</script>
</body>
</html>
