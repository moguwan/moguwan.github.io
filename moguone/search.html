<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Mogu Search - Mg</title>
<style>
:root {
  --forest: #3D6B4F;
  --forest-dark: #2D4F3A;
  --peach: #E07A5F;
  --peach-light: #F4A261;
  --cream: #F2E8CF;
  --soft-gold: #E9C46A;
  --glass-bg: rgba(255, 253, 245, 0.78);
  --glass-border: rgba(255, 255, 255, 0.5);
  --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.12);
  --text-primary: #2D4F3A;
  --text-secondary: #5A7D6C;
  --ease-smooth: cubic-bezier(0.25, 0.46, 0.45, 0.94);
  --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
  --radius: 32px;
  --radius-lg: 48px;
  --radius-sm: 20px;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "PingFang SC", "Helvetica Neue", sans-serif;
  -webkit-tap-highlight-color: transparent;
}

html, body {
  height: 100%;
  overflow: hidden;
  position: fixed;
  width: 100%;
}

body {
  color: var(--text-primary);
  background: #f5f3f0;
}

.chinese-bg-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: -1;
  background-image: url('https://img.wjwj.top/2026/01/28/6b1f3899b3a7eefb30f601d3003d76bf.png');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  background-attachment: fixed;
}

/* 新的扁平化玻璃效果 - 更 subtle */
.liquid-glass-flat {
  background: rgba(255, 253, 245, 0.85);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.6);
  box-shadow: 0 4px 20px rgba(45, 79, 58, 0.08);
  border-radius: var(--radius);
  position: relative;
  overflow: hidden;
}

.liquid-glass {
  background: linear-gradient(135deg, rgba(255, 253, 245, 0.85) 0%, rgba(255, 251, 240, 0.6) 100%);
  backdrop-filter: blur(20px) saturate(200%) contrast(1.1);
  -webkit-backdrop-filter: blur(20px) saturate(200%) contrast(1.1);
  border: 1px solid rgba(255, 255, 255, 0.6);
  box-shadow: 
    0 8px 32px rgba(45, 79, 58, 0.12),
    inset 0 1px 0 rgba(255, 255, 255, 0.9),
    inset 0 -1px 0 rgba(255, 255, 255, 0.3);
  border-radius: var(--radius);
  position: relative;
  overflow: hidden;
}

.liquid-glass::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(180deg, 
    rgba(255, 255, 255, 0.4) 0%, 
    transparent 40%, 
    transparent 60%, 
    rgba(242, 232, 207, 0.3) 100%);
  pointer-events: none;
  border-radius: var(--radius);
}

.main-container {
  height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 0 20px;
  position: relative;
  z-index: 1;
  gap: 16px;
}

/* 标题缩小并优化 */
.search-title {
  font-size: clamp(2rem, 6vw, 3rem);
  font-weight: 700;
  letter-spacing: -0.01em;
  color: #ffffff;
  text-shadow: 0 2px 8px rgba(0,0,0,0.2);
  position: relative;
  font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
  user-select: none;
  cursor: default;
  transition: transform 0.4s var(--ease-spring), filter 0.4s;
  margin-bottom: 8px;
  background: none;
  -webkit-background-clip: unset;
  -webkit-text-fill-color: unset;
}

.search-title:hover {
  transform: scale(1.03) translateY(-3px);
  filter: drop-shadow(0 6px 12px rgba(0,0,0,0.15));
}

/* 搜索容器调整 */
.search-wrapper {
  width: 100%;
  max-width: 600px;
  position: relative;
  transform: translateY(0);
}

/* 新的搜索框样式 - 扁平化设计 */
.search-container {
  width: 100%;
  padding: 6px;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s var(--ease-smooth);
  will-change: transform;
  border-radius: 24px;
  background: rgba(255, 253, 245, 0.9);
  backdrop-filter: blur(12px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.8);
  box-shadow: 
    0 2px 12px rgba(45, 79, 58, 0.06),
    0 1px 3px rgba(0, 0, 0, 0.04),
    inset 0 1px 0 rgba(255, 255, 255, 0.9);
}

.search-container:hover {
  transform: translateY(-1px);
  box-shadow: 
    0 4px 20px rgba(45, 79, 58, 0.1),
    0 2px 6px rgba(0, 0, 0, 0.04),
    inset 0 1px 0 rgba(255, 255, 255, 0.9);
  border-color: rgba(224, 122, 95, 0.3);
}

.search-container:focus-within {
  transform: translateY(-1px);
  box-shadow: 
    0 0 0 3px rgba(224, 122, 95, 0.1),
    0 4px 20px rgba(45, 79, 58, 0.12),
    inset 0 1px 0 rgba(255, 255, 255, 0.9);
  border-color: rgba(224, 122, 95, 0.4);
}

.search-engine-select {
  appearance: none;
  background: rgba(61, 107, 79, 0.06);
  border: none;
  padding: 10px 16px;
  font-size: 14px;
  font-weight: 600;
  color: var(--forest);
  cursor: pointer;
  border-radius: 18px;
  transition: all 0.3s var(--ease-smooth);
  font-family: "PingFang SC", sans-serif;
  border: 1px solid rgba(61, 107, 79, 0.1);
}

.search-engine-select:hover {
  background: rgba(61, 107, 79, 0.12);
  transform: scale(1.02);
}

#search-input {
  flex: 1;
  border: none;
  background: transparent;
  font-size: 16px;
  padding: 12px 8px;
  color: var(--text-primary);
  outline: none;
  font-weight: 500;
  font-family: "PingFang SC", sans-serif;
}

#search-input::placeholder {
  color: var(--text-secondary);
  font-weight: 400;
  opacity: 0.5;
  font-size: 15px;
}

/* 搜索按钮调整 */
#search-btn {
  background: var(--forest);
  color: white;
  border: none;
  box-shadow: 0 2px 8px rgba(61, 107, 79, 0.25);
  width: 42px;
  height: 42px;
  border-radius: 50%;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s var(--ease-spring);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
  flex-shrink: 0;
}

#search-btn:hover {
  transform: scale(1.1) rotate(8deg);
  box-shadow: 0 4px 16px rgba(224, 122, 95, 0.35);
  background: var(--peach);
}

#search-btn:active {
  transform: scale(0.95);
}

#search-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  transition: left 0.5s;
}

#search-btn:hover::before {
  left: 100%;
}

.history-rank-wrap {
  width: 100%;
  max-width: 600px;
  transform: translateY(0);
  transition: all 0.5s var(--ease-spring);
  max-height: 400px;
  opacity: 1;
  overflow: hidden;
  margin-top: 8px;
}

.history-rank-wrap.hidden {
  max-height: 0;
  opacity: 0;
  margin: 0;
  transform: translateY(-10px);
}

.history-rank-container {
  display: grid;
  grid-template-columns: 1fr;
  gap: 16px;
}

.history-section {
  margin-top: 0;
  padding: 20px;
  display: flex;
  flex-direction: column;
  min-height: 280px;
  transition: all 0.4s var(--ease-spring);
  border-radius: var(--radius);
}

.history-section:hover {
  transform: translateY(-3px);
  box-shadow: 
    0 20px 40px rgba(45, 79, 58, 0.08),
    inset 0 1px 0 rgba(255,255,255,0.9);
}

.module-title {
  font-size: 12px;
  font-weight: 700;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-family: "PingFang SC", sans-serif;
}

.history-list {
  list-style: none;
  max-height: 240px;
  overflow-y: auto;
  padding-right: 4px;
  overflow-x: hidden;
  position: relative;
}

::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-thumb {
  background: rgba(61, 107, 79, 0.2);
  border-radius: 10px;
  border: 2px solid transparent;
  background-clip: padding-box;
}
::-webkit-scrollbar-track { background: transparent; }

.history-item {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  border-radius: 14px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: all 0.3s var(--ease-spring);
  color: var(--text-primary);
  font-size: 13px;
  font-weight: 500;
  background: rgba(255,253,245,0.5);
  border: 1px solid rgba(255,255,255,0.4);
  font-family: "PingFang SC", sans-serif;
}

.history-item:hover {
  background: rgba(255,255,255,0.95);
  transform: scale(1.01) translateX(4px);
  box-shadow: 0 2px 8px rgba(45, 79, 58, 0.06);
  border-color: rgba(224, 122, 95, 0.2);
  padding-left: 20px;
}

.history-item .time {
  margin-left: auto;
  font-size: 11px;
  color: var(--text-secondary);
  margin-right: 8px;
  font-weight: 500;
  opacity: 0.7;
}

.delete-btn {
  background: rgba(224, 122, 95, 0.08);
  border: none;
  color: var(--peach);
  cursor: pointer;
  opacity: 0;
  width: 24px;
  height: 24px;
  border-radius: 8px;
  transition: all 0.3s var(--ease-spring);
  display: flex;
  align-items: center;
  justify-content: center;
}

.history-item:hover .delete-btn { opacity: 1; }
.delete-btn:hover { 
  background: var(--peach); 
  color: white; 
  transform: scale(1.1) rotate(90deg);
}

.toggle-switch {
  width: 44px;
  height: 26px;
  position: relative;
  display: inline-block;
}

.toggle-switch input { opacity: 0; width: 0; height: 0; }

.switch-slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: rgba(45, 79, 58, 0.15);
  border-radius: 26px;
  transition: .3s var(--ease-spring);
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.08);
}

.switch-slider:before {
  position: absolute;
  content: "";
  height: 22px;
  width: 22px;
  left: 2px;
  bottom: 2px;
  background-color: white;
  border-radius: 50%;
  transition: .3s var(--ease-spring);
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

input:checked + .switch-slider { background-color: var(--forest); }
input:checked + .switch-slider:before { transform: translateX(18px); }

.float-btn {
  position: fixed;
  background: var(--glass-bg);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.4s var(--ease-spring);
  z-index: 100;
  color: var(--forest);
  border-radius: var(--radius-sm);
}

.toggle-btn {
  bottom: 30px;
  left: 30px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  animation: slideInLeft 0.6s var(--ease-spring) 0.8s backwards;
}

.toggle-btn:hover {
  transform: scale(1.1) rotate(8deg);
  box-shadow: 0 12px 30px rgba(45, 79, 58, 0.15);
}

.mogu-active-btn, .mogu-chat-btn {
  top: 24px;
  width: 48px;
  height: 48px;
  opacity: 0.9;
}

.mogu-chat-btn { 
  right: 24px; 
  color: var(--peach);
  animation: slideInRight 0.6s var(--ease-spring) 0.4s backwards;
}

.mogu-active-btn { 
  right: 80px; 
  color: var(--soft-gold);
  animation: slideInRight 0.6s var(--ease-spring) 0.5s backwards;
}

.mogu-active-btn:hover {
  transform: scale(1.1) rotate(10deg);
  color: var(--forest);
  box-shadow: 0 12px 30px rgba(233, 196, 106, 0.25);
}

.mogu-chat-btn:hover {
  transform: scale(1.1) rotate(-10deg);
  box-shadow: 0 12px 30px rgba(224, 122, 95, 0.25);
}

.float-btn:active {
  transform: scale(0.95);
}

@keyframes slideInRight {
  from { opacity: 0; transform: translateX(50px); }
  to { opacity: 1; transform: translateX(0); }
}

@keyframes slideInLeft {
  from { opacity: 0; transform: translateX(-50px); }
  to { opacity: 1; transform: translateX(0); }
}

.user-info {
  position: fixed;
  top: 24px;
  left: 24px;
  background: var(--glass-bg);
  backdrop-filter: blur(20px) saturate(180%);
  padding: 6px 6px 6px 14px;
  border-radius: 50px;
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: var(--glass-shadow);
  border: 1px solid var(--glass-border);
  z-index: 1000;
  transition: all 0.4s var(--ease-spring);
  animation: slideInLeft 0.6s var(--ease-spring) forwards;
  max-width: 200px;
  cursor: pointer;
}

.user-info:hover { 
  transform: translateY(-2px) scale(1.02); 
  box-shadow: 0 12px 30px rgba(45, 79, 58, 0.12);
}

.user-profile-btn { 
  display: flex; 
  align-items: center; 
  gap: 8px; 
  cursor: pointer;
  overflow: hidden;
}

.user-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 2px solid rgba(255,255,255,0.8);
  box-shadow: 0 2px 6px rgba(45, 79, 58, 0.1);
  background-size: cover;
  background-position: center;
  transition: transform 0.3s;
}

.user-info:hover .user-avatar {
  transform: rotate(360deg) scale(1.1);
}

.user-name { 
  font-size: 13px; 
  font-weight: 600; 
  color: var(--text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 80px;
  font-family: "PingFang SC", sans-serif;
}

.logout-btn {
  padding: 8px 16px;
  border-radius: 20px;
  border: none;
  background: rgba(61, 107, 79, 0.08);
  color: var(--text-secondary);
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  font-family: "PingFang SC", sans-serif;
  opacity: 0;
  transform: translateX(-10px);
  pointer-events: none;
  font-size: 12px;
}

.user-info:hover .logout-btn {
  opacity: 1;
  transform: translateX(0);
  pointer-events: all;
  transition-delay: 0.1s;
}

.logout-btn:hover { 
  background: var(--peach); 
  color: white;
  transform: scale(1.05);
}

.login-btn {
  position: fixed;
  top: 24px; 
  left: 24px;
  padding: 12px 24px;
  border-radius: 24px;
  border: 2px solid #fff;
  background: #FFE4C4;
  color: #5D4037;
  font-weight: 700;
  font-size: 13px;
  cursor: pointer;
  z-index: 1000;
  box-shadow: 
    0 4px 0 #E6C2A0,
    0 6px 10px rgba(0,0,0,0.1);
  transition: all 0.1s;
  font-family: "PingFang SC", sans-serif;
}

.login-btn:active {
  transform: translateY(4px);
  box-shadow: 
    0 0 0 #E6C2A0,
    0 2px 4px rgba(0,0,0,0.1);
}

.login-btn:hover {
  background: #FFEED8;
}

.mogu-chat-window {
  position: fixed;
  top: 90px;
  right: 24px;
  width: 360px;
  height: 480px;
  z-index: 1999;
  transform: translateX(120%) scale(0.9);
  opacity: 0;
  visibility: hidden;
  transition: all 0.6s var(--ease-spring);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  background: rgba(255, 253, 245, 0.92);
  backdrop-filter: blur(25px) saturate(220%) contrast(1.15);
  -webkit-backdrop-filter: blur(25px) saturate(220%) contrast(1.15);
  border: 1px solid rgba(255, 255, 255, 0.7);
  box-shadow: 
    0 25px 50px rgba(45, 79, 58, 0.15),
    inset 0 1px 0 rgba(255,255,255,0.9);
  border-radius: 28px;
}

.mogu-chat-window.open {
  transform: translateX(0) scale(1);
  opacity: 1;
  visibility: visible;
}

.mogu-chat-header {
  padding: 20px;
  background: linear-gradient(180deg, rgba(255,255,255,0.95) 0%, rgba(255,251,240,0.5) 100%);
  border-bottom: 1px solid rgba(45, 79, 58, 0.06);
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: relative;
  z-index: 2;
}

.mogu-chat-title {
  font-weight: 700;
  color: var(--text-primary);
  font-size: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-family: "PingFang SC", sans-serif;
}

.mogu-chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  position: relative;
  z-index: 1;
}

.message-item {
  max-width: 85%;
  padding: 14px 18px;
  font-size: 14px;
  line-height: 1.5;
  position: relative;
  word-break: break-word;
  backdrop-filter: blur(10px);
  animation: messageSlideIn 0.4s var(--ease-spring);
  font-family: "PingFang SC", sans-serif;
  border-radius: 20px;
  transition: all 0.3s var(--ease-smooth);
}

@keyframes messageSlideIn {
  from { 
    opacity: 0; 
    transform: translateY(10px) scale(0.95);
  }
  to { 
    opacity: 1; 
    transform: translateY(0) scale(1);
  }
}

.message-item.other {
  align-self: flex-start;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 20px 20px 20px 6px;
  box-shadow: 0 2px 10px rgba(45, 79, 58, 0.05);
  color: var(--text-primary);
  border: 1px solid rgba(255,255,255,0.8);
}

.message-item.user {
  align-self: flex-end;
  background: linear-gradient(135deg, var(--forest) 0%, #4A7D5F 100%);
  color: white;
  border-radius: 20px 20px 6px 20px;
  box-shadow: 0 4px 16px rgba(61, 107, 79, 0.2);
}

.message-item.user .message-sender {
  color: rgba(255,255,255,0.95);
}

.message-item.user .message-time {
  color: rgba(255,255,255,0.7);
}

.message-header {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
  gap: 8px;
}
/* 用户消息（右侧）的头像和用户名顺序调整 */
.message-item.user .message-header {
  flex-direction: row-reverse; /* 头像在右，用户名在左 */
}
.message-avatar {
  width: 28px;  /* 稍微大一点更容易看到 */
  height: 28px;
  min-width: 28px;  /* 防止被 flex 压缩 */
  min-height: 28px;
  border-radius: 50%;
  background-size: cover;
  background-position: center;
  background-color: rgba(45, 79, 58, 0.15); /* 后备颜色 */
  flex-shrink: 0;
  display: block;
  border: 2px solid rgba(255,255,255,0.6);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* 用户消息的头像样式 */
.message-item.user .message-avatar {
  border-color: rgba(255,255,255,0.4);
  background-color: rgba(255,255,255,0.2);
}
.message-sender {
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
  opacity: 0.9;
}

.message-text {
  line-height: 1.6;
  word-break: break-all; /* 防止长 URL 撑破布局 */
}
.message-text img {
  max-width: 100%;
  height: auto;
  border-radius: 8px;
  margin-top: 6px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.message-time {
  font-size: 10px;
  opacity: 0.6;
  margin-top: 6px;
  text-align: right;
}
.mogu-chat-input-area {
  padding: 16px;
  background: linear-gradient(0deg, rgba(255,253,245,0.98) 0%, rgba(255,251,240,0.7) 100%);
  display: flex;
  gap: 10px;
  border-top: 1px solid rgba(45, 79, 58, 0.06);
  position: relative;
  z-index: 2;
}

.mogu-chat-input {
  flex: 1;
  background: rgba(255,255,255,0.95);
  border: none;
  border-radius: 20px;
  padding: 12px 16px;
  font-size: 14px;
  outline: none;
  box-shadow: inset 0 2px 4px rgba(45, 79, 58, 0.03);
  font-family: "PingFang SC", sans-serif;
  transition: all 0.3s;
  color: var(--text-primary);
}

.mogu-chat-input:focus {
  box-shadow: inset 0 2px 8px rgba(45, 79, 58, 0.06), 0 0 0 3px rgba(224, 122, 95, 0.1);
}

.mogu-chat-send {
  background: var(--forest);
  color: white;
  border: none;
  border-radius: 14px;
  width: 44px;
  height: 44px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s var(--ease-spring);
  box-shadow: 0 4px 12px rgba(45, 79, 58, 0.2);
  flex-shrink: 0;
}

.mogu-chat-send:hover { 
  transform: scale(1.05) rotate(8deg); 
  background: var(--peach);
  box-shadow: 0 6px 18px rgba(224, 122, 95, 0.3);
}

.mogu-chat-send:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.modal-mask {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(45, 79, 58, 0.3);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  z-index: 9000;
  display: none;
  opacity: 0;
  transition: opacity 0.4s ease;
}

.modal-mask.show { opacity: 1; }

.custom-modal, .notice-modal {
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -40%) scale(0.9);
  background: rgba(255, 253, 245, 0.96);
  backdrop-filter: blur(30px) saturate(200%);
  padding: 32px;
  border-radius: 32px;
  box-shadow: 
    0 30px 60px -15px rgba(45, 79, 58, 0.25),
    inset 0 1px 0 rgba(255,255,255,0.9),
    0 0 0 1px rgba(255,255,255,0.5) inset;
  width: 90%;
  max-width: 380px;
  z-index: 9001;
  display: none;
  opacity: 0;
  transition: all 0.5s var(--ease-spring);
  text-align: center;
  border: 1px solid rgba(255,255,255,0.6);
}

.custom-modal.show, .notice-modal.show { 
  transform: translate(-50%, -50%) scale(1); 
  opacity: 1; 
}

.modal-header, .notice-header {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 14px;
  color: var(--forest);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  font-family: "PingFang SC", sans-serif;
}

.modal-btns { display: flex; gap: 10px; justify-content: center; margin-top: 24px; }

.modal-btn, .notice-confirm-btn {
  padding: 14px 28px;
  border-radius: 18px;
  border: none;
  font-weight: 600;
  cursor: pointer;
  font-size: 15px;
  transition: all 0.3s var(--ease-spring);
  font-family: "PingFang SC", sans-serif;
  flex: 1;
}

.modal-btn.cancel { 
  background: rgba(45, 79, 58, 0.06); 
  color: var(--text-secondary); 
}

.modal-btn.confirm { 
  background: var(--forest); 
  color: white;
  box-shadow: 0 6px 16px rgba(45, 79, 58, 0.2);
}

.modal-btn:hover { transform: translateY(-2px); }
.modal-btn.confirm:hover { background: var(--peach); }

.notice-confirm-btn { 
  background: var(--peach); 
  color: white; 
  width: 100%; 
  margin-top: 10px;
  box-shadow: 0 6px 16px rgba(224, 122, 95, 0.25);
  border-radius: 18px;
}

.loading-spinner {
  width: 18px; 
  height: 18px;
  border: 2px solid rgba(255,255,255,0.3);
  border-radius: 50%; 
  border-top-color: white;
  animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.admin-only { display: none !important; }
.admin-only.admin-show { display: block !important; }

.clear-all-btn {
  border: none;
  background: none;
  color: var(--peach);
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  padding: 6px 12px;
  border-radius: 10px;
  transition: all 0.3s;
  font-family: "PingFang SC", sans-serif;
}

.clear-all-btn:hover {
  background: rgba(224, 122, 95, 0.1);
  transform: scale(1.05);
}

/* 登录提示弹窗样式 */
.login-notice-modal {
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -40%) scale(0.9);
  background: rgba(255, 253, 245, 0.98);
  backdrop-filter: blur(30px) saturate(200%);
  padding: 40px 32px;
  border-radius: 32px;
  box-shadow: 
    0 30px 60px -15px rgba(45, 79, 58, 0.3),
    inset 0 1px 0 rgba(255,255,255,0.9);
  width: 90%;
  max-width: 360px;
  z-index: 10001;
  display: none;
  opacity: 0;
  transition: all 0.5s var(--ease-spring);
  text-align: center;
  border: 1px solid rgba(255,255,255,0.6);
}

.login-notice-modal.show {
  transform: translate(-50%, -50%) scale(1);
  opacity: 1;
}

.login-notice-icon {
  width: 64px;
  height: 64px;
  margin: 0 auto 20px;
  background: linear-gradient(135deg, var(--peach) 0%, var(--peach-light) 100%);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 8px 24px rgba(224, 122, 95, 0.3);
}

.login-notice-icon svg {
  width: 32px;
  height: 32px;
  color: white;
}

.login-notice-title {
  font-size: 22px;
  font-weight: 700;
  color: var(--forest);
  margin-bottom: 12px;
  font-family: "PingFang SC", sans-serif;
}

.login-notice-text {
  font-size: 15px;
  color: var(--text-secondary);
  line-height: 1.7;
  margin-bottom: 28px;
  font-family: "PingFang SC", sans-serif;
}

.login-notice-btn {
  width: 100%;
  padding: 16px 28px;
  border-radius: 20px;
  border: none;
  background: linear-gradient(135deg, var(--forest) 0%, #4A7D5F 100%);
  color: white;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s var(--ease-spring);
  font-family: "PingFang SC", sans-serif;
  box-shadow: 0 6px 20px rgba(61, 107, 79, 0.3);
}

.login-notice-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 28px rgba(61, 107, 79, 0.4);
  background: linear-gradient(135deg, var(--peach) 0%, var(--peach-light) 100%);
}

.login-notice-overlay {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(45, 79, 58, 0.5);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  z-index: 10000;
  display: none;
  opacity: 0;
  transition: opacity 0.4s ease;
}

.login-notice-overlay.show {
  opacity: 1;
}

/* ========== iOS Dynamic Island Notification System ========== */
.dynamic-island-container {
  position: fixed;
  top: 12px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 99999;
  display: flex;
  flex-direction: column;
  gap: 10px;
  align-items: center;
  pointer-events: none;
  width: 100%;
  max-width: 400px;
  padding: 0 20px;
}

.dynamic-island {
  background: rgba(0, 0, 0, 0.85);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-radius: 50px;
  padding: 12px 20px;
  min-width: 200px;
  max-width: 100%;
  box-shadow: 
    0 10px 40px rgba(0, 0, 0, 0.3),
    0 0 0 0.5px rgba(255, 255, 255, 0.1) inset;
  display: flex;
  align-items: center;
  gap: 12px;
  color: white;
  font-family: "SF Pro Display", "PingFang SC", -apple-system, sans-serif;
  transform: translateY(-100px) scale(0.8);
  opacity: 0;
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  pointer-events: auto;
  position: relative;
  overflow: hidden;
}

.dynamic-island.show {
  transform: translateY(0) scale(1);
  opacity: 1;
}

.dynamic-island.hide {
  transform: translateY(-20px) scale(0.9);
  opacity: 0;
}

.dynamic-island-icon {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  background: rgba(255, 255, 255, 0.15);
}

.dynamic-island-icon.success { background: rgba(61, 107, 79, 0.9); }
.dynamic-island-icon.error { background: rgba(224, 122, 95, 0.9); }
.dynamic-island-icon.warning { background: rgba(233, 196, 106, 0.9); }
.dynamic-island-icon.loading { background: rgba(90, 125, 108, 0.9); }

.dynamic-island-icon svg {
  width: 16px;
  height: 16px;
  stroke: white;
  stroke-width: 2.5;
  fill: none;
  stroke-linecap: round;
  stroke-linejoin: round;
}

.dynamic-island-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 6px;
  min-width: 0;
}

.dynamic-island-title {
  font-size: 14px;
  font-weight: 600;
  letter-spacing: -0.01em;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.dynamic-island-subtitle {
  font-size: 12px;
  opacity: 0.8;
  font-weight: 400;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Progress Bar */
.dynamic-island-progress-container {
  width: 100%;
  height: 3px;
  background: rgba(255, 255, 255, 0.15);
  border-radius: 2px;
  overflow: hidden;
  margin-top: 4px;
}

.dynamic-island-progress-bar {
  height: 100%;
  background: linear-gradient(90deg, var(--soft-gold), var(--peach-light));
  border-radius: 2px;
  transition: width 0.3s ease;
  box-shadow: 0 0 10px rgba(233, 196, 106, 0.5);
}

/* Loading Animation */
.dynamic-island-spinner {
  width: 16px;
  height: 16px;
  border: 2px solid rgba(255, 255, 255, 0.2);
  border-top-color: white;
  border-radius: 50%;
  animation: island-spin 0.8s linear infinite;
}

@keyframes island-spin {
  to { transform: rotate(360deg); }
}

/* Glow effect for important notifications */
.dynamic-island.important {
  box-shadow: 
    0 10px 40px rgba(0, 0, 0, 0.3),
    0 0 0 0.5px rgba(255, 255, 255, 0.1) inset,
    0 0 20px rgba(224, 122, 95, 0.3);
}

/* Compact mode for simple alerts */
.dynamic-island.compact {
  padding: 10px 16px;
  border-radius: 30px;
}

.dynamic-island.compact .dynamic-island-title {
  font-size: 13px;
}

@media (max-width: 768px) {
  .dynamic-island-container {
    top: 8px;
    padding: 0 10px;
  }
  
  .dynamic-island {
    min-width: 180px;
    padding: 10px 16px;
  }
  
  .dynamic-island-title {
    font-size: 13px;
  }
  
  .dynamic-island-subtitle {
    font-size: 11px;
  }
}

/* Hide old custom alert */
.custom-alert {
  display: none !important;
}

@media (max-width: 768px) {
  .main-container {
    padding: 10vh 16px 24px;
    justify-content: flex-start;
    height: auto;
    min-height: 100vh;
    overflow-y: auto;
    gap: 12px;
  }
  
  .search-title { 
    font-size: 2rem;
    margin-bottom: 1rem;
    margin-top: 0;
    font-weight: 700;
  }
  
  .search-wrapper {
    transform: translateY(0);
    max-width: 100%;
  }
  
  .history-rank-wrap {
    transform: translateY(0);
    max-width: 100%;
  }
  
  .history-section {
    min-height: auto;
    padding: 18px;
    border-radius: 24px;
  }
  
  .toggle-btn { 
    display: none; 
  }
  
  .mogu-chat-window { 
    width: 100%; 
    height: 100%; 
    top: 0; 
    right: 0; 
    border-radius: 0;
    transform: translateY(100%) scale(1);
    max-height: 100vh;
    backdrop-filter: blur(30px) saturate(200%);
  }
  
  .mogu-chat-window.open { 
    transform: translateY(0) scale(1); 
  }
  
  .mogu-chat-header {
    padding-top: 60px;
    background: rgba(255,253,245,0.98);
  }
  
  .user-info { 
    padding: 6px; 
    border-radius: 50%;
    top: 16px;
    left: 16px;
    max-width: 180px;
  }
  
  .user-name { 
    display: none; 
  }
  
  .logout-btn {
    display: none;
  }
  
  .mogu-active-btn { 
    right: 72px; 
    width: 44px; 
    height: 44px; 
    top: 16px; 
  }
  
  .mogu-chat-btn { 
    right: 16px; 
    width: 44px; 
    height: 44px; 
    top: 16px; 
  }
  
  .login-btn { 
    top: 16px; 
    left: 16px; 
    padding: 10px 20px; 
    font-size: 13px;
    border-radius: 50px;
  }
  
  .search-container { 
    flex-direction: column; 
    margin-bottom: 12px; 
    border-radius: 24px; 
    gap: 8px; 
    width: 100%;
    padding: 8px;
  }
  
  .search-engine-select { 
    width: 100%; 
    text-align: center; 
    border-radius: 16px;
    color: var(--forest);
    padding: 10px;
    font-size: 14px;
  }
  
  #search-btn { 
    width: 100%; 
    height: 44px; 
    border-radius: 16px; 
  }
  
  #search-input { 
    text-align: center; 
    width: 100%;
    font-size: 16px;
    padding: 10px;
    color: var(--text-primary);
  }
  
  .modal-btn, .notice-confirm-btn {
    padding: 12px 20px;
    font-size: 14px;
    border-radius: 16px;
  }
  
  .custom-modal, .notice-modal {
    border-radius: 28px;
    padding: 24px;
    max-width: 340px;
  }
  
  .modal-header, .notice-header {
    font-size: 18px;
  }

  .login-notice-modal {
    padding: 32px 24px;
    max-width: 320px;
  }

  .login-notice-icon {
    width: 56px;
    height: 56px;
  }

  .login-notice-icon svg {
    width: 28px;
    height: 28px;
  }

  .login-notice-title {
    font-size: 20px;
  }

  .login-notice-text {
    font-size: 14px;
  }

  .login-notice-btn {
    padding: 14px 24px;
    font-size: 15px;
  }
}

@media (max-width: 380px) {
  .search-title {
    font-size: 1.75rem;
  }
  
  .module-title {
    font-size: 11px;
  }
  
  .history-item {
    padding: 10px 14px;
    font-size: 12px;
    border-radius: 12px;
  }
}
</style>
<base target="_blank">
</head>
<body>

<div class="chinese-bg-container"></div>

<!-- Dynamic Island Container -->
<div class="dynamic-island-container" id="dynamicIslandContainer"></div>

<!-- 登录提示弹窗 -->
<div class="login-notice-overlay" id="loginNoticeOverlay"></div>
<div class="login-notice-modal" id="loginNoticeModal">
  <div class="login-notice-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
      <polyline points="10,17 15,12 10,7"></polyline>
      <line x1="15" y1="12" x2="3" y2="12"></line>
    </svg>
  </div>
  <div class="login-notice-title">未登录账号</div>
  <div class="login-notice-text">您当前未登录账号，请先登录后再使用Mg搜索功能</div>
  <button class="login-notice-btn" onclick="goToLogin()">去登录</button>
</div>

<div id="userStatusArea"></div>

<button class="mogu-active-btn float-btn liquid-glass" id="moguActiveBtn" onclick="window.location.href='active.html'">
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M2 12h20"></path><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
</button>

<button class="mogu-chat-btn float-btn liquid-glass" id="moguChatBtn">
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
</button>

<div class="mogu-chat-window liquid-glass-flat" id="moguChatWindow">
  <div class="mogu-chat-header">
    <div class="mogu-chat-title">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#E07A5F" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
      Mg茶室
    </div>
    <button class="clear-all-btn admin-only" id="clearAllMessages">清空</button>
  </div>
  <div class="mogu-chat-messages" id="moguChatMessages"></div>
  <div class="mogu-chat-input-area" id="moguChatInputArea">
    <input type="text" class="mogu-chat-input" id="moguChatInput" placeholder="输入消息..." disabled>
    <button class="mogu-chat-send" id="moguChatSend" disabled>
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
    </button>
  </div>
</div>

<div class="main-container">
  <div class="search-title">Mg搜索</div>

  <div class="search-wrapper">
    <div class="search-container">
      <div class="search-engine-wrap">
        <select class="search-engine-select" id="searchEngine">
          <option value="bing">必应</option>
          <option value="google">谷歌</option>
          <option value="baidu">百度</option>
        </select>
      </div>
      <input type="text" id="search-input" placeholder="今日欲寻何物？">
      <button id="search-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
      </button>
    </div>
  </div>

  <div class="history-rank-wrap" id="historyRankWrap">
    <div class="history-rank-container">
      <div class="history-section liquid-glass-flat">
        <div class="module-title">
          <span>近期搜索</span>
          <label class="toggle-switch">
            <input type="checkbox" id="historySwitch">
            <span class="switch-slider"></span>
          </label>
        </div>
        <ul class="history-list" id="historyList"></ul>
      </div>
    </div>
  </div>
</div>

<button class="toggle-btn float-btn liquid-glass" id="toggleBtn">
  <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
</button>

<div class="modal-mask" id="modalMask"></div>

<div class="custom-modal liquid-glass-flat" id="logoutModal">
  <div class="modal-header">退出登录</div>
  <div class="modal-content" style="color:var(--text-secondary); margin-bottom:20px; font-size:15px; line-height:1.6;">您确定要退出当前账号吗？</div>
  <div class="modal-btns">
    <button class="modal-btn cancel" id="logoutCancel">取消</button>
    <button class="modal-btn confirm" id="logoutConfirm">退出</button>
  </div>
</div>

<div class="custom-modal liquid-glass-flat" id="clearMsgModal">
  <div class="modal-header">清空消息</div>
  <div class="modal-content" style="color:var(--text-secondary); margin-bottom:20px; font-size:15px; line-height:1.6;">此操作将永久删除所有聊天记录，不可恢复。</div>
  <div class="modal-btns">
    <button class="modal-btn cancel" id="clearMsgCancel">取消</button>
    <button class="modal-btn confirm" style="background:#E07A5F;" id="clearMsgConfirm">确认清空</button>
  </div>
</div>

<div class="notice-modal liquid-glass-flat" id="noticeModal">
  <div class="notice-header">
    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#E07A5F" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
    系统公告
  </div>
  <div class="notice-content" id="noticeContent" style="text-align:left; color:var(--text-secondary); line-height:1.7; font-size:14px;"></div>
  <div class="notice-checkbox-wrap" id="noticeCheckbox" style="display:flex;align-items:center;justify-content:center;gap:8px;margin:20px 0;cursor:pointer;">
    <div class="notice-checkbox" style="width:20px;height:20px;border:2px solid #ddd;border-radius:6px;transition:0.2s; display:flex;align-items:center;justify-content:center;"></div>
    <span class="notice-checkbox-label" style="font-size:13px;color:var(--text-secondary);">不再显示此公告</span>
  </div>
  <button class="notice-confirm-btn" id="noticeConfirm">我知道了</button>
</div>

<script>
document.head.insertAdjacentHTML("beforeend", `<style>.notice-checkbox.checked{background:var(--peach);border-color:var(--peach); position:relative;} .notice-checkbox.checked::after{content:"✓";color:white;font-size:12px;font-weight:bold;}</style>`);

// ============ 配置常量 ============
const USER_DATABASE_ISSUE_NUMBER = 11;
const USER_DATABASE_REPO_OWNER = 'moguwan';
const USER_DATABASE_REPO_NAME = 'moguwan.github.io';
const USER_LOCAL_KEY = 'MOGU_CHAT_USER';
const ADMIN_ACCOUNT = '2926197119';
const GITHUB_TOKEN = ["gh","p_p","VXlo0HQ","PmMx","Ic","eM","HB","uMzm","EON","LPX","700","10","M","SL"].join('');
const REPO_OWNER = 'moguwan';
const REPO_NAME = 'mogu-chat';
const CHAT_ISSUE_NUMBER = 1;  // 聊天存储在 #1 issue
const MAP_ISSUE_NUMBER = 2;   // 用户映射在 #2 issue
const MAP_ISSUE_TITLE = "用户-专属Issue映射表";
const MAP_MARK_START = "// USER-MAP-JSON-START";
const MAP_MARK_END = "// USER-MAP-JSON-END";
const MAX_HISTORY = 10;
const MAX_MESSAGE_LENGTH = 200;
const NOTICE_LOCAL_KEY = 'MOGU_SEARCH_NOTICE';
const DEFAULT_AVATAR = "https://img.wjwj.top/2026/01/26/30abddc90230cef0bc9896ca3eafd0d3.gif";

// ============ DOM 元素 ============
const searchEngine = document.getElementById('searchEngine');
const searchInput = document.getElementById('search-input');
const searchBtn = document.getElementById('search-btn');
const historyRankWrap = document.getElementById('historyRankWrap');
const toggleBtn = document.getElementById('toggleBtn');
const historyList = document.getElementById('historyList');
const historySwitch = document.getElementById('historySwitch');
const moguChatBtn = document.getElementById('moguChatBtn');
const moguChatWindow = document.getElementById('moguChatWindow');
const moguChatMessages = document.getElementById('moguChatMessages');
const moguChatInput = document.getElementById('moguChatInput');
const moguChatSend = document.getElementById('moguChatSend');
const userStatusArea = document.getElementById('userStatusArea');
const loginNoticeModal = document.getElementById('loginNoticeModal');
const loginNoticeOverlay = document.getElementById('loginNoticeOverlay');
const dynamicIslandContainer = document.getElementById('dynamicIslandContainer');

// ============ 状态变量 ============
let alertTimer = null;
let chatOpen = false;
let lastMessageId = 0;
let chatUpdateInterval = null;
let isLoading = false;
let currentUser = null;
let isHistoryFetched = false;
let isNoticeShown = false;
let isUserValid = false;  // 用户是否通过验证

// ============ Dynamic Island Notification System ============
class DynamicIsland {
  constructor() {
    this.notifications = new Map();
    this.idCounter = 0;
  }

  generateId() {
    return `island-${++this.idCounter}-${Date.now()}`;
  }

  createIslandElement(id, options) {
    const {
      title,
      subtitle = '',
      type = 'info', // info, success, error, warning, loading
      showProgress = false,
      progress = 0,
      duration = 3000,
      compact = false
    } = options;

    const island = document.createElement('div');
    island.className = `dynamic-island ${compact ? 'compact' : ''} ${type === 'important' ? 'important' : ''}`;
    island.id = id;

    // Icon based on type
    const icons = {
      success: `<svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>`,
      error: `<svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`,
      warning: `<svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>`,
      loading: `<div class="dynamic-island-spinner"></div>`,
      info: `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>`
    };

    const iconHtml = type === 'loading' ? icons.loading : (icons[type] || icons.info);

    island.innerHTML = `
      <div class="dynamic-island-icon ${type}">
        ${iconHtml}
      </div>
      <div class="dynamic-island-content">
        <div class="dynamic-island-title">${title}</div>
        ${subtitle ? `<div class="dynamic-island-subtitle">${subtitle}</div>` : ''}
        ${showProgress ? `
          <div class="dynamic-island-progress-container">
            <div class="dynamic-island-progress-bar" style="width: ${progress}%"></div>
          </div>
        ` : ''}
      </div>
    `;

    return island;
  }

  show(options) {
    const id = this.generateId();
    const island = this.createIslandElement(id, options);
    
    dynamicIslandContainer.appendChild(island);
    this.notifications.set(id, { element: island, options });

    // Trigger animation
    requestAnimationFrame(() => {
      island.classList.add('show');
    });

    // Auto hide if duration > 0 and not loading
    if (options.duration !== 0 && options.type !== 'loading') {
      setTimeout(() => {
        this.hide(id);
      }, options.duration || 3000);
    }

    return {
      id,
      update: (newOptions) => this.update(id, newOptions),
      hide: () => this.hide(id),
      setProgress: (progress) => this.setProgress(id, progress)
    };
  }

  update(id, newOptions) {
    const notification = this.notifications.get(id);
    if (!notification) return;

    const { element, options } = notification;
    const mergedOptions = { ...options, ...newOptions };

    // Recreate content
    element.innerHTML = this.createIslandElement(id, mergedOptions).innerHTML;
    notification.options = mergedOptions;
  }

  setProgress(id, progress) {
    const notification = this.notifications.get(id);
    if (!notification) return;

    const progressBar = notification.element.querySelector('.dynamic-island-progress-bar');
    if (progressBar) {
      progressBar.style.width = `${Math.min(100, Math.max(0, progress))}%`;
    }
  }

  hide(id) {
    const notification = this.notifications.get(id);
    if (!notification) return;

    const { element } = notification;
    element.classList.remove('show');
    element.classList.add('hide');

    setTimeout(() => {
      element.remove();
      this.notifications.delete(id);
    }, 500);
  }

  // Helper methods for common use cases
  success(title, subtitle, duration = 2500) {
    return this.show({ title, subtitle, type: 'success', duration });
  }

  error(title, subtitle, duration = 3000) {
    return this.show({ title, subtitle, type: 'error', duration });
  }

  warning(title, subtitle, duration = 3000) {
    return this.show({ title, subtitle, type: 'warning', duration });
  }

  info(title, subtitle, duration = 2500) {
    return this.show({ title, subtitle, type: 'info', duration });
  }

  loading(title, subtitle = '请稍候...') {
    return this.show({ 
      title, 
      subtitle, 
      type: 'loading', 
      duration: 0, // Don't auto-hide
      showProgress: true,
      progress: 0
    });
  }

  progress(title, subtitle, initialProgress = 0) {
    return this.show({
      title,
      subtitle,
      type: 'loading',
      duration: 0,
      showProgress: true,
      progress: initialProgress
    });
  }
}

// Create global instance
const island = new DynamicIsland();

// Helper function to replace old showCustomAlert
function showCustomAlert(message, type = 'info') {
  const titles = {
    success: '操作成功',
    error: '操作失败',
    warning: '温馨提示',
    info: '系统提示'
  };
  
  island.show({
    title: titles[type] || titles.info,
    subtitle: message,
    type: type,
    duration: 2500
  });
}

// ============ 工具函数 ============
function isMobile() {
  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
}

function toggleModal(type, show) {
  const mask = document.getElementById('modalMask');
  const logoutModal = document.getElementById('logoutModal');
  const clearMsgModal = document.getElementById('clearMsgModal');
   
  if (!show) {
    mask.classList.remove('show');
    logoutModal.classList.remove('show');
    clearMsgModal.classList.remove('show');
    setTimeout(() => {
        mask.style.display = 'none';
        logoutModal.style.display = 'none';
        clearMsgModal.style.display = 'none';
    }, 300);
  } else {
    mask.style.display = 'block';
    if (type === 'logout') logoutModal.style.display = 'block';
    if (type === 'clearMsg') clearMsgModal.style.display = 'block';
    setTimeout(() => {
        mask.classList.add('show');
        if (type === 'logout') logoutModal.classList.add('show');
        if (type === 'clearMsg') clearMsgModal.classList.add('show');
    }, 10);
  }
}

// ============ 登录提示弹窗 ============
function showLoginNotice() {
  loginNoticeOverlay.style.display = 'block';
  loginNoticeModal.style.display = 'block';
  setTimeout(() => {
    loginNoticeOverlay.classList.add('show');
    loginNoticeModal.classList.add('show');
  }, 10);
}

function hideLoginNotice() {
  loginNoticeOverlay.classList.remove('show');
  loginNoticeModal.classList.remove('show');
  setTimeout(() => {
    loginNoticeOverlay.style.display = 'none';
    loginNoticeModal.style.display = 'none';
  }, 300);
}

// ============ 用户验证 - 检查账号是否存在于 #11 issue ============
async function validateUserFromGitHub(account) {
  try {
    const response = await fetch(`https://api.github.com/repos/${USER_DATABASE_REPO_OWNER}/${USER_DATABASE_REPO_NAME}/issues/${USER_DATABASE_ISSUE_NUMBER}`, {
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json' }
    });
    if (!response.ok) return false;
    const data = await response.json();
    const body = data.body || '';
    // 检查账号是否存在于issue内容中
    const lines = body.split('\n').filter(l => l.trim());
    for (const line of lines) {
      const parts = line.split('|');
      if (parts.length >= 2 && parts[0].trim() === account) {
        return true;
      }
    }
    return false;
  } catch (e) {
    console.error('验证用户失败:', e);
    return false;
  }
}

// ============ 获取用户数据库（用于获取用户信息） ============
async function getUserDatabaseFromGitHub() {
  try {
    const response = await fetch(`https://api.github.com/repos/${USER_DATABASE_REPO_OWNER}/${USER_DATABASE_REPO_NAME}/issues/${USER_DATABASE_ISSUE_NUMBER}`, {
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json' }
    });
    if (!response.ok) return [];
    const data = await response.json();
    return (data.body || '').split('\n').filter(l => l.trim()).map(line => {
      const p = line.split('|');
      if (p.length >= 2) {
        return { 
            account: p[0].trim(), 
            password: p[1].trim(), 
            email: p[2] ? p[2].trim() : '', 
            nickname: p[3] ? p[3].trim() : p[0].trim(), 
            isAdmin: p[4] ? p[4].trim().toLowerCase() === 'true' : false, 
            avatar: p[5] && p[5].trim() !== '无' ? p[5].trim() : DEFAULT_AVATAR, 
            signature: p[6] ? p[6].trim() : '人生格言思密达' 
        };
      }
      return null;
    }).filter(u => u);
  } catch { return []; }
}

// ============ 检查登录状态 ============
async function checkLoginStatus() {
  const userData = localStorage.getItem(USER_LOCAL_KEY);
  if (userData) {
    try {
      const parsedUser = JSON.parse(userData);
      // 验证用户是否存在于GitHub #11 issue
      const isValid = await validateUserFromGitHub(parsedUser.account);
      if (!isValid) {
        // 用户不存在，清除本地数据并显示登录提示
        localStorage.removeItem(USER_LOCAL_KEY);
        currentUser = null;
        isUserValid = false;
        updateUIForGuest();
        showLoginNotice();
        return false;
      }
      currentUser = parsedUser;
      isUserValid = true;
      await updateCurrentUserFromGitHub();
      currentUser.isAdmin = currentUser.account === ADMIN_ACCOUNT || currentUser.isAdmin === true;
      updateUIForLoggedInUser();
      return true;
    } catch (e) {
      currentUser = null;
      isUserValid = false;
      updateUIForGuest();
      showLoginNotice();
      return false;
    }
  }
  isUserValid = false;
  updateUIForGuest();
  showLoginNotice();
  return false;
}

function updateUIForLoggedInUser() {
  if (!currentUser) return;
  const userInitial = currentUser.nickname ? currentUser.nickname.charAt(0).toUpperCase() : 'U';
  const userAvatar = currentUser.avatar && currentUser.avatar !== '无' ? currentUser.avatar : DEFAULT_AVATAR;
  const avatarStyle = `background-image: url('${userAvatar}'); background-size: cover;`;
   
  userStatusArea.innerHTML = `
    <div class="user-info liquid-glass-flat" onclick="window.location.href='profile.html'">
      <div class="user-profile-btn" id="userProfileBtn">
        <div class="user-avatar" style="${avatarStyle}"></div>
        <div class="user-name">${currentUser.nickname || currentUser.account}</div>
      </div>
      <button class="logout-btn" id="logoutBtn">退出</button>
    </div>
  `;
  document.getElementById('logoutBtn').addEventListener('click', (e) => { e.stopPropagation(); logout(); });
  moguChatInput.disabled = false;
  moguChatInput.placeholder = "输入消息...";
  moguChatSend.disabled = false;
  updateAdminUI();
}

function updateUIForGuest() {
  userStatusArea.innerHTML = `<button class="login-btn liquid-glass-flat" onclick="goToLogin()">登录 / 注册</button>`;
  moguChatInput.disabled = true;
  moguChatInput.placeholder = "请先登录";
  moguChatSend.disabled = true;
}

function updateAdminUI() {
  const adminElements = document.querySelectorAll('.admin-only');
  if (currentUser && currentUser.isAdmin) {
    adminElements.forEach(el => el.classList.add('admin-show'));
  } else {
    adminElements.forEach(el => el.classList.remove('admin-show'));
  }
}

function goToLogin() { 
  window.location.href = 'auth.html'; 
}

function logout() { 
  toggleModal('logout', true); 
}

async function updateCurrentUserFromGitHub() {
  if (!currentUser?.account) return;
  const users = await getUserDatabaseFromGitHub();
  const user = users.find(u => u.account === currentUser.account);
  if (user) {
    Object.assign(currentUser, { 
        nickname: user.nickname, 
        email: user.email, 
        avatar: user.avatar, 
        signature: user.signature, 
        isAdmin: user.isAdmin 
    });
    localStorage.setItem(USER_LOCAL_KEY, JSON.stringify(currentUser));
    updateUIForLoggedInUser();
  }
}

// ============ 搜索历史相关 ============
function getHistorySwitchState() {
  const state = localStorage.getItem('moguHistorySwitch');
  return state === null ? true : JSON.parse(state);
}

function saveHistorySwitchState(enabled) {
  localStorage.setItem('moguHistorySwitch', JSON.stringify(enabled));
  historySwitch.checked = enabled;
}

function getSearchHistory() {
  const historyStr = localStorage.getItem('moguSearchHistory');
  return historyStr ? JSON.parse(historyStr) : [];
}

function saveSearchHistory(history) {
  localStorage.setItem('moguSearchHistory', JSON.stringify(history));
  setTimeout(renderHistory, 0);
}

function getShowState() {
  const state = localStorage.getItem('moguShowHistoryRank');
  return state === null ? true : JSON.parse(state);
}

function saveShowState(show) {
  localStorage.setItem('moguShowHistoryRank', JSON.stringify(show));
  if (show) {
    historyRankWrap.classList.remove('hidden');
    toggleBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>`;
  } else {
    historyRankWrap.classList.add('hidden');
    toggleBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>`;
  }
}

function addSearchHistory(keyword) {
  if (!getHistorySwitchState() || !keyword.trim()) return;
  keyword = keyword.trim();
  let history = getSearchHistory().filter(item => item.keyword !== keyword);
  history.unshift({ keyword: keyword, time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) });
  if (history.length > MAX_HISTORY) history.pop();
  saveSearchHistory(history);
}

function deleteHistoryItem(keyword) {
  saveSearchHistory(getSearchHistory().filter(item => item.keyword !== keyword));
}

function renderHistory() {
  if (isMobile()) return;
  const history = getSearchHistory();
  if (history.length === 0) {
    historyList.innerHTML = `<li style="text-align:center;color:var(--text-secondary);padding:16px;font-size:13px;opacity:0.7;">暂无搜索记录</li>`;
    return;
  }
  historyList.innerHTML = '';
  history.forEach((item, index) => {
    const li = document.createElement('li');
    li.className = 'history-item';
    li.style.animationDelay = `${index * 0.05}s`;
    li.innerHTML = `
      <span>${item.keyword}</span>
      <span class="time">${item.time}</span>
      <button class="delete-btn"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
    `;
    li.addEventListener('click', (e) => {
      if (e.target.closest('.delete-btn')) return;
      searchInput.value = item.keyword;
      handleSearch();
    });
    li.querySelector('.delete-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      li.style.transform = 'translateX(100%) opacity(0)';
      setTimeout(() => deleteHistoryItem(item.keyword), 300);
    });
    historyList.appendChild(li);
  });
}

// ============ 搜索功能 - 同时记录到GitHub ============
async function handleSearch() {
  const searchText = searchInput.value.trim();
  if (!searchText) {
    island.warning('搜索提示', '请输入搜索内容');
    searchInput.focus();
    return;
  }
  
  // 如果用户未登录，不允许搜索
  if (!currentUser || !isUserValid) {
    island.warning('需要登录', '请先登录后再使用搜索功能');
    showLoginNotice();
    return;
  }
  
  // Show loading island
  const loadingIsland = island.loading('正在搜索', `搜索 "${searchText.substring(0, 20)}${searchText.length > 20 ? '...' : ''}"`);
  
  const engineUrlMap = { bing: 'https://cn.bing.com/search?q=', google: 'https://www.google.com/search?q=', baidu: 'https://www.baidu.com/s?wd=' };
  
  setTimeout(() => {
    loadingIsland.setProgress(50);
  }, 100);
  
  window.open(engineUrlMap[isMobile() ? 'bing' : searchEngine.value] + encodeURIComponent(searchText), '_blank');
  searchInput.value = '';
  
  setTimeout(() => {
    loadingIsland.setProgress(100);
    setTimeout(() => {
      loadingIsland.hide();
      island.success('搜索完成', '已在新标签页打开搜索结果');
    }, 300);
  }, 400);
  
  // 记录搜索到GitHub
  await recordSearchToGitHub(searchText);
  
  if (!isMobile()) {
    setTimeout(() => {
      addSearchHistory(searchText);
    }, 0);
  }
}

// ============ 用户映射相关 ============
async function getUserMapFromGitHub() {
  try {
    const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${MAP_ISSUE_NUMBER}`, {
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json' }
    });
    if (res.status === 404) {
      // 如果映射issue不存在，创建一个新的
      await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues`, {
        method: 'POST',
        headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
        body: JSON.stringify({ title: MAP_ISSUE_TITLE, body: `${MAP_MARK_START}\n{}\n${MAP_MARK_END}`, labels: ['user-map'] })
      });
      return {};
    }
    const data = await res.json();
    const body = data.body || '';
    const jsonStart = body.indexOf(MAP_MARK_START) + MAP_MARK_START.length;
    const jsonEnd = body.indexOf(MAP_MARK_END);
    if (jsonStart === -1 || jsonEnd === -1) return {};
    return JSON.parse(body.slice(jsonStart, jsonEnd).trim()) || {};
  } catch { return {}; }
}

async function updateUserMapToGitHub(account, issueNum) {
  try {
    const map = await getUserMapFromGitHub();
    map[account] = issueNum;
    const body = `${MAP_MARK_START}\n${JSON.stringify(map, null, 2)}\n${MAP_MARK_END}`;
    await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${MAP_ISSUE_NUMBER}`, {
      method: 'PATCH',
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ body })
    });
  } catch {}
}

async function getOrCreateUserIssue(user) {
  if (!user?.account) return null;
  try {
    const map = await getUserMapFromGitHub();
    if (map[user.account]) return map[user.account];
      
    // 搜索是否已存在该用户的issue
    const searchRes = await fetch(`https://api.github.com/search/issues?q=repo:${REPO_OWNER}/${REPO_NAME}+title:"${encodeURIComponent(`【用户操作记录】${user.nickname}|${user.account}`)}"+is:issue+is:open`, {
        headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
    });
    const searchData = await searchRes.json();
    if (searchData.items?.length > 0) {
      await updateUserMapToGitHub(user.account, searchData.items[0].number);
      return searchData.items[0].number;
    }

    // 创建新的用户issue
    const createRes = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues`, {
      method: 'POST',
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        title: `【用户操作记录】${user.nickname}|${user.account}`, 
        body: `【用户操作记录】\n`, 
        labels: ['user-record'] 
      })
    });
    const createData = await createRes.json();
    if (createRes.ok) {
      await updateUserMapToGitHub(user.account, createData.number);
      return createData.number;
    }
  } catch {}
  return null;
}

// ============ 记录搜索到GitHub ============
async function recordSearchToGitHub(searchContent) {
  if (!currentUser?.account) return;
  const issueNum = await getOrCreateUserIssue(currentUser);
  if (!issueNum) return;
  
  // 格式: 2026/1/26 21:11:20|blbl
  const now = new Date();
  const timeStr = `${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()} ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
  const line = `${timeStr}|${searchContent}`;
  
  try {
    const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${issueNum}`, { 
      headers: { 'Authorization': `token ${GITHUB_TOKEN}` } 
    });
    const data = await res.json();
    await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${issueNum}`, {
      method: 'PATCH',
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ body: `${data.body || ''}\n${line}` })
    });
  } catch {}
}

// ============ 聊天功能 - 从GitHub issue #1 获取和发送消息 ============

// 格式化时间 - 格式: 26.1.24 16:01
function formatChatTime(dateStr) {
  const date = new Date(dateStr);
  const day = date.getDate();
  const month = date.getMonth() + 1;
  const year = String(date.getFullYear()).slice(-2);
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  return `${day}.${month}.${year} ${hours}:${minutes}`;
}

// 获取所有评论（用于首次加载）
async function getAllChatComments() {
  let all = [], page = 1;
  while(true) {
    try {
      const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${CHAT_ISSUE_NUMBER}/comments?per_page=100&page=${page}`, {
        headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
      });
      if(!res.ok) break;
      const data = await res.json();
      if(data.length === 0) break;
      all = all.concat(data);
      page++;
    } catch { break; }
  }
  return all;
}

// 获取最新消息（只获取比lastMessageId新的）
async function getNewChatComments() {
  try {
    // 获取最近的评论，按时间倒序
    const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${CHAT_ISSUE_NUMBER}/comments?per_page=50&page=1`, {
      headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
    });
    if (!res.ok) return [];
    const data = await res.json();
    // 过滤出新的消息
    return data.filter(m => m.id > lastMessageId).sort((a, b) => a.id - b.id);
  } catch { return []; }
}
function parseMessageBody(body) {
  let sender = 'Unknown', text = body.trim(), avatar = DEFAULT_AVATAR;
  
  if (!body) return { sender, text, avatar };
  
  // 新格式：用户名||头像URL||消息内容
  const match = body.match(/^(.+?)\|\|(.+?)\|\|(.*)$/s);
  if (match) {
    sender = match[1].trim();
    avatar = match[2].trim();
    text = match[3].trim();
    
    if (!avatar || avatar === '无' || avatar === 'null' || avatar === '') {
      avatar = DEFAULT_AVATAR;
    }
    return { sender, text, avatar };
  }
  
  // 兼容旧格式（尝试解析 username|avatar: text）
  // 只有当 | 后面跟着 http 或 // 时才认为是头像格式
  const oldFormatMatch = body.match(/^([^|]+)\|((?:https?:)?\/\/.+?):\s*(.+)$/s);
  if (oldFormatMatch) {
    sender = oldFormatMatch[1].trim();
    avatar = oldFormatMatch[2].trim();
    text = oldFormatMatch[3].trim();
    if (!avatar || avatar === '无' || avatar === 'null' || avatar === '') {
      avatar = DEFAULT_AVATAR;
    }
    return { sender, text, avatar };
  }
  
  // 最简单的格式：用户名: 消息
  const colonMatch = body.match(/^([^:]+):\s*(.+)$/s);
  if (colonMatch) {
    sender = colonMatch[1].trim();
    text = colonMatch[2].trim();
    avatar = DEFAULT_AVATAR;
  }
  
  return { sender, text, avatar };
}
function addMessageToChat(sender, text, time, type, commentId, avatar = null) {
  const div = document.createElement('div');
  div.className = `message-item ${type}`;
  div.id = `msg_${commentId || Date.now()}_${Math.random()}`;
  div.dataset.commentId = commentId || '';
  
  // 处理头像，确保有有效的URL
  let realAvatar = avatar || DEFAULT_AVATAR;
  if (realAvatar === '无' || realAvatar === 'null' || realAvatar === '') {
    realAvatar = DEFAULT_AVATAR;
  }
  // 确保头像URL有协议
  if (realAvatar.startsWith('//')) {
    realAvatar = 'https:' + realAvatar;
  }
  
  const isCurrentUser = type === 'user';
  
  // 处理消息内容
  const processedText = processMessageContent(text);
  
  // 构建HTML - 使用 createElement 更安全，避免 innerHTML 解析问题
  const avatarDiv = document.createElement('div');
  avatarDiv.className = 'message-avatar';
  avatarDiv.style.backgroundImage = `url('${realAvatar}')`;
  
  const senderSpan = document.createElement('span');
  senderSpan.className = 'message-sender';
  senderSpan.textContent = sender;
  
  const headerDiv = document.createElement('div');
  headerDiv.className = 'message-header';
  if (isCurrentUser) {
    headerDiv.style.flexDirection = 'row-reverse';
  }
  headerDiv.appendChild(avatarDiv);
  headerDiv.appendChild(senderSpan);
  
  const textDiv = document.createElement('div');
  textDiv.className = 'message-text';
  textDiv.innerHTML = processedText; // 这里用 innerHTML 因为包含 <img> 标签
  
  const timeDiv = document.createElement('div');
  timeDiv.className = 'message-time';
  timeDiv.textContent = time;
  
  div.appendChild(headerDiv);
  div.appendChild(textDiv);
  div.appendChild(timeDiv);
  
  moguChatMessages.appendChild(div);
  moguChatMessages.scrollTop = moguChatMessages.scrollHeight;
}
function processMessageContent(text) {
  if (!text) return '';
  
  // 先进行HTML转义防止XSS
  let escaped = escapeHtml(text);
  
  // 匹配图片URL - 改进版：支持 // 开头的协议相对URL
  // 匹配 http(s):// 或 // 开头的图片URL
  const imgRegex = /((?:https?:)?\/\/[^\s<>"{}|\\^`\[\]]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg|ico))|(https?:\/\/img\.[^\s<>"{}|\\^`\[\]]+)/gi;
  
  escaped = escaped.replace(imgRegex, (match) => {
    // 确保URL有协议（如果是 // 开头，添加 https:）
    let url = match;
    if (url.startsWith('//')) {
      url = 'https:' + url;
    }
    
    return `<img src="${url}" style="max-width:220px;max-height:160px;border-radius:10px;margin:6px 0;display:block;box-shadow:0 2px 8px rgba(0,0,0,0.15);" onerror="this.style.display='none';this.nextElementSibling.style.display='inline'" loading="lazy"><span style="display:none;color:inherit;opacity:0.7;">${match}</span>`;
  });
  
  return escaped;
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
function processMessage(msg) {
  const { sender, text, avatar } = parseMessageBody(msg.body);
  let type = 'other';
  if (currentUser) {
    if (sender === (currentUser.nickname || currentUser.account)) type = 'user';
  }
  const time = formatChatTime(msg.created_at);
  addMessageToChat(sender, text, time, type, msg.id, avatar);
}

// 获取聊天消息
async function fetchChatMessages() {
  if (!currentUser || !isUserValid) return;
  
  try {
    if (!isHistoryFetched) {
      // 首次加载，获取所有历史消息
      const msgs = await getAllChatComments();
      if (msgs.length > 0) {
        moguChatMessages.innerHTML = ''; // 清空现有内容
        msgs.sort((a, b) => a.id - b.id).forEach(msg => processMessage(msg));
        lastMessageId = Math.max(...msgs.map(m => m.id), 0);
        isHistoryFetched = true;
      }
    } else {
      // 只获取新消息
      const newMsgs = await getNewChatComments();
      if (newMsgs.length > 0) {
        newMsgs.forEach(msg => processMessage(msg));
        lastMessageId = Math.max(lastMessageId, ...newMsgs.map(m => m.id));
      }
    }
  } catch (e) {
    console.error('获取聊天消息失败:', e);
  }
}

// 发送聊天消息
async function sendChatMessage() {
  if (!currentUser || !isUserValid) { 
    island.warning('需要登录', '请先登录后再发送消息');
    showLoginNotice();
    return; 
  }
  
  const msg = moguChatInput.value.trim();
  if (msg.length > MAX_MESSAGE_LENGTH) { 
    island.warning('消息过长', `消息长度不能超过${MAX_MESSAGE_LENGTH}个字符`);
    return; 
  }
  if (!msg || isLoading) return;
   
  isLoading = true;
  const originalBtnContent = moguChatSend.innerHTML;
  moguChatSend.innerHTML = '<div class="loading-spinner"></div>';
  moguChatSend.disabled = true;
   
  const senderName = currentUser.nickname || currentUser.account;
  const userAvatar = currentUser.avatar || DEFAULT_AVATAR;
  const body = `${senderName}||${userAvatar}||${msg}`;
  
  // 先在本地显示消息
  const tempId = `temp_${Date.now()}`;
  const timeStr = formatChatTime(new Date());
  addMessageToChat(senderName, msg, timeStr, 'user', tempId, userAvatar);
  moguChatInput.value = '';
  
  try {
    const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${CHAT_ISSUE_NUMBER}/comments`, {
      method: 'POST',
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ body })
    });
    if (res.ok) {
      const data = await res.json();
      lastMessageId = Math.max(lastMessageId, data.id);
      // 更新临时消息的ID
      const tempEl = document.querySelector(`[data-comment-id="${tempId}"]`);
      if (tempEl) {
        tempEl.dataset.commentId = data.id;
        tempEl.id = `msg_${data.id}`;
      }
      // Success feedback removed as requested
    } else {
      island.error('发送失败', '消息发送失败，请重试');
    }
  } catch (e) {
    console.error('发送消息失败:', e);
    island.error('发送失败', '网络错误，请检查连接');
  } finally {
    isLoading = false;
    moguChatSend.innerHTML = originalBtnContent;
    moguChatSend.disabled = false;
  }
}

// 切换聊天窗口
function toggleChatWindow() {
  chatOpen = !chatOpen;
  if (chatOpen) {
    moguChatWindow.classList.add('open');
    // 打开时立即检测一次最新消息
    fetchChatMessages();
    // 开启3秒检测
    if (chatUpdateInterval) clearInterval(chatUpdateInterval);
    chatUpdateInterval = setInterval(fetchChatMessages, 3000);
  } else {
    moguChatWindow.classList.remove('open');
    // 关闭后改为15秒检测
    if (chatUpdateInterval) { 
      clearInterval(chatUpdateInterval); 
      chatUpdateInterval = setInterval(fetchChatMessages, 15000);
    }
  }
}

// ============ 事件监听 ============
document.getElementById('logoutCancel').addEventListener('click', () => toggleModal('logout', false));
document.getElementById('logoutConfirm').addEventListener('click', () => {
  toggleModal('logout', false);
  localStorage.removeItem(USER_LOCAL_KEY);
  currentUser = null;
  isUserValid = false;
  updateUIForGuest();
  island.success('已退出登录', '期待您的再次访问');
  // 退出后显示登录提示
  showLoginNotice();
});

document.getElementById('clearMsgCancel').addEventListener('click', () => toggleModal('clearMsg', false));

// Clear messages with progress island
document.getElementById('clearMsgConfirm').addEventListener('click', async () => {
  toggleModal('clearMsg', false);
  if (!currentUser?.isAdmin || isLoading) return;
  
  isLoading = true;
  const items = document.querySelectorAll('.message-item');
  const totalItems = items.length;
  
  // Create progress island
  const progressIsland = island.progress('正在清空聊天记录', `准备删除 ${totalItems} 条消息...`, 0);
  
  try {
    let processed = 0;
    let successCount = 0;
    
    for (const el of items) {
      processed++;
      const progress = Math.round((processed / totalItems) * 100);
      
      // Update progress
      progressIsland.setProgress(progress);
      progressIsland.update({
        subtitle: `正在删除第 ${processed}/${totalItems} 条消息...`
      });
      
      // Small delay to show progress
      await new Promise(resolve => setTimeout(resolve, 100));
      
      if (el.dataset.commentId && !el.dataset.commentId.startsWith('temp_')) {
        try {
          const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/comments/${el.dataset.commentId}`, {
            method: 'DELETE', 
            headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
          });
          if (res.ok) successCount++;
        } catch (err) {
          console.error('删除消息失败:', err);
        }
      }
      el.remove();
    }
    
    // Complete
    progressIsland.setProgress(100);
    progressIsland.update({
      subtitle: '清理完成'
    });
    
    setTimeout(() => {
      progressIsland.hide();
      island.success('清空完成', `成功删除 ${successCount} 条聊天记录`);
    }, 500);
    
    isHistoryFetched = false;
    lastMessageId = 0;
  } catch { 
    progressIsland.hide();
    island.error('清空失败', '删除过程中发生错误');
  } finally { 
    isLoading = false;
  }
});

document.getElementById('clearAllMessages').addEventListener('click', () => {
    if(!currentUser?.isAdmin) return;
    toggleModal('clearMsg', true);
});

searchBtn.addEventListener('click', handleSearch);
searchInput.addEventListener('keydown', e => e.key === 'Enter' && handleSearch());
moguChatBtn.addEventListener('click', toggleChatWindow);
moguChatSend.addEventListener('click', sendChatMessage);
moguChatInput.addEventListener('keydown', e => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), sendChatMessage()));

if (!isMobile()) {
  toggleBtn.addEventListener('click', () => saveShowState(!getShowState()));
  historySwitch.addEventListener('change', e => saveHistorySwitchState(e.target.checked));
}

document.addEventListener('click', e => {
  if (chatOpen && !moguChatWindow.contains(e.target) && !moguChatBtn.contains(e.target)) toggleChatWindow();
});

// ============ 公告相关 ============
const noticeContent = `<p><strong>欢迎回到Mg搜索！</strong></p>
<p style="margin-top:8px;">由于没有备份，更新时误删了账号数据...</p>
<p style="margin-top:8px;">请大家重新注册登录 ~ </p>
<p style="margin-top:8px;">新增茶室聊天功能，点击右上角进入</p>`;

function initNotice() {
  const data = localStorage.getItem(NOTICE_LOCAL_KEY);
  if (data && JSON.parse(data).dontShowAgain) return;
  document.getElementById('noticeContent').innerHTML = noticeContent;
  setTimeout(() => {
    document.getElementById('modalMask').style.display = 'block';
    document.getElementById('noticeModal').style.display = 'block';
    setTimeout(() => {
        document.getElementById('modalMask').classList.add('show');
        document.getElementById('noticeModal').classList.add('show');
    }, 10);
    isNoticeShown = true;
  }, 500);

  const checkbox = document.querySelector('.notice-checkbox');
  document.getElementById('noticeCheckbox').addEventListener('click', () => checkbox.classList.toggle('checked'));
  document.getElementById('noticeConfirm').addEventListener('click', () => {
    if (checkbox.classList.contains('checked')) localStorage.setItem(NOTICE_LOCAL_KEY, JSON.stringify({ dontShowAgain: true }));
    document.getElementById('modalMask').classList.remove('show');
    document.getElementById('noticeModal').classList.remove('show');
    setTimeout(() => {
        document.getElementById('modalMask').style.display = 'none';
        document.getElementById('noticeModal').style.display = 'none';
    }, 300);
    isNoticeShown = false;
  });
}

// ============ 初始化 ============
window.addEventListener('DOMContentLoaded', async () => {
  initNotice();
  const isLoggedIn = await checkLoginStatus();
  
  if (isLoggedIn && currentUser) {
    // 启动聊天消息检测（15秒间隔，因为窗口默认关闭）
    chatUpdateInterval = setInterval(fetchChatMessages, 15000);
    // 首次加载聊天消息
    fetchChatMessages();
  }
  
  if (isMobile()) {
    searchInput.focus();
  } else {
    saveShowState(getShowState());
    saveHistorySwitchState(getHistorySwitchState());
    renderHistory();
    searchInput.focus();
  }
  updateAdminUI();
});
</script>
</body>
</html>
