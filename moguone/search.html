<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Mogu Search - Liquid OS</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  /* iOS 26 Liquid Colors & Settings */
  --glass-base: rgba(255, 255, 255, 0.2);
  --glass-border: rgba(255, 255, 255, 0.6);
  --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
  --accent-color: #6366f1;
  --text-main: #1e293b;
  --text-sub: #475569;
  --ios-easing: cubic-bezier(0.25, 1, 0.5, 1);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
  -webkit-tap-highlight-color: transparent;
}

body {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding-top: 12vh;
  color: var(--text-main);
  overflow-x: hidden;
  /* Âü∫Á°ÄËÉåÊôØËâ≤Ôºå‰Ωú‰∏∫ÂÖâÁêÉÁöÑÁîªÂ∏É */
  background: #f8fafc; 
  position: relative;
}

/* --- Improved Liquid Background --- */
.liquid-bg {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  z-index: -1;
  overflow: hidden;
  background: #f0f4f8; /* ÊüîÂíåÁöÑÁÅ∞ËìùÂ∫ïËâ≤ */
}

.blob {
  position: absolute;
  border-radius: 50%;
  filter: blur(90px); /* Âä†Â§ßÊ®°Á≥äÂ∫¶ÔºåËÆ©È¢úËâ≤ËûçÂêà */
  opacity: 0.7;
  will-change: transform; /* ÊÄßËÉΩ‰ºòÂåñ */
}

/* È¢úËâ≤ÊñπÊ°àÔºöÊûÅÂÖâËâ≤Á≥ª (Aurora) - ÈùíËâ≤„ÄÅÁ¥´Ëâ≤„ÄÅÊ¥ãÁ∫¢ */
.blob-1 {
  top: -20%;
  left: -20%;
  width: 70vw;
  height: 70vw;
  background: radial-gradient(circle, #a78bfa 0%, #818cf8 100%); /* ËìùÁ¥´Ëâ≤ */
  animation: moveVertical 30s infinite alternate linear;
}

.blob-2 {
  bottom: -20%;
  right: -20%;
  width: 60vw;
  height: 60vw;
  background: radial-gradient(circle, #f472b6 0%, #c084fc 100%); /* Ê¥ãÁ∫¢Á¥´ */
  animation: moveHorizontal 25s infinite alternate linear;
}

.blob-3 {
  top: 30%;
  left: 30%;
  width: 50vw;
  height: 50vw;
  background: radial-gradient(circle, #22d3ee 0%, #60a5fa 100%); /* ÈùíËìùËâ≤ */
  animation: moveCircular 40s infinite linear;
  opacity: 0.5;
}

/* ÂûÇÁõ¥ÊµÅÂä®Âä®Áîª */
@keyframes moveVertical {
  0% { transform: translate3d(0, -10%, 0) scale(1); }
  50% { transform: translate3d(10%, 20%, 0) scale(1.1); }
  100% { transform: translate3d(-10%, 5%, 0) scale(0.9); }
}

/* Ê∞¥Âπ≥ÊµÅÂä®Âä®Áîª */
@keyframes moveHorizontal {
  0% { transform: translate3d(-20%, 20%, 0) rotate(0deg); }
  50% { transform: translate3d(20%, -10%, 0) rotate(20deg); }
  100% { transform: translate3d(-10%, -20%, 0) rotate(-10deg); }
}

/* ÁéØÂΩ¢ÊµÅÂä®Âä®Áîª */
@keyframes moveCircular {
  0% { transform: translate3d(-20%, -20%, 0) rotate(0deg) scale(1); }
  25% { transform: translate3d(20%, -20%, 0) rotate(90deg) scale(1.1); }
  50% { transform: translate3d(20%, 20%, 0) rotate(180deg) scale(1); }
  75% { transform: translate3d(-20%, 20%, 0) rotate(270deg) scale(0.9); }
  100% { transform: translate3d(-20%, -20%, 0) rotate(360deg) scale(1); }
}

/* --- Glassmorphism Utils --- */
.glass-panel {
  background: rgba(255, 255, 255, 0.35); /* Á®çÂæÆÂ¢ûÂä†‰∏çÈÄèÊòéÂ∫¶‰ª•Á™ÅÂá∫Á£®Á†ÇÊÑü */
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
  border-radius: 28px;
}

/* --- Main Layout --- */
.search-title {
  font-size: 4.5rem;
  font-weight: 800;
  letter-spacing: -0.05em;
  margin-bottom: 3rem;
  /* Ê†áÈ¢òÈ¢úËâ≤Ë∞ÉÊï¥‰∏∫Ê∑±Ëâ≤Ê∏êÂèòÔºåÈÅøÂÖçË¢´ËÉåÊôØÂêÉÊéâ */
  background: linear-gradient(135deg, #1e293b 0%, #4f46e5 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: 0 20px 50px rgba(99, 102, 241, 0.2);
  cursor: default;
  transition: transform 0.6s var(--ios-easing);
  position: relative;
  z-index: 10;
}

.search-title:hover {
  transform: scale(1.02);
}

.search-container {
  width: 90%;
  max-width: 720px;
  padding: 10px;
  display: flex;
  align-items: center;
  gap: 12px;
  transition: all 0.4s var(--ios-easing);
  background: rgba(255, 255, 255, 0.5); /* ÊêúÁ¥¢Ê°ÜÊõ¥‰∫Æ‰∏Ä‰∫õ */
  border: 1px solid rgba(255, 255, 255, 0.9);
  position: relative;
  z-index: 10;
}

.search-container:hover, .search-container:focus-within {
  transform: translateY(-5px) scale(1.01);
  background: rgba(255, 255, 255, 0.8);
  box-shadow: 0 20px 60px -10px rgba(99, 102, 241, 0.15);
  border-color: #fff;
}

.search-engine-wrap { position: relative; }

.search-engine-select {
  appearance: none;
  background: rgba(255, 255, 255, 0.6);
  border: none;
  padding: 12px 20px;
  font-size: 14px;
  font-weight: 700;
  color: var(--text-main);
  cursor: pointer;
  border-radius: 18px;
  transition: all 0.3s;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,0.6);
}

.search-engine-select:hover { background: #fff; }
.search-engine-select:focus { outline: none; }

#search-input {
  flex: 1;
  border: none;
  background: transparent;
  font-size: 18px;
  padding: 12px 10px;
  color: var(--text-main);
  outline: none;
  font-weight: 500;
}

#search-input::placeholder {
  color: #64748b;
  font-weight: 400;
  opacity: 0.7;
}

#search-btn {
  background: var(--text-main);
  color: white;
  border: none;
  width: 50px;
  height: 50px;
  border-radius: 20px;
  font-weight: 700;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.4s var(--ios-easing);
  box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  justify-content: center;
}

#search-btn:hover {
  transform: scale(1.1) rotate(5deg);
  background: #000;
  box-shadow: 0 15px 30px rgba(0,0,0,0.2);
}

#search-btn:active { transform: scale(0.95); }

/* --- History & Rank Modules --- */
.history-rank-wrap {
  width: 90%;
  max-width: 720px;
  margin-top: 40px;
  transition: all 0.6s var(--ios-easing);
  position: relative;
  z-index: 10;
}

.history-rank-wrap.hidden {
  opacity: 0;
  transform: translateY(40px) scale(0.95);
  pointer-events: none;
  height: 0;
  margin: 0;
}

.history-rank-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
}

.history-section, .rank-section {
  padding: 24px;
  display: flex;
  flex-direction: column;
  transition: transform 0.3s var(--ios-easing);
}

.history-section:hover, .rank-section:hover { transform: translateY(-5px); }

.module-title {
  font-size: 12px;
  font-weight: 800;
  color: var(--text-sub);
  text-transform: uppercase;
  letter-spacing: 1.5px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  opacity: 0.8;
}

.history-list, .rank-list {
  list-style: none;
  max-height: 220px;
  overflow-y: auto;
  padding-right: 6px;
}

/* Liquid Scrollbar */
::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-thumb {
  background: rgba(0,0,0,0.1);
  border-radius: 10px;
}
::-webkit-scrollbar-track { background: transparent; }

.history-item, .rank-item {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  border-radius: 16px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: all 0.3s var(--ios-easing);
  color: var(--text-main);
  font-size: 14px;
  font-weight: 600;
  background: rgba(255,255,255,0.2); /* Á®çÂæÆÂä†Ê∑±‰∏ÄÁÇπËÉåÊôØ‰ª•‰æøÈòÖËØª */
}

.history-item:hover, .rank-item:hover {
  background: rgba(255,255,255,0.8);
  transform: scale(1.02);
  box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.history-item .time {
  margin-left: auto;
  font-size: 11px;
  color: #64748b;
  margin-right: 10px;
  font-weight: 500;
}

.delete-btn {
  background: rgba(239, 68, 68, 0.1);
  border: none;
  color: #ef4444;
  cursor: pointer;
  opacity: 0;
  width: 24px;
  height: 24px;
  border-radius: 8px;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.history-item:hover .delete-btn { opacity: 1; }
.delete-btn:hover { background: #ef4444; color: white; transform: scale(1.1); }

.rank-num {
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 800;
  border-radius: 8px;
  margin-right: 12px;
  background: rgba(255,255,255,0.6);
  box-shadow: inset 0 1px 2px rgba(255,255,255,0.8);
}

.rank-item:nth-child(1) .rank-num { background: linear-gradient(135deg, #ffd700, #fdb931); color: #7c2d12; box-shadow: 0 4px 10px rgba(253, 186, 116, 0.4); }
.rank-item:nth-child(2) .rank-num { background: linear-gradient(135deg, #e0e7ff, #c7d2fe); color: #4338ca; }
.rank-item:nth-child(3) .rank-num { background: linear-gradient(135deg, #ffedd5, #fdba74); color: #9a3412; }

.rank-item .count {
  margin-left: auto;
  font-size: 11px;
  font-weight: 700;
  color: var(--accent-color);
  background: rgba(99, 102, 241, 0.1);
  padding: 4px 10px;
  border-radius: 20px;
}

/* --- Controls --- */
.toggle-switch {
  width: 44px;
  height: 24px;
  position: relative;
  display: inline-block;
}

.toggle-switch input { opacity: 0; width: 0; height: 0; }

.switch-slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: rgba(0,0,0,0.1);
  border-radius: 34px;
  transition: .4s var(--ios-easing);
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}

.switch-slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  border-radius: 50%;
  transition: .4s var(--ios-easing);
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

input:checked + .switch-slider { background-color: var(--accent-color); }
input:checked + .switch-slider:before { transform: translateX(20px); }

/* --- Floating Buttons --- */
.toggle-btn, .mogu-active-btn, .mogu-chat-btn {
  position: fixed;
  background: rgba(255, 255, 255, 0.7);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255,255,255,0.8);
  box-shadow: 0 15px 35px rgba(0,0,0,0.1);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.4s var(--ios-easing);
  z-index: 100;
}

.toggle-btn {
  bottom: 40px;
  left: 40px;
  width: 56px;
  height: 56px;
  border-radius: 22px;
}

.mogu-active-btn, .mogu-chat-btn {
  top: 30px;
  width: 50px;
  height: 50px;
  border-radius: 18px;
}

.mogu-chat-btn { right: 40px; color: var(--accent-color); }
.mogu-active-btn { right: 100px; color: #c084fc; }

.toggle-btn:hover, .mogu-active-btn:hover, .mogu-chat-btn:hover {
  transform: translateY(-4px) scale(1.1);
  background: white;
  box-shadow: 0 20px 40px rgba(0,0,0,0.15);
}

/* --- User Info --- */
.user-info {
  position: fixed;
  top: 30px;
  left: 40px;
  background: rgba(255, 255, 255, 0.65);
  backdrop-filter: blur(20px);
  padding: 6px 6px 6px 16px;
  border-radius: 50px;
  display: flex;
  align-items: center;
  gap: 12px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.05);
  border: 1px solid rgba(255,255,255,0.8);
  z-index: 1000;
  transition: transform 0.3s var(--ios-easing);
}

.user-info:hover { transform: translateY(2px) scale(1.02); background: white; }

.user-profile-btn { display: flex; align-items: center; gap: 10px; cursor: pointer; }

.user-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 2px solid white;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  background-size: cover;
  background-position: center;
}

.user-name { font-size: 14px; font-weight: 700; color: var(--text-main); }

.logout-btn {
  padding: 8px 18px;
  border-radius: 24px;
  border: none;
  background: #f1f5f9;
  color: #64748b;
  font-weight: 600;
  cursor: pointer;
  transition: 0.2s;
}

.logout-btn:hover { background: #fee2e2; color: #ef4444; }

.login-btn {
  position: fixed;
  top: 30px; left: 40px;
  padding: 12px 28px;
  border-radius: 24px;
  border: none;
  background: white;
  color: var(--accent-color);
  font-weight: 700;
  box-shadow: 0 10px 30px rgba(99, 102, 241, 0.2);
  cursor: pointer;
  transition: 0.3s var(--ios-easing);
}

.login-btn:hover { transform: scale(1.05); box-shadow: 0 15px 40px rgba(99, 102, 241, 0.3); }

/* --- Chat Window --- */
.mogu-chat-window {
  position: fixed;
  top: 100px;
  right: 40px;
  width: 380px;
  height: 600px;
  z-index: 1999;
  transform: translateX(120%) skewX(-5deg);
  opacity: 0;
  visibility: hidden;
  transition: all 0.5s var(--ios-easing);
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.mogu-chat-window.open {
  transform: translateX(0) skewX(0);
  opacity: 1;
  visibility: visible;
}

.mogu-chat-header {
  padding: 20px;
  background: rgba(255,255,255,0.4);
  border-bottom: 1px solid rgba(255,255,255,0.3);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.mogu-chat-title {
  font-weight: 800;
  color: var(--text-main);
  font-size: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.mogu-chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  background: rgba(255,255,255,0.1);
}

.message-item {
  max-width: 85%;
  padding: 14px 18px;
  font-size: 14px;
  line-height: 1.5;
  position: relative;
  word-break: break-word;
  backdrop-filter: blur(10px);
}

.message-item.other {
  align-self: flex-start;
  background: rgba(255, 255, 255, 0.8);
  border-radius: 20px 20px 20px 4px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.03);
  color: var(--text-main);
}

.message-item.user {
  align-self: flex-end;
  background: linear-gradient(135deg, #6366f1, #4f46e5);
  color: white;
  border-radius: 20px 20px 4px 20px;
  box-shadow: 0 8px 20px rgba(99, 102, 241, 0.25);
}

.mogu-chat-input-area {
  padding: 16px;
  background: rgba(255,255,255,0.7);
  display: flex;
  gap: 10px;
  border-top: 1px solid rgba(255,255,255,0.5);
}

.mogu-chat-input {
  flex: 1;
  background: white;
  border: none;
  border-radius: 14px;
  padding: 12px 16px;
  font-size: 14px;
  outline: none;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
}

.mogu-chat-send {
  background: var(--text-main);
  color: white;
  border: none;
  border-radius: 14px;
  width: 44px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: 0.3s;
}

.mogu-chat-send:hover { transform: scale(1.05); background: black; }

/* --- Modals --- */
.modal-mask {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.2);
  backdrop-filter: blur(15px);
  -webkit-backdrop-filter: blur(15px);
  z-index: 9000;
  display: none;
  opacity: 0;
  transition: opacity 0.4s ease;
}

.modal-mask.show { opacity: 1; }

.custom-modal, .notice-modal {
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -40%) scale(0.9);
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(30px) saturate(200%);
  padding: 30px;
  border-radius: 32px;
  box-shadow: 0 40px 80px -20px rgba(0,0,0,0.3), inset 0 0 0 1px rgba(255,255,255,0.5);
  width: 90%;
  max-width: 400px;
  z-index: 9001;
  display: none;
  opacity: 0;
  transition: all 0.5s var(--ios-easing);
  text-align: center;
}

.custom-modal.show, .notice-modal.show { transform: translate(-50%, -50%) scale(1); opacity: 1; }

.modal-header, .notice-header {
  font-size: 22px;
  font-weight: 800;
  margin-bottom: 16px;
  color: #0f172a;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.modal-btns { display: flex; gap: 12px; justify-content: center; margin-top: 24px; }

.modal-btn, .notice-confirm-btn {
  padding: 12px 24px;
  border-radius: 16px;
  border: none;
  font-weight: 700;
  cursor: pointer;
  font-size: 15px;
  transition: 0.3s var(--ios-easing);
}

.modal-btn.cancel { background: #f1f5f9; color: #64748b; }
.modal-btn.confirm { background: var(--text-main); color: white; box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
.modal-btn:hover, .notice-confirm-btn:hover { transform: scale(1.05); }

.notice-confirm-btn { background: var(--text-main); color: white; width: 100%; margin-top: 10px; }

.custom-alert {
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(20px);
  color: black;
  border: 1px solid white;
  box-shadow: 0 10px 40px rgba(0,0,0,0.1);
  /* Keep positioning from original */
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(-150%);
  padding: 12px 24px;
  border-radius: 50px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 600;
  z-index: 10000;
  opacity: 0;
  transition: all 0.5s var(--ios-easing);
}
.custom-alert.show { transform: translateX(-50%) translateY(0); opacity: 1; }

/* --- Mobile --- */
@media (max-width: 768px) {
  .search-title { font-size: 2.8rem; text-align: center; }
  .history-rank-container { grid-template-columns: 1fr; }
  .toggle-btn { display: none; }
  .mogu-chat-window { width: 100%; height: 100%; top: 0; right: 0; border-radius: 0; transform: translateY(100%); }
  .mogu-chat-window.open { transform: translateY(0); }
  .user-info { padding: 8px; border-radius: 20px; }
  .user-name { display: none; }
  .mogu-active-btn { right: 80px; width: 44px; height: 44px; top: 20px; }
  .mogu-chat-btn { right: 20px; width: 44px; height: 44px; top: 20px; }
  .login-btn { top: 20px; left: 20px; padding: 10px 20px; font-size: 13px; }
  .user-info { top: 20px; left: 20px; }
  .search-container { flex-direction: column; padding: 16px; border-radius: 24px; gap: 16px; }
  .search-engine-select { width: 100%; text-align: center; }
  #search-btn { width: 100%; height: 44px; border-radius: 16px; }
  #search-input { text-align: center; width: 100%; }
}

/* Spinner */
.loading-spinner {
  width: 16px; height: 16px;
  border: 2px solid rgba(255,255,255,0.3);
  border-radius: 50%; border-top-color: white;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Helpers */
.admin-only { display: none !important; }
.admin-only.admin-show { display: block !important; }
</style>
</head>
<body>

<div class="liquid-bg">
  <div class="blob blob-1"></div>
  <div class="blob blob-2"></div>
  <div class="blob blob-3"></div>
</div>

<div id="customAlert" class="custom-alert"></div>

<div id="userStatusArea"></div>

<button class="mogu-active-btn glass-panel" id="moguActiveBtn" onclick="window.location.href='active.html'">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M2 12h20"></path><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
</button>

<button class="mogu-chat-btn glass-panel" id="moguChatBtn">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
</button>

<div class="mogu-chat-window glass-panel" id="moguChatWindow">
  <div class="mogu-chat-header">
    <div class="mogu-chat-title">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
      Mogu Chat
    </div>
    <button class="clear-all-btn admin-only" id="clearAllMessages" style="border:none;background:none;color:#ef4444;font-size:12px;font-weight:700;cursor:pointer;">Ê∏ÖÁ©∫</button>
  </div>
  <div class="mogu-chat-messages" id="moguChatMessages"></div>
  <div class="mogu-chat-input-area" id="moguChatInputArea">
    <input type="text" class="mogu-chat-input" id="moguChatInput" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." disabled>
    <button class="mogu-chat-send" id="moguChatSend" disabled>
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
        <span id="sendText" style="display:none">ÂèëÈÄÅ</span>
    </button>
  </div>
</div>

<div class="search-title">Mogu_search</div>

<div class="search-container glass-panel">
  <div class="search-engine-wrap">
    <select class="search-engine-select" id="searchEngine">
      <option value="bing">Bing</option>
      <option value="google">Google</option>
      <option value="baidu">Baidu</option>
    </select>
  </div>
  <input type="text" id="search-input" placeholder="What are you looking for?">
  <button id="search-btn">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
  </button>
</div>

<div class="history-rank-wrap" id="historyRankWrap">
  <div class="history-rank-container">
    <div class="history-section glass-panel">
      <div class="module-title">
        <span>History</span>
        <label class="toggle-switch">
          <input type="checkbox" id="historySwitch">
          <span class="switch-slider"></span>
        </label>
      </div>
      <ul class="history-list" id="historyList"></ul>
    </div>
    <div class="rank-section glass-panel">
      <div class="module-title">Trending</div>
      <ul class="rank-list" id="rankList"></ul>
    </div>
  </div>
</div>

<button class="toggle-btn" id="toggleBtn">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
</button>

<div class="modal-mask" id="modalMask"></div>

<div class="custom-modal" id="logoutModal">
  <div class="modal-header">ÈÄÄÂá∫ÁôªÂΩï</div>
  <div class="modal-content" style="color:#64748b; margin-bottom:20px;">ÊÇ®Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÂΩìÂâçË¥¶Âè∑ÂêóÔºü</div>
  <div class="modal-btns">
    <button class="modal-btn cancel" id="logoutCancel">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" id="logoutConfirm">ÈÄÄÂá∫</button>
  </div>
</div>

<div class="custom-modal" id="clearMsgModal">
  <div class="modal-header">Ê∏ÖÁ©∫Ê∂àÊÅØ</div>
  <div class="modal-content" style="color:#64748b; margin-bottom:20px;">Ê≠§Êìç‰ΩúÂ∞ÜÊ∞∏‰πÖÂà†Èô§ÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÔºå‰∏çÂèØÊÅ¢Â§ç„ÄÇ</div>
  <div class="modal-btns">
    <button class="modal-btn cancel" id="clearMsgCancel">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" style="background:#ef4444;" id="clearMsgConfirm">Á°ÆËÆ§Ê∏ÖÁ©∫</button>
  </div>
</div>

<div class="notice-modal" id="noticeModal">
  <div class="notice-header">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
    Á≥ªÁªüÂÖ¨Âëä
  </div>
  <div class="notice-content" id="noticeContent" style="text-align:left; color:#475569; line-height:1.6;"></div>
  <div class="notice-checkbox-wrap" id="noticeCheckbox" style="display:flex;align-items:center;justify-content:center;gap:10px;margin:20px 0;cursor:pointer;">
    <div class="notice-checkbox" style="width:20px;height:20px;border:2px solid #cbd5e1;border-radius:6px;transition:0.2s;"></div>
    <span class="notice-checkbox-label" style="font-size:13px;color:#64748b;">‰∏çÂÜçÊòæÁ§∫Ê≠§ÂÖ¨Âëä</span>
  </div>
  <button class="notice-confirm-btn" id="noticeConfirm">ÊàëÁü•ÈÅì‰∫Ü</button>
</div>

<script>
// CSS Helper for Notice Checkbox
document.head.insertAdjacentHTML("beforeend", `<style>.notice-checkbox.checked{background:var(--text-main);border-color:var(--text-main);}</style>`);

// --- Original Logic (Unchanged) ---
const USER_DATABASE_ISSUE_NUMBER = 11;
const USER_DATABASE_REPO_OWNER = 'moguwan';
const USER_DATABASE_REPO_NAME = 'moguwan.github.io';
const USER_LOCAL_KEY = 'MOGU_CHAT_USER';
const ADMIN_ACCOUNT = '2926197119';
const GITHUB_TOKEN = ["gh","p_p","VXlo0HQ","PmMx","Ic","eM","HB","uMzm","EON","LPX","700","10","M","SL"].join('');
const REPO_OWNER = 'moguwan';
const REPO_NAME = 'mogu-chat';
const ISSUE_NUMBER = 1;
const MAP_ISSUE_NUMBER = 2;
const MAP_ISSUE_TITLE = "Áî®Êà∑-‰∏ìÂ±ûIssueÊò†Â∞ÑË°®";
const MAP_MARK_START = "// USER-MAP-JSON-START";
const MAP_MARK_END = "// USER-MAP-JSON-END";
const MAX_HISTORY = 10;
const MAX_RANK = 10;
const MAX_MESSAGE_LENGTH = 200;
const NOTICE_LOCAL_KEY = 'MOGU_SEARCH_NOTICE';
const DEFAULT_AVATAR = "https://img.wjwj.top/2026/01/26/30abddc90230cef0bc9896ca3eafd0d3.gif";

const searchEngine = document.getElementById('searchEngine');
const searchInput = document.getElementById('search-input');
const searchBtn = document.getElementById('search-btn');
const customAlert = document.getElementById('customAlert');
const historyRankWrap = document.getElementById('historyRankWrap');
const toggleBtn = document.getElementById('toggleBtn');
const historyList = document.getElementById('historyList');
const rankList = document.getElementById('rankList');
const historySwitch = document.getElementById('historySwitch');
const moguChatBtn = document.getElementById('moguChatBtn');
const moguChatWindow = document.getElementById('moguChatWindow');
const moguChatMessages = document.getElementById('moguChatMessages');
const moguChatInput = document.getElementById('moguChatInput');
const moguChatSend = document.getElementById('moguChatSend');
const sendText = document.getElementById('sendText');
const userStatusArea = document.getElementById('userStatusArea');

let alertTimer = null;
let chatOpen = false;
let lastMessageId = 0;
let chatUpdateInterval = null;
let isLoading = false;
let currentUser = null;
let isHistoryFetched = false;
let isNoticeShown = false;

function isMobile() {
  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
}

function showCustomAlert(message) {
  customAlert.textContent = message;
  customAlert.classList.add('show');
  if (alertTimer) clearTimeout(alertTimer);
  alertTimer = setTimeout(() => {
    customAlert.classList.remove('show');
  }, 2200);
}

function toggleModal(type, show) {
  const mask = document.getElementById('modalMask');
  const logoutModal = document.getElementById('logoutModal');
  const clearMsgModal = document.getElementById('clearMsgModal');
   
  if (!show) {
    mask.classList.remove('show');
    logoutModal.classList.remove('show');
    clearMsgModal.classList.remove('show');
    setTimeout(() => {
        mask.style.display = 'none';
        logoutModal.style.display = 'none';
        clearMsgModal.style.display = 'none';
    }, 300);
  } else {
    mask.style.display = 'block';
    if (type === 'logout') logoutModal.style.display = 'block';
    if (type === 'clearMsg') clearMsgModal.style.display = 'block';
    setTimeout(() => {
        mask.classList.add('show');
        if (type === 'logout') logoutModal.classList.add('show');
        if (type === 'clearMsg') clearMsgModal.classList.add('show');
    }, 10);
  }
}

async function checkLoginStatus() {
  const userData = localStorage.getItem(USER_LOCAL_KEY);
  if (userData) {
    try {
      currentUser = JSON.parse(userData);
      await updateCurrentUserFromGitHub();
      // Ensure specific user gets admin
      currentUser.isAdmin = currentUser.account === ADMIN_ACCOUNT || currentUser.isAdmin === true;
      updateUIForLoggedInUser();
      return true;
    } catch (e) {
      currentUser = null;
    }
  }
  updateUIForGuest();
  return false;
}

function updateUIForLoggedInUser() {
  if (!currentUser) return;
  const userInitial = currentUser.nickname ? currentUser.nickname.charAt(0).toUpperCase() : 'U';
  const userAvatar = currentUser.avatar && currentUser.avatar !== 'Êó†' ? currentUser.avatar : DEFAULT_AVATAR;
  const avatarStyle = `background-image: url('${userAvatar}'); background-size: cover;`;
   
  userStatusArea.innerHTML = `
    <div class="user-info">
      <div class="user-profile-btn" id="userProfileBtn">
        <div class="user-avatar" style="${avatarStyle}"></div>
        <div class="user-name">${currentUser.nickname || currentUser.account}</div>
      </div>
      <button class="logout-btn" id="logoutBtn">ÈÄÄÂá∫</button>
    </div>
  `;
  document.getElementById('userProfileBtn').addEventListener('click', () => window.location.href = 'profile.html');
  document.getElementById('logoutBtn').addEventListener('click', (e) => { e.stopPropagation(); logout(); });
  moguChatInput.disabled = false;
  moguChatInput.placeholder = "Write a message...";
  moguChatSend.disabled = false;
  updateAdminUI();
}

function updateUIForGuest() {
  userStatusArea.innerHTML = `<button class="login-btn" onclick="goToLogin()">Login / Register</button>`;
  moguChatInput.disabled = true;
  moguChatInput.placeholder = "Please login to chat";
  moguChatSend.disabled = true;
}

function updateAdminUI() {
  const adminElements = document.querySelectorAll('.admin-only');
  if (currentUser && currentUser.isAdmin) {
    adminElements.forEach(el => el.classList.add('admin-show'));
  } else {
    adminElements.forEach(el => el.classList.remove('admin-show'));
  }
}

function goToLogin() { window.location.href = 'auth.html'; }
function logout() { toggleModal('logout', true); }

function getHistorySwitchState() {
  const state = localStorage.getItem('moguHistorySwitch');
  return state === null ? true : JSON.parse(state);
}
function saveHistorySwitchState(enabled) {
  localStorage.setItem('moguHistorySwitch', JSON.stringify(enabled));
  historySwitch.checked = enabled;
}
function getSearchHistory() {
  const historyStr = localStorage.getItem('moguSearchHistory');
  return historyStr ? JSON.parse(historyStr) : [];
}
function saveSearchHistory(history) {
  localStorage.setItem('moguSearchHistory', JSON.stringify(history));
  setTimeout(renderHistory, 0);
}
function getSearchCount() {
  const countStr = localStorage.getItem('moguSearchCount');
  return countStr ? JSON.parse(countStr) : {};
}
function saveSearchCount(countMap) {
  localStorage.setItem('moguSearchCount', JSON.stringify(countMap));
  setTimeout(renderRank, 0);
}
function incrementSearchCount(keyword) {
  const countMap = getSearchCount();
  countMap[keyword] = (countMap[keyword] || 0) + 1;
  saveSearchCount(countMap);
}
function getShowState() {
  const state = localStorage.getItem('moguShowHistoryRank');
  return state === null ? true : JSON.parse(state);
}
function saveShowState(show) {
  localStorage.setItem('moguShowHistoryRank', JSON.stringify(show));
  if (show) {
    historyRankWrap.classList.remove('hidden');
    toggleBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>`;
  } else {
    historyRankWrap.classList.add('hidden');
    toggleBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.45-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>`;
  }
}

function addSearchHistory(keyword) {
  if (!getHistorySwitchState() || !keyword.trim()) return;
  keyword = keyword.trim();
  let history = getSearchHistory().filter(item => item.keyword !== keyword);
  history.unshift({ keyword: keyword, time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) });
  if (history.length > MAX_HISTORY) history.pop();
  saveSearchHistory(history);
}

function deleteHistoryItem(keyword) {
  saveSearchHistory(getSearchHistory().filter(item => item.keyword !== keyword));
  const countMap = getSearchCount();
  delete countMap[keyword];
  saveSearchCount(countMap);
}

function renderHistory() {
  if (isMobile()) return;
  const history = getSearchHistory();
  if (history.length === 0) {
    historyList.innerHTML = `<li style="text-align:center;color:#64748b;padding:10px;font-size:13px;">No history yet</li>`;
    return;
  }
  historyList.innerHTML = '';
  history.forEach(item => {
    const li = document.createElement('li');
    li.className = 'history-item';
    li.innerHTML = `
      <span>${item.keyword}</span>
      <span class="time">${item.time}</span>
      <button class="delete-btn"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
    `;
    li.addEventListener('click', (e) => {
      if (e.target.closest('.delete-btn')) return;
      searchInput.value = item.keyword;
      handleSearch();
    });
    li.querySelector('.delete-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      deleteHistoryItem(item.keyword);
    });
    historyList.appendChild(li);
  });
}

function renderRank() {
  if (isMobile()) return;
  const rankArray = Object.entries(getSearchCount()).map(([k, c]) => ({ keyword: k, count: c })).sort((a, b) => b.count - a.count).slice(0, MAX_RANK);
  if (rankArray.length === 0) {
    rankList.innerHTML = `<li style="text-align:center;color:#64748b;padding:10px;font-size:13px;">No data yet</li>`;
    return;
  }
  rankList.innerHTML = '';
  rankArray.forEach((item, index) => {
    const li = document.createElement('li');
    li.className = 'rank-item';
    li.innerHTML = `<span class="rank-num">${index + 1}</span><span>${item.keyword}</span><span class="count">${item.count}</span>`;
    li.addEventListener('click', () => {
      searchInput.value = item.keyword;
      searchInput.focus();
    });
    rankList.appendChild(li);
  });
}

function handleSearch() {
  const searchText = searchInput.value.trim();
  if (!searchText) {
    showCustomAlert('Please enter something!');
    searchInput.focus();
    return;
  }
  const engineUrlMap = { bing: 'https://cn.bing.com/search?q=', google: 'https://www.google.com/search?q=', baidu: 'https://www.baidu.com/s?wd=' };
  window.open(engineUrlMap[isMobile() ? 'bing' : searchEngine.value] + encodeURIComponent(searchText), '_blank');
  searchInput.value = '';
  if (currentUser) recordUserActionToGitHub('search', searchText);
  if (!isMobile()) {
    setTimeout(() => {
      addSearchHistory(searchText);
      incrementSearchCount(searchText);
    }, 0);
  }
}

async function getUserDatabaseFromGitHub() {
  try {
    const response = await fetch(`https://api.github.com/repos/${USER_DATABASE_REPO_OWNER}/${USER_DATABASE_REPO_NAME}/issues/${USER_DATABASE_ISSUE_NUMBER}`, {
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json' }
    });
    if (!response.ok) return [];
    const data = await response.json();
    return (data.body || '').split('\n').filter(l => l.trim()).map(line => {
      const p = line.split('|');
      // account|password|email|nickname|isAdmin|avatar|signature
      if (p.length >= 2) {
        return { 
            account: p[0].trim(), 
            password: p[1].trim(), 
            email: p[2] ? p[2].trim() : '', 
            nickname: p[3] ? p[3].trim() : p[0].trim(), 
            isAdmin: p[4] ? p[4].trim().toLowerCase() === 'true' : false, 
            avatar: p[5] && p[5].trim() !== 'Êó†' ? p[5].trim() : DEFAULT_AVATAR, 
            signature: p[6] ? p[6].trim() : '‰∫∫ÁîüÊ†ºË®ÄÊÄùÂØÜËææ' 
        };
      }
      return null;
    }).filter(u => u);
  } catch { return []; }
}

async function updateCurrentUserFromGitHub() {
  if (!currentUser?.account) return;
  const users = await getUserDatabaseFromGitHub();
  const user = users.find(u => u.account === currentUser.account);
  if (user) {
    Object.assign(currentUser, { 
        nickname: user.nickname, 
        email: user.email, 
        avatar: user.avatar, 
        signature: user.signature, 
        isAdmin: user.isAdmin 
    });
    localStorage.setItem(USER_LOCAL_KEY, JSON.stringify(currentUser));
    updateUIForLoggedInUser();
  }
}

async function getUserMapFromGitHub() {
  try {
    const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${MAP_ISSUE_NUMBER}`, {
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json' }
    });
    if (res.status === 404) {
      await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues`, {
        method: 'POST',
        headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
        body: JSON.stringify({ number: MAP_ISSUE_NUMBER, title: MAP_ISSUE_TITLE, body: `${MAP_MARK_START}\n{}\n${MAP_MARK_END}`, labels: ['user-map'] })
      });
      return {};
    }
    const data = await res.json();
    const body = data.body || '';
    const jsonStart = body.indexOf(MAP_MARK_START) + MAP_MARK_START.length;
    const jsonEnd = body.indexOf(MAP_MARK_END);
    return JSON.parse(body.slice(jsonStart, jsonEnd).trim()) || {};
  } catch { return {}; }
}

async function updateUserMapToGitHub(account, issueNum) {
  try {
    const map = await getUserMapFromGitHub();
    map[account] = issueNum;
    const body = `${MAP_MARK_START}\n${JSON.stringify(map, null, 2)}\n${MAP_MARK_END}`;
    await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${MAP_ISSUE_NUMBER}`, {
      method: 'PATCH',
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ body })
    });
  } catch {}
}

async function getOrCreateUserIssue(user) {
  if (!user?.account) return null;
  try {
    const map = await getUserMapFromGitHub();
    if (map[user.account]) return map[user.account];
      
    const searchRes = await fetch(`https://api.github.com/search/issues?q=repo:${REPO_OWNER}/${REPO_NAME}+title:"${encodeURIComponent(`${user.nickname}|${user.account}`)}"+is:issue+is:open`, {
        headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
    });
    const searchData = await searchRes.json();
    if (searchData.items?.length > 0) {
      await updateUserMapToGitHub(user.account, searchData.items[0].number);
      return searchData.items[0].number;
    }

    const createRes = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues`, {
      method: 'POST',
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ title: `${user.nickname}|${user.account}`, body: `„ÄêRecord„Äë\n${new Date().toLocaleString()}|Init`, labels: ['user-record'] })
    });
    const createData = await createRes.json();
    if (createRes.ok) {
      await updateUserMapToGitHub(user.account, createData.number);
      return createData.number;
    }
  } catch {}
  return null;
}

async function recordUserActionToGitHub(type, content = '') {
  if (!currentUser?.account) return;
  const issueNum = await getOrCreateUserIssue(currentUser);
  if (!issueNum) return;
  const line = `${new Date().toLocaleString()}|${type === 'open-page' ? 'Open Page' : content}`;
  try {
    const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${issueNum}`, { headers: { 'Authorization': `token ${GITHUB_TOKEN}` } });
    const data = await res.json();
    await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${issueNum}`, {
      method: 'PATCH',
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ body: `${data.body || ''}\n${line}` })
    });
  } catch {}
}

async function getAllComments() {
  let all = [], page = 1;
  while(true) {
    try {
      const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${ISSUE_NUMBER}/comments?per_page=100&page=${page}`, {
        headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
      });
      if(!res.ok) break;
      const data = await res.json();
      if(data.length === 0) break;
      all = all.concat(data);
      page++;
    } catch { break; }
  }
  return all;
}

function formatMessageTime(date) {
  return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function addMessageToChat(sender, text, time, type, commentId, avatar = null) {
  const div = document.createElement('div');
  div.className = `message-item ${type}`;
  div.id = `msg_${Date.now()}_${Math.random()}`;
  div.dataset.commentId = commentId;
  // Use avatar if present, else fallback
  const realAvatar = avatar && avatar !== 'Êó†' ? avatar : DEFAULT_AVATAR;
  const avatarHtml = `<div style="width:20px;height:20px;border-radius:50%;margin-right:6px;background:url('${realAvatar}') center/cover;"></div>`;
   
  div.innerHTML = `
    <div style="display:flex;align-items:center;margin-bottom:4px;opacity:0.7;font-size:11px;font-weight:700;">${avatarHtml}<div class="message-sender">${sender}</div></div>
    <div class="message-text">${text}</div>
    <div class="message-time" style="font-size:10px;opacity:0.5;margin-top:4px;text-align:right;">${time}</div>
  `;
  moguChatMessages.appendChild(div);
}

async function fetchChatMessages() {
  try {
    if (!isHistoryFetched) {
      const msgs = await getAllComments();
      if (msgs.length > 0) {
        msgs.sort((a,b) => a.id - b.id).forEach(msg => processMessage(msg));
        lastMessageId = Math.max(...msgs.map(m => m.id));
        isHistoryFetched = true;
        moguChatMessages.scrollTop = moguChatMessages.scrollHeight;
      }
    } else {
      const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${ISSUE_NUMBER}/comments?per_page=100&page=1`, { headers: { 'Authorization': `token ${GITHUB_TOKEN}` } });
      const msgs = await res.json();
      const newMsgs = msgs.filter(m => m.id > lastMessageId).sort((a,b) => a.id - b.id);
      if (newMsgs.length > 0) {
        newMsgs.forEach(msg => processMessage(msg));
        lastMessageId = Math.max(lastMessageId, ...newMsgs.map(m => m.id));
        moguChatMessages.scrollTop = moguChatMessages.scrollHeight;
      }
    }
  } catch {}
}

function processMessage(msg) {
  let sender = 'Unknown', text = msg.body.trim(), avatar = null;
  const parts = msg.body.split(': ');
  if (parts.length >= 2) {
    const sPart = parts[0].trim();
    if (sPart.includes('|')) {
      const [name, avt] = sPart.split('|');
      sender = name.trim();
      avatar = avt.trim() || DEFAULT_AVATAR;
    } else {
      sender = sPart;
    }
    text = parts.slice(1).join(': ').trim();
  }
  let type = 'other';
  if (currentUser) {
    if (sender === (currentUser.nickname || currentUser.account)) type = 'user';
  }
  addMessageToChat(sender, text, formatMessageTime(new Date(msg.created_at)), type, msg.id, avatar);
}

async function sendChatMessage() {
  if (!currentUser) { showCustomAlert('Please login first'); goToLogin(); return; }
  const msg = moguChatInput.value.trim();
  if (msg.length > MAX_MESSAGE_LENGTH) { showCustomAlert('Message too long'); return; }
  if (!msg || isLoading) return;
   
  isLoading = true;
  // Replace text with spinner
  const originalBtnContent = moguChatSend.innerHTML;
  moguChatSend.innerHTML = '<div class="loading-spinner"></div>';
  moguChatSend.disabled = true;
   
  const senderName = currentUser.nickname || currentUser.account;
  const userAvatar = currentUser.avatar || DEFAULT_AVATAR;
   
  // Format: Name|Avatar: Message
  const body = `${senderName}|${userAvatar}: ${msg}`;
  const localId = `msg_temp_${Date.now()}`;
  addMessageToChat(senderName, msg, formatMessageTime(new Date()), 'user', '', userAvatar);
  const localEl = moguChatMessages.lastElementChild;
  localEl.id = localId;
  moguChatInput.value = '';
  moguChatMessages.scrollTop = moguChatMessages.scrollHeight;

  try {
    const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${ISSUE_NUMBER}/comments`, {
      method: 'POST',
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ body })
    });
    if (res.ok) {
      const data = await res.json();
      lastMessageId = Math.max(lastMessageId, data.id);
      document.getElementById(localId).dataset.commentId = data.id;
    }
  } catch {
    showCustomAlert('Failed to send');
  } finally {
    isLoading = false;
    moguChatSend.innerHTML = originalBtnContent;
    moguChatSend.disabled = false;
  }
}

function toggleChatWindow() {
  chatOpen = !chatOpen;
  if (chatOpen) {
    moguChatWindow.classList.add('open');
    if (!chatUpdateInterval) chatUpdateInterval = setInterval(fetchChatMessages, 3000); // Changed to 3s
    fetchChatMessages();
  } else {
    moguChatWindow.classList.remove('open');
    if (chatUpdateInterval) { clearInterval(chatUpdateInterval); chatUpdateInterval = null; }
  }
}

document.getElementById('logoutCancel').addEventListener('click', () => toggleModal('logout', false));
document.getElementById('logoutConfirm').addEventListener('click', () => {
  toggleModal('logout', false);
  localStorage.removeItem(USER_LOCAL_KEY);
  currentUser = null;
  updateUIForGuest();
  showCustomAlert('Logged out');
});

document.getElementById('clearMsgCancel').addEventListener('click', () => toggleModal('clearMsg', false));
document.getElementById('clearMsgConfirm').addEventListener('click', async () => {
  toggleModal('clearMsg', false);
  if (!currentUser?.isAdmin || isLoading) return;
  isLoading = true;
  const btn = document.getElementById('clearAllMessages');
  const originalText = btn.textContent;
  btn.textContent = '...';
  try {
    const items = document.querySelectorAll('.message-item');
    for (const el of items) {
      if (el.dataset.commentId) {
        await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/comments/${el.dataset.commentId}`, {
          method: 'DELETE', headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
        });
      }
      el.remove();
    }
    showCustomAlert('Cleared all messages');
  } catch { showCustomAlert('Error clearing'); }
  finally { isLoading = false; btn.textContent = originalText; isHistoryFetched = false; }
});
document.getElementById('clearAllMessages').addEventListener('click', () => {
    if(!currentUser?.isAdmin) return;
    toggleModal('clearMsg', true);
});

searchBtn.addEventListener('click', handleSearch);
searchInput.addEventListener('keydown', e => e.key === 'Enter' && handleSearch());
moguChatBtn.addEventListener('click', toggleChatWindow);
moguChatSend.addEventListener('click', sendChatMessage);
moguChatInput.addEventListener('keydown', e => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), sendChatMessage()));
if (!isMobile()) {
  toggleBtn.addEventListener('click', () => saveShowState(!getShowState()));
  historySwitch.addEventListener('change', e => saveHistorySwitchState(e.target.checked));
}
document.addEventListener('click', e => {
  if (chatOpen && !moguChatWindow.contains(e.target) && !moguChatBtn.contains(e.target)) toggleChatWindow();
});

const noticeContent = `<p><strong>Welcome to Mogu Search!</strong></p>
<p>Áî±‰∫éÊ≤°ÊúâÂ§á‰ªΩ</p>
<p>Êõ¥Êñ∞ÁöÑÊó∂ÂÄôËØØÂà†‰∫ÜÊâÄÊúâ‰∫∫ÁöÑË¥¶Âè∑ Â§ßÂÆ∂ÈáçÊñ∞Ê≥®ÂÜåÁôªÂΩï‰∏Ä‰∏ãÂêß~üå∏</p>
<p>Êõ¥Êñ∞ËÆ∫ÂùõÂäüËÉΩ Âú®È°µÈù¢Âè≥‰∏äËßí</p>`;
function initNotice() {
  const data = localStorage.getItem(NOTICE_LOCAL_KEY);
  if (data && JSON.parse(data).dontShowAgain) return;
  document.getElementById('noticeContent').innerHTML = noticeContent;
  setTimeout(() => {
    document.getElementById('modalMask').style.display = 'block';
    document.getElementById('noticeModal').style.display = 'block';
    setTimeout(() => {
        document.getElementById('modalMask').classList.add('show');
        document.getElementById('noticeModal').classList.add('show');
    }, 10);
    isNoticeShown = true;
  }, 500);

  const checkbox = document.querySelector('.notice-checkbox');
  document.getElementById('noticeCheckbox').addEventListener('click', () => checkbox.classList.toggle('checked'));
  document.getElementById('noticeConfirm').addEventListener('click', () => {
    if (checkbox.classList.contains('checked')) localStorage.setItem(NOTICE_LOCAL_KEY, JSON.stringify({ dontShowAgain: true }));
    document.getElementById('modalMask').classList.remove('show');
    document.getElementById('noticeModal').classList.remove('show');
    setTimeout(() => {
        document.getElementById('modalMask').style.display = 'none';
        document.getElementById('noticeModal').style.display = 'none';
    }, 300);
    isNoticeShown = false;
  });
}

window.addEventListener('DOMContentLoaded', async () => {
  initNotice();
  await checkLoginStatus();
  if (currentUser) recordUserActionToGitHub('open-page');
  if (isMobile()) {
    searchInput.focus();
  } else {
    saveShowState(getShowState());
    saveHistorySwitchState(getHistorySwitchState());
    renderHistory();
    renderRank();
    searchInput.focus();
  }
  fetchChatMessages();
  updateAdminUI();
});
</script>
</body>
</html>
