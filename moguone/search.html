
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人信息设置 - Mogu Search</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Inter", "SF Pro Display", "Microsoft YaHei", sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .profile-container {
            width: 100%;
            max-width: 500px;
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }
        
        .profile-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .profile-title {
            font-size: 28px;
            font-weight: 600;
            color: #0078d4;
            margin-bottom: 8px;
        }
        
        .profile-subtitle {
            color: #64748b;
            font-size: 14px;
        }
        
        .profile-form {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-label {
            font-size: 14px;
            font-weight: 500;
            color: #2d3748;
        }
        
        .form-input {
            padding: 14px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            color: #2d3748;
            outline: none;
            transition: all 0.2s ease;
            background: #ffffff;
        }
        
        .form-input:focus {
            border-color: #0078d4;
            box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
        }
        
        .avatar-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin: 0 auto 16px;
            overflow: hidden;
            border: 3px solid #e2e8f0;
            background: linear-gradient(135deg, #0078d4 0%, #0066b8 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 36px;
            font-weight: bold;
        }
        
        .avatar-preview.has-avatar {
            background-size: cover;
            background-position: center;
        }
        
        .avatar-hint {
            font-size: 12px;
            color: #94a3b8;
            text-align: center;
            margin-top: 4px;
        }
        
        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #0078d4 0%, #0066b8 100%);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #0066b8 0%, #005599 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 120, 212, 0.2);
        }
        
        .btn-secondary {
            background: #f1f5f9;
            color: #64748b;
        }
        
        .btn-secondary:hover {
            background: #e2e8f0;
            transform: translateY(-1px);
        }
        
        .custom-alert {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(-30px);
            background-color: #fff;
            border: 1px solid #ff8080;
            color: #dc2626;
            padding: 14px 28px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(255, 128, 128, 0.12);
            font-size: 16px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 9999;
            cursor: default;
        }
        
        .custom-alert.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }
        
        .success {
            border: 1px solid #34d399;
            color: #10b981;
            box-shadow: 0 6px 20px rgba(52, 211, 153, 0.12);
        }
        
        .back-link {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #0078d4;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 16px;
            }
            
            .profile-container {
                padding: 24px 20px;
            }
            
            .profile-title {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <a href="search.html" class="back-link">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
        </svg>
        返回搜索页面
    </a>
    
    <div class="profile-container">
        <div class="profile-header">
            <h1 class="profile-title">个人信息设置</h1>
            <p class="profile-subtitle">修改您的个人信息</p>
        </div>
        
        <form class="profile-form" id="profileForm">
            <div class="form-group">
                <div class="avatar-preview" id="avatarPreview">
                    <!-- 头像预览 -->
                </div>
                <p class="avatar-hint">点击下方输入框修改头像链接</p>
            </div>
            
            <div class="form-group">
                <label for="username" class="form-label">用户名</label>
                <input type="text" id="username" class="form-input" placeholder="请输入用户名" required>
            </div>
            
            <div class="form-group">
                <label for="avatar" class="form-label">头像链接</label>
                <input type="text" id="avatar" class="form-input" placeholder="请输入头像图片链接（支持 jpg, png, gif）">
                <p class="avatar-hint">例如：https://example.com/avatar.jpg</p>
            </div>
            
            <div class="form-group">
                <label for="signature" class="form-label">个性签名</label>
                <input type="text" id="signature" class="form-input" placeholder="请输入个性签名">
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="cancelBtn">取消</button>
                <button type="submit" class="btn btn-primary" id="saveBtn">保存设置</button>
            </div>
        </form>
    </div>
    
    <div class="custom-alert" id="customAlert">提示信息</div>
    
    <script>
        // 常量定义
        const USER_LOCAL_KEY = 'MOGU_CHAT_USER';
        const GITHUB_TOKEN = ["gh","p_p","VXlo0HQ","PmMx","Ic","eM","HB","uMzm","EON","LPX","700","10","M","SL"].join('');
        const USER_DATABASE_REPO_OWNER = 'moguwan';
        const USER_DATABASE_REPO_NAME = 'moguwan.github.io';
        const USER_DATABASE_ISSUE_NUMBER = 11;
        
        const customAlert = document.getElementById('customAlert');
        let alertTimer = null;
        let currentUser = null;
        
        // 从GitHub Issue #11获取所有用户数据
        async function getUserDatabaseFromGitHub() {
          try {
            const response = await fetch(
              `https://api.github.com/repos/${USER_DATABASE_REPO_OWNER}/${USER_DATABASE_REPO_NAME}/issues/${USER_DATABASE_ISSUE_NUMBER}`,
              {
                headers: {
                  'Authorization': `token ${GITHUB_TOKEN}`,
                  'Accept': 'application/vnd.github.v3+json'
                }
              }
            );
        
            if (!response.ok) {
              console.error('获取用户数据库失败:', response.status);
              return [];
            }
        
            const issueData = await response.json();
            const body = issueData.body || '';
            
            // 按行解析用户数据
            const lines = body.split('\n').filter(line => line.trim() !== '');
            const users = [];
            
            for (const line of lines) {
              const parts = line.split('|').map(p => p.trim());
              // 只要有前5个核心字段就解析
              if (parts.length >= 5) {
                let avatar = '';
                let signature = '正常'; // 默认值，和现有数据一致
                
                // 处理第6个及以后的字段
                if (parts.length >= 6) {
                  // 判断第6个部分是否是头像链接（包含http/https）
                  if (parts[5].startsWith('http')) {
                    avatar = parts[5];
                    // 如果有第7个部分，用它作为signature
                    if (parts.length >= 7) {
                      signature = parts[6];
                    }
                  } else {
                    // 第6个部分不是链接，作为signature
                    signature = parts[5];
                  }
                }
                
                const user = {
                  account: parts[0],
                  password: parts[1],
                  email: parts[2],
                  nickname: parts[3],
                  isAdmin: parts[4].toLowerCase() === 'true',
                  avatar: avatar,
                  signature: signature
                };
                users.push(user);
              }
            }
            
            console.log(`从GitHub获取到${users.length}个用户数据`);
            return users;
          } catch (error) {
            console.error('获取用户数据库异常:', error);
            return [];
          }
        }

        // 更新GitHub Issue #11中的用户数据
        async function updateUserDatabaseInGitHub(users) {
          try {
            // 将用户数据转换为文本格式（修复：移除末尾多余的|，统一格式）
            const userLines = users.map(user => 
              `${user.account}|${user.password}|${user.email}|${user.nickname}|${user.isAdmin}|${user.avatar || ''}|${user.signature || '正常'}`
            ).join('\n');
            
            const response = await fetch(
              `https://api.github.com/repos/${USER_DATABASE_REPO_OWNER}/${USER_DATABASE_REPO_NAME}/issues/${USER_DATABASE_ISSUE_NUMBER}`,
              {
                method: 'PATCH',
                headers: {
                  'Authorization': `token ${GITHUB_TOKEN}`,
                  'Accept': 'application/vnd.github.v3+json',
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  body: userLines
                })
              }
            );
        
            if (response.ok) {
              console.log('用户数据库更新成功');
              return true;
            } else {
              console.error('更新用户数据库失败:', await response.json());
              return false;
            }
          } catch (error) {
            console.error('更新用户数据库异常:', error);
            return false;
          }
        }

        // 从GitHub数据库获取单个用户完整信息
        async function getCompleteUserInfoFromGitHub(account) {
          try {
            const users = await getUserDatabaseFromGitHub();
            const user = users.find(u => u.account === account);
            return user || null;
          } catch (error) {
            console.error('获取用户完整信息失败:', error);
            return null;
          }
        }

        // 更新当前用户在GitHub数据库中的信息
        async function updateCurrentUserInGitHub() {
          if (!currentUser || !currentUser.account) return false;
          
          try {
            // 获取所有用户
            const users = await getUserDatabaseFromGitHub();
            
            // 找到当前用户的索引
            const userIndex = users.findIndex(u => u.account === currentUser.account);
            
            if (userIndex === -1) {
              console.error('在用户数据库中未找到当前用户');
              return false;
            }
            
            // 更新用户信息（保留密码和邮箱，只更新可修改的字段）
            users[userIndex].nickname = currentUser.nickname || currentUser.account;
            users[userIndex].avatar = currentUser.avatar || '';
            users[userIndex].signature = currentUser.signature || '';
            
            // 更新到GitHub
            const success = await updateUserDatabaseInGitHub(users);
            return success;
          } catch (error) {
            console.error('更新用户到GitHub失败:', error);
            return false;
          }
        }
        
        // 检查登录状态
        async function checkLoginStatus() {
            const userData = localStorage.getItem(USER_LOCAL_KEY);
            if (userData) {
                try {
                    currentUser = JSON.parse(userData);
                    
                    // 从GitHub获取完整用户信息并更新本地数据
                    const completeUserInfo = await getCompleteUserInfoFromGitHub(currentUser.account);
                    if (completeUserInfo) {
                        // 保留原有的密码和登录状态
                        currentUser.nickname = completeUserInfo.nickname;
                        currentUser.email = completeUserInfo.email;
                        currentUser.avatar = completeUserInfo.avatar;
                        currentUser.signature = completeUserInfo.signature;
                        currentUser.isAdmin = completeUserInfo.isAdmin;
                        
                        // 更新本地存储
                        localStorage.setItem(USER_LOCAL_KEY, JSON.stringify(currentUser));
                    }
                    
                    return true;
                } catch (e) {
                    console.error('解析用户数据失败:', e);
                    showCustomAlert('用户数据异常，请重新登录', 'error');
                    setTimeout(() => {
                        window.location.href = 'auth.html';
                    }, 1500);
                    return false;
                }
            } else {
                showCustomAlert('请先登录', 'error');
                setTimeout(() => {
                    window.location.href = 'auth.html';
                }, 1500);
                return false;
            }
        }
        
        // 加载用户数据到表单
        function loadUserData() {
            if (!currentUser) return;
            
            document.getElementById('username').value = currentUser.nickname || currentUser.account || '';
            document.getElementById('avatar').value = currentUser.avatar || '';
            document.getElementById('signature').value = currentUser.signature || '';
            
            updateAvatarPreview();
        }
        
        // 更新头像预览
        function updateAvatarPreview() {
            const avatarPreview = document.getElementById('avatarPreview');
            const avatarUrl = document.getElementById('avatar').value.trim();
            const username = document.getElementById('username').value.trim() || currentUser.account;
            
            if (avatarUrl) {
                // 有头像链接，设置为背景图片
                avatarPreview.style.backgroundImage = `url('${avatarUrl}')`;
                avatarPreview.classList.add('has-avatar');
                avatarPreview.textContent = '';
            } else {
                // 没有头像，显示首字母
                avatarPreview.style.backgroundImage = '';
                avatarPreview.classList.remove('has-avatar');
                const initial = username ? username.charAt(0).toUpperCase() : 'U';
                avatarPreview.textContent = initial;
            }
        }
        
        // 显示提示信息
        function showCustomAlert(message, type = 'error') {
            customAlert.textContent = message;
            customAlert.className = 'custom-alert';
            customAlert.classList.add('show');
            if (type === 'success') {
                customAlert.classList.add('success');
            }
            
            if (alertTimer) clearTimeout(alertTimer);
            alertTimer = setTimeout(() => {
                customAlert.classList.remove('show');
            }, 3000);
        }
        
        // 验证头像链接
        function validateAvatarUrl(url) {
            if (!url.trim()) return true; // 空链接也是有效的（表示不使用头像）
            
            // 简单的URL验证
            try {
                const urlObj = new URL(url);
                // 检查是否有效的图片URL（常见图片格式）
                const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.svg'];
                const hasImageExtension = imageExtensions.some(ext => 
                    urlObj.pathname.toLowerCase().endsWith(ext)
                );
                
                if (!hasImageExtension) {
                    showCustomAlert('请提供有效的图片链接（支持 jpg, png, gif, webp, svg 格式）', 'error');
                    return false;
                }
                
                return true;
            } catch (e) {
                showCustomAlert('请输入有效的图片链接地址', 'error');
                return false;
            }
        }
        
        // 保存用户信息
        async function saveUserData(e) {
            e.preventDefault();
            
            if (!currentUser) return;
            
            const username = document.getElementById('username').value.trim();
            const avatarUrl = document.getElementById('avatar').value.trim();
            const signature = document.getElementById('signature').value.trim();
            
            if (!username) {
                showCustomAlert('用户名不能为空', 'error');
                return;
            }
            
            if (!validateAvatarUrl(avatarUrl)) {
                return;
            }
            
            // 显示保存中状态
            const saveBtn = document.getElementById('saveBtn');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = '保存中...';
            saveBtn.disabled = true;
            
            // 更新当前用户信息
            currentUser.nickname = username;
            currentUser.avatar = avatarUrl;
            currentUser.signature = signature;
            
            try {
                // 1. 更新到GitHub数据库
                const gitHubSuccess = await updateCurrentUserInGitHub();
                
                if (!gitHubSuccess) {
                    showCustomAlert('保存到服务器失败，请重试', 'error');
                    saveBtn.textContent = originalText;
                    saveBtn.disabled = false;
                    return;
                }
                
                // 2. 更新本地存储
                localStorage.setItem(USER_LOCAL_KEY, JSON.stringify(currentUser));
                
                showCustomAlert('个人信息保存成功！', 'success');
                
                // 延迟返回，让用户看到成功提示
                setTimeout(() => {
                    window.location.href = 'search.html';
                }, 1500);
                
            } catch (error) {
                console.error('保存用户信息失败:', error);
                showCustomAlert('保存失败，请检查网络连接', 'error');
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            }
        }
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', async () => {
            // 检查登录状态
            const isLoggedIn = await checkLoginStatus();
            if (isLoggedIn) {
                loadUserData();
            }
            
            // 头像输入框变化时更新预览
            document.getElementById('avatar').addEventListener('input', updateAvatarPreview);
            
            // 用户名输入框变化时更新预览（如果没有头像）
            document.getElementById('username').addEventListener('input', () => {
                const avatarUrl = document.getElementById('avatar').value.trim();
                if (!avatarUrl) {
                    updateAvatarPreview();
                }
            });
            
            // 表单提交
            document.getElementById('profileForm').addEventListener('submit', saveUserData);
            
            // 取消按钮
            document.getElementById('cancelBtn').addEventListener('click', () => {
                window.location.href = 'search.html';
            });
            
            // 头像链接输入框添加示例
            document.getElementById('avatar').addEventListener('focus', function() {
                if (!this.value) {
                    this.placeholder = '例如：https://img.wjwj.top/2026/01/26/30abddc90230cef0bc9896ca3eafd0d3.gif';
                }
            });
        });
    </script>
</body>
</html>
