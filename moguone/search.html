<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mogu Search</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #6366f1;
  --primary-hover: #4f46e5;
  --bg-color: #f8fafc;
  --glass-bg: rgba(255, 255, 255, 0.75);
  --glass-border: rgba(255, 255, 255, 0.8);
  --glass-shadow: 0 10px 40px -10px rgba(0,0,0,0.05);
  --text-main: #1e293b;
  --text-sub: #64748b;
  --ease-spring: cubic-bezier(0.25, 0.8, 0.25, 1);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
  -webkit-font-smoothing: antialiased;
}

body {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding-top: 14vh;
  background-color: var(--bg-color);
  color: var(--text-main);
  position: relative;
  overflow-x: hidden;
}

.ambient-bg {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  z-index: -1;
  overflow: hidden;
  background: radial-gradient(circle at 0% 0%, #e0e7ff 0%, transparent 50%), radial-gradient(circle at 100% 100%, #f3e8ff 0%, transparent 50%);
}

.orb {
  position: absolute;
  border-radius: 50%;
  filter: blur(80px);
  opacity: 0.6;
  animation: floatOrb 20s infinite ease-in-out;
}

.orb-1 {
  width: 400px;
  height: 400px;
  background: #818cf8;
  top: -100px;
  left: -100px;
  animation-delay: 0s;
}

.orb-2 {
  width: 300px;
  height: 300px;
  background: #c084fc;
  bottom: 10%;
  right: -50px;
  animation-delay: -5s;
}

@keyframes floatOrb {
  0%, 100% { transform: translate(0, 0) scale(1); }
  33% { transform: translate(30px, 50px) scale(1.1); }
  66% { transform: translate(-20px, 20px) scale(0.9); }
}

.search-title {
  font-size: 4rem;
  font-weight: 800;
  letter-spacing: -0.04em;
  background: linear-gradient(135deg, #4f46e5 0%, #9333ea 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 2.5rem;
  text-shadow: 0 20px 40px rgba(99, 102, 241, 0.15);
  cursor: default;
  transition: transform 0.6s var(--ease-spring);
}

.search-title:hover {
  transform: scale(1.02);
}

.search-container {
  width: 100%;
  max-width: 720px;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 24px;
  padding: 8px;
  display: flex;
  align-items: center;
  gap: 12px;
  box-shadow: var(--glass-shadow);
  transition: all 0.4s var(--ease-spring);
}

.search-container:focus-within {
  transform: translateY(-4px);
  box-shadow: 0 20px 50px -10px rgba(79, 70, 229, 0.15);
  background: rgba(255, 255, 255, 0.9);
  border-color: #fff;
}

.search-engine-wrap {
  position: relative;
}

.search-engine-select {
  appearance: none;
  background: transparent;
  border: none;
  padding: 14px 24px;
  font-size: 15px;
  font-weight: 600;
  color: var(--text-main);
  cursor: pointer;
  border-radius: 16px;
  transition: background 0.2s;
}

.search-engine-select:hover {
  background: rgba(0,0,0,0.03);
}

.search-engine-select:focus {
  outline: none;
}

#search-input {
  flex: 1;
  border: none;
  background: transparent;
  font-size: 17px;
  padding: 12px 0;
  color: var(--text-main);
  outline: none;
  font-weight: 500;
}

#search-input::placeholder {
  color: #94a3b8;
  font-weight: 400;
}

#search-btn {
  background: linear-gradient(135deg, #6366f1, #4f46e5);
  color: white;
  border: none;
  padding: 14px 32px;
  border-radius: 18px;
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.3s var(--ease-spring);
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

#search-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
}

#search-btn:active {
  transform: scale(0.95);
}

.history-rank-wrap {
  width: 100%;
  max-width: 720px;
  margin-top: 40px;
  transition: all 0.5s var(--ease-spring);
  opacity: 1;
  transform: translateY(0);
}

.history-rank-wrap.hidden {
  opacity: 0;
  transform: translateY(20px);
  pointer-events: none;
  height: 0;
  margin: 0;
}

.history-rank-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
}

.history-section, .rank-section {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 24px;
  padding: 24px;
  box-shadow: var(--glass-shadow);
  display: flex;
  flex-direction: column;
}

.module-title {
  font-size: 13px;
  font-weight: 700;
  color: #94a3b8;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.history-list, .rank-list {
  list-style: none;
  max-height: 200px;
  overflow-y: auto;
  padding-right: 4px;
}

::-webkit-scrollbar {
  width: 4px;
}
::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 4px;
}
::-webkit-scrollbar-track {
  background: transparent;
}

.history-item, .rank-item {
  display: flex;
  align-items: center;
  padding: 10px 12px;
  border-radius: 12px;
  margin-bottom: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
  color: var(--text-main);
  font-size: 14px;
  font-weight: 500;
}

.history-item:hover, .rank-item:hover {
  background: rgba(255,255,255,0.8);
  transform: translateX(2px);
}

.history-item .time {
  margin-left: auto;
  font-size: 11px;
  color: #94a3b8;
  margin-right: 8px;
}

.delete-btn {
  background: none;
  border: none;
  color: #ef4444;
  cursor: pointer;
  opacity: 0;
  padding: 4px;
  border-radius: 6px;
  transition: all 0.2s;
  display: flex;
}

.history-item:hover .delete-btn {
  opacity: 1;
}

.delete-btn:hover {
  background: #fee2e2;
}

.rank-num {
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: 700;
  border-radius: 6px;
  margin-right: 10px;
  background: #f1f5f9;
  color: #64748b;
}

.rank-item:nth-child(1) .rank-num { background: #fcd34d; color: #78350f; }
.rank-item:nth-child(2) .rank-num { background: #e2e8f0; color: #475569; }
.rank-item:nth-child(3) .rank-num { background: #fdba74; color: #7c2d12; }

.rank-item .count {
  margin-left: auto;
  font-size: 11px;
  font-weight: 600;
  color: var(--primary);
  background: rgba(99, 102, 241, 0.1);
  padding: 2px 8px;
  border-radius: 10px;
}

.toggle-switch {
  width: 36px;
  height: 20px;
  position: relative;
  display: inline-block;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.switch-slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: #cbd5e1;
  border-radius: 34px;
  transition: .3s var(--ease-spring);
}

.switch-slider:before {
  position: absolute;
  content: "";
  height: 16px;
  width: 16px;
  left: 2px;
  bottom: 2px;
  background-color: white;
  border-radius: 50%;
  transition: .3s var(--ease-spring);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

input:checked + .switch-slider {
  background-color: var(--primary);
}

input:checked + .switch-slider:before {
  transform: translateX(16px);
}

.toggle-btn {
  position: fixed;
  bottom: 40px;
  left: 40px;
  width: 48px;
  height: 48px;
  border-radius: 16px;
  background: white;
  border: none;
  box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.4s var(--ease-spring);
  z-index: 100;
}

.toggle-btn:hover {
  transform: translateY(-4px) rotate(5deg);
  box-shadow: 0 15px 35px rgba(0,0,0,0.15);
}

.toggle-btn svg {
  fill: #64748b;
  transition: fill 0.3s;
}

.toggle-btn:hover svg {
  fill: var(--primary);
}

.user-info {
  position: fixed;
  top: 30px;
  left: 40px;
  background: white;
  padding: 6px 6px 6px 16px;
  border-radius: 50px;
  display: flex;
  align-items: center;
  gap: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.06);
  z-index: 1000;
  transition: transform 0.3s var(--ease-spring);
}

.user-info:hover {
  transform: translateY(2px) scale(1.02);
}

.user-profile-btn {
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
}

.user-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #e2e8f0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  color: #64748b;
  font-size: 12px;
}

.user-name {
  font-size: 14px;
  font-weight: 600;
  color: var(--text-main);
}

.logout-btn, .login-btn {
  border: none;
  border-radius: 20px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  transition: all 0.2s;
}

.logout-btn {
  padding: 8px 16px;
  background: #f1f5f9;
  color: #64748b;
}

.logout-btn:hover {
  background: #fee2e2;
  color: #ef4444;
}

.login-btn {
  position: fixed;
  top: 30px;
  left: 40px;
  padding: 10px 24px;
  background: white;
  color: var(--primary);
  box-shadow: 0 4px 15px rgba(0,0,0,0.05);
  z-index: 1000;
}

.login-btn:hover {
  transform: translateY(2px);
  box-shadow: 0 8px 25px rgba(99, 102, 241, 0.15);
}

.mogu-chat-btn {
  position: fixed;
  top: 30px;
  right: 40px;
  width: 56px;
  height: 56px;
  border-radius: 18px;
  background: white;
  border: none;
  color: var(--primary);
  cursor: pointer;
  box-shadow: 0 10px 30px rgba(99, 102, 241, 0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  transition: all 0.4s var(--ease-spring);
}

.mogu-chat-btn:hover {
  transform: scale(1.05) rotate(5deg);
  background: var(--primary);
  color: white;
}

.mogu-chat-window {
  position: fixed;
  top: 100px;
  right: 40px;
  width: 360px;
  height: 600px;
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border-radius: 24px;
  box-shadow: 0 30px 60px rgba(0,0,0,0.15);
  border: 1px solid rgba(255,255,255,0.8);
  display: flex;
  flex-direction: column;
  z-index: 1999;
  transform: translateY(20px) scale(0.95);
  opacity: 0;
  visibility: hidden;
  transition: all 0.4s var(--ease-spring);
  overflow: hidden;
}

.mogu-chat-window.open {
  transform: translateY(0) scale(1);
  opacity: 1;
  visibility: visible;
}

.mogu-chat-header {
  padding: 20px;
  background: rgba(255,255,255,0.5);
  border-bottom: 1px solid rgba(0,0,0,0.05);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.mogu-chat-title {
  font-weight: 700;
  color: var(--text-main);
  display: flex;
  align-items: center;
  gap: 8px;
}

.clear-all-btn {
  font-size: 11px;
  padding: 4px 10px;
  background: #fee2e2;
  color: #ef4444;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  font-weight: 600;
  transition: 0.2s;
}

.clear-all-btn:hover {
  background: #ef4444;
  color: white;
}

.mogu-chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  background: #f8fafc;
}

.message-item {
  max-width: 80%;
  padding: 12px 16px;
  font-size: 14px;
  line-height: 1.5;
  position: relative;
  word-break: break-word;
}

.message-item.other {
  align-self: flex-start;
  background: white;
  border-radius: 18px 18px 18px 4px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  color: var(--text-main);
}

.message-item.user {
  align-self: flex-end;
  background: var(--primary);
  color: white;
  border-radius: 18px 18px 4px 18px;
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

.message-sender {
  font-size: 10px;
  margin-bottom: 2px;
  opacity: 0.7;
  font-weight: 700;
}

.message-time {
  font-size: 10px;
  opacity: 0.5;
  margin-top: 4px;
  text-align: right;
}

.mogu-chat-input-area {
  padding: 16px;
  background: white;
  display: flex;
  gap: 10px;
  border-top: 1px solid #f1f5f9;
}

.mogu-chat-input {
  flex: 1;
  background: #f1f5f9;
  border: none;
  border-radius: 12px;
  padding: 12px 16px;
  font-size: 14px;
  outline: none;
  transition: 0.2s;
}

.mogu-chat-input:focus {
  background: white;
  box-shadow: 0 0 0 2px #e2e8f0;
}

.mogu-chat-send {
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 12px;
  padding: 0 20px;
  font-weight: 600;
  cursor: pointer;
  transition: 0.2s;
}

.mogu-chat-send:hover {
  background: var(--primary-hover);
}

.modal-mask {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(30, 41, 59, 0.4);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  z-index: 9000;
  display: none;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.modal-mask.show {
  opacity: 1;
}

.custom-modal, .notice-modal {
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -40%) scale(0.95);
  background: white;
  padding: 30px;
  border-radius: 24px;
  box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
  width: 90%;
  max-width: 400px;
  z-index: 9001;
  display: none;
  opacity: 0;
  transition: all 0.4s var(--ease-spring);
  text-align: center;
}

.custom-modal.show, .notice-modal.show {
  transform: translate(-50%, -50%) scale(1);
  opacity: 1;
}

.modal-header, .notice-header {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 12px;
  color: #0f172a;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.modal-content, .notice-content {
  color: #64748b;
  font-size: 15px;
  line-height: 1.6;
  margin-bottom: 24px;
}

.modal-btns {
  display: flex;
  gap: 12px;
  justify-content: center;
}

.modal-btn {
  padding: 10px 24px;
  border-radius: 12px;
  border: none;
  font-weight: 600;
  cursor: pointer;
  font-size: 14px;
  transition: 0.2s;
}

.modal-btn.cancel {
  background: #f1f5f9;
  color: #64748b;
}

.modal-btn.cancel:hover {
  background: #e2e8f0;
}

.modal-btn.confirm {
  background: var(--primary);
  color: white;
}

.modal-btn.confirm:hover {
  background: var(--primary-hover);
}

.modal-btn.confirm.danger {
  background: #ef4444;
}

.modal-btn.confirm.danger:hover {
  background: #dc2626;
}

.notice-checkbox-wrap {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin-bottom: 20px;
  cursor: pointer;
}

.notice-checkbox {
  width: 20px;
  height: 20px;
  border: 2px solid #cbd5e1;
  border-radius: 6px;
  position: relative;
  transition: all 0.2s;
}

.notice-checkbox.checked {
  background: var(--primary);
  border-color: var(--primary);
}

.notice-checkbox.checked::after {
  content: '';
  position: absolute;
  left: 5px;
  top: 1px;
  width: 5px;
  height: 10px;
  border: solid white;
  border-width: 0 2px 2px 0;
  transform: rotate(45deg);
}

.notice-checkbox-label {
  font-size: 13px;
  color: #64748b;
  font-weight: 500;
}

.notice-confirm-btn {
  width: 100%;
  padding: 12px;
  background: #0f172a;
  color: white;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: 0.2s;
}

.notice-confirm-btn:hover {
  background: #334155;
}

.custom-alert {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(-100%);
  background: white;
  padding: 12px 24px;
  border-radius: 50px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 600;
  color: #0f172a;
  z-index: 10000;
  opacity: 0;
  transition: all 0.5s var(--ease-spring);
}

.custom-alert.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
}

@media (max-width: 768px) {
  .search-title { font-size: 3rem; }
  .history-rank-container { grid-template-columns: 1fr; }
  .toggle-btn { display: none; }
  .mogu-chat-window { width: 100%; height: 100%; top: 0; right: 0; border-radius: 0; transform: none; }
  .mogu-chat-window.open { transform: none; }
  .user-info { padding: 6px; }
  .user-name { display: none; }
}

.loading-spinner {
  width: 16px;
  height: 16px;
  border: 2px solid rgba(255,255,255,0.3);
  border-radius: 50%;
  border-top-color: white;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.admin-only { display: none !important; }
.admin-only.admin-show { display: block !important; }
</style>
</head>
<body>

<div class="ambient-bg">
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>
</div>

<div id="customAlert" class="custom-alert"></div>

<div id="userStatusArea"></div>

<button class="mogu-chat-btn" id="moguChatBtn">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
</button>

<div class="mogu-chat-window" id="moguChatWindow">
  <div class="mogu-chat-header">
    <div class="mogu-chat-title">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
      Mogu Chat
    </div>
    <button class="clear-all-btn admin-only" id="clearAllMessages">Ê∏ÖÁ©∫</button>
  </div>
  <div class="mogu-chat-messages" id="moguChatMessages"></div>
  <div class="mogu-chat-input-area" id="moguChatInputArea">
    <input type="text" class="mogu-chat-input" id="moguChatInput" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." disabled>
    <button class="mogu-chat-send" id="moguChatSend" disabled><span id="sendText">ÂèëÈÄÅ</span></button>
  </div>
</div>

<div class="search-title">Mogu_search</div>

<div class="search-container">
  <div class="search-engine-wrap">
    <select class="search-engine-select" id="searchEngine">
      <option value="bing">Bing</option>
      <option value="google">Google</option>
      <option value="baidu">Baidu</option>
    </select>
  </div>
  <input type="text" id="search-input" placeholder="Search anything...">
  <button id="search-btn">Go</button>
</div>

<div class="history-rank-wrap" id="historyRankWrap">
  <div class="history-rank-container">
    <div class="history-section">
      <div class="module-title">
        <span>History</span>
        <label class="toggle-switch">
          <input type="checkbox" id="historySwitch">
          <span class="switch-slider"></span>
        </label>
      </div>
      <ul class="history-list" id="historyList"></ul>
    </div>
    <div class="rank-section">
      <div class="module-title">Trending</div>
      <ul class="rank-list" id="rankList"></ul>
    </div>
  </div>
</div>

<button class="toggle-btn" id="toggleBtn">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
</button>

<div class="modal-mask" id="modalMask"></div>

<div class="custom-modal" id="logoutModal">
  <div class="modal-header">ÈÄÄÂá∫ÁôªÂΩï</div>
  <div class="modal-content">ÊÇ®Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÂΩìÂâçË¥¶Âè∑ÂêóÔºü</div>
  <div class="modal-btns">
    <button class="modal-btn cancel" id="logoutCancel">ÂèñÊ∂à</button>
    <button class="modal-btn confirm" id="logoutConfirm">ÈÄÄÂá∫</button>
  </div>
</div>

<div class="custom-modal" id="clearMsgModal">
  <div class="modal-header">Ê∏ÖÁ©∫Ê∂àÊÅØ</div>
  <div class="modal-content">Ê≠§Êìç‰ΩúÂ∞ÜÊ∞∏‰πÖÂà†Èô§ÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÔºå‰∏çÂèØÊÅ¢Â§ç„ÄÇ</div>
  <div class="modal-btns">
    <button class="modal-btn cancel" id="clearMsgCancel">ÂèñÊ∂à</button>
    <button class="modal-btn confirm danger" id="clearMsgConfirm">Á°ÆËÆ§Ê∏ÖÁ©∫</button>
  </div>
</div>

<div class="notice-modal" id="noticeModal">
  <div class="notice-header">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#6366f1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
    Á≥ªÁªüÂÖ¨Âëä
  </div>
  <div class="notice-content" id="noticeContent"></div>
  <div class="notice-checkbox-wrap" id="noticeCheckbox">
    <div class="notice-checkbox"></div>
    <span class="notice-checkbox-label">‰∏çÂÜçÊòæÁ§∫Ê≠§ÂÖ¨Âëä</span>
  </div>
  <button class="notice-confirm-btn" id="noticeConfirm">ÊàëÁü•ÈÅì‰∫Ü</button>
</div>

<script>
const USER_DATABASE_ISSUE_NUMBER = 11;
const USER_DATABASE_REPO_OWNER = 'moguwan';
const USER_DATABASE_REPO_NAME = 'moguwan.github.io';
const USER_LOCAL_KEY = 'MOGU_CHAT_USER';
const ADMIN_ACCOUNT = '2926197119';
const GITHUB_TOKEN = ["gh","p_p","VXlo0HQ","PmMx","Ic","eM","HB","uMzm","EON","LPX","700","10","M","SL"].join('');
const REPO_OWNER = 'moguwan';
const REPO_NAME = 'mogu-chat';
const ISSUE_NUMBER = 1;
const MAP_ISSUE_NUMBER = 2;
const MAP_ISSUE_TITLE = "Áî®Êà∑-‰∏ìÂ±ûIssueÊò†Â∞ÑË°®";
const MAP_MARK_START = "// USER-MAP-JSON-START";
const MAP_MARK_END = "// USER-MAP-JSON-END";
const MAX_HISTORY = 10;
const MAX_RANK = 10;
const MAX_MESSAGE_LENGTH = 200;
const NOTICE_LOCAL_KEY = 'MOGU_SEARCH_NOTICE';

const searchEngine = document.getElementById('searchEngine');
const searchInput = document.getElementById('search-input');
const searchBtn = document.getElementById('search-btn');
const customAlert = document.getElementById('customAlert');
const historyRankWrap = document.getElementById('historyRankWrap');
const toggleBtn = document.getElementById('toggleBtn');
const historyList = document.getElementById('historyList');
const rankList = document.getElementById('rankList');
const historySwitch = document.getElementById('historySwitch');
const moguChatBtn = document.getElementById('moguChatBtn');
const moguChatWindow = document.getElementById('moguChatWindow');
const moguChatMessages = document.getElementById('moguChatMessages');
const moguChatInput = document.getElementById('moguChatInput');
const moguChatSend = document.getElementById('moguChatSend');
const sendText = document.getElementById('sendText');
const userStatusArea = document.getElementById('userStatusArea');

let alertTimer = null;
let chatOpen = false;
let lastMessageId = 0;
let chatUpdateInterval = null;
let isLoading = false;
let currentUser = null;
let isHistoryFetched = false;
let isNoticeShown = false;

function isMobile() {
  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
}

function showCustomAlert(message) {
  customAlert.textContent = message;
  customAlert.classList.add('show');
  if (alertTimer) clearTimeout(alertTimer);
  alertTimer = setTimeout(() => {
    customAlert.classList.remove('show');
  }, 2200);
}

function toggleModal(type, show) {
  const mask = document.getElementById('modalMask');
  const logoutModal = document.getElementById('logoutModal');
  const clearMsgModal = document.getElementById('clearMsgModal');
  
  if (!show) {
    mask.classList.remove('show');
    logoutModal.classList.remove('show');
    clearMsgModal.classList.remove('show');
    setTimeout(() => {
        mask.style.display = 'none';
        logoutModal.style.display = 'none';
        clearMsgModal.style.display = 'none';
    }, 300);
  } else {
    mask.style.display = 'block';
    if (type === 'logout') logoutModal.style.display = 'block';
    if (type === 'clearMsg') clearMsgModal.style.display = 'block';
    setTimeout(() => {
        mask.classList.add('show');
        if (type === 'logout') logoutModal.classList.add('show');
        if (type === 'clearMsg') clearMsgModal.classList.add('show');
    }, 10);
  }
}

async function checkLoginStatus() {
  const userData = localStorage.getItem(USER_LOCAL_KEY);
  if (userData) {
    try {
      currentUser = JSON.parse(userData);
      await updateCurrentUserFromGitHub();
      currentUser.isAdmin = currentUser.account === ADMIN_ACCOUNT;
      updateUIForLoggedInUser();
      return true;
    } catch (e) {
      currentUser = null;
    }
  }
  updateUIForGuest();
  return false;
}

function updateUIForLoggedInUser() {
  if (!currentUser) return;
  const userInitial = currentUser.nickname ? currentUser.nickname.charAt(0).toUpperCase() : 'U';
  const userAvatar = currentUser.avatar || ''; 
  const avatarStyle = userAvatar ? `background-image: url('${userAvatar}'); background-size: cover;` : `background: #6366f1; color: white;`;
  
  userStatusArea.innerHTML = `
    <div class="user-info">
      <div class="user-profile-btn" id="userProfileBtn">
        <div class="user-avatar" style="${avatarStyle}">
          ${!userAvatar ? userInitial : ''}
        </div>
        <div class="user-name">${currentUser.nickname || currentUser.account}</div>
      </div>
      <button class="logout-btn" id="logoutBtn">ÈÄÄÂá∫</button>
    </div>
  `;
  document.getElementById('userProfileBtn').addEventListener('click', () => window.location.href = 'profile.html');
  document.getElementById('logoutBtn').addEventListener('click', (e) => { e.stopPropagation(); logout(); });
  moguChatInput.disabled = false;
  moguChatInput.placeholder = "Write a message...";
  moguChatSend.disabled = false;
  updateAdminUI();
}

function updateUIForGuest() {
  userStatusArea.innerHTML = `<button class="login-btn" onclick="goToLogin()">Login / Register</button>`;
  moguChatInput.disabled = true;
  moguChatInput.placeholder = "Please login to chat";
  moguChatSend.disabled = true;
}

function updateAdminUI() {
  const adminElements = document.querySelectorAll('.admin-only');
  if (currentUser && currentUser.isAdmin) {
    adminElements.forEach(el => el.classList.add('admin-show'));
  } else {
    adminElements.forEach(el => el.classList.remove('admin-show'));
  }
}

function goToLogin() { window.location.href = 'auth.html'; }
function logout() { toggleModal('logout', true); }

function getHistorySwitchState() {
  const state = localStorage.getItem('moguHistorySwitch');
  return state === null ? true : JSON.parse(state);
}
function saveHistorySwitchState(enabled) {
  localStorage.setItem('moguHistorySwitch', JSON.stringify(enabled));
  historySwitch.checked = enabled;
}
function getSearchHistory() {
  const historyStr = localStorage.getItem('moguSearchHistory');
  return historyStr ? JSON.parse(historyStr) : [];
}
function saveSearchHistory(history) {
  localStorage.setItem('moguSearchHistory', JSON.stringify(history));
  setTimeout(renderHistory, 0);
}
function getSearchCount() {
  const countStr = localStorage.getItem('moguSearchCount');
  return countStr ? JSON.parse(countStr) : {};
}
function saveSearchCount(countMap) {
  localStorage.setItem('moguSearchCount', JSON.stringify(countMap));
  setTimeout(renderRank, 0);
}
function incrementSearchCount(keyword) {
  const countMap = getSearchCount();
  countMap[keyword] = (countMap[keyword] || 0) + 1;
  saveSearchCount(countMap);
}
function getShowState() {
  const state = localStorage.getItem('moguShowHistoryRank');
  return state === null ? true : JSON.parse(state);
}
function saveShowState(show) {
  localStorage.setItem('moguShowHistoryRank', JSON.stringify(show));
  if (show) {
    historyRankWrap.classList.remove('hidden');
    toggleBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>`;
  } else {
    historyRankWrap.classList.add('hidden');
    toggleBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.45-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>`;
  }
}

function addSearchHistory(keyword) {
  if (!getHistorySwitchState() || !keyword.trim()) return;
  keyword = keyword.trim();
  let history = getSearchHistory().filter(item => item.keyword !== keyword);
  history.unshift({ keyword: keyword, time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) });
  if (history.length > MAX_HISTORY) history.pop();
  saveSearchHistory(history);
}

function deleteHistoryItem(keyword) {
  saveSearchHistory(getSearchHistory().filter(item => item.keyword !== keyword));
  const countMap = getSearchCount();
  delete countMap[keyword];
  saveSearchCount(countMap);
}

function renderHistory() {
  if (isMobile()) return;
  const history = getSearchHistory();
  if (history.length === 0) {
    historyList.innerHTML = `<li style="text-align:center;color:#94a3b8;padding:10px;font-size:13px;">No history yet</li>`;
    return;
  }
  historyList.innerHTML = '';
  history.forEach(item => {
    const li = document.createElement('li');
    li.className = 'history-item';
    li.innerHTML = `
      <span>${item.keyword}</span>
      <span class="time">${item.time}</span>
      <button class="delete-btn"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
    `;
    li.addEventListener('click', (e) => {
      if (e.target.closest('.delete-btn')) return;
      searchInput.value = item.keyword;
      handleSearch();
    });
    li.querySelector('.delete-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      deleteHistoryItem(item.keyword);
    });
    historyList.appendChild(li);
  });
}

function renderRank() {
  if (isMobile()) return;
  const rankArray = Object.entries(getSearchCount()).map(([k, c]) => ({ keyword: k, count: c })).sort((a, b) => b.count - a.count).slice(0, MAX_RANK);
  if (rankArray.length === 0) {
    rankList.innerHTML = `<li style="text-align:center;color:#94a3b8;padding:10px;font-size:13px;">No data yet</li>`;
    return;
  }
  rankList.innerHTML = '';
  rankArray.forEach((item, index) => {
    const li = document.createElement('li');
    li.className = 'rank-item';
    li.innerHTML = `<span class="rank-num">${index + 1}</span><span>${item.keyword}</span><span class="count">${item.count}</span>`;
    li.addEventListener('click', () => {
      searchInput.value = item.keyword;
      searchInput.focus();
    });
    rankList.appendChild(li);
  });
}

function handleSearch() {
  const searchText = searchInput.value.trim();
  if (!searchText) {
    showCustomAlert('Please enter something!');
    searchInput.focus();
    return;
  }
  const engineUrlMap = { bing: 'https://cn.bing.com/search?q=', google: 'https://www.google.com/search?q=', baidu: 'https://www.baidu.com/s?wd=' };
  window.open(engineUrlMap[isMobile() ? 'bing' : searchEngine.value] + encodeURIComponent(searchText), '_blank');
  searchInput.value = '';
  if (currentUser) recordUserActionToGitHub('search', searchText);
  if (!isMobile()) {
    setTimeout(() => {
      addSearchHistory(searchText);
      incrementSearchCount(searchText);
    }, 0);
  }
}

async function getUserDatabaseFromGitHub() {
  try {
    const response = await fetch(`https://api.github.com/repos/${USER_DATABASE_REPO_OWNER}/${USER_DATABASE_REPO_NAME}/issues/${USER_DATABASE_ISSUE_NUMBER}`, {
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json' }
    });
    if (!response.ok) return [];
    const data = await response.json();
    return (data.body || '').split('\n').filter(l => l.trim()).map(line => {
      const p = line.split('|');
      return p.length >= 7 ? { account: p[0].trim(), password: p[1].trim(), email: p[2].trim(), nickname: p[3].trim(), isAdmin: p[4].trim().toLowerCase() === 'true', avatar: p[5].trim(), signature: p[6].trim() } : null;
    }).filter(u => u);
  } catch { return []; }
}

async function updateCurrentUserFromGitHub() {
  if (!currentUser?.account) return;
  const users = await getUserDatabaseFromGitHub();
  const user = users.find(u => u.account === currentUser.account);
  if (user) {
    Object.assign(currentUser, { nickname: user.nickname, email: user.email, avatar: user.avatar, signature: user.signature, isAdmin: user.isAdmin });
    localStorage.setItem(USER_LOCAL_KEY, JSON.stringify(currentUser));
    updateUIForLoggedInUser();
  }
}

async function getUserMapFromGitHub() {
  try {
    const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${MAP_ISSUE_NUMBER}`, {
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json' }
    });
    if (res.status === 404) {
      await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues`, {
        method: 'POST',
        headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
        body: JSON.stringify({ number: MAP_ISSUE_NUMBER, title: MAP_ISSUE_TITLE, body: `${MAP_MARK_START}\n{}\n${MAP_MARK_END}`, labels: ['user-map'] })
      });
      return {};
    }
    const data = await res.json();
    const body = data.body || '';
    const jsonStart = body.indexOf(MAP_MARK_START) + MAP_MARK_START.length;
    const jsonEnd = body.indexOf(MAP_MARK_END);
    return JSON.parse(body.slice(jsonStart, jsonEnd).trim()) || {};
  } catch { return {}; }
}

async function updateUserMapToGitHub(account, issueNum) {
  try {
    const map = await getUserMapFromGitHub();
    map[account] = issueNum;
    const body = `${MAP_MARK_START}\n${JSON.stringify(map, null, 2)}\n${MAP_MARK_END}`;
    await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${MAP_ISSUE_NUMBER}`, {
      method: 'PATCH',
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ body })
    });
  } catch {}
}

async function getOrCreateUserIssue(user) {
  if (!user?.account) return null;
  try {
    const map = await getUserMapFromGitHub();
    if (map[user.account]) return map[user.account];
    
    const searchRes = await fetch(`https://api.github.com/search/issues?q=repo:${REPO_OWNER}/${REPO_NAME}+title:"${encodeURIComponent(`${user.nickname}|${user.account}`)}"+is:issue+is:open`, {
       headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
    });
    const searchData = await searchRes.json();
    if (searchData.items?.length > 0) {
      await updateUserMapToGitHub(user.account, searchData.items[0].number);
      return searchData.items[0].number;
    }

    const createRes = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues`, {
      method: 'POST',
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ title: `${user.nickname}|${user.account}`, body: `„ÄêRecord„Äë\n${new Date().toLocaleString()}|Init`, labels: ['user-record'] })
    });
    const createData = await createRes.json();
    if (createRes.ok) {
      await updateUserMapToGitHub(user.account, createData.number);
      return createData.number;
    }
  } catch {}
  return null;
}

async function recordUserActionToGitHub(type, content = '') {
  if (!currentUser?.account) return;
  const issueNum = await getOrCreateUserIssue(currentUser);
  if (!issueNum) return;
  const line = `${new Date().toLocaleString()}|${type === 'open-page' ? 'Open Page' : content}`;
  try {
    const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${issueNum}`, { headers: { 'Authorization': `token ${GITHUB_TOKEN}` } });
    const data = await res.json();
    await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${issueNum}`, {
      method: 'PATCH',
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ body: `${data.body || ''}\n${line}` })
    });
  } catch {}
}

async function getAllComments() {
  let all = [], page = 1;
  while(true) {
    try {
      const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${ISSUE_NUMBER}/comments?per_page=100&page=${page}`, {
        headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
      });
      if(!res.ok) break;
      const data = await res.json();
      if(data.length === 0) break;
      all = all.concat(data);
      page++;
    } catch { break; }
  }
  return all;
}

function formatMessageTime(date) {
  return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function addMessageToChat(sender, text, time, type, commentId, avatar = null) {
  const div = document.createElement('div');
  div.className = `message-item ${type}`;
  div.id = `msg_${Date.now()}_${Math.random()}`;
  div.dataset.commentId = commentId;
  const avatarHtml = avatar ? `<div style="width:20px;height:20px;border-radius:50%;margin-right:6px;background:url('${avatar}') center/cover;"></div>` : '';
  div.innerHTML = `
    <div style="display:flex;align-items:center;margin-bottom:4px;">${avatarHtml}<div class="message-sender">${sender}</div></div>
    <div class="message-text">${text}</div>
    <div class="message-time">${time}</div>
  `;
  moguChatMessages.appendChild(div);
}

async function fetchChatMessages() {
  try {
    if (!isHistoryFetched) {
      const msgs = await getAllComments();
      if (msgs.length > 0) {
        msgs.sort((a,b) => a.id - b.id).forEach(msg => processMessage(msg));
        lastMessageId = Math.max(...msgs.map(m => m.id));
        isHistoryFetched = true;
        moguChatMessages.scrollTop = moguChatMessages.scrollHeight;
      }
    } else {
      const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${ISSUE_NUMBER}/comments?per_page=100&page=1`, { headers: { 'Authorization': `token ${GITHUB_TOKEN}` } });
      const msgs = await res.json();
      const newMsgs = msgs.filter(m => m.id > lastMessageId).sort((a,b) => a.id - b.id);
      if (newMsgs.length > 0) {
        newMsgs.forEach(msg => processMessage(msg));
        lastMessageId = Math.max(lastMessageId, ...newMsgs.map(m => m.id));
        moguChatMessages.scrollTop = moguChatMessages.scrollHeight;
      }
    }
  } catch {}
}

function processMessage(msg) {
  let sender = 'Unknown', text = msg.body.trim(), avatar = null;
  const parts = msg.body.split(': ');
  if (parts.length >= 2) {
    const sPart = parts[0].trim();
    if (sPart.includes('|')) {
      const [name, avt] = sPart.split('|');
      sender = name.trim();
      avatar = avt.trim() || null;
    } else {
      sender = sPart;
    }
    text = parts.slice(1).join(': ').trim();
  }
  let type = 'other';
  if (currentUser) {
    if (sender === (currentUser.nickname || currentUser.account)) type = 'user';
  }
  addMessageToChat(sender, text, formatMessageTime(new Date(msg.created_at)), type, msg.id, avatar);
}

async function sendChatMessage() {
  if (!currentUser) { showCustomAlert('Please login first'); goToLogin(); return; }
  const msg = moguChatInput.value.trim();
  if (msg.length > MAX_MESSAGE_LENGTH) { showCustomAlert('Message too long'); return; }
  if (!msg || isLoading) return;
  
  isLoading = true;
  sendText.innerHTML = '<div class="loading-spinner"></div>';
  moguChatSend.disabled = true;
  
  const senderName = currentUser.nickname || currentUser.account;
  const body = `${senderName}|${currentUser.avatar || ''}: ${msg}`;
  const localId = `msg_temp_${Date.now()}`;
  addMessageToChat(senderName, msg, formatMessageTime(new Date()), 'user', '', currentUser.avatar);
  const localEl = moguChatMessages.lastElementChild;
  localEl.id = localId;
  moguChatInput.value = '';
  moguChatMessages.scrollTop = moguChatMessages.scrollHeight;

  try {
    const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${ISSUE_NUMBER}/comments`, {
      method: 'POST',
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ body })
    });
    if (res.ok) {
      const data = await res.json();
      lastMessageId = Math.max(lastMessageId, data.id);
      document.getElementById(localId).dataset.commentId = data.id;
    }
  } catch {
    showCustomAlert('Failed to send');
  } finally {
    isLoading = false;
    sendText.textContent = 'ÂèëÈÄÅ';
    moguChatSend.disabled = false;
  }
}

function toggleChatWindow() {
  chatOpen = !chatOpen;
  if (chatOpen) {
    moguChatWindow.classList.add('open');
    if (!chatUpdateInterval) chatUpdateInterval = setInterval(fetchChatMessages, 5000);
    fetchChatMessages();
  } else {
    moguChatWindow.classList.remove('open');
    if (chatUpdateInterval) { clearInterval(chatUpdateInterval); chatUpdateInterval = null; }
  }
}

document.getElementById('logoutCancel').addEventListener('click', () => toggleModal('logout', false));
document.getElementById('logoutConfirm').addEventListener('click', () => {
  toggleModal('logout', false);
  localStorage.removeItem(USER_LOCAL_KEY);
  currentUser = null;
  updateUIForGuest();
  showCustomAlert('Logged out');
});

document.getElementById('clearMsgCancel').addEventListener('click', () => toggleModal('clearMsg', false));
document.getElementById('clearMsgConfirm').addEventListener('click', async () => {
  toggleModal('clearMsg', false);
  if (!currentUser?.isAdmin || isLoading) return;
  isLoading = true;
  const btn = document.getElementById('clearAllMessages');
  btn.textContent = '...';
  try {
    const items = document.querySelectorAll('.message-item');
    for (const el of items) {
      if (el.dataset.commentId) {
        await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/comments/${el.dataset.commentId}`, {
          method: 'DELETE', headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
        });
      }
      el.remove();
    }
    showCustomAlert('Cleared all messages');
  } catch { showCustomAlert('Error clearing'); }
  finally { isLoading = false; btn.textContent = 'Ê∏ÖÁ©∫'; isHistoryFetched = false; }
});
document.getElementById('clearAllMessages').addEventListener('click', () => {
    if(!currentUser?.isAdmin) return;
    toggleModal('clearMsg', true);
});

searchBtn.addEventListener('click', handleSearch);
searchInput.addEventListener('keydown', e => e.key === 'Enter' && handleSearch());
moguChatBtn.addEventListener('click', toggleChatWindow);
moguChatSend.addEventListener('click', sendChatMessage);
moguChatInput.addEventListener('keydown', e => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), sendChatMessage()));
if (!isMobile()) {
  toggleBtn.addEventListener('click', () => saveShowState(!getShowState()));
  historySwitch.addEventListener('change', e => saveHistorySwitchState(e.target.checked));
}
document.addEventListener('click', e => {
  if (chatOpen && !moguChatWindow.contains(e.target) && !moguChatBtn.contains(e.target)) toggleChatWindow();
});

const noticeContent = `<p><strong>Welcome to Mogu Search!</strong></p><p>Áî±‰∫éÊ≤°ÊúâÂ§á‰ªΩ</p><p>Êõ¥Êñ∞ÁöÑÊó∂ÂÄôËØØÂà†‰∫ÜÊâÄÊúâ‰∫∫ÁöÑË¥¶Âè∑ Â§ßÂÆ∂ÈáçÊñ∞Ê≥®ÂÜåÁôªÂΩï‰∏Ä‰∏ãÂêß~üå∏</p>`;
function initNotice() {
  const data = localStorage.getItem(NOTICE_LOCAL_KEY);
  if (data && JSON.parse(data).dontShowAgain) return;
  document.getElementById('noticeContent').innerHTML = noticeContent;
  setTimeout(() => {
    document.getElementById('modalMask').style.display = 'block';
    document.getElementById('noticeModal').style.display = 'block';
    setTimeout(() => {
        document.getElementById('modalMask').classList.add('show');
        document.getElementById('noticeModal').classList.add('show');
    }, 10);
    isNoticeShown = true;
  }, 500);

  const checkbox = document.querySelector('.notice-checkbox');
  document.getElementById('noticeCheckbox').addEventListener('click', () => checkbox.classList.toggle('checked'));
  document.getElementById('noticeConfirm').addEventListener('click', () => {
    if (checkbox.classList.contains('checked')) localStorage.setItem(NOTICE_LOCAL_KEY, JSON.stringify({ dontShowAgain: true }));
    document.getElementById('modalMask').classList.remove('show');
    document.getElementById('noticeModal').classList.remove('show');
    setTimeout(() => {
        document.getElementById('modalMask').style.display = 'none';
        document.getElementById('noticeModal').style.display = 'none';
    }, 300);
    isNoticeShown = false;
  });
}

window.addEventListener('DOMContentLoaded', async () => {
  initNotice();
  await checkLoginStatus();
  if (currentUser) recordUserActionToGitHub('open-page');
  if (isMobile()) {
    searchInput.focus();
  } else {
    saveShowState(getShowState());
    saveHistorySwitchState(getHistorySwitchState());
    renderHistory();
    renderRank();
    searchInput.focus();
  }
  fetchChatMessages();
  updateAdminUI();
});
</script>
</body>
</html>
