<!DOCTYPE html>
<html lang="en">
<head>
<link rel="dns-prefetch" href="https://cn.bing.com">
<link rel="dns-prefetch" href="https://www.google.com">
<link rel="dns-prefetch" href="https://www.baidu.com">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mogu Search</title>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: "Inter", "SF Pro Display", "Microsoft YaHei", sans-serif;
-webkit-user-select: none;
-moz-user-select: none;
-ms-user-select: none;
user-select: none;
}
#search-input {
-webkit-user-select: text;
-moz-user-select: text;
-ms-user-select: text;
user-select: text;
}
body {
background-color: #f5f7fa;
display: flex;
flex-direction: column;
justify-content: flex-start;
align-items: center;
min-height: 100vh;
padding: 15vh 20px 40px;
position: relative;
}
.search-title {
font-size: 40px;
font-weight: 600;
color: #0078d4;
margin-bottom: 36px;
letter-spacing: 1px;
transition: all 0.25s ease-out;
cursor: default;
text-shadow: 0 2px 4px rgba(0, 120, 212, 0.05);
}
.search-title:hover {
color: #0066b8;
transform: scale(1.03);
}
.search-container {
width: 100%;
max-width: 720px;
display: flex;
align-items: center;
gap: 10px;
position: relative;
margin-bottom: 20px;
}
.search-engine-wrap {
position: relative;
}
.search-engine-select {
padding: 18px 40px 18px 24px;
font-size: 17px;
border: none;
border-radius: 24px;
background: linear-gradient(145deg, #ffffff, #f8f9fa);
color: #2d3748;
outline: none;
appearance: none;
cursor: pointer;
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
box-shadow: 
0 4px 12px rgba(0, 0, 0, 0.05),
inset 0 1px 0 rgba(255, 255, 255, 0.8);
min-width: 110px;
font-weight: 500;
}
.search-engine-arrow {
position: absolute;
right: 20px;
top: 50%;
transform: translateY(-50%);
width: 10px;
height: 10px;
pointer-events: none;
transition: all 0.2s ease;
}
.search-engine-arrow::before {
content: "";
display: block;
width: 7px;
height: 7px;
border-right: 2px solid #0078d4;
border-bottom: 2px solid #0078d4;
transform: rotate(45deg);
transition: all 0.2s ease;
opacity: 0.7;
}
.search-engine-select:hover {
box-shadow: 
0 6px 16px rgba(0, 0, 0, 0.08),
inset 0 1px 0 rgba(255, 255, 255, 0.9);
transform: translateY(-1px);
}
.search-engine-select:focus {
box-shadow: 
0 0 0 4px rgba(0, 120, 212, 0.12),
0 6px 16px rgba(0, 120, 212, 0.1),
inset 0 1px 0 rgba(255, 255, 255, 0.9);
transform: translateY(-2px);
}
.search-engine-select:hover + .search-engine-arrow::before,
.search-engine-select:focus + .search-engine-arrow::before {
opacity: 1;
transform: rotate(45deg) scale(1.1);
}
.search-engine-select option {
padding: 12px 16px;
background: #ffffff;
color: #2d3748;
border-radius: 8px;
font-weight: 500;
}
.search-engine-select option:hover {
background: #e8f4ff;
}
#search-input {
flex: 1;
padding: 18px 24px;
font-size: 17px;
border: none;
border-radius: 24px;
outline: none;
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
box-shadow: 
0 4px 12px rgba(0, 0, 0, 0.05),
inset 0 1px 0 rgba(255, 255, 255, 0.8);
color: #2d3748;
font-weight: 500;
}
#search-input:focus {
box-shadow: 
0 0 0 4px rgba(0, 120, 212, 0.12),
0 6px 16px rgba(0, 120, 212, 0.1),
inset 0 1px 0 rgba(255, 255, 255, 0.9);
transform: translateY(-2px);
}
#search-input::placeholder {
color: #94a3b8;
font-size: 16px;
font-weight: 400;
}
#search-btn {
padding: 18px 36px;
font-size: 17px;
background: linear-gradient(135deg, #0078d4 0%, #0066b8 100%);
color: white;
border: none;
border-radius: 24px;
cursor: pointer;
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
box-shadow: 0 4px 12px rgba(0, 120, 212, 0.15);
font-weight: 500;
}
#search-btn:hover {
background: linear-gradient(135deg, #0066b8 0%, #005599 100%);
transform: translateY(-2px);
box-shadow: 0 6px 16px rgba(0, 120, 212, 0.2);
}
#search-btn:active {
transform: translateY(0);
box-shadow: 0 2px 8px rgba(0, 120, 212, 0.15);
}
.history-rank-wrap {
width: 100%;
max-width: 720px;
margin-top: 65px;
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
opacity: 1;
height: auto;
overflow: hidden;
}
.history-rank-wrap.hidden {
opacity: 0;
height: 0;
margin-top: 0;
}
.toggle-btn {
position: fixed;
bottom: 20px;
left: 20px;
width: 36px;
height: 36px;
border-radius: 50%;
background: linear-gradient(145deg, #ffffff, #f8f9fa);
border: none;
box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
transition: all 0.2s ease;
z-index: 9998;
opacity: 0.3;
pointer-events: auto;
}
.toggle-btn:hover {
transform: scale(1.1);
box-shadow: 0 3px 10px rgba(0, 120, 212, 0.12);
opacity: 1;
}
.toggle-btn svg {
width: 18px;
height: 18px;
fill: #0078d4;
transition: all 0.2s ease;
}
.custom-alert {
position: fixed;
top: 30px;
left: 50%;
transform: translateX(-50%) translateY(-30px);
background-color: #fff;
border: 1px solid #ff8080;
color: #dc2626;
padding: 14px 28px;
border-radius: 12px;
box-shadow: 0 6px 20px rgba(255, 128, 128, 0.12);
font-size: 16px;
opacity: 0;
visibility: hidden;
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
z-index: 9999;
cursor: default;
}
.custom-alert.show {
opacity: 1;
visibility: visible;
transform: translateX(-50%) translateY(0);
animation: gentleShake 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}
/* 新增：用户登录状态样式 */
.user-info {
position: fixed;
top: 20px;
left: 20px;
display: flex;
align-items: center;
gap: 10px;
z-index: 9999;
}
.user-avatar {
width: 40px;
height: 40px;
border-radius: 50%;
background: linear-gradient(135deg, #0078d4 0%, #0066b8 100%);
display: flex;
align-items: center;
justify-content: center;
color: white;
font-weight: bold;
font-size: 16px;
}
.user-name {
font-weight: 500;
color: #2d3748;
}
.logout-btn {
padding: 6px 12px;
background: #f8fafc;
border: 1px solid #e2e8f0;
border-radius: 8px;
color: #64748b;
cursor: pointer;
font-size: 12px;
transition: all 0.2s;
}
.logout-btn:hover {
background: #f1f5f9;
color: #475569;
}
.login-btn {
position: fixed;
top: 20px;
left: 20px;
padding: 8px 16px;
background: linear-gradient(135deg, #0078d4 0%, #0066b8 100%);
color: white;
border: none;
border-radius: 8px;
cursor: pointer;
font-size: 14px;
font-weight: 500;
z-index: 9999;
}
.login-btn:hover {
transform: translateY(-1px);
box-shadow: 0 4px 12px rgba(0, 120, 212, 0.2);
}
/* 聊天按钮位置调整 */
.mogu-chat-btn {
position: fixed;
top: 20px;
right: 20px;
width: 48px;
height: 48px;
border-radius: 50%;
background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
border: none;
color: white;
font-size: 12px;
font-weight: 600;
cursor: pointer;
transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
box-shadow: 0 6px 20px rgba(139, 92, 246, 0.3);
z-index: 9999;
display: flex;
align-items: center;
justify-content: center;
overflow: hidden;
}
.mogu-chat-btn:hover {
transform: scale(1.1) rotate(5deg);
box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
}
.mogu-chat-btn::before {
content: "";
position: absolute;
width: 100%;
height: 100%;
background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
opacity: 0;
transition: opacity 0.3s ease;
border-radius: 50%;
}
.mogu-chat-btn:hover::before {
opacity: 1;
}
.mogu-chat-btn span {
position: relative;
z-index: 1;
}
/* 聊天窗默认样式：定位右上角，隐藏状态（缩放+平移+透明） */
.mogu-chat-window {
    position: fixed;
    top: 80px; /* 与聊天按钮（top:20px）保持间距，避免重叠 */
    right: 20px; /* 与聊天按钮（right:20px）同水平位置 */
    transform: translate(20px, -20px) scale(0); /* 右移+上移+缩放到0，隐藏状态 */
    transform-origin: top right; /* 变形原点：右上角（核心！） */
    width: 80%; /* 固定宽高，不再随动画变化 */
    max-width: 800px;
    height: 80vh;
    max-height: 600px;
    background: linear-gradient(145deg, #ffffff, #f8f9fa);
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    overflow: hidden;
    opacity: 0; /* 透明隐藏 */
    z-index: 9998;
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); /* 保留原缓动函数，保证丝滑 */
}

/* 聊天窗打开状态：复位缩放+平移，显示不透明 */
.mogu-chat-window.open {
    transform: translate(0, 0) scale(1); /* 复位：无平移+缩放到1，从右上角滑出 */
    opacity: 1; /* 完全不透明 */
}
.mogu-chat-header {
    padding: 20px;
    border-bottom: 1px solid #e2e8f0;
    background: linear-gradient(145deg, #ffffff, #f8f9fa);
    display: flex;
    justify-content: space-between; /* 标题左，清空按钮右 */
    align-items: center;
}
/* 管理员专属样式：默认隐藏，仅管理员显示 */
.admin-only {
    display: none !important;
}
/* 管理员显示类：优先级高于!important，强制显示专属元素 */
.admin-only.admin-show {
    display: block !important;
}
/* 单条消息删除按钮单独适配（本身是flex布局） */
.msg-delete-btn.admin-show {
    display: flex !important;
}
/* 管理员专属：一键清空所有消息按钮（蓝色） */
.clear-all-btn {
    padding: 8px 16px;
    background: linear-gradient(135deg, #0078d4 0%, #0066b8 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
}
.clear-all-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 120, 212, 0.3);
    background: linear-gradient(135deg, #0066b8 0%, #005599 100%);
}
/* 单条消息删除按钮（消息右上角） */
.msg-delete-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: none;
    background: rgba(0, 120, 212, 0.2);
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: all 0.2s ease;
    z-index: 1;
}
/* 消息项悬浮时显示删除按钮 */
.message-item {
    padding: 12px 16px;
    border-radius: 16px;
    max-width: 85%; /* 加宽消息显示宽度 */
    animation: messageAppear 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative; /* 为删除按钮定位做准备 */
}
.message-item:hover .msg-delete-btn {
    opacity: 1;
}
/* 区分用户/其他消息的删除按钮背景 */
.message-item.user .msg-delete-btn {
    background: rgba(0, 120, 212, 0.3);
    color: white;
}
.message-item.other .msg-delete-btn {
    background: rgba(0, 120, 212, 0.2);
    color: #0078d4;
}
/* 删除按钮悬浮加深蓝色 */
.msg-delete-btn:hover {
    background: linear-gradient(135deg, #0078d4 0%, #0066b8 100%);
    color: white !important;
}
.mogu-chat-title {
font-size: 18px;
font-weight: 600;
color: #8b5cf6;
display: flex;
align-items: center;
gap: 8px;
}
.mogu-chat-title svg {
width: 20px;
height: 20px;
fill: #8b5cf6;
}
.mogu-chat-subtitle {
font-size: 12px;
color: #94a3b8;
margin-top: 4px;
}
.mogu-chat-messages {
    height: calc(100% - 180px); /* 自适应窗口，减去头部+输入区高度 */
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px; /* 加大消息间距，避免拥挤 */
    position: relative;
}
/* 聊天框滚动条加粗样式（宽度8px，原配色不变） */
.mogu-chat-messages::-webkit-scrollbar {
width: 8px; /* 核心：从4px改为8px，可根据需要调10px/12px */
}
.mogu-chat-messages::-webkit-scrollbar-track {
background: #f1f5f9;
border-radius: 4px; /* 圆角随宽度调整，更协调 */
}
.mogu-chat-messages::-webkit-scrollbar-thumb {
background: #cbd5e1;
border-radius: 4px;
}
.mogu-chat-messages::-webkit-scrollbar-thumb:hover {
background: #94a3b8;
}
/* 修改：消息项样式 */
.message-item {
padding: 12px 16px;
border-radius: 16px;
max-width: 80%;
animation: messageAppear 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.message-item.user {
align-self: flex-end;
background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
color: white;
border-bottom-right-radius: 4px;
}
.message-item.other {
align-self: flex-start;
background: #f1f5f9;
color: #2d3748;
border-bottom-left-radius: 4px;
}
/* 修改：用户名样式 */
.message-sender {
font-size: 12px;
font-weight: 600;
margin-bottom: 6px;
opacity: 0.9;
}
.message-item.user .message-sender {
color: rgba(255, 255, 255, 0.9);
}
.message-item.other .message-sender {
color: #64748b;
}
.message-text {
font-size: 14px;
line-height: 1.4;
}
.message-time {
font-size: 11px;
margin-top: 6px;
opacity: 0.6;
text-align: right;
}
.message-item.user .message-time {
color: rgba(255, 255, 255, 0.7);
}
.message-item.other .message-time {
color: #94a3b8;
}
/* 修改：聊天输入区域 */
.mogu-chat-input-area {
    padding: 16px 20px;
    border-top: 1px solid #e2e8f0;
    display: flex;
    gap: 10px;
    align-items: center;
    background: #ffffff;
    position: relative;
}
.mogu-chat-input {
    flex: 1;
    padding: 14px 18px;
    border: none;
    border-radius: 12px;
    background: #f1f5f9;
    font-size: 14px;
    color: #2d3748;
    outline: none;
    transition: all 0.3s ease;
    min-width: 0; /* 解决flex布局下输入框溢出 */
}
.mogu-chat-input:disabled {
background: #e2e8f0;
color: #94a3b8;
cursor: not-allowed;
}
.mogu-chat-input:focus {
background: #ffffff;
box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
}
.mogu-chat-send {
padding: 12px 24px;
background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
color: white;
border: none;
border-radius: 12px;
font-size: 14px;
font-weight: 600;
cursor: pointer;
transition: all 0.3s ease;
}
.mogu-chat-send:hover:not(:disabled) {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
}
.mogu-chat-send:disabled {
opacity: 0.5;
cursor: not-allowed;
transform: none;
}
.login-prompt {
position: absolute;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(255, 255, 255, 0.95);
display: flex;
align-items: center;
justify-content: center;
flex-direction: column;
gap: 15px;
border-radius: 20px;
z-index: 10;
}
.login-prompt p {
color: #64748b;
font-size: 14px;
}
.login-prompt-btn {
padding: 10px 20px;
background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
color: white;
border: none;
border-radius: 8px;
cursor: pointer;
font-size: 14px;
font-weight: 500;
}
.login-prompt-btn:hover {
transform: translateY(-1px);
box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
}
.history-rank-container {
display: flex;
gap: 20px;
background: linear-gradient(145deg, #ffffff, #f8f9fa);
border-radius: 20px;
padding: 20px;
box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
margin-top: 10px;
}
.history-section {
flex: 1;
}
.rank-section {
flex: 1;
}
.module-title {
font-size: 16px;
font-weight: 600;
color: #2d3748;
margin-bottom: 12px;
display: flex;
align-items: center;
justify-content: flex-start;
gap: 8px;
cursor: default;
}
.module-title svg {
width: 18px;
height: 18px;
fill: #0078d4;
}
.history-switch-wrap {
display: flex;
align-items: center;
gap: 8px;
margin-left: auto;
}
.switch-label {
font-size: 11px;
color: #64748b;
font-weight: 400;
}
.toggle-switch {
position: relative;
display: inline-block;
width: 36px;
height: 20px;
cursor: pointer;
}
.toggle-switch input {
opacity: 0;
width: 0;
height: 0;
}
.switch-slider {
position: absolute;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: linear-gradient(145deg, #e2e8f0, #f1f5f9);
box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
border-radius: 24px;
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.switch-slider:before {
position: absolute;
content: "";
height: 14px;
width: 14px;
left: 3px;
bottom: 3px;
background: linear-gradient(145deg, #ffffff, #f8f9fa);
box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
border-radius: 50%;
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
input:checked + .switch-slider {
background: linear-gradient(135deg, #0078d4 0%, #0066b8 100%);
}
input:checked + .switch-slider:before {
transform: translateX(16px);
}
.toggle-switch:hover .switch-slider {
box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.08);
}
input:checked + .switch-slider:hover {
box-shadow: 0 0 0 8px rgba(0, 120, 212, 0.12);
}
.history-list, .rank-list {
list-style: none;
max-height: 210px;
overflow-y: auto;
padding-right: 8px;
}
.history-list::-webkit-scrollbar, .rank-list::-webkit-scrollbar {
width: 4px;
}
.history-list::-webkit-scrollbar-track, .rank-list::-webkit-scrollbar-track {
background: #f1f5f9;
border-radius: 2px;
}
.history-list::-webkit-scrollbar-thumb, .rank-list::-webkit-scrollbar-thumb {
background: #cbd5e1;
border-radius: 2px;
}
.history-list::-webkit-scrollbar-thumb:hover, .rank-list::-webkit-scrollbar-thumb:hover {
background: #94a3b8;
}
.history-item {
padding: 8px 12px;
border-radius: 12px;
margin-bottom: 8px;
display: flex;
justify-content: space-between;
align-items: center;
background: #f8fafc;
transition: all 0.2s ease;
cursor: pointer;
}
.history-item:hover {
background: #e8f4ff;
transform: translateX(2px);
}
.history-item .keyword {
font-size: 14px;
color: #2d3748;
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
flex: 1;
}
.history-item .time {
font-size: 12px;
color: #94a3b8;
margin-left: 8px;
}
.history-item .delete-btn {
width: 24px;
height: 24px;
border-radius: 50%;
border: none;
background: transparent;
color: #94a3b8;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
transition: all 0.2s ease;
margin-left: 8px;
}
.history-item .delete-btn:hover {
background: #fef2f2;
color: #ef4444;
}
.rank-item {
padding: 8px 12px;
border-radius: 12px;
margin-bottom: 8px;
display: flex;
align-items: center;
background: #f8fafc;
transition: all 0.2s ease;
cursor: pointer;
}
.rank-item:hover {
background: #e8f4ff;
transform: translateX(2px);
}
.rank-item .rank-num {
width: 20px;
height: 20px;
border-radius: 50%;
background: #0078d4;
color: white;
font-size: 12px;
display: flex;
align-items: center;
justify-content: center;
margin-right: 10px;
font-weight: 600;
}
.rank-item:nth-child(1) .rank-num {
background: #f59e0b;
}
.rank-item:nth-child(2) .rank-num {
background: #94a3b8;
}
.rank-item:nth-child(3) .rank-num {
background: #b45309;
}
.rank-item .keyword {
font-size: 14px;
color: #2d3748;
flex: 1;
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
}
.rank-item .count {
font-size: 12px;
color: #94a3b8;
background: #f1f5f9;
padding: 2px 8px;
border-radius: 8px;
margin-left: 8px;
}
.empty-tip {
font-size: 14px;
color: #94a3b8;
text-align: center;
padding: 20px 0;
cursor: default;
}
.loading-spinner {
display: inline-block;
width: 12px;
height: 12px;
border: 2px solid rgba(255, 255, 255, 0.3);
border-radius: 50%;
border-top-color: white;
animation: spin 0.8s linear infinite;
}
@keyframes spin {
to { transform: rotate(360deg); }
}
@keyframes messageAppear {
from {
opacity: 0;
transform: translateY(10px);
}
to {
opacity: 1;
transform: translateY(0);
}
}
@keyframes gentleShake {
0%, 100% { transform: translateX(-50%) translateY(0); }
20% { transform: translateX(-52%) translateY(0); }
40% { transform: translateX(-48%) translateY(0); }
60% { transform: translateX(-52%) translateY(0); }
80% { transform: translateX(-48%) translateY(0); }
}
@media (max-width: 768px) {
.mogu-chat-window {
        top: 80px;
        left: auto;
        right: 20px;
        transform: translateX(20px) translateY(-20px) scale(0.8);
        transform-origin: top right;
    }
.search-engine-wrap {
display: none !important;
}
.history-rank-wrap {
display: none !important;
}
.toggle-btn {
display: none !important;
}
.search-container {
flex-wrap: wrap;
gap: 15px;
}
.search-engine-wrap {
width: 100%;
}
.search-engine-select {
width: 100%;
}
#search-input {
width: 100%;
}
#search-btn {
width: 100%;
}
.search-title {
font-size: 32px;
margin-bottom: 24px;
}
.user-info {
top: 15px;
left: 15px;
}
.login-btn {
top: 15px;
left: 15px;
}
.mogu-chat-btn {
top: 15px;
right: 15px;
width: 42px;
height: 42px;
font-size: 10px;
}
.mogu-chat-window.open {
        width: calc(100vw - 40px);
        height: 450px;
        max-width: none;
        max-height: none;
        transform: translateX(0) translateY(0) scale(1);
    }
.mogu-chat-messages {
        height: 300px; /* 恢复移动设备固定高度 */
    }
}
/* 自定义弹窗遮罩层：全屏半透明，防止背景操作 */
.modal-mask {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.2);
  backdrop-filter: blur(4px); /* 背景模糊，提升高级感 */
  z-index: 99999; /* 高于所有页面元素，确保不被遮挡 */
  transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  opacity: 0;
}
.modal-mask.show {
  opacity: 1;
}

/* 自定义弹窗容器：居中显示，适配页面风格 */
.custom-modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.95);
  width: 100%;
  max-width: 400px; /* 固定最大宽度，适配移动端 */
  background: linear-gradient(145deg, #ffffff, #f8f9fa);
  border-radius: 20px; /* 与聊天窗、搜索框同圆角 */
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12); /* 适中阴影，不突兀 */
  z-index: 999999; /* 高于遮罩层 */
  padding: 24px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  opacity: 0;
}
.custom-modal.show {
  transform: translate(-50%, -50%) scale(1);
  opacity: 1;
}

/* 弹窗标题 */
.modal-header {
  font-size: 18px;
  font-weight: 600;
  color: #2d3748;
  margin-bottom: 8px;
}

/* 弹窗提示内容 */
.modal-content {
  font-size: 14px;
  color: #64748b;
  line-height: 1.5;
  margin-bottom: 24px;
}

/* 弹窗按钮组：横向排列，间距均匀 */
.modal-btns {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

/* 弹窗按钮基础样式：适配页面按钮设计 */
.modal-btn {
  padding: 10px 20px;
  border: none;
  border-radius: 12px; /* 与聊天发送按钮同圆角 */
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
}

/* 取消按钮：浅色系，中性风格 */
.modal-btn.cancel {
  background: #f1f5f9;
  color: #64748b;
}
.modal-btn.cancel:hover {
  background: #e2e8f0;
  transform: translateY(-1px);
}

/* 确认按钮：主色系（页面蓝色），渐变效果与搜索按钮一致 */
.modal-btn.confirm {
  background: linear-gradient(135deg, #0078d4 0%, #0066b8 100%);
  color: white;
}
.modal-btn.confirm:hover {
  background: linear-gradient(135deg, #0066b8 0%, #005599 100%);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 120, 212, 0.2);
}

/* 危险操作确认按钮（清空消息）：紫色系（与聊天功能配色一致） */
.modal-btn.confirm.danger {
  background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
}
.modal-btn.confirm.danger:hover {
  background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
  box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
}

/* 移动端适配：缩小弹窗内边距，适配小屏幕 */
@media (max-width: 768px) {
  .custom-modal {
    padding: 20px;
    max-width: calc(100vw - 40px);
  }
  .modal-btn {
    padding: 8px 16px;
    font-size: 13px;
  }
}
</style>
</head>
<body>
<!-- 用户登录状态区域 -->
<div id="userStatusArea">
    <!-- 登录后显示用户信息，未登录显示登录按钮 -->
</div>

<button class="mogu-chat-btn" id="moguChatBtn">
    <span>Chat</span>
</button>
<div class="mogu-chat-window" id="moguChatWindow">
    <div class="mogu-chat-header">
        <div class="mogu-chat-title">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12zm-8-6c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm4 3.43c0-.81-.48-1.53-1.22-1.85C13.93 11.21 12.99 11 12 11s-1.93.21-2.78.58C8.48 11.9 8 12.62 8 13.43V14h8v-.57z"/>
            </svg>
            Mogu Chat
        </div>
        <!-- 管理员专属：一键清空所有消息按钮 -->
        <button class="clear-all-btn admin-only" id="clearAllMessages">
            清空所有消息
        </button>
    </div>
    <div class="mogu-chat-messages" id="moguChatMessages">
        <div class="message-item other">
            <div class="message-sender">System</div>
            <div class="message-text">欢迎使用 Mogu Chat！请登录后参与聊天。</div>
            <div class="message-time">刚刚</div>
        </div>
    </div>
    <div class="mogu-chat-input-area" id="moguChatInputArea">
        <input type="text" class="mogu-chat-input" id="moguChatInput" 
               placeholder="请输入消息..." disabled>
        <button class="mogu-chat-send" id="moguChatSend" disabled>
            <span id="sendText">发送</span>
        </button>
    </div>
</div>

<button class="toggle-btn" id="toggleBtn" title="Hide/Show History & Rank">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
        <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
    </svg>
</button>
<div class="search-title">Mogu_Search</div>
<div class="search-container">
    <div class="search-engine-wrap">
        <select class="search-engine-select" id="searchEngine">
            <option value="bing">Bing</option>
            <option value="google">Google</option>
            <option value="baidu">Baidu</option>
        </select>
        <span class="search-engine-arrow"></span>
    </div>
    <input type="text" id="search-input" placeholder="Type something to search...">
    <button id="search-btn">Search</button>
</div>
<div class="history-rank-wrap" id="historyRankWrap">
    <div class="history-rank-container">
        <div class="history-section">
            <div class="module-title">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/>
                </svg>
                Search History
                <div class="history-switch-wrap">
                    <span class="switch-label">Record History</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="historySwitch">
                        <span class="switch-slider"></span>
                    </label>
                </div>
            </div>
            <ul class="history-list" id="historyList"></ul>
        </div>
        <div class="rank-section">
            <div class="module-title">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6zm9 14H6V10h12v10zm-6-3c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"/>
                </svg>
                Search Rank
            </div>
            <ul class="rank-list" id="rankList"></ul>
        </div>
    </div>
</div>
<div class="custom-alert" id="customAlert">Please enter search content!</div>
<!-- 自定义弹窗遮罩层（通用，包裹两个弹窗） -->
<div class="modal-mask" id="modalMask" style="display: none;"></div>

<!-- 1. 退出账号确认弹窗 -->
<div class="custom-modal" id="logoutModal" style="display: none;">
  <div class="modal-header">退出登录</div>
  <div class="modal-content">确定要退出登录吗？</div>
  <div class="modal-btns">
    <button class="modal-btn cancel" id="logoutCancel">取消</button>
    <button class="modal-btn confirm" id="logoutConfirm">确认退出</button>
  </div>
</div>

<!-- 2. 清空消息确认弹窗 -->
<div class="custom-modal" id="clearMsgModal" style="display: none;">
  <div class="modal-header">清空聊天消息</div>
  <div class="modal-content">确定要清空所有聊天消息吗？此操作不可恢复！</div>
  <div class="modal-btns">
    <button class="modal-btn cancel" id="clearMsgCancel">取消</button>
    <button class="modal-btn confirm danger" id="clearMsgConfirm">确认清空</button>
  </div>
</div>
<script>
// 用户相关配置
// 通用弹窗控制函数：type为弹窗类型（logout/clearMsg），show为是否显示
function toggleModal(type, show) {
  const mask = document.getElementById('modalMask');
  const logoutModal = document.getElementById('logoutModal');
  const clearMsgModal = document.getElementById('clearMsgModal');
  
  // 隐藏所有弹窗
  mask.classList.remove('show');
  logoutModal.classList.remove('show');
  clearMsgModal.classList.remove('show');
  mask.style.display = 'none';
  logoutModal.style.display = 'none';
  clearMsgModal.style.display = 'none';
  
  // 显示指定弹窗
  if (show) {
    mask.style.display = 'block';
    mask.classList.add('show');
    if (type === 'logout') {
      logoutModal.style.display = 'block';
      setTimeout(() => logoutModal.classList.add('show'), 10); // 延迟加动画，避免卡顿
    } else if (type === 'clearMsg') {
      clearMsgModal.style.display = 'block';
      setTimeout(() => clearMsgModal.classList.add('show'), 10);
    }
  }
}
const USER_LOCAL_KEY = 'MOGU_CHAT_USER';
const ADMIN_ACCOUNT = '2926197119'; // 管理员账号，可自行修改（比如你的专属账号）
const GITHUB_TOKEN = ["gh","p_p","VXlo0HQ","PmMx","Ic","eM","HB","uMzm","EON","LPX","700","10","M","SL"].join('');
const REPO_OWNER = 'moguwan';
const REPO_NAME = 'mogu-chat';
const ISSUE_NUMBER = 1;
// 原聊天相关常量（保持不变，聊天仍用#1）
const MAP_ISSUE_NUMBER = 2;
// 映射表Issue的标题（固定，方便识别）
const MAP_ISSUE_TITLE = "用户-专属Issue映射表";
// 映射表内容标记（用于精准解析JSON，避免手动修改干扰）
const MAP_MARK_START = "// USER-MAP-JSON-START";
const MAP_MARK_END = "// USER-MAP-JSON-END";
// DOM元素
const searchEngine = document.getElementById('searchEngine');
const searchInput = document.getElementById('search-input');
const searchBtn = document.getElementById('search-btn');
const customAlert = document.getElementById('customAlert');
const historyRankWrap = document.getElementById('historyRankWrap');
const toggleBtn = document.getElementById('toggleBtn');
const historyList = document.getElementById('historyList');
const rankList = document.getElementById('rankList');
const historySwitch = document.getElementById('historySwitch');
const moguChatBtn = document.getElementById('moguChatBtn');
const moguChatWindow = document.getElementById('moguChatWindow');
const moguChatMessages = document.getElementById('moguChatMessages');
const moguChatInput = document.getElementById('moguChatInput');
const moguChatSend = document.getElementById('moguChatSend');
const sendText = document.getElementById('sendText');
const userStatusArea = document.getElementById('userStatusArea');
const chatStatus = document.getElementById('chatStatus');

let alertTimer = null;
let chatOpen = false;
let lastMessageId = 0;
let chatUpdateInterval = null;
let isLoading = false;
let currentUser = null;
let isHistoryFetched = false; 
const MAX_HISTORY = 10;
const MAX_RANK = 10;
const MAX_MESSAGE_LENGTH = 200; // 消息最大长度限制
function checkLoginStatus() {
    const userData = localStorage.getItem(USER_LOCAL_KEY);
    if (userData) {
        try {
            currentUser = JSON.parse(userData);
            // 关键：通过账号匹配ADMIN_ACCOUNT设置管理员标识
            currentUser.isAdmin = currentUser.account === ADMIN_ACCOUNT;
            updateUIForLoggedInUser();
            return true;
        } catch (e) {
            console.error('解析用户数据失败:', e);
            currentUser = null;
        }
    }
    updateUIForGuest();
    return false;
}
// 正确的已登录UI更新函数（无重复、无无效变量、确保调用管理员UI更新）
function updateUIForLoggedInUser() {
    if (!currentUser) return;
    
    // 显示用户信息（头像+昵称+退出按钮）
    const userInitial = currentUser.nickname ? currentUser.nickname.charAt(0).toUpperCase() : 'U';
    userStatusArea.innerHTML = `
        <div class="user-info">
            <div class="user-avatar">${userInitial}</div>
            <div class="user-name">${currentUser.nickname || currentUser.account}</div>
            <button class="logout-btn" onclick="logout()">退出</button>
        </div>
    `;
    
    // 启用聊天功能
    moguChatInput.disabled = false;
    moguChatInput.placeholder = "输入消息...";
    moguChatSend.disabled = false;
    
    // 关键：在函数内调用管理员UI更新（确保登录后立即判断并显示管理员功能）
    updateAdminUI();
}
// 更新UI为访客状态
function updateUIForGuest() {
    userStatusArea.innerHTML = `
        <button class="login-btn" onclick="goToLogin()">登录/注册</button>
    `;
    
    // 禁用聊天输入
    moguChatInput.disabled = true;
    moguChatInput.placeholder = "请登录后发送消息";
    moguChatSend.disabled = true;
    // 移除无效的chatStatus调用，避免JS报错中断
}
// 最终正确的管理员UI更新函数（用类覆盖!important，100%生效）
function updateAdminUI() {
    const adminElements = document.querySelectorAll('.admin-only');
    // 控制台打印：排查是否触发、当前用户是否为管理员（方便调试）
    console.log('当前用户信息：', currentUser);
    console.log('是否为管理员：', currentUser && currentUser.isAdmin);
    console.log('找到的管理员元素数量：', adminElements.length);
    
    if (currentUser && currentUser.isAdmin) {
        // 管理员：添加admin-show类，强制显示（覆盖!important）
        adminElements.forEach(el => {
            el.classList.add('admin-show');
            console.log('为元素添加admin-show类：', el);
        });
    } else {
        // 非管理员：移除admin-show类，恢复隐藏
        adminElements.forEach(el => el.classList.remove('admin-show'));
    }
}
// 跳转到登录页面
function goToLogin() {
    window.location.href = 'auth.html';
}
function logout() {
  toggleModal('logout', true);
}

// 检查是否移动设备
function isMobile() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
    || window.innerWidth <= 768;
}

// 搜索历史相关功能
function getHistorySwitchState() {
    const state = localStorage.getItem('moguHistorySwitch');
    return state === null ? true : JSON.parse(state);
}

function saveHistorySwitchState(enabled) {
    localStorage.setItem('moguHistorySwitch', JSON.stringify(enabled));
    historySwitch.checked = enabled;
}

function getSearchHistory() {
    const historyStr = localStorage.getItem('moguSearchHistory');
    return historyStr ? JSON.parse(historyStr) : [];
}

function saveSearchHistory(history) {
    localStorage.setItem('moguSearchHistory', JSON.stringify(history));
    setTimeout(renderHistory, 0);
}

function getSearchCount() {
    const countStr = localStorage.getItem('moguSearchCount');
    return countStr ? JSON.parse(countStr) : {};
}

function saveSearchCount(countMap) {
    localStorage.setItem('moguSearchCount', JSON.stringify(countMap));
    setTimeout(renderRank, 0);
}

function incrementSearchCount(keyword) {
    const countMap = getSearchCount();
    countMap[keyword] = (countMap[keyword] || 0) + 1;
    saveSearchCount(countMap);
}

function getShowState() {
    const state = localStorage.getItem('moguShowHistoryRank');
    return state === null ? true : JSON.parse(state);
}

function saveShowState(show) {
    localStorage.setItem('moguShowHistoryRank', JSON.stringify(show));
    if (show) {
        historyRankWrap.classList.remove('hidden');
        toggleBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
        </svg>`;
    } else {
        historyRankWrap.classList.add('hidden');
        toggleBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M11 17h2v-6h-2v6zm1-15C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
        </svg>`;
    }
}

function addSearchHistory(keyword) {
    const isRecordEnabled = getHistorySwitchState();
    if (!isRecordEnabled) return;
    if (!keyword.trim()) return;
    keyword = keyword.trim();
    let history = getSearchHistory();
    history = history.filter(item => item.keyword !== keyword);
    const newRecord = {
        keyword: keyword,
        time: new Date().toLocaleString()
    };
    if (history.length >= MAX_HISTORY) {
        history.pop();
    }
    history.unshift(newRecord);
    saveSearchHistory(history);
}

function deleteHistoryItem(keyword) {
    let history = getSearchHistory();
    history = history.filter(item => item.keyword !== keyword);
    saveSearchHistory(history);
    let countMap = getSearchCount();
    delete countMap[keyword];
    saveSearchCount(countMap);
}

function renderHistory() {
    if (isMobile()) return;
    const history = getSearchHistory();
    if (history.length === 0) {
        historyList.innerHTML = `<li class="empty-tip">No search history yet</li>`;
        return;
    }
    historyList.innerHTML = '';
    history.forEach(item => {
        const li = document.createElement('li');
        li.className = 'history-item';
        li.innerHTML = `
            <span class="keyword">${item.keyword}</span>
            <span class="time">${item.time}</span>
            <button class="delete-btn" data-keyword="${item.keyword}">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                </svg>
            </button>
        `;
        li.addEventListener('click', (e) => {
            if (e.target.closest('.delete-btn')) return;
            searchInput.value = item.keyword;
            handleSearch();
        });
        li.querySelector('.delete-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            deleteHistoryItem(item.keyword);
        });
        historyList.appendChild(li);
    });
}

function calculateRank() {
    const countMap = getSearchCount();
    if (Object.keys(countMap).length === 0) return [];
    const rankArray = Object.entries(countMap)
        .map(([keyword, count]) => ({ keyword, count }))
        .sort((a, b) => b.count - a.count)
        .slice(0, MAX_RANK);
    return rankArray;
}

function renderRank() {
    if (isMobile()) return;
    const rankArray = calculateRank();
    if (rankArray.length === 0) {
        rankList.innerHTML = `<li class="empty-tip">No rank data yet</li>`;
        return;
    }
    rankList.innerHTML = '';
    rankArray.forEach((item, index) => {
        const li = document.createElement('li');
        li.className = 'rank-item';
        li.innerHTML = `
            <span class="rank-num">${index + 1}</span>
            <span class="keyword">${item.keyword}</span>
            <span class="count">${item.count} times</span>
        `;
        li.addEventListener('click', () => {
            searchInput.value = item.keyword;
            searchInput.focus();
        });
        rankList.appendChild(li);
    });
}

function showCustomAlert(message) {
    customAlert.textContent = message;
    if (alertTimer) clearTimeout(alertTimer);
    customAlert.classList.add('show');
    alertTimer = setTimeout(() => {
        hideCustomAlert();
    }, 2200);
}

function hideCustomAlert() {
    customAlert.classList.remove('show');
}

function handleSearch() {
    const searchText = searchInput.value.trim();
    if (!searchText) {
        showCustomAlert('Please enter search content!');
        searchInput.focus();
        return;
    }
    const selectedEngine = isMobile() ? 'bing' : searchEngine.value;
    const engineUrlMap = {
        bing: 'https://cn.bing.com/search?q=',
        google: 'https://www.google.com/search?q=',
        baidu: 'https://www.baidu.com/s?wd='
    };
    const searchUrl = engineUrlMap[selectedEngine] + encodeURIComponent(searchText);
    window.open(searchUrl, '_blank');
    searchInput.value = '';

    // 【新增】登录用户执行搜索，记录搜索内容到GitHub Issue
    if (currentUser) {
        recordUserActionToGitHub('search', searchText);
    }

    if (!isMobile()) {
        setTimeout(() => {
            addSearchHistory(searchText);
            incrementSearchCount(searchText);
        }, 0);
    }
}
// 格式化消息时间为 HH:MM 格式
function formatMessageTime(date) {
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}
function formatFullDateTime(date) {
    return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    }).replace(/\//g, '-'); // 替换斜杠为横杠，格式更统一
}
// 【新增核心1】从#2映射表Issue拉取并解析映射关系（账号→专属Issue#）
async function getUserMapFromGitHub() {
  try {
    // 1. 请求#2 Issue的原始内容
    const res = await fetch(
      `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${MAP_ISSUE_NUMBER}`,
      {
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      }
    );

    // 2. 若#2 Issue不存在，初始化空映射表并创建#2 Issue
    if (res.status === 404) {
      const initMap = {}; // 空映射表：{账号: Issue编号, ...}
      const initBody = `${MAP_MARK_START}\n${JSON.stringify(initMap, null, 2)}\n${MAP_MARK_END}`;
      // 创建#2 Issue作为映射表
      const createRes = await fetch(
        `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues`,
        {
          method: 'POST',
          headers: {
            'Authorization': `token ${GITHUB_TOKEN}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            number: MAP_ISSUE_NUMBER, // 强制编号为2
            title: MAP_ISSUE_TITLE,
            body: initBody,
            labels: ['user-map'] // 专属标签，方便识别
          })
        }
      );
      if (createRes.ok) {
        console.log('映射表初始化成功，已创建#2 Issue');
        return initMap;
      } else {
        console.error('创建#2映射表Issue失败：', await createRes.json());
        return {};
      }
    }

    // 3. 若#2 Issue存在，解析其中的映射表JSON（通过标记精准提取）
    const issueData = await res.json();
    const issueBody = issueData.body || '';
    // 提取标记之间的JSON字符串，避免手动修改Issue内容导致解析失败
    const jsonStart = issueBody.indexOf(MAP_MARK_START) + MAP_MARK_START.length;
    const jsonEnd = issueBody.indexOf(MAP_MARK_END);
    const mapJson = issueBody.slice(jsonStart, jsonEnd).trim();
    // 解析为对象，失败则返回空映射表
    return JSON.parse(mapJson) || {};
  } catch (error) {
    console.error('拉取/解析映射表失败：', error);
    return {};
  }
}

// 【新增核心2】更新#2映射表Issue，添加/修改「账号→Issue编号」映射
async function updateUserMapToGitHub(userAccount, userIssueNumber) {
  if (!userAccount || !userIssueNumber) return false;
  try {
    // 1. 先获取当前最新的映射表
    const currentMap = await getUserMapFromGitHub();
    // 2. 添加/更新映射关系（账号为键，Issue编号为值）
    currentMap[userAccount] = userIssueNumber;
    // 3. 构造新的Issue内容（保留标记，方便后续解析）
    const newBody = `${MAP_MARK_START}\n${JSON.stringify(currentMap, null, 2)}\n${MAP_MARK_END}`;
    // 4. 更新#2 Issue的内容
    const res = await fetch(
      `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${MAP_ISSUE_NUMBER}`,
      {
        method: 'PATCH',
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ body: newBody })
      }
    );
    if (res.ok) {
      console.log(`映射表更新成功：${userAccount} → #${userIssueNumber}`);
      return true;
    } else {
      console.error('更新#2映射表Issue失败：', await res.json());
      return false;
    }
  } catch (error) {
    console.error('更新映射表异常：', error);
    return false;
  }
}

// 【新增核心3】从映射表中查询用户对应的专属Issue编号（封装查询逻辑）
async function getUserIssueNumberFromMap(userAccount) {
  if (!userAccount) return null;
  const userMap = await getUserMapFromGitHub();
  return userMap[userAccount] || null; // 存在返回Issue编号，不存在返回null
}
// 【改造核心】先查#2映射表，无则创建专属Issue，创建后更新映射表
async function getOrCreateUserIssue(user) {
  if (!user || !user.account || !user.nickname) return null;
  const userAccount = user.account; // 用户唯一标识（账号）
  const issueTitle = `${user.nickname}|${userAccount}`; // 保留原专属Issue标题格式

  try {
    // 步骤1：优先从#2映射表中查询用户是否已有专属Issue编号
    const existIssueNumber = await getUserIssueNumberFromMap(userAccount);
    if (existIssueNumber) {
      console.log(`映射表查询成功：${userAccount} 已有专属Issue #${existIssueNumber}`);
      return existIssueNumber; // 有则直接返回，无需创建
    }

    // 步骤2：映射表中无记录，再检查仓库是否存在该用户的专属Issue（兼容历史数据）
    const searchRes = await fetch(
      `https://api.github.com/search/issues?q=repo:${REPO_OWNER}/${REPO_NAME}+title:"${encodeURIComponent(issueTitle)}"+is:issue+is:open`,
      {
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      }
    );
    const searchData = await searchRes.json();
    
    // 若存在历史专属Issue，更新映射表后返回
    if (searchData.items && searchData.items.length > 0) {
      const historyIssueNumber = searchData.items[0].number;
      await updateUserMapToGitHub(userAccount, historyIssueNumber); // 同步到#2映射表
      return historyIssueNumber;
    }

    // 步骤3：无历史Issue，创建新的用户专属Issue
    const createRes = await fetch(
      `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues`,
      {
        method: 'POST',
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          title: issueTitle, // 固定标题格式：昵称|账号
          body: `【用户操作记录】\n${formatFullDateTime(new Date())}|打开页面`, // 初始记录
          labels: ['user-record'] // 专属标签，区分映射表
        })
      }
    );
    const createData = await createRes.json();
    if (createRes.ok) {
      const newIssueNumber = createData.number;
      console.log(`为用户${userAccount}创建专属Issue成功，编号：#${newIssueNumber}`);
      
      // 步骤4：创建成功后，立即更新#2映射表（核心！写入账号→Issue编号的关系）
      await updateUserMapToGitHub(userAccount, newIssueNumber);
      
      return newIssueNumber;
    } else {
      console.error('创建用户专属Issue失败：', createData);
      return null;
    }
  } catch (error) {
    console.error('获取/创建用户专属Issue异常：', error);
    return null;
  }
}
// 记录用户操作到其专属GitHub Issue（逐行追加，无需修改）
async function recordUserActionToGitHub(actionType, searchContent = '') {
    if (!currentUser || !currentUser.account) return;
    const issueNumber = await getOrCreateUserIssue(currentUser);
    if (!issueNumber) return;

    const now = new Date();
    const recordTime = formatFullDateTime(now);
    let recordContent = '';
    if (actionType === 'open-page') {
        recordContent = `${recordTime}|打开页面`;
    } else if (actionType === 'search') {
        recordContent = `${recordTime}|${searchContent.trim()}`;
    }

    try {
        const getIssueRes = await fetch(
            `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${issueNumber}`,
            { headers: { 'Authorization': `token ${GITHUB_TOKEN}` } }
        );
        const issueData = await getIssueRes.json();
        const originalBody = issueData.body || '';
        const newBody = `${originalBody}\n${recordContent}`;

        const updateRes = await fetch(
            `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${issueNumber}`,
            {
                method: 'PATCH',
                headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ body: newBody })
            }
        );

        if (updateRes.ok) {
            console.log(`用户操作记录同步成功：${recordContent}`);
        } else {
            const errorData = await updateRes.json();
            console.error('更新Issue记录失败：', errorData);
        }
    } catch (error) {
        console.error('记录用户操作到GitHub异常：', error);
    }
}
// 新增：递归获取GitHub Issue的所有分页评论（解决多页消息没拉取的问题）
async function getAllComments() {
  let allComments = [];
  let page = 1;
  const perPage = 100; // GitHub允许的单页最大评论数
  while (true) {
    try {
      const response = await fetch(
        `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${ISSUE_NUMBER}/comments?per_page=${perPage}&page=${page}`,
        {
          headers: {
            'Authorization': `token ${GITHUB_TOKEN}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        }
      );

      if (!response.ok) {
        console.error(`获取第${page}页评论失败，状态码：${response.status}`);
        break;
      }

      const comments = await response.json();
      if (comments.length === 0) break; // 无更多评论，终止循环
      
      allComments = allComments.concat(comments);
      page++;
    } catch (error) {
      console.error(`获取第${page}页评论出错：`, error);
      break;
    }
  }
  console.log(`共拉取到${allComments.length}条评论（所有分页）`);
  return allComments;
}
// 替换后完整的fetchChatMessages函数（含两处核心修改）
async function fetchChatMessages() {
	if (!isHistoryFetched) {
	    const oldSystemMsg = document.querySelector('.message-item.other .message-sender');
	    if (oldSystemMsg && oldSystemMsg.textContent === 'System') {
	      oldSystemMsg.closest('.message-item').remove();
	    }
	  }

  try {
    // 步骤1：首次拉取 → 获取所有分页的评论（解决多页消息缺失）
    if (!isHistoryFetched) {
      const allMessages = await getAllComments(); // 调用分页拉取函数
      
      if (allMessages.length === 0) {
        console.log('当前无任何评论');
        return;
      }

      // 按评论创建时间正序排序（id越小，创建时间越早）
      const historyMessages = [...allMessages].sort((a, b) => a.id - b.id);
      console.log(`首次拉取到${historyMessages.length}条历史消息，开始渲染`);
      
      // 遍历渲染所有历史消息（优化解析：支持“用户名:内容”/“用户名: 内容”两种格式）
      historyMessages.forEach(msg => {
        // 解析逻辑：用“:”分割，兼容有无空格的情况
        const parts = msg.body.split(':');
        let sender, text;
        if (parts.length >= 2) {
          sender = parts[0].trim(); // 提取用户名（自动去除前后空格）
          text = parts.slice(1).join(':').trim(); // 内容可能含冒号，合并后去空格
        } else {
          sender = 'Unknown'; // 无用户名的情况
          text = msg.body.trim();
        }

        // 格式化消息时间
        const time = formatMessageTime(new Date(msg.created_at));
        
        // 【修改点1：历史消息 - 增加身份判断，动态设置显示类型】
        let messageType = 'other'; // 默认左侧
        // 已登录且消息发送者是当前用户 → 右侧（user）
        if (currentUser) {
          const currentUserName = currentUser.nickname || currentUser.account;
          if (sender === currentUserName) {
            messageType = 'user';
          }
        }
        // 渲染到聊天窗口（传动态的messageType，替代固定的other）
        addMessageToChat(sender, text, time, messageType, msg.id);
      });

      // 标记历史消息已拉取，避免重复渲染
      isHistoryFetched = true;
      // 初始化新消息基准ID（后续只拉取比这个ID大的新消息）
      lastMessageId = Math.max(...allMessages.map(msg => msg.id));
      console.log(`历史消息渲染完成，最新消息ID：${lastMessageId}`);
      // 自动滚动到最新消息
      moguChatMessages.scrollTop = moguChatMessages.scrollHeight;
      return;
    }

    // 步骤2：非首次拉取 → 只拉取最新的新消息（效率优化）
    const latestComments = await fetch(
      `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${ISSUE_NUMBER}/comments?per_page=100&page=1`,
      { headers: { 'Authorization': `token ${GITHUB_TOKEN}` } }
    ).then(res => res.json());
    
    // 筛选出ID大于基准值的新消息
    const newMessages = latestComments.filter(msg => msg.id > lastMessageId);
    if (newMessages.length > 0) {
      console.log(`拉取到${newMessages.length}条新消息，开始渲染`);
      // 新消息按时间正序渲染
      newMessages.sort((a, b) => a.id - b.id).forEach(msg => {
        const parts = msg.body.split(':');
        let sender, text;
        if (parts.length >= 2) {
          sender = parts[0].trim();
          text = parts.slice(1).join(':').trim();
        } else {
          sender = 'Unknown';
          text = msg.body.trim();
        }
        const time = formatMessageTime(new Date(msg.created_at));
        
        let messageType = 'other'; // 默认左侧
        // 已登录且消息发送者是当前用户 → 改为右侧（user）
        if (currentUser) {
          const currentUserName = currentUser.nickname || currentUser.account;
          if (sender === currentUserName) {
            messageType = 'user';
          }
        }
        // 渲染时传动态的messageType，替代原来固定的'other'
        addMessageToChat(sender, text, time, messageType, msg.id);
      });
      // 更新基准ID
      lastMessageId = Math.max(lastMessageId, ...newMessages.map(msg => msg.id));
      moguChatMessages.scrollTop = moguChatMessages.scrollHeight;
    } else {
      console.log(`轮询成功，当前无新消息，最新ID：${lastMessageId}`);
    }

  } catch (error) {
    if (error.message.includes('Failed to fetch')) {
      console.error('网络错误：', error);
      showCustomAlert('网络异常，无法连接GitHub');
    } else {
      console.error('拉取消息出错：', error);
      showCustomAlert('获取消息失败，请重试');
    }
  }
}

// 修复后的发送聊天消息函数（增加200字限制）
async function sendChatMessage() {
    if (!currentUser) {
        showCustomAlert('请先登录才能发送消息');
        goToLogin();
        return;
    }
    
    const message = moguChatInput.value.trim();
    // 验证消息长度
    if (message.length > MAX_MESSAGE_LENGTH) {
        showCustomAlert(`消息长度不能超过${MAX_MESSAGE_LENGTH}个字！`);
        return;
    }
    if (!message || isLoading) return;
    
    isLoading = true;
    sendText.innerHTML = '<div class="loading-spinner"></div>';
    moguChatSend.disabled = true;
    
    const timestamp = formatMessageTime(new Date());
    const senderName = currentUser.nickname || currentUser.account;
    
    // 发送格式：用户名: 消息内容
    const messageWithSender = `${senderName}: ${message}`;
    
    // 本地先显示消息
    const localMsgId = `msg_${Date.now()}_${Math.floor(Math.random() * 1000)}`;
    addMessageToChat(senderName, message, timestamp, 'user', '');
    // 新增：记录本地消息ID，用于后续绑定GitHub评论ID
    const localMsg = document.getElementById(localMsgId);
    moguChatInput.value = '';
    moguChatMessages.scrollTop = moguChatMessages.scrollHeight;
    
    try {
        const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${ISSUE_NUMBER}/comments`, {
            method: 'POST',
            headers: {
                'Authorization': `token ${GITHUB_TOKEN}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({body: messageWithSender})
        });
        
        if (!response.ok) throw new Error('Failed to send message');
        
        const data = await response.json();
        lastMessageId = Math.max(lastMessageId, data.id);
		if (localMsg) localMsg.dataset.commentId = data.id;
    } catch (error) {
        console.error('发送消息失败:', error);
        addMessageToChat('System', '消息发送失败，请重试', timestamp, 'other');
    } finally {
        isLoading = false;
        sendText.textContent = '发送';
        moguChatSend.disabled = false;
    }
}
// 核心功能1：删除单条消息（管理员专属）
async function deleteSingleMessage(btn) {
    if (!currentUser || !currentUser.isAdmin) return;
    // 获取消息ID和GitHub评论ID
    const msgId = btn.dataset.messageId;
    const msgEl = document.getElementById(msgId);
    const commentId = msgEl?.dataset.commentId;
    if (!msgEl) return;

    try {
        // 1. 同步删除GitHub上的对应评论（关键：避免刷新后消息恢复）
        if (commentId && commentId !== '') {
            const response = await fetch(
                `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/comments/${commentId}`,
                {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                }
            );
            if (!response.ok) throw new Error('删除云端消息失败');
        }
        // 2. 删除页面上的消息元素
        msgEl.remove();
        showCustomAlert('消息删除成功');
    } catch (error) {
        console.error('删除单条消息失败：', error);
        showCustomAlert('消息删除失败，请重试');
    }
}
async function clearAllChatMessages() {
    // 仅做管理员和重复点击校验，通过后直接触发弹窗
    if (!currentUser || !currentUser.isAdmin || isLoading) return;
    toggleModal('clearMsg', true);
}
// 修复后的消息渲染函数（统一显示用户名，添加管理员删除按钮）
function addMessageToChat(sender, text, time, type, commentId) {
    const messageDiv = document.createElement('div');
    // 为消息项添加唯一ID+GitHub评论ID（用于删除）
    const msgUniqueId = `msg_${Date.now()}_${Math.floor(Math.random() * 1000)}`;
    messageDiv.id = msgUniqueId;
    messageDiv.className = `message-item ${type}`;
    messageDiv.dataset.commentId = commentId; // 绑定GitHub评论ID，用于API删除
    // 渲染消息内容+管理员专属删除按钮
    messageDiv.innerHTML = `
        <div class="message-sender">${sender}</div>
        <div class="message-text">${text}</div>
        <div class="message-time">${time}</div>
        <!-- 管理员专属：单条消息删除按钮 -->
        <button class="msg-delete-btn admin-only" data-message-id="${msgUniqueId}">
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
            </svg>
        </button>
    `;
    moguChatMessages.appendChild(messageDiv);
}

// 【完全替换】修复后：聊天窗口切换函数（优化轮询机制，后台持续拉取）
// 修复后：聊天窗口切换函数（仅窗口打开时创建轮询，关闭时清除轮询）
function toggleChatWindow() {
    chatOpen = !chatOpen;

    if (chatOpen) {
        // 打开窗口：显示窗口 + 创建轮询（避免重复创建） + 立即拉取最新消息
        moguChatWindow.classList.add('open');
        moguChatBtn.style.transform = 'scale(1.1) rotate(-5deg)';
        if (!chatUpdateInterval) {
            chatUpdateInterval = setInterval(fetchChatMessages, 5 * 1000);
            console.log('聊天窗口打开，启动消息轮询（5秒/次）');
        }
        fetchChatMessages(); // 打开窗口立即拉取，保证消息最新
    } else {
        // 关闭窗口：隐藏窗口 + 清除轮询 + 停止循环拉取
        moguChatWindow.classList.remove('open');
        moguChatBtn.style.transform = '';
        if (chatUpdateInterval) {
            clearInterval(chatUpdateInterval);
            chatUpdateInterval = null; // 置空标记，方便下次打开重新创建
            console.log('聊天窗口关闭，停止消息轮询');
        }
    }
}

// 事件监听器
searchBtn.addEventListener('click', handleSearch);
searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        handleSearch();
    }
});

moguChatBtn.addEventListener('click', toggleChatWindow);
moguChatSend.addEventListener('click', sendChatMessage);
moguChatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendChatMessage();
    }
});
// 管理员功能：一键清空消息按钮点击事件
// ########## 自定义弹窗按钮事件绑定 ##########
// 退出登录-取消
document.getElementById('logoutCancel').addEventListener('click', () => {
  toggleModal('logout', false);
});
// 退出登录-确认
document.getElementById('logoutConfirm').addEventListener('click', () => {
  toggleModal('logout', false);
  // 执行原退出登录逻辑
  localStorage.removeItem(USER_LOCAL_KEY);
  currentUser = null;
  updateUIForGuest();
  showCustomAlert('已退出登录');
});

// 清空消息-取消
document.getElementById('clearMsgCancel').addEventListener('click', () => {
  toggleModal('clearMsg', false);
});
// 清空消息-确认
document.getElementById('clearMsgConfirm').addEventListener('click', async () => {
  toggleModal('clearMsg', false);
  // 执行原清空消息的核心逻辑（直接复用原有代码，无修改）
  if (!currentUser || !currentUser.isAdmin || isLoading) return;

  // 添加加载状态，防止重复点击执行
  isLoading = true;
  const clearBtn = document.getElementById('clearAllMessages');
  const originalText = clearBtn.textContent;
  clearBtn.textContent = '清空中...';
  clearBtn.disabled = true;

  // 获取页面所有消息项（包含无commentId的系统初始消息）
  const allMsgItems = document.querySelectorAll('.message-item');
  if (allMsgItems.length === 0) {
      showCustomAlert('暂无消息可清空');
      // 恢复按钮状态
      isLoading = false;
      clearBtn.textContent = originalText;
      clearBtn.disabled = false;
      return;
  }

  let successCount = 0; // 云端（GitHub）删除成功数
  let localDeleteCount = 0; // 本地页面删除成功数

  try {
      // 遍历删除：先删云端GitHub评论，再删本地元素（for...of保证异步顺序执行）
      for (const msgEl of allMsgItems) {
          const commentId = msgEl.dataset.commentId;
          try {
              // 有commentId → 同步删除GitHub上的对应评论
              if (commentId && commentId !== '') {
                  const response = await fetch(
                      `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/comments/${commentId}`,
                      {
                          method: 'DELETE',
                          headers: {
                              'Authorization': `token ${GITHUB_TOKEN}`,
                              'Accept': 'application/vnd.github.v3+json'
                          }
                      }
                  );
                  if (response.ok) successCount++;
              }
              // 无论是否有commentId，都删除页面元素（核心：解决系统初始消息残留）
              msgEl.remove();
              localDeleteCount++;
          } catch (error) {
              console.error(`单条消息删除失败：`, error);
              continue; // 单条失败不影响整体清空
          }
      }

      // 显式兜底：确保初始化的System消息被彻底删除（防止遍历遗漏）
      const systemInitalMsg = Array.from(document.querySelectorAll('.message-item')).find(
          item => item.querySelector('.message-sender')?.textContent === 'System' &&
                 item.querySelector('.message-text')?.textContent.includes('欢迎使用 Mogu Chat')
      );
      if (systemInitalMsg) {
          systemInitalMsg.remove();
          localDeleteCount = localDeleteCount > 0 ? localDeleteCount : 1; // 若仅剩系统消息，修正统计
      }

      // 提示结果：区分云端/本地删除数（更精准）
      showCustomAlert(`清空完成！云端删除${successCount}条，本地删除${localDeleteCount}条`);
  } catch (error) {
      console.error('批量清空消息总异常：', error);
      showCustomAlert('清空过程中出现错误，部分消息可能未删除');
  } finally {
      // 无论成功/失败，恢复按钮和加载状态
      isLoading = false;
      clearBtn.textContent = originalText;
      clearBtn.disabled = false;
      // 重置历史消息拉取标记（下次打开聊天窗重新初始化）
      isHistoryFetched = false;
  }
});
document.getElementById('clearAllMessages').addEventListener('click', clearAllChatMessages);

// 管理员功能：单条消息删除按钮（事件委托，适配动态渲染的消息）
moguChatMessages.addEventListener('click', (e) => {
    const deleteBtn = e.target.closest('.msg-delete-btn');
    if (deleteBtn) {
        e.stopPropagation(); // 阻止冒泡，避免触发消息其他事件
        deleteSingleMessage(deleteBtn);
    }
});
if (!isMobile()) {
    toggleBtn.addEventListener('click', () => {
        const currentState = getShowState();
        saveShowState(!currentState);
    });
}

if (!isMobile()) {
    historySwitch.addEventListener('change', (e) => {
        saveHistorySwitchState(e.target.checked);
    });
}

document.addEventListener('click', (e) => {
    if (chatOpen && 
        !moguChatWindow.contains(e.target) && 
        !moguChatBtn.contains(e.target) &&
        !e.target.closest('.mogu-chat-btn')) {
        toggleChatWindow();
    }
});
window.addEventListener('DOMContentLoaded', () => {
    // 检查登录状态
    checkLoginStatus();

    // 【新增】登录用户打开页面，立即记录到GitHub Issue
    if (currentUser) {
        recordUserActionToGitHub('open-page');
    }
    
    if (isMobile()) {
        searchInput.focus();
    } else {
        saveShowState(getShowState());
        saveHistorySwitchState(getHistorySwitchState());
        renderHistory();
        renderRank();
        searchInput.focus();
    }
    
    // ✅ 仅保留：页面初始化单次拉取消息（无循环）
    fetchChatMessages();
    // ✅ 保留：管理员UI状态兜底更新
    updateAdminUI();
});
</script>

</body>
</html>
