<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Mogu Search - Mg</title>
<style>
:root {
  --forest: #3D6B4F;
  --forest-dark: #2D4F3A;
  --peach: #E07A5F;
  --peach-light: #F4A261;
  --cream: #F2E8CF;
  --soft-gold: #E9C46A;
  --glass-bg: rgba(255, 253, 245, 0.78);
  --glass-border: rgba(255, 255, 255, 0.5);
  --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.12);
  --text-primary: #2D4F3A;
  --text-secondary: #5A7D6C;
  --ease-smooth: cubic-bezier(0.25, 0.46, 0.45, 0.94);
  --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
  --radius: 32px;
  --radius-lg: 48px;
  --radius-sm: 20px;
}
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "PingFang SC", "Helvetica Neue", sans-serif;
  -webkit-tap-highlight-color: transparent;
}
html, body {
  height: 100%;
  overflow: hidden;
  position: fixed;
  width: 100%;
  overscroll-behavior: none;
}
body {
  color: var(--text-primary);
  background: #f5f3f0;
  transition: background 0.5s ease;
}
.chinese-bg-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: -1;
  background-image: url('https://img.wjwj.top/2026/01/28/6b1f3899b3a7eefb30f601d3003d76bf.png');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  background-attachment: fixed;
}
.liquid-glass-flat {
  background: rgba(255, 253, 245, 0.85);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.6);
  box-shadow: 0 4px 20px rgba(45, 79, 58, 0.08);
  border-radius: var(--radius);
  position: relative;
  overflow: hidden;
}
.liquid-glass {
  background: linear-gradient(135deg, rgba(255, 253, 245, 0.85) 0%, rgba(255, 251, 240, 0.6) 100%);
  backdrop-filter: blur(20px) saturate(200%) contrast(1.1);
  -webkit-backdrop-filter: blur(20px) saturate(200%) contrast(1.1);
  border: 1px solid rgba(255, 255, 255, 0.6);
  box-shadow: 
    0 8px 32px rgba(45, 79, 58, 0.12),
    inset 0 1px 0 rgba(255, 255, 255, 0.9),
    inset 0 -1px 0 rgba(255, 255, 255, 0.3);
  border-radius: var(--radius);
  position: relative;
  overflow: hidden;
}
.liquid-glass::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(180deg, 
    rgba(255, 255, 255, 0.4) 0%, 
    transparent 40%, 
    transparent 60%, 
    rgba(242, 232, 207, 0.3) 100%);
  pointer-events: none;
  border-radius: var(--radius);
}
.main-container {
  height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 0 20px;
  position: relative;
  z-index: 1;
  gap: 16px;
}
.search-title {
  font-size: clamp(2rem, 6vw, 3rem);
  font-weight: 700;
  letter-spacing: -0.01em;
  color: #ffffff;
  text-shadow: 0 2px 8px rgba(0,0,0,0.2);
  position: relative;
  font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
  user-select: none;
  cursor: default;
  transition: transform 0.4s var(--ease-spring), filter 0.4s;
  margin-bottom: 8px;
  background: none;
  -webkit-background-clip: unset;
  -webkit-text-fill-color: unset;
}
.search-title:hover {
  transform: scale(1.03) translateY(-3px);
  filter: drop-shadow(0 6px 12px rgba(0,0,0,0.15));
}
.search-wrapper {
  width: 100%;
  max-width: 600px;
  position: relative;
  transform: translateY(0);
}
.search-container {
  width: 100%;
  padding: 6px;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s var(--ease-smooth);
  will-change: transform;
  border-radius: 24px;
  background: rgba(255, 253, 245, 0.9);
  backdrop-filter: blur(12px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.8);
  box-shadow: 
    0 2px 12px rgba(45, 79, 58, 0.06),
    0 1px 3px rgba(0, 0, 0, 0.04),
    inset 0 1px 0 rgba(255, 255, 255, 0.9);
}
.search-container:hover {
  transform: translateY(-1px);
  box-shadow: 
    0 4px 20px rgba(45, 79, 58, 0.1),
    0 2px 6px rgba(0, 0, 0, 0.04),
    inset 0 1px 0 rgba(255, 255, 255, 0.9);
  border-color: rgba(224, 122, 95, 0.3);
}
.search-container:focus-within {
  transform: translateY(-1px);
  box-shadow: 
    0 0 0 3px rgba(224, 122, 95, 0.1),
    0 4px 20px rgba(45, 79, 58, 0.12),
    inset 0 1px 0 rgba(255, 255, 255, 0.9);
  border-color: rgba(224, 122, 95, 0.4);
}
.search-engine-select {
  appearance: none;
  background: rgba(61, 107, 79, 0.06);
  border: none;
  padding: 10px 16px;
  font-size: 14px;
  font-weight: 600;
  color: var(--forest);
  cursor: pointer;
  border-radius: 18px;
  transition: all 0.3s var(--ease-smooth);
  font-family: "PingFang SC", sans-serif;
  border: 1px solid rgba(61, 107, 79, 0.1);
}
.search-engine-select:hover {
  background: rgba(61, 107, 79, 0.12);
  transform: scale(1.02);
}
#search-input {
  flex: 1;
  border: none;
  background: transparent;
  font-size: 16px;
  padding: 12px 8px;
  color: var(--text-primary);
  outline: none;
  font-weight: 500;
  font-family: "PingFang SC", sans-serif;
}
#search-input::placeholder {
  color: var(--text-secondary);
  font-weight: 400;
  opacity: 0.5;
  font-size: 15px;
}
#search-btn {
  background: var(--forest);
  color: white;
  border: none;
  box-shadow: 0 2px 8px rgba(61, 107, 79, 0.25);
  width: 42px;
  height: 42px;
  border-radius: 50%;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s var(--ease-spring);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
  flex-shrink: 0;
}
#search-btn:hover {
  transform: scale(1.1) rotate(8deg);
  box-shadow: 0 4px 16px rgba(224, 122, 95, 0.35);
  background: var(--peach);
}
#search-btn:active {
  transform: scale(0.95);
}
#search-btn::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
  transition: left 0.5s;
}
#search-btn:hover::before {
  left: 100%;
}
.history-rank-wrap {
  width: 100%;
  max-width: 600px;
  transform: translateY(0);
  transition: all 0.5s var(--ease-spring);
  max-height: 400px;
  opacity: 1;
  overflow: hidden;
  margin-top: 8px;
}
.history-rank-wrap.hidden {
  max-height: 0;
  opacity: 0;
  margin: 0;
  transform: translateY(-10px);
}
.history-rank-container {
  display: grid;
  grid-template-columns: 1fr;
  gap: 16px;
}
.history-section {
  margin-top: 0;
  padding: 20px;
  display: flex;
  flex-direction: column;
  min-height: 280px;
  transition: all 0.4s var(--ease-spring);
  border-radius: var(--radius);
}
.history-section:hover {
  transform: translateY(-3px);
  box-shadow: 
    0 20px 40px rgba(45, 79, 58, 0.08),
    inset 0 1px 0 rgba(255,255,255,0.9);
}
.module-title {
  font-size: 12px;
  font-weight: 700;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-family: "PingFang SC", sans-serif;
}
.history-list {
  list-style: none;
  max-height: 240px;
  overflow-y: auto;
  padding-right: 4px;
  overflow-x: hidden;
  position: relative;
}
::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-thumb {
  background: rgba(61, 107, 79, 0.2);
  border-radius: 10px;
  border: 2px solid transparent;
  background-clip: padding-box;
}
::-webkit-scrollbar-track { background: transparent; }
.history-item {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  border-radius: 14px;
  margin-bottom: 8px;
  cursor: pointer;
  transition: all 0.3s var(--ease-spring);
  color: var(--text-primary);
  font-size: 13px;
  font-weight: 500;
  background: rgba(255,253,245,0.5);
  border: 1px solid rgba(255,255,255,0.4);
  font-family: "PingFang SC", sans-serif;
}
.history-item:hover {
  background: rgba(255,255,255,0.95);
  transform: scale(1.01) translateX(4px);
  box-shadow: 0 2px 8px rgba(45, 79, 58, 0.06);
  border-color: rgba(224, 122, 95, 0.2);
  padding-left: 20px;
}
.history-item .time {
  margin-left: auto;
  font-size: 11px;
  color: var(--text-secondary);
  margin-right: 8px;
  font-weight: 500;
  opacity: 0.7;
}
.delete-btn {
  background: rgba(224, 122, 95, 0.08);
  border: none;
  color: var(--peach);
  cursor: pointer;
  opacity: 0;
  width: 24px;
  height: 24px;
  border-radius: 8px;
  transition: all 0.3s var(--ease-spring);
  display: flex;
  align-items: center;
  justify-content: center;
}
.history-item:hover .delete-btn { opacity: 1; }
.delete-btn:hover { 
  background: var(--peach); 
  color: white; 
  transform: scale(1.1) rotate(90deg);
}
.toggle-switch {
  width: 44px;
  height: 26px;
  position: relative;
  display: inline-block;
}
.toggle-switch input { opacity: 0; width: 0; height: 0; }
.switch-slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: rgba(45, 79, 58, 0.15);
  border-radius: 26px;
  transition: .3s var(--ease-spring);
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.08);
}
.switch-slider:before {
  position: absolute;
  content: "";
  height: 22px;
  width: 22px;
  left: 2px;
  bottom: 2px;
  background-color: white;
  border-radius: 50%;
  transition: .3s var(--ease-spring);
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}
input:checked + .switch-slider { background-color: var(--forest); }
input:checked + .switch-slider:before { transform: translateX(18px); }
.float-btn {
  position: fixed;
  background: var(--glass-bg);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.4s var(--ease-spring);
  z-index: 100;
  color: var(--forest);
  border-radius: var(--radius-sm);
}
.toggle-btn {
  bottom: 30px;
  left: 30px;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  animation: slideInLeft 0.6s var(--ease-spring) 0.8s backwards;
}
.toggle-btn:hover {
  transform: scale(1.1) rotate(8deg);
  box-shadow: 0 12px 30px rgba(45, 79, 58, 0.15);
}
.mogu-active-btn, .mogu-chat-btn {
  top: 24px;
  width: 48px;
  height: 48px;
  opacity: 0.9;
}
.mogu-chat-btn { 
  right: 24px; 
  color: var(--peach);
  animation: slideInRight 0.6s var(--ease-spring) 0.4s backwards;
}
.mogu-active-btn { 
  right: 80px; 
  color: var(--soft-gold);
  animation: slideInRight 0.6s var(--ease-spring) 0.5s backwards;
}
.mogu-active-btn:hover {
  transform: scale(1.1) rotate(10deg);
  color: var(--forest);
  box-shadow: 0 12px 30px rgba(233, 196, 106, 0.25);
}
.mogu-chat-btn:hover {
  transform: scale(1.1) rotate(-10deg);
  box-shadow: 0 12px 30px rgba(224, 122, 95, 0.25);
}
.float-btn:active {
  transform: scale(0.95);
}
@keyframes slideInRight {
  from { opacity: 0; transform: translateX(50px); }
  to { opacity: 1; transform: translateX(0); }
}
@keyframes slideInLeft {
  from { opacity: 0; transform: translateX(-50px); }
  to { opacity: 1; transform: translateX(0); }
}
.user-info {
  position: fixed;
  top: 24px;
  left: 24px;
  background: var(--glass-bg);
  backdrop-filter: blur(20px) saturate(180%);
  padding: 6px 6px 6px 14px;
  border-radius: 50px;
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: var(--glass-shadow);
  border: 1px solid var(--glass-border);
  z-index: 1000;
  transition: all 0.4s var(--ease-spring);
  animation: slideInLeft 0.6s var(--ease-spring) forwards;
  max-width: 200px;
  cursor: pointer;
}
.user-info:hover { 
  transform: translateY(-2px) scale(1.02); 
  box-shadow: 0 12px 30px rgba(45, 79, 58, 0.12);
}
.user-profile-btn { 
  display: flex; 
  align-items: center; 
  gap: 8px; 
  cursor: pointer;
  overflow: hidden;
}
.user-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 2px solid rgba(255,255,255,0.8);
  box-shadow: 0 2px 6px rgba(45, 79, 58, 0.1);
  background-size: cover;
  background-position: center;
  transition: transform 0.3s;
}
.user-info:hover .user-avatar {
  transform: rotate(360deg) scale(1.1);
}
.user-name { 
  font-size: 13px; 
  font-weight: 600; 
  color: var(--text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 80px;
  font-family: "PingFang SC", sans-serif;
}
.logout-btn {
  padding: 8px 16px;
  border-radius: 20px;
  border: none;
  background: rgba(61, 107, 79, 0.08);
  color: var(--text-secondary);
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  font-family: "PingFang SC", sans-serif;
  opacity: 0;
  transform: translateX(-10px);
  pointer-events: none;
  font-size: 12px;
}
.user-info:hover .logout-btn {
  opacity: 1;
  transform: translateX(0);
  pointer-events: all;
  transition-delay: 0.1s;
}
.logout-btn:hover { 
  background: var(--peach); 
  color: white;
  transform: scale(1.05);
}
.login-btn {
  position: fixed;
  top: 24px; 
  left: 24px;
  padding: 12px 24px;
  border-radius: 24px;
  border: 2px solid #fff;
  background: #FFE4C4;
  color: #5D4037;
  font-weight: 700;
  font-size: 13px;
  cursor: pointer;
  z-index: 1000;
  box-shadow: 
    0 4px 0 #E6C2A0,
    0 6px 10px rgba(0,0,0,0.1);
  transition: all 0.1s;
  font-family: "PingFang SC", sans-serif;
}
.login-btn:active {
  transform: translateY(4px);
  box-shadow: 
    0 0 0 #E6C2A0,
    0 2px 4px rgba(0,0,0,0.1);
}
.login-btn:hover {
  background: #FFEED8;
}
.mogu-chat-window {
  position: fixed;
  top: 90px;
  right: 24px;
  width: 360px;
  height: 480px;
  z-index: 1999;
  transform: translateX(120%) scale(0.9);
  opacity: 0;
  visibility: hidden;
  transition: all 0.6s var(--ease-spring);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  background: rgba(255, 253, 245, 0.92);
  backdrop-filter: blur(25px) saturate(220%) contrast(1.15);
  -webkit-backdrop-filter: blur(25px) saturate(220%) contrast(1.15);
  border: 1px solid rgba(255, 255, 255, 0.7);
  box-shadow: 
    0 25px 50px rgba(45, 79, 58, 0.15),
    inset 0 1px 0 rgba(255,255,255,0.9);
  border-radius: 28px;
}
.mogu-chat-window.open {
  transform: translateX(0) scale(1);
  opacity: 1;
  visibility: visible;
}
.mogu-chat-header {
  padding: 20px;
  background: linear-gradient(180deg, rgba(255,255,255,0.95) 0%, rgba(255,251,240,0.5) 100%);
  border-bottom: 1px solid rgba(45, 79, 58, 0.06);
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: relative;
  z-index: 2;
}
.mogu-chat-title {
  font-weight: 700;
  color: var(--text-primary);
  font-size: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-family: "PingFang SC", sans-serif;
}
.mogu-chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  position: relative;
  z-index: 1;
}
.message-item {
  max-width: 85%;
  padding: 14px 18px;
  font-size: 14px;
  line-height: 1.5;
  position: relative;
  word-break: break-word;
  backdrop-filter: blur(10px);
  animation: messageSlideIn 0.4s var(--ease-spring);
  font-family: "PingFang SC", sans-serif;
  border-radius: 20px;
  transition: all 0.3s var(--ease-smooth);
}
@keyframes messageSlideIn {
  from { 
    opacity: 0; 
    transform: translateY(10px) scale(0.95);
  }
  to { 
    opacity: 1; 
    transform: translateY(0) scale(1);
  }
}
.message-item.other {
  align-self: flex-start;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 20px 20px 20px 6px;
  box-shadow: 0 2px 10px rgba(45, 79, 58, 0.05);
  color: var(--text-primary);
  border: 1px solid rgba(255,255,255,0.8);
}
.message-item.user {
  align-self: flex-end;
  background: linear-gradient(135deg, var(--forest) 0%, #4A7D5F 100%);
  color: white;
  border-radius: 20px 20px 6px 20px;
  box-shadow: 0 4px 16px rgba(61, 107, 79, 0.2);
}
.message-item.user .message-sender {
  color: rgba(255,255,255,0.95);
}
.message-item.user .message-time {
  color: rgba(255,255,255,0.7);
}
.message-header {
  display: flex;
  align-items: center;
  margin-bottom: 8px;
  gap: 8px;
}
.message-item.user .message-header {
  flex-direction: row-reverse;
}
.message-avatar {
  width: 28px; 
  height: 28px;
  min-width: 28px; 
  min-height: 28px;
  border-radius: 50%;
  background-size: cover;
  background-position: center;
  background-color: rgba(45, 79, 58, 0.15);
  flex-shrink: 0;
  display: block;
  border: 2px solid rgba(255,255,255,0.6);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.message-item.user .message-avatar {
  border-color: rgba(255,255,255,0.4);
  background-color: rgba(255,255,255,0.2);
}
.message-sender {
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
  opacity: 0.9;
}
.message-text {
  line-height: 1.6;
  word-break: break-all;
}
.message-text img {
  max-width: 100%;
  height: auto;
  border-radius: 8px;
  margin-top: 6px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.message-time {
  font-size: 10px;
  opacity: 0.6;
  margin-top: 6px;
  text-align: right;
}
.mogu-chat-input-area {
  padding: 16px;
  background: linear-gradient(0deg, rgba(255,253,245,0.98) 0%, rgba(255,251,240,0.7) 100%);
  display: flex;
  gap: 10px;
  border-top: 1px solid rgba(45, 79, 58, 0.06);
  position: relative;
  z-index: 2;
}
.mogu-chat-input {
  flex: 1;
  background: rgba(255,255,255,0.95);
  border: none;
  border-radius: 20px;
  padding: 12px 16px;
  font-size: 14px;
  outline: none;
  box-shadow: inset 0 2px 4px rgba(45, 79, 58, 0.03);
  font-family: "PingFang SC", sans-serif;
  transition: all 0.3s;
  color: var(--text-primary);
}
.mogu-chat-input:focus {
  box-shadow: inset 0 2px 8px rgba(45, 79, 58, 0.06), 0 0 0 3px rgba(224, 122, 95, 0.1);
}
.mogu-chat-send {
  background: var(--forest);
  color: white;
  border: none;
  border-radius: 14px;
  width: 44px;
  height: 44px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s var(--ease-spring);
  box-shadow: 0 4px 12px rgba(45, 79, 58, 0.2);
  flex-shrink: 0;
}
.mogu-chat-send:hover { 
  transform: scale(1.05) rotate(8deg); 
  background: var(--peach);
  box-shadow: 0 6px 18px rgba(224, 122, 95, 0.3);
}
.mogu-chat-send:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}
.modal-mask {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(45, 79, 58, 0.3);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  z-index: 9000;
  display: none;
  opacity: 0;
  transition: opacity 0.4s ease;
}
.modal-mask.show { opacity: 1; }
.custom-modal, .notice-modal {
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -40%) scale(0.9);
  background: rgba(255, 253, 245, 0.96);
  backdrop-filter: blur(30px) saturate(200%);
  padding: 32px;
  border-radius: 32px;
  box-shadow: 
    0 30px 60px -15px rgba(45, 79, 58, 0.25),
    inset 0 1px 0 rgba(255,255,255,0.9),
    0 0 0 1px rgba(255,255,255,0.5) inset;
  width: 90%;
  max-width: 380px;
  z-index: 9001;
  display: none;
  opacity: 0;
  transition: all 0.5s var(--ease-spring);
  text-align: center;
  border: 1px solid rgba(255,255,255,0.6);
}
.custom-modal.show, .notice-modal.show { 
  transform: translate(-50%, -50%) scale(1); 
  opacity: 1; 
}
.modal-header, .notice-header {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 14px;
  color: var(--forest);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  font-family: "PingFang SC", sans-serif;
}
.modal-btns { display: flex; gap: 10px; justify-content: center; margin-top: 24px; }
.modal-btn, .notice-confirm-btn {
  padding: 14px 28px;
  border-radius: 18px;
  border: none;
  font-weight: 600;
  cursor: pointer;
  font-size: 15px;
  transition: all 0.3s var(--ease-spring);
  font-family: "PingFang SC", sans-serif;
  flex: 1;
}
.modal-btn.cancel { 
  background: rgba(45, 79, 58, 0.06); 
  color: var(--text-secondary); 
}
.modal-btn.confirm { 
  background: var(--forest); 
  color: white;
  box-shadow: 0 6px 16px rgba(45, 79, 58, 0.2);
}
.modal-btn:hover { transform: translateY(-2px); }
.modal-btn.confirm:hover { background: var(--peach); }
.notice-confirm-btn { 
  background: var(--peach); 
  color: white; 
  width: 100%; 
  margin-top: 10px;
  box-shadow: 0 6px 16px rgba(224, 122, 95, 0.25);
  border-radius: 18px;
}
.loading-spinner {
  width: 18px; 
  height: 18px;
  border: 2px solid rgba(255,255,255,0.3);
  border-radius: 50%; 
  border-top-color: white;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.admin-only { display: none !important; }
.admin-only.admin-show { display: block !important; }
.clear-all-btn {
  border: none;
  background: none;
  color: var(--peach);
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  padding: 6px 12px;
  border-radius: 10px;
  transition: all 0.3s;
  font-family: "PingFang SC", sans-serif;
}
.clear-all-btn:hover {
  background: rgba(224, 122, 95, 0.1);
  transform: scale(1.05);
}
.login-notice-modal {
  position: fixed;
  top: 50%; left: 50%;
  transform: translate(-50%, -40%) scale(0.9);
  background: rgba(255, 253, 245, 0.98);
  backdrop-filter: blur(30px) saturate(200%);
  padding: 40px 32px;
  border-radius: 32px;
  box-shadow: 
    0 30px 60px -15px rgba(45, 79, 58, 0.3),
    inset 0 1px 0 rgba(255,255,255,0.9);
  width: 90%;
  max-width: 360px;
  z-index: 10001;
  display: none;
  opacity: 0;
  transition: all 0.5s var(--ease-spring);
  text-align: center;
  border: 1px solid rgba(255,255,255,0.6);
}
.login-notice-modal.show {
  transform: translate(-50%, -50%) scale(1);
  opacity: 1;
}
.login-notice-icon {
  width: 64px;
  height: 64px;
  margin: 0 auto 20px;
  background: linear-gradient(135deg, var(--peach) 0%, var(--peach-light) 100%);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 8px 24px rgba(224, 122, 95, 0.3);
}
.login-notice-icon svg {
  width: 32px;
  height: 32px;
  color: white;
}
.login-notice-title {
  font-size: 22px;
  font-weight: 700;
  color: var(--forest);
  margin-bottom: 12px;
  font-family: "PingFang SC", sans-serif;
}
.login-notice-text {
  font-size: 15px;
  color: var(--text-secondary);
  line-height: 1.7;
  margin-bottom: 28px;
  font-family: "PingFang SC", sans-serif;
}
.login-notice-btn {
  width: 100%;
  padding: 16px 28px;
  border-radius: 20px;
  border: none;
  background: linear-gradient(135deg, var(--forest) 0%, #4A7D5F 100%);
  color: white;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s var(--ease-spring);
  font-family: "PingFang SC", sans-serif;
  box-shadow: 0 6px 20px rgba(61, 107, 79, 0.3);
}
.login-notice-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 28px rgba(61, 107, 79, 0.4);
  background: linear-gradient(135deg, var(--peach) 0%, var(--peach-light) 100%);
}
.login-notice-overlay {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(45, 79, 58, 0.5);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  z-index: 10000;
  display: none;
  opacity: 0;
  transition: opacity 0.4s ease;
}
.login-notice-overlay.show {
  opacity: 1;
}
.dynamic-island-container {
  position: fixed;
  top: 12px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 99999;
  display: flex;
  flex-direction: column;
  gap: 10px;
  align-items: center;
  pointer-events: none;
  width: 100%;
  max-width: 500px; 
  padding: 0 20px;
}
.dynamic-island {
  background: rgba(0, 0, 0, 0.85);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border-radius: 50px;
  padding: 14px 24px; 
  min-width: 250px; 
  max-width: 100%;
  box-shadow: 
    0 10px 40px rgba(0, 0, 0, 0.3),
    0 0 0 0.5px rgba(255, 255, 255, 0.1) inset;
  display: flex;
  align-items: center;
  gap: 12px;
  color: white;
  font-family: "SF Pro Display", "PingFang SC", -apple-system, sans-serif;
  transform: translateY(-100px) scale(0.8);
  opacity: 0;
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  pointer-events: auto;
  position: relative;
  overflow: hidden;
}
.dynamic-island.show {
  transform: translateY(0) scale(1);
  opacity: 1;
}
.dynamic-island.hide {
  transform: translateY(-20px) scale(0.9);
  opacity: 0;
}
.dynamic-island-icon {
  width: 32px; 
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  background: rgba(255, 255, 255, 0.15);
}
.dynamic-island-icon.success { background: rgba(61, 107, 79, 0.9); }
.dynamic-island-icon.error { background: rgba(224, 122, 95, 0.9); }
.dynamic-island-icon.warning { background: rgba(233, 196, 106, 0.9); }
.dynamic-island-icon.loading { background: rgba(90, 125, 108, 0.9); }
.dynamic-island-icon svg {
  width: 18px; 
  height: 18px;
  stroke: white;
  stroke-width: 2.5;
  fill: none;
  stroke-linecap: round;
  stroke-linejoin: round;
}
.dynamic-island-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 6px;
  min-width: 0;
}
.dynamic-island-title {
  font-size: 15px; 
  font-weight: 600;
  letter-spacing: -0.01em;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.dynamic-island-subtitle {
  font-size: 13px; 
  opacity: 0.8;
  font-weight: 400;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.dynamic-island-progress-container {
  width: 100%;
  height: 3px;
  background: rgba(255, 255, 255, 0.15);
  border-radius: 2px;
  overflow: hidden;
  margin-top: 4px;
}
.dynamic-island-progress-bar {
  height: 100%;
  background: linear-gradient(90deg, var(--soft-gold), var(--peach-light));
  border-radius: 2px;
  transition: width 0.3s ease;
  box-shadow: 0 0 10px rgba(233, 196, 106, 0.5);
}
.dynamic-island-spinner {
  width: 18px; 
  height: 18px;
  border: 2px solid rgba(255, 255, 255, 0.2);
  border-top-color: white;
  border-radius: 50%;
  animation: island-spin 0.8s linear infinite;
}
@keyframes island-spin {
  to { transform: rotate(360deg); }
}
.dynamic-island.important {
  box-shadow: 
    0 10px 40px rgba(0, 0, 0, 0.3),
    0 0 0 0.5px rgba(255, 255, 255, 0.1) inset,
    0 0 20px rgba(224, 122, 95, 0.3);
}
.dynamic-island.compact {
  padding: 10px 16px;
  border-radius: 30px;
}
.dynamic-island.compact .dynamic-island-title {
  font-size: 13px;
}
.custom-alert {
  display: none !important;
}
.quick-links-sidebar {
  position: fixed;
  top: 0;
  left: 0;
  width: 380px;
  max-width: 90vw;
  height: 100vh;
  background: rgba(255, 253, 245, 0.92);
  backdrop-filter: blur(30px) saturate(220%) contrast(1.1);
  -webkit-backdrop-filter: blur(30px) saturate(220%) contrast(1.1);
  border-right: 1px solid rgba(255, 255, 255, 0.6);
  box-shadow: 20px 0 60px rgba(45, 79, 58, 0.15);
  z-index: 9998;
  transform: translateX(-110%); 
  opacity: 0;
  transition: all 0.5s cubic-bezier(0.32, 0.72, 0, 1); 
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.quick-links-sidebar.open {
  transform: translateX(0);
  opacity: 1;
}
.quick-links-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(45, 79, 58, 0.2);
  backdrop-filter: blur(4px);
  z-index: 9997;
  opacity: 0;
  visibility: hidden;
  transition: all 0.4s ease;
}
.quick-links-overlay.show {
  opacity: 1;
  visibility: visible;
}
.quick-links-header {
  padding: 50px 24px 20px;
  background: linear-gradient(180deg, rgba(255,255,255,0.95) 0%, rgba(255,251,240,0.7) 100%);
  border-bottom: 1px solid rgba(45, 79, 58, 0.06);
}
.quick-links-title {
  font-size: 24px;
  font-weight: 700;
  color: var(--forest);
  display: flex;
  align-items: center;
  gap: 10px;
  font-family: "PingFang SC", sans-serif;
}
.quick-links-tabs {
  display: flex;
  gap: 12px;
  margin-top: 20px;
  padding: 4px;
  background: rgba(61, 107, 79, 0.06);
  border-radius: 16px;
  backdrop-filter: blur(10px);
}
.quick-links-tab {
  flex: 1;
  padding: 10px 16px;
  border: none;
  background: transparent;
  color: var(--text-secondary);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  border-radius: 12px;
  transition: all 0.3s var(--ease-spring);
  font-family: "PingFang SC", sans-serif;
}
.quick-links-tab.active {
  background: rgba(255, 255, 255, 0.9);
  color: var(--forest);
  box-shadow: 0 2px 8px rgba(45, 79, 58, 0.1);
}
.quick-links-content {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}
.quick-links-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 12px;
  animation: fadeInUp 0.4s var(--ease-spring);
}
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
.quick-link-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  padding: 16px 12px;
  background: rgba(255, 255, 255, 0.7);
  border: 1px solid rgba(255, 255, 255, 0.8);
  border-radius: 20px;
  cursor: pointer;
  transition: all 0.3s var(--ease-spring);
  text-decoration: none;
  color: var(--text-primary);
  position: relative;
  overflow: hidden;
}
.quick-link-item:hover {
  transform: translateY(-4px) scale(1.02);
  background: rgba(255, 255, 255, 0.95);
  box-shadow: 0 8px 24px rgba(45, 79, 58, 0.12);
}
.quick-link-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--link-color, var(--forest));
  opacity: 0.8;
}
.quick-link-icon {
  width: 48px;
  height: 48px;
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  background: var(--link-color, var(--forest));
  color: white;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  transition: transform 0.3s var(--ease-spring);
}
.quick-link-item:hover .quick-link-icon {
  transform: scale(1.1) rotate(-5deg);
}
.quick-link-name {
  font-size: 13px;
  font-weight: 600;
  text-align: center;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
  font-family: "PingFang SC", sans-serif;
}
.quick-link-delete {
  position: absolute;
  top: 6px;
  right: 6px;
  width: 20px;
  height: 20px;
  background: rgba(224, 122, 95, 0.9);
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transform: scale(0.8);
  transition: all 0.2s;
  font-size: 12px;
  padding: 0;
}
.quick-link-item:hover .quick-link-delete {
  opacity: 1;
  transform: scale(1);
}
.quick-link-add {
  border: 2px dashed rgba(61, 107, 79, 0.3);
  background: rgba(255, 255, 255, 0.4);
  color: var(--text-secondary);
}
.quick-link-add:hover {
  border-color: var(--forest);
  background: rgba(61, 107, 79, 0.05);
  color: var(--forest);
}
.quick-link-add .quick-link-icon {
  background: rgba(61, 107, 79, 0.1);
  color: var(--forest);
  font-size: 32px;
}
.add-link-form {
  background: rgba(255, 255, 255, 0.9);
  padding: 20px;
  border-radius: 20px;
  margin-bottom: 20px;
  border: 1px solid rgba(255, 255, 255, 0.8);
  box-shadow: 0 4px 20px rgba(45, 79, 58, 0.08);
  animation: slideDown 0.3s var(--ease-spring);
  display: none;
}
.add-link-form.show {
  display: block;
}
@keyframes slideDown {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}
.add-link-input {
  width: 100%;
  padding: 12px 16px;
  margin-bottom: 12px;
  border: 1px solid rgba(61, 107, 79, 0.15);
  border-radius: 14px;
  font-size: 14px;
  background: rgba(255, 255, 255, 0.8);
  font-family: "PingFang SC", sans-serif;
  transition: all 0.3s;
}
.add-link-input:focus {
  outline: none;
  border-color: var(--forest);
  box-shadow: 0 0 0 3px rgba(61, 107, 79, 0.1);
}
.color-picker {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}
.color-option {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  cursor: pointer;
  border: 3px solid transparent;
  transition: all 0.2s;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
.color-option:hover {
  transform: scale(1.15);
}
.color-option.selected {
  border-color: white;
  box-shadow: 0 0 0 2px var(--forest), 0 4px 12px rgba(0,0,0,0.2);
  transform: scale(1.1);
}
.add-link-actions {
  display: flex;
  gap: 10px;
}
.add-link-btn {
  flex: 1;
  padding: 12px;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  font-family: "PingFang SC", sans-serif;
}
.add-link-btn.cancel {
  background: rgba(45, 79, 58, 0.06);
  color: var(--text-secondary);
}
.add-link-btn.confirm {
  background: var(--forest);
  color: white;
}
.add-link-btn:hover {
  transform: translateY(-2px);
}
.quick-links-toggle {
  position: fixed;
  top: 24px;
  right: 136px; 
  width: 48px;
  height: 48px;
  z-index: 100;
  color: var(--forest);
  animation: slideInRight 0.6s var(--ease-spring) 0.6s backwards;
}
.announcement-btn {
  position: fixed;
  top: 24px;
  right: 192px; 
  left: auto;   
  width: 48px;  
  height: 48px; 
  background: var(--glass-bg);
  backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid var(--glass-border);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 1000;
  color: var(--peach);
  box-shadow: var(--glass-shadow);
  transition: all 0.4s var(--ease-spring);
  animation: slideInLeft 0.6s var(--ease-spring) 0.2s backwards;
}
.announcement-btn:hover {
  transform: scale(1.1) rotate(-10deg);
  box-shadow: 0 12px 30px rgba(224, 122, 95, 0.2);
}
.announcement-btn.has-new {
  animation: pulse 2s infinite;
}
@keyframes pulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(224, 122, 95, 0.4); }
  50% { box-shadow: 0 0 0 10px rgba(224, 122, 95, 0); }
}
.announcement-badge {
  position: absolute;
  top: -2px;
  right: -2px;
  width: 12px;
  height: 12px;
  background: var(--peach);
  border-radius: 50%;
  border: 2px solid white;
  display: none;
}
.announcement-btn.has-new .announcement-badge {
  display: block;
}
/* New Leder Button Styles */
.leder-btn {
  position: fixed;
  top: 24px;
  right: 248px; /* 192 + 56 */
  width: 48px;
  height: 48px;
  z-index: 1000;
  color: var(--forest);
  animation: slideInLeft 0.6s var(--ease-spring) 0.1s backwards;
}
.leder-btn:hover {
  transform: scale(1.1) rotate(-10deg);
  box-shadow: 0 12px 30px rgba(45, 79, 58, 0.15);
}

/* Clean Mode (Hide Mode) Styles */
body.clean-mode .user-info,
body.clean-mode .login-btn,
body.clean-mode .quick-links-toggle,
body.clean-mode .announcement-btn,
body.clean-mode .leder-btn,
body.clean-mode .mogu-active-btn,
body.clean-mode .mogu-chat-btn,
body.clean-mode .admin-tools-btn,
body.clean-mode .history-rank-wrap {
  opacity: 0;
  pointer-events: none;
  transition: all 0.5s ease;
}

body.clean-mode #toggleBtn {
  opacity: 0.3;
  background: rgba(255, 255, 255, 0.2);
  box-shadow: none;
}
body.clean-mode #toggleBtn:hover {
  opacity: 1;
  background: var(--glass-bg);
  box-shadow: var(--glass-shadow);
}

.announcement-modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -45%) scale(0.95);
  width: 90%;
  max-width: 600px;
  max-height: 80vh;
  background: rgba(255, 253, 245, 0.98);
  backdrop-filter: blur(40px) saturate(250%);
  border-radius: 32px;
  box-shadow: 
    0 40px 80px -20px rgba(45, 79, 58, 0.3),
    inset 0 1px 0 rgba(255,255,255,0.9);
  z-index: 10002;
  display: none;
  opacity: 0;
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  overflow: hidden;
  border: 1px solid rgba(255,255,255,0.7);
}
.announcement-modal.show {
  transform: translate(-50%, -50%) scale(1);
  opacity: 1;
  display: flex;
  flex-direction: column;
}
.announcement-header {
  padding: 28px 28px 20px;
  background: linear-gradient(180deg, rgba(255,255,255,0.98) 0%, rgba(255,251,240,0.8) 100%);
  border-bottom: 1px solid rgba(45, 79, 58, 0.06);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-shrink: 0;
}
.announcement-title {
  font-size: 22px;
  font-weight: 700;
  color: var(--forest);
  display: flex;
  align-items: center;
  gap: 10px;
  font-family: "PingFang SC", sans-serif;
}
.announcement-close {
  width: 36px;
  height: 36px;
  border: none;
  background: rgba(45, 79, 58, 0.06);
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-secondary);
  transition: all 0.3s;
}
.announcement-close:hover {
  background: rgba(224, 122, 95, 0.1);
  color: var(--peach);
  transform: rotate(90deg);
}
.announcement-content-wrapper {
  flex: 1;
  overflow-y: auto;
  padding: 24px 28px;
}
.announcement-nav {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
  padding: 4px;
  background: rgba(61, 107, 79, 0.06);
  border-radius: 14px;
}
.announcement-nav-btn {
  padding: 10px 20px;
  border: none;
  background: transparent;
  color: var(--text-secondary);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  border-radius: 10px;
  transition: all 0.3s;
  font-family: "PingFang SC", sans-serif;
  flex: 1;
  text-align: center;
}
.announcement-nav-btn.active {
  background: rgba(255, 255, 255, 0.95);
  color: var(--forest);
  box-shadow: 0 2px 8px rgba(45, 79, 58, 0.08);
}
.announcement-body {
  line-height: 1.8;
  color: var(--text-primary);
  font-size: 15px;
  font-family: "PingFang SC", sans-serif;
}
.announcement-body h1 {
  font-size: 24px;
  color: var(--forest);
  margin: 24px 0 16px;
  padding-bottom: 10px;
  border-bottom: 2px solid rgba(61, 107, 79, 0.1);
}
.announcement-body h2 {
  font-size: 20px;
  color: var(--forest);
  margin: 20px 0 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.announcement-body h2::before {
  content: '';
  width: 4px;
  height: 20px;
  background: var(--peach);
  border-radius: 2px;
}
.announcement-body h3 {
  font-size: 17px;
  color: var(--text-secondary);
  margin: 16px 0 10px;
  font-weight: 600;
}
.announcement-body p {
  margin: 12px 0;
  color: var(--text-secondary);
  line-height: 1.8;
}
.announcement-body img {
  max-width: 100%;
  border-radius: 16px;
  margin: 16px 0;
  box-shadow: 0 8px 24px rgba(0,0,0,0.1);
}
.announcement-body ul, .announcement-body ol {
  margin: 12px 0;
  padding-left: 24px;
}
.announcement-body li {
  margin: 8px 0;
  color: var(--text-secondary);
}
.announcement-list {
  display: none;
}
.announcement-list.active {
  display: block;
  animation: fadeIn 0.4s ease;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.announcement-item {
  padding: 16px 20px;
  background: rgba(255, 255, 255, 0.7);
  border-radius: 16px;
  margin-bottom: 12px;
  cursor: pointer;
  transition: all 0.3s;
  border: 1px solid rgba(255, 255, 255, 0.6);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.announcement-item:hover {
  transform: translateX(4px);
  background: rgba(255, 255, 255, 0.95);
  box-shadow: 0 4px 12px rgba(45, 79, 58, 0.08);
}
.announcement-item-title {
  font-weight: 600;
  color: var(--text-primary);
  font-size: 15px;
  font-family: "PingFang SC", sans-serif;
}
.announcement-item-date {
  font-size: 12px;
  color: var(--text-secondary);
  opacity: 0.7;
}
.dont-show-again {
  padding: 16px 28px 24px;
  border-top: 1px solid rgba(45, 79, 58, 0.06);
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  background: rgba(255, 253, 245, 0.6);
}
.dont-show-checkbox {
  width: 20px;
  height: 20px;
  border: 2px solid rgba(61, 107, 79, 0.3);
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  background: white;
}
.dont-show-checkbox.checked {
  background: var(--peach);
  border-color: var(--peach);
}
.dont-show-checkbox.checked::after {
  content: 'âœ“';
  color: white;
  font-size: 12px;
  font-weight: bold;
}
.dont-show-label {
  font-size: 14px;
  color: var(--text-secondary);
  font-family: "PingFang SC", sans-serif;
  user-select: none;
}
.admin-tools-btn {
  position: fixed;
  bottom: 30px;
  right: 30px;
  width: 52px;
  height: 52px;
  background: var(--glass-bg);
  backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid var(--glass-border);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 999;
  color: var(--forest);
  box-shadow: var(--glass-shadow);
  transition: all 0.4s var(--ease-spring);
  opacity: 0;
  transform: scale(0) rotate(-180deg);
  pointer-events: none;
}
.admin-tools-btn.show {
  opacity: 1;
  transform: scale(1) rotate(0);
  pointer-events: all;
  animation: slideInRight 0.6s var(--ease-spring);
}
.admin-tools-btn:hover {
  transform: scale(1.1) rotate(15deg);
  box-shadow: 0 12px 30px rgba(45, 79, 58, 0.15);
}
.admin-panel-modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -45%) scale(0.95);
  width: 90%;
  max-width: 800px;
  max-height: 85vh;
  background: rgba(255, 253, 245, 0.98);
  backdrop-filter: blur(40px) saturate(250%);
  border-radius: 32px;
  box-shadow: 0 40px 80px -20px rgba(45, 79, 58, 0.3);
  z-index: 10003;
  display: none;
  opacity: 0;
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  overflow: hidden;
  flex-direction: column;
  border: 1px solid rgba(255,255,255,0.7);
}
.admin-panel-modal.show {
  transform: translate(-50%, -50%) scale(1);
  opacity: 1;
  display: flex;
}
.admin-panel-header {
  padding: 24px 28px;
  background: linear-gradient(180deg, rgba(255,255,255,0.98) 0%, rgba(255,251,240,0.8) 100%);
  border-bottom: 1px solid rgba(45, 79, 58, 0.06);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.admin-panel-title {
  font-size: 20px;
  font-weight: 700;
  color: var(--forest);
  font-family: "PingFang SC", sans-serif;
}
.admin-panel-close {
  width: 36px;
  height: 36px;
  border: none;
  background: rgba(45, 79, 58, 0.06);
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-secondary);
  transition: all 0.3s;
}
.admin-panel-close:hover {
  background: rgba(224, 122, 95, 0.1);
  color: var(--peach);
  transform: rotate(90deg);
}
.admin-panel-content {
  flex: 1;
  overflow-y: auto;
  padding: 24px 28px;
}
.announcement-editor {
  display: flex;
  flex-direction: column;
  gap: 16px;
}
.editor-field {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.editor-label {
  font-size: 13px;
  font-weight: 600;
  color: var(--text-secondary);
  font-family: "PingFang SC", sans-serif;
}
.editor-input, .editor-textarea, .editor-select {
  padding: 14px 18px;
  border: 1px solid rgba(61, 107, 79, 0.15);
  border-radius: 16px;
  font-size: 14px;
  font-family: "PingFang SC", sans-serif;
  background: rgba(255, 255, 255, 0.8);
  transition: all 0.3s;
  color: var(--text-primary);
}
.editor-input:focus, .editor-textarea:focus, .editor-select:focus {
  outline: none;
  border-color: var(--forest);
  box-shadow: 0 0 0 4px rgba(61, 107, 79, 0.1);
}
.editor-textarea {
  min-height: 200px;
  resize: vertical;
  line-height: 1.6;
}
.editor-hint {
  font-size: 12px;
  color: var(--text-secondary);
  opacity: 0.7;
  font-family: "PingFang SC", sans-serif;
}
.editor-actions {
  display: flex;
  gap: 12px;
  margin-top: 8px;
}
.editor-btn {
  padding: 14px 28px;
  border: none;
  border-radius: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s var(--ease-spring);
  font-family: "PingFang SC", sans-serif;
  font-size: 15px;
  flex: 1;
}
.editor-btn.secondary {
  background: rgba(45, 79, 58, 0.06);
  color: var(--text-secondary);
}
.editor-btn.primary {
  background: var(--forest);
  color: white;
  box-shadow: 0 6px 20px rgba(61, 107, 79, 0.25);
}
.editor-btn:hover {
  transform: translateY(-2px);
}
.editor-btn.primary:hover {
  background: var(--peach);
  box-shadow: 0 8px 24px rgba(224, 122, 95, 0.3);
}
.history-announcements-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.history-announcement-item {
  padding: 16px 20px;
  background: rgba(255, 255, 255, 0.7);
  border-radius: 16px;
  border: 1px solid rgba(255, 255, 255, 0.6);
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.3s;
}
.history-announcement-item:hover {
  background: rgba(255, 255, 255, 0.95);
  transform: translateX(4px);
  box-shadow: 0 4px 12px rgba(45, 79, 58, 0.08);
}
.history-ann-info {
  flex: 1;
}
.history-ann-title {
  font-weight: 600;
  color: var(--text-primary);
  font-size: 15px;
  margin-bottom: 4px;
  font-family: "PingFang SC", sans-serif;
}
.history-ann-date {
  font-size: 12px;
  color: var(--text-secondary);
  opacity: 0.7;
}
.history-ann-actions {
  display: flex;
  gap: 8px;
}
.history-ann-btn {
  padding: 8px 16px;
  border: none;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  font-family: "PingFang SC", sans-serif;
}
.history-ann-btn.edit {
  background: rgba(61, 107, 79, 0.1);
  color: var(--forest);
}
.history-ann-btn.delete {
  background: rgba(224, 122, 95, 0.1);
  color: var(--peach);
}
.history-ann-btn:hover {
  transform: scale(1.05);
}
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}
.stat-card {
  background: rgba(255, 255, 255, 0.8);
  padding: 20px;
  border-radius: 20px;
  border: 1px solid rgba(255, 255, 255, 0.6);
  transition: all 0.3s;
}
.stat-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 30px rgba(45, 79, 58, 0.1);
  background: rgba(255, 255, 255, 0.95);
}
.stat-value {
  font-size: 32px;
  font-weight: 700;
  color: var(--forest);
  margin-bottom: 6px;
  font-family: "SF Pro Display", sans-serif;
}
.stat-label {
  font-size: 13px;
  color: var(--text-secondary);
  font-family: "PingFang SC", sans-serif;
}
.user-data-list {
  background: rgba(255, 255, 255, 0.7);
  border-radius: 20px;
  overflow: hidden;
  border: 1px solid rgba(255, 255, 255, 0.6);
}
.user-data-item {
  padding: 16px 20px;
  border-bottom: 1px solid rgba(45, 79, 58, 0.06);
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.3s;
}
.user-data-item:hover {
  background: rgba(255, 255, 255, 0.95);
}
.user-data-item:last-child {
  border-bottom: none;
}
.user-data-name {
  font-weight: 600;
  color: var(--text-primary);
  font-family: "PingFang SC", sans-serif;
  display: flex;
  align-items: center;
  gap: 10px;
}
.user-data-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background-size: cover;
  background-position: center;
  border: 2px solid rgba(255,255,255,0.8);
}
.user-data-actions {
  display: flex;
  gap: 8px;
}
.user-data-btn {
  padding: 6px 12px;
  border: none;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  font-family: "PingFang SC", sans-serif;
}
.user-data-btn.view {
  background: rgba(61, 107, 79, 0.1);
  color: var(--forest);
}

/* Tablet (iPad/Tablets) Adaptation */
@media screen and (min-width: 768px) and (max-width: 1024px) {
  .search-wrapper {
    max-width: 80%;
  }
  .search-title {
    font-size: 2.5rem;
  }
  .history-rank-wrap {
    max-width: 80%;
  }
  .mogu-chat-window {
    width: 380px;
    height: 60vh;
    top: 100px;
    right: 20px;
  }
  .quick-links-sidebar {
    width: 400px;
  }
  .search-container {
    padding: 8px;
  }
  .user-info {
    max-width: 240px;
  }
}

/* Mobile Adaptation */
@media (max-width: 768px) {
  .main-container {
    padding: 10vh 16px 24px;
    justify-content: flex-start;
    height: auto;
    min-height: 100vh;
    overflow-y: auto;
    gap: 12px;
  }
  .search-title { 
    font-size: 2rem;
    margin-bottom: 1rem;
    margin-top: 0;
    font-weight: 700;
  }
  .search-wrapper {
    transform: translateY(0);
    max-width: 100%;
  }
  .history-rank-wrap {
    transform: translateY(0);
    max-width: 100%;
  }
  .history-section {
    min-height: auto;
    padding: 18px;
    border-radius: 24px;
  }
  /* Remove display:none from toggle-btn as requested */
  /* .toggle-btn { display: none; } */
  
  .mogu-chat-window { 
    width: 100%; 
    height: 100%; 
    top: 0; 
    right: 0; 
    border-radius: 0;
    transform: translateY(100%) scale(1);
    max-height: 100vh;
    backdrop-filter: blur(30px) saturate(200%);
  }
  .mogu-chat-window.open { 
    transform: translateY(0) scale(1); 
  }
  .mogu-chat-header {
    padding-top: 60px;
    background: rgba(255,253,245,0.98);
  }
  .user-info { 
    padding: 6px; 
    border-radius: 50%;
    top: 16px;
    left: 16px;
    max-width: 180px;
  }
  .user-name { 
    display: none; 
  }
  .logout-btn {
    display: none;
  }
  .mogu-active-btn { 
    right: 72px; 
    width: 44px; 
    height: 44px; 
    top: 16px; 
  }
  .mogu-chat-btn { 
    right: 16px; 
    width: 44px; 
    height: 44px; 
    top: 16px; 
  }
  .login-btn { 
    top: 16px; 
    left: 16px; 
    padding: 10px 20px; 
    font-size: 13px;
    border-radius: 50px;
  }
  .search-container { 
    flex-direction: column; 
    margin-bottom: 12px; 
    border-radius: 24px; 
    gap: 8px; 
    width: 100%;
    padding: 8px;
  }
  .search-engine-select { 
    width: 100%; 
    text-align: center; 
    border-radius: 16px;
    color: var(--forest);
    padding: 10px;
    font-size: 14px;
  }
  #search-btn { 
    width: 100%; 
    height: 44px; 
    border-radius: 16px; 
  }
  #search-input { 
    text-align: center; 
    width: 100%;
    font-size: 16px;
    padding: 10px;
    color: var(--text-primary);
  }
  .modal-btn, .notice-confirm-btn {
    padding: 12px 20px;
    font-size: 14px;
    border-radius: 16px;
  }
  .custom-modal, .notice-modal {
    border-radius: 28px;
    padding: 24px;
    max-width: 340px;
  }
  .modal-header, .notice-header {
    font-size: 18px;
  }
  .login-notice-modal {
    padding: 32px 24px;
    max-width: 320px;
  }
  .login-notice-icon {
    width: 56px;
    height: 56px;
  }
  .login-notice-icon svg {
    width: 28px;
    height: 28px;
  }
  .login-notice-title {
    font-size: 20px;
  }
  .login-notice-text {
    font-size: 14px;
  }
  .login-notice-btn {
    padding: 14px 24px;
    font-size: 15px;
  }
  .quick-links-toggle {
    right: 120px;
    top: 16px;
    width: 44px;
    height: 44px;
  }
  .quick-links-sidebar {
    width: 85vw;
    max-width: 100%;
    border-radius: 0 32px 32px 0;
  }
  .quick-links-list {
    grid-template-columns: repeat(2, 1fr);
  }
  .announcement-btn {
    right: 176px;
    left: auto;
    top: 16px;
    width: 44px;  
    height: 44px;  
  }
  .leder-btn {
    right: 232px; /* 176 + 56 */
    top: 16px;
    width: 44px;
    height: 44px;
  }
  .admin-tools-btn {
    bottom: 20px;
    right: 20px;
  }
  .admin-panel-modal {
    width: 95%;
    max-height: 90vh;
    border-radius: 24px;
  }
  .announcement-modal {
    max-width: 95%;
    border-radius: 24px;
  }
  .dynamic-island-container {
    top: 8px;
    padding: 0 10px;
    max-width: 90%;
  }
  .dynamic-island {
    min-width: 200px;
    padding: 12px 18px;
  }
  .dynamic-island-title {
    font-size: 14px;
  }
  .dynamic-island-subtitle {
    font-size: 12px;
  }
  .dynamic-island-icon {
    width: 28px;
    height: 28px;
  }
}
@media (max-width: 380px) {
  .search-title {
    font-size: 1.75rem;
  }
  .module-title {
    font-size: 11px;
  }
  .history-item {
    padding: 10px 14px;
    font-size: 12px;
    border-radius: 12px;
  }
  .quick-links-list {
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
  }
  .quick-link-item {
    padding: 12px 8px;
  }
  .quick-link-icon {
    width: 40px;
    height: 40px;
    font-size: 20px;
  }
}
/* æ–°å¢žæ ·å¼çš„ CSS */
.history-back-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  border: none;
  background: transparent;
  color: var(--forest);
  font-weight: 700;
  font-size: 14px;
  cursor: pointer;
  margin-bottom: 20px;
  padding: 8px 0;
  font-family: "PingFang SC", sans-serif;
  transition: color 0.3s;
}
.history-back-btn:hover {
  color: var(--peach);
  transform: translateX(-2px);
}
.history-back-btn svg {
  width: 18px;
  height: 18px;
}
/* --- ç¼–è¾‘å™¨ä¼˜åŒ–æ ·å¼ --- */
.editor-wrapper {
  border: 1px solid rgba(61, 107, 79, 0.2);
  border-radius: 16px;
  background: rgba(255, 255, 255, 0.6);
  overflow: hidden;
  transition: all 0.3s;
}
.editor-wrapper:focus-within {
  background: rgba(255, 255, 255, 0.9);
  box-shadow: 0 0 0 3px rgba(61, 107, 79, 0.1);
  border-color: var(--forest);
}
.editor-toolbar {
  display: flex;
  gap: 4px;
  padding: 8px 12px;
  background: rgba(61, 107, 79, 0.05);
  border-bottom: 1px solid rgba(61, 107, 79, 0.1);
  flex-wrap: wrap;
}
.toolbar-btn {
  padding: 6px 10px;
  border: none;
  background: transparent;
  color: var(--forest);
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 4px;
}
.toolbar-btn:hover {
  background: rgba(61, 107, 79, 0.1);
  transform: translateY(-1px);
}
.toolbar-btn svg { width: 16px; height: 16px; }
.editor-textarea {
  width: 100%;
  border: none;
  background: transparent;
  padding: 16px;
  font-family: "PingFang SC", sans-serif;
  font-size: 14px;
  line-height: 1.6;
  resize: vertical;
  min-height: 240px;
  outline: none;
  color: var(--text-primary);
}
.editor-preview-area {
  padding: 16px;
  min-height: 240px;
  background: rgba(255, 255, 255, 0.8);
  display: none;
  border-top: 1px solid rgba(61, 107, 79, 0.1);
  animation: fadeIn 0.3s;
}
.editor-preview-area.show { display: block; }
.editor-mode-switch {
  margin-left: auto;
  background: var(--peach);
  color: white;
}
.editor-mode-switch:hover { background: var(--peach-light); color: white; }
</style>
<base target="_blank">
</head>
<body>

<div class="chinese-bg-container"></div>
<div class="dynamic-island-container" id="dynamicIslandContainer"></div>

<div class="login-notice-overlay" id="loginNoticeOverlay"></div>
<div class="login-notice-modal" id="loginNoticeModal">
  <div class="login-notice-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
      <polyline points="10,17 15,12 10,7"></polyline>
      <line x1="15" y1="12" x2="3" y2="12"></line>
    </svg>
  </div>
  <div class="login-notice-title">æœªç™»å½•è´¦å·</div>
  <div class="login-notice-text">æ‚¨å½“å‰æœªç™»å½•è´¦å·ï¼Œè¯·å…ˆç™»å½•åŽå†ä½¿ç”¨Mgæœç´¢åŠŸèƒ½</div>
  <button class="login-notice-btn" onclick="goToLogin()">åŽ»ç™»å½•</button>
</div>

<button class="leder-btn float-btn liquid-glass" id="lederBtn" onclick="window.open('leder.html', '_blank')">
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
    <line x1="22" y1="2" x2="11" y2="13"></line>
    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
  </svg>
</button>

<button class="announcement-btn float-btn liquid-glass" id="announcementBtn" onclick="openAnnouncementModal()">
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
    <path d="M3 11l18-5v12L3 14v-3z"></path>
    <path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"></path>
  </svg>
  <span class="announcement-badge"></span>
</button>

<div id="userStatusArea"></div>

<button class="quick-links-toggle float-btn liquid-glass" id="quickLinksBtn" onclick="toggleQuickLinks()">
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
    <rect x="3" y="3" width="7" height="7" rx="1"></rect>
    <rect x="14" y="3" width="7" height="7" rx="1"></rect>
    <rect x="14" y="14" width="7" height="7" rx="1"></rect>
    <rect x="3" y="14" width="7" height="7" rx="1"></rect>
  </svg>
</button>

<button class="mogu-active-btn float-btn liquid-glass" id="moguActiveBtn" onclick="window.location.href='active.html'">
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M2 12h20"></path><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
</button>

<button class="mogu-chat-btn float-btn liquid-glass" id="moguChatBtn">
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
</button>

<div class="quick-links-overlay" id="quickLinksOverlay" onclick="toggleQuickLinks()"></div>
<div class="quick-links-sidebar" id="quickLinksSidebar">
  <div class="quick-links-header">
    <div class="quick-links-title">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="3" width="7" height="7" rx="1"></rect>
        <rect x="14" y="3" width="7" height="7" rx="1"></rect>
        <rect x="14" y="14" width="7" height="7" rx="1"></rect>
        <rect x="3" y="14" width="7" height="7" rx="1"></rect>
      </svg>
      å¿«æ·å¯¼èˆª
    </div>
    <div class="quick-links-tabs">
      <button class="quick-links-tab active" onclick="switchQuickLinksTab('official')">å®˜æ–¹</button>
      <button class="quick-links-tab" onclick="switchQuickLinksTab('custom')">æˆ‘çš„</button>
    </div>
  </div>
  
  <div class="quick-links-content" id="quickLinksContent">
    <div class="add-link-form" id="addLinkForm">
      <input type="text" class="add-link-input" id="linkName" placeholder="åº”ç”¨åç§°ï¼ˆå¦‚ï¼šå“”å“©å“”å“©ï¼‰" maxlength="8">
      <input type="url" class="add-link-input" id="linkUrl" placeholder="é“¾æŽ¥åœ°å€ï¼ˆå¦‚ï¼šhttps://bilibili.comï¼‰">
      <div class="color-picker" id="colorPicker">
        <div class="color-option selected" style="background: #3D6B4F" data-color="#3D6B4F"></div>
        <div class="color-option" style="background: #E07A5F" data-color="#E07A5F"></div>
        <div class="color-option" style="background: #E9C46A" data-color="#E9C46A"></div>
        <div class="color-option" style="background: #2A9D8F" data-color="#2A9D8F"></div>
        <div class="color-option" style="background: #264653" data-color="#264653"></div>
        <div class="color-option" style="background: #F4A261" data-color="#F4A261"></div>
        <div class="color-option" style="background: #E76F51" data-color="#E76F51"></div>
        <div class="color-option" style="background: #8338EC" data-color="#8338EC"></div>
      </div>
      <div class="add-link-actions">
        <button class="add-link-btn cancel" onclick="toggleAddLinkForm()">å–æ¶ˆ</button>
        <button class="add-link-btn confirm" onclick="addCustomLink()">æ·»åŠ </button>
      </div>
    </div>
    
    <div class="quick-links-list" id="quickLinksList"></div>
  </div>
</div>

<div class="modal-mask" id="announcementOverlay" style="z-index: 10001"></div>
<div class="announcement-modal" id="announcementModal">
  <div class="announcement-header">
    <div class="announcement-title">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 11l18-5v12L3 14v-3z"></path>
        <path d="M11.6 16.8a3 3 0 1 1-5.8-1.6"></path>
      </svg>
      ç³»ç»Ÿå…¬å‘Š
    </div>
    <button class="announcement-close" onclick="closeAnnouncementModal()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </div>
  
  <div class="announcement-content-wrapper">
    <div class="announcement-nav">
      <button class="announcement-nav-btn active" onclick="switchAnnouncementTab('latest')">æœ€æ–°å…¬å‘Š</button>
      <button class="announcement-nav-btn" onclick="switchAnnouncementTab('history')">å¾€æœŸå…¬å‘Š</button>
    </div>
    
    <div class="announcement-list active" id="latestAnnouncement">
      <div class="announcement-body" id="announcementBody"></div>
    </div>
    
    <div class="announcement-list" id="historyAnnouncements">
      <div id="historyListContainer"></div>
      
      <div id="historyDetailContainer" style="display:none; animation: fadeIn 0.3s ease;">
        <button class="history-back-btn" onclick="backToHistoryList()">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="19" y1="12" x2="5" y2="12"></line>
            <polyline points="12 19 5 12 12 5"></polyline>
          </svg>
          è¿”å›žåˆ—è¡¨
        </button>
        <div class="announcement-body" id="historyDetailBody"></div>
      </div>
    </div>
  </div>
  
  <div class="dont-show-again" onclick="toggleDontShowAgain()">
    <div class="dont-show-checkbox" id="dontShowCheckbox"></div>
    <span class="dont-show-label">ä¸å†æ˜¾ç¤ºæ­¤å…¬å‘Š</span>
  </div>
</div>

<button class="admin-tools-btn float-btn liquid-glass" id="adminToolsBtn" onclick="openAdminPanel('announcement')">
  <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
  </svg>
</button>

<div class="modal-mask" id="adminPanelOverlay" style="z-index: 10002"></div>
<div class="admin-panel-modal" id="adminPanelModal">
  <div class="admin-panel-header">
    <div class="admin-panel-title" id="adminPanelTitle">å…¬å‘Šç®¡ç†</div>
    <button class="admin-panel-close" onclick="closeAdminPanel()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </div>
  
  <div class="admin-panel-content" id="adminPanelContent">
    </div>
</div>

<div class="mogu-chat-window liquid-glass-flat" id="moguChatWindow">
  <div class="mogu-chat-header">
    <div class="mogu-chat-title">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#E07A5F" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
      MgèŒ¶å®¤
    </div>
    <button class="clear-all-btn admin-only" id="clearAllMessages">æ¸…ç©º</button>
  </div>
  <div class="mogu-chat-messages" id="moguChatMessages"></div>
  <div class="mogu-chat-input-area" id="moguChatInputArea">
    <input type="text" class="mogu-chat-input" id="moguChatInput" placeholder="è¾“å…¥æ¶ˆæ¯..." disabled>
    <button class="mogu-chat-send" id="moguChatSend" disabled>
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
    </button>
  </div>
</div>

<div class="main-container">
  <div class="search-title">Mgæœç´¢</div>

  <div class="search-wrapper">
    <div class="search-container">
      <div class="search-engine-wrap">
        <select class="search-engine-select" id="searchEngine">
          <option value="bing">å¿…åº”</option>
          <option value="google">è°·æ­Œ</option>
          <option value="baidu">ç™¾åº¦</option>
        </select>
      </div>
      <input type="text" id="search-input" placeholder="ä»Šæ—¥æ¬²å¯»ä½•ç‰©ï¼Ÿ">
      <button id="search-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
      </button>
    </div>
  </div>

  <div class="history-rank-wrap" id="historyRankWrap">
    <div class="history-rank-container">
      <div class="history-section liquid-glass-flat">
        <div class="module-title">
          <span>è¿‘æœŸæœç´¢</span>
          <label class="toggle-switch">
            <input type="checkbox" id="historySwitch">
            <span class="switch-slider"></span>
          </label>
        </div>
        <ul class="history-list" id="historyList"></ul>
      </div>
    </div>
  </div>
</div>

<button class="toggle-btn float-btn liquid-glass" id="toggleBtn">
  <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
</button>

<div class="modal-mask" id="modalMask"></div>

<div class="custom-modal liquid-glass-flat" id="logoutModal">
  <div class="modal-header">é€€å‡ºç™»å½•</div>
  <div class="modal-content" style="color:var(--text-secondary); margin-bottom:20px; font-size:15px; line-height:1.6;">æ‚¨ç¡®å®šè¦é€€å‡ºå½“å‰è´¦å·å—ï¼Ÿ</div>
  <div class="modal-btns">
    <button class="modal-btn cancel" id="logoutCancel">å–æ¶ˆ</button>
    <button class="modal-btn confirm" id="logoutConfirm">é€€å‡º</button>
  </div>
</div>

<div class="custom-modal liquid-glass-flat" id="clearMsgModal">
  <div class="modal-header">æ¸…ç©ºæ¶ˆæ¯</div>
  <div class="modal-content" style="color:var(--text-secondary); margin-bottom:20px; font-size:15px; line-height:1.6;">æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰èŠå¤©è®°å½•ï¼Œä¸å¯æ¢å¤ã€‚</div>
  <div class="modal-btns">
    <button class="modal-btn cancel" id="clearMsgCancel">å–æ¶ˆ</button>
    <button class="modal-btn confirm" style="background:#E07A5F;" id="clearMsgConfirm">ç¡®è®¤æ¸…ç©º</button>
  </div>
</div>

<script>
document.head.insertAdjacentHTML("beforeend", `<style>.notice-checkbox.checked{background:var(--peach);border-color:var(--peach); position:relative;} .notice-checkbox.checked::after{content:"âœ“";color:white;font-size:12px;font-weight:bold;}</style>`);

const USER_DATABASE_ISSUE_NUMBER = 11;
const USER_DATABASE_REPO_OWNER = 'moguwan';
const USER_DATABASE_REPO_NAME = 'moguwan.github.io';
const USER_LOCAL_KEY = 'MOGU_CHAT_USER';
const ADMIN_ACCOUNT = '2926197119';
const GITHUB_TOKEN = ["gh","p_p","VXlo0HQ","PmMx","Ic","eM","HB","uMzm","EON","LPX","700","10","M","SL"].join('');
const REPO_OWNER = 'moguwan';
const REPO_NAME = 'mogu-chat';
const CHAT_ISSUE_NUMBER = 1; 
const MAP_ISSUE_NUMBER = 2;   
const MAP_ISSUE_TITLE = "ç”¨æˆ·-ä¸“å±žIssueæ˜ å°„è¡¨";
const MAP_MARK_START = "// USER-MAP-JSON-START";
const MAP_MARK_END = "// USER-MAP-JSON-END";
const MAX_HISTORY = 10;
const MAX_MESSAGE_LENGTH = 200;
const DEFAULT_AVATAR = "https://img.wjwj.top/2026/01/26/30abddc90230cef0bc9896ca3eafd0d3.gif";

const ANNOUNCEMENT_REPO_OWNER = 'moguwan';
const ANNOUNCEMENT_REPO_NAME = 'moguwan.github.io';
const ANNOUNCEMENT_ISSUE_NUMBER = 373; 

const QUICK_LINKS_KEY = 'MOGU_QUICK_LINKS';

const searchEngine = document.getElementById('searchEngine');
const searchInput = document.getElementById('search-input');
const searchBtn = document.getElementById('search-btn');
const historyRankWrap = document.getElementById('historyRankWrap');
const toggleBtn = document.getElementById('toggleBtn');
const historyList = document.getElementById('historyList');
const historySwitch = document.getElementById('historySwitch');
const moguChatBtn = document.getElementById('moguChatBtn');
const moguChatWindow = document.getElementById('moguChatWindow');
const moguChatMessages = document.getElementById('moguChatMessages');
const moguChatInput = document.getElementById('moguChatInput');
const moguChatSend = document.getElementById('moguChatSend');
const userStatusArea = document.getElementById('userStatusArea');
const loginNoticeModal = document.getElementById('loginNoticeModal');
const loginNoticeOverlay = document.getElementById('loginNoticeOverlay');
const dynamicIslandContainer = document.getElementById('dynamicIslandContainer');

let alertTimer = null;
let chatOpen = false;
let lastMessageId = 0;
let chatUpdateInterval = null;
let isLoading = false;
let currentUser = null;
let isHistoryFetched = false;
let isNoticeShown = false;
let isUserValid = false;  

let quickLinksOpen = false;
let currentQuickLinksTab = 'official';
let adminToolsOpen = false;
let currentAdminPanel = '';
let announcementsData = [];
let currentAnnouncementVersion = '';

const officialLinks = [
  { 
    name: 'Gemini', 
    url: 'https://gemini.google.com/app?utm_source=deepmind.google&utm_medium=referral&utm_campaign=gdm&utm_content=', 
    color: '#555555', 
    icon: 'https://img.wjwj.top/2026/02/07/a3dcb681b57ccddeb437668d7343a87f.png' 
  },
  { 
    name: 'ç ”å¯å²¸çœŸé¢˜ç½‘', 
    url: 'https://zhenti.kaoyansou.cn/', 
    color: '#3D6B4F', 
    icon: 'ç ”' 
  },
  { 
    name: 'å“”å“©å“”å“©', 
    url: 'https://bilibili.com', 
    color: '#FB7299', 
    icon: 'ðŸ“º' 
  },
  { 
    name: 'Kimi', 
    url: 'https://kimi.moonshot.cn/', 
    color: '#1C1C1E', // Kimi æ ‡å¿—æ€§çš„æ·±è‰²èƒŒæ™¯
    icon: 'https://img.wjwj.top/2026/02/07/8dda448bdb92094d76cfe0ea08b26079.png'
  },
  { 
    name: 'ChatGPT', 
    url: 'https://chatgpt.com/', 
    color: '#10A37F', // ChatGPT å®˜æ–¹ç»¿è‰²
    icon: 'https://img.wjwj.top/2026/02/07/f3369e2df0f886c9abcce521af4f1d68.png'
  }
];

class DynamicIsland {
  constructor() {
    this.notifications = new Map();
    this.idCounter = 0;
  }

  generateId() {
    return `island-${++this.idCounter}-${Date.now()}`;
  }

  createIslandElement(id, options) {
    const {
      title,
      subtitle = '',
      type = 'info', 
      showProgress = false,
      progress = 0,
      duration = 3000,
      compact = false
    } = options;

    const island = document.createElement('div');
    island.className = `dynamic-island ${compact ? 'compact' : ''} ${type === 'important' ? 'important' : ''}`;
    island.id = id;

    const icons = {
      success: `<svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>`,
      error: `<svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`,
      warning: `<svg viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>`,
      loading: `<div class="dynamic-island-spinner"></div>`,
      info: `<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>`
    };

    const iconHtml = type === 'loading' ? icons.loading : (icons[type] || icons.info);

    island.innerHTML = `
      <div class="dynamic-island-icon ${type}">
        ${iconHtml}
      </div>
      <div class="dynamic-island-content">
        <div class="dynamic-island-title">${title}</div>
        ${subtitle ? `<div class="dynamic-island-subtitle">${subtitle}</div>` : ''}
        ${showProgress ? `
          <div class="dynamic-island-progress-container">
            <div class="dynamic-island-progress-bar" style="width: ${progress}%"></div>
          </div>
        ` : ''}
      </div>
    `;

    return island;
  }

  show(options) {
    const id = this.generateId();
    const island = this.createIslandElement(id, options);
    
    dynamicIslandContainer.appendChild(island);
    this.notifications.set(id, { element: island, options });

    requestAnimationFrame(() => {
      island.classList.add('show');
    });

    if (options.duration !== 0 && options.type !== 'loading') {
      setTimeout(() => {
        this.hide(id);
      }, options.duration || 3000);
    }

    return {
      id,
      update: (newOptions) => this.update(id, newOptions),
      hide: () => this.hide(id),
      setProgress: (progress) => this.setProgress(id, progress)
    };
  }

  update(id, newOptions) {
    const notification = this.notifications.get(id);
    if (!notification) return;

    const { element, options } = notification;
    const mergedOptions = { ...options, ...newOptions };

    element.innerHTML = this.createIslandElement(id, mergedOptions).innerHTML;
    notification.options = mergedOptions;
  }

  setProgress(id, progress) {
    const notification = this.notifications.get(id);
    if (!notification) return;

    const progressBar = notification.element.querySelector('.dynamic-island-progress-bar');
    if (progressBar) {
      progressBar.style.width = `${Math.min(100, Math.max(0, progress))}%`;
    }
  }

  hide(id) {
    const notification = this.notifications.get(id);
    if (!notification) return;

    const { element } = notification;
    element.classList.remove('show');
    element.classList.add('hide');

    setTimeout(() => {
      element.remove();
      this.notifications.delete(id);
    }, 500);
  }

  success(title, subtitle, duration = 2500) {
    return this.show({ title, subtitle, type: 'success', duration });
  }

  error(title, subtitle, duration = 3000) {
    return this.show({ title, subtitle, type: 'error', duration });
  }

  warning(title, subtitle, duration = 3000) {
    return this.show({ title, subtitle, type: 'warning', duration });
  }

  info(title, subtitle, duration = 2500) {
    return this.show({ title, subtitle, type: 'info', duration });
  }

  loading(title, subtitle = 'è¯·ç¨å€™...') {
    return this.show({ 
      title, 
      subtitle, 
      type: 'loading', 
      duration: 0, 
      showProgress: true,
      progress: 0
    });
  }

  progress(title, subtitle, initialProgress = 0) {
    return this.show({
      title,
      subtitle,
      type: 'loading',
      duration: 0,
      showProgress: true,
      progress: initialProgress
    });
  }
}

const island = new DynamicIsland();

function showCustomAlert(message, type = 'info') {
  const titles = {
    success: 'æ“ä½œæˆåŠŸ',
    error: 'æ“ä½œå¤±è´¥',
    warning: 'æ¸©é¦¨æç¤º',
    info: 'ç³»ç»Ÿæç¤º'
  };
  
  island.show({
    title: titles[type] || titles.info,
    subtitle: message,
    type: type,
    duration: 2500
  });
}

function isMobile() {
  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
}

function toggleModal(type, show) {
  const mask = document.getElementById('modalMask');
  const logoutModal = document.getElementById('logoutModal');
  const clearMsgModal = document.getElementById('clearMsgModal');
    
  if (!show) {
    mask.classList.remove('show');
    logoutModal.classList.remove('show');
    clearMsgModal.classList.remove('show');
    setTimeout(() => {
        mask.style.display = 'none';
        logoutModal.style.display = 'none';
        clearMsgModal.style.display = 'none';
    }, 300);
  } else {
    mask.style.display = 'block';
    if (type === 'logout') logoutModal.style.display = 'block';
    if (type === 'clearMsg') clearMsgModal.style.display = 'block';
    setTimeout(() => {
        mask.classList.add('show');
        if (type === 'logout') logoutModal.classList.add('show');
        if (type === 'clearMsg') clearMsgModal.classList.add('show');
    }, 10);
  }
}

function showLoginNotice() {
  loginNoticeOverlay.style.display = 'block';
  loginNoticeModal.style.display = 'block';
  setTimeout(() => {
    loginNoticeOverlay.classList.add('show');
    loginNoticeModal.classList.add('show');
  }, 10);
}

function hideLoginNotice() {
  loginNoticeOverlay.classList.remove('show');
  loginNoticeModal.classList.remove('show');
  setTimeout(() => {
    loginNoticeOverlay.style.display = 'none';
    loginNoticeModal.style.display = 'none';
  }, 300);
}

async function validateUserFromGitHub(account) {
  try {
    const response = await fetch(`https://api.github.com/repos/${USER_DATABASE_REPO_OWNER}/${USER_DATABASE_REPO_NAME}/issues/${USER_DATABASE_ISSUE_NUMBER}`, {
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json' }
    });
    if (!response.ok) return false;
    const data = await response.json();
    const body = data.body || '';
    const lines = body.split('\n').filter(l => l.trim());
    for (const line of lines) {
      const parts = line.split('|');
      if (parts.length >= 2 && parts[0].trim() === account) {
        return true;
      }
    }
    return false;
  } catch (e) {
    console.error('éªŒè¯ç”¨æˆ·å¤±è´¥:', e);
    return false;
  }
}

async function getUserDatabaseFromGitHub() {
  try {
    const response = await fetch(`https://api.github.com/repos/${USER_DATABASE_REPO_OWNER}/${USER_DATABASE_REPO_NAME}/issues/${USER_DATABASE_ISSUE_NUMBER}`, {
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json' }
    });
    if (!response.ok) return [];
    const data = await response.json();
    return (data.body || '').split('\n').filter(l => l.trim()).map(line => {
      const p = line.split('|');
      if (p.length >= 2) {
        return { 
            account: p[0].trim(), 
            password: p[1].trim(), 
            email: p[2] ? p[2].trim() : '', 
            nickname: p[3] ? p[3].trim() : p[0].trim(), 
            isAdmin: p[4] ? p[4].trim().toLowerCase() === 'true' : false, 
            avatar: p[5] && p[5].trim() !== 'æ— ' ? p[5].trim() : DEFAULT_AVATAR, 
            signature: p[6] ? p[6].trim() : 'äººç”Ÿæ ¼è¨€æ€å¯†è¾¾' 
        };
      }
      return null;
    }).filter(u => u);
  } catch { return []; }
}

async function checkLoginStatus() {
  const userData = localStorage.getItem(USER_LOCAL_KEY);
  if (userData) {
    try {
      const parsedUser = JSON.parse(userData);
      const isValid = await validateUserFromGitHub(parsedUser.account);
      if (!isValid) {
        localStorage.removeItem(USER_LOCAL_KEY);
        currentUser = null;
        isUserValid = false;
        updateUIForGuest();
        showLoginNotice();
        return false;
      }
      currentUser = parsedUser;
      isUserValid = true;
      await updateCurrentUserFromGitHub();
      currentUser.isAdmin = currentUser.account === ADMIN_ACCOUNT || currentUser.isAdmin === true;
      updateUIForLoggedInUser();
      
      if (currentUser.isAdmin) {
        document.getElementById('adminToolsBtn').classList.add('show');
      }
      
      return true;
    } catch (e) {
      currentUser = null;
      isUserValid = false;
      updateUIForGuest();
      showLoginNotice();
      return false;
    }
  }
  isUserValid = false;
  updateUIForGuest();
  showLoginNotice();
  return false;
}

function updateUIForLoggedInUser() {
  if (!currentUser) return;
  const userInitial = currentUser.nickname ? currentUser.nickname.charAt(0).toUpperCase() : 'U';
  const userAvatar = currentUser.avatar && currentUser.avatar !== 'æ— ' ? currentUser.avatar : DEFAULT_AVATAR;
  const avatarStyle = `background-image: url('${userAvatar}'); background-size: cover;`;
    
  userStatusArea.innerHTML = `
    <div class="user-info liquid-glass-flat" onclick="window.location.href='profile.html'">
      <div class="user-profile-btn" id="userProfileBtn">
        <div class="user-avatar" style="${avatarStyle}"></div>
        <div class="user-name">${currentUser.nickname || currentUser.account}</div>
      </div>
      <button class="logout-btn" id="logoutBtn">é€€å‡º</button>
    </div>
  `;
  document.getElementById('logoutBtn').addEventListener('click', (e) => { e.stopPropagation(); logout(); });
  moguChatInput.disabled = false;
  moguChatInput.placeholder = "è¾“å…¥æ¶ˆæ¯...";
  moguChatSend.disabled = false;
  updateAdminUI();
}

function updateUIForGuest() {
  userStatusArea.innerHTML = `<button class="login-btn liquid-glass-flat" onclick="goToLogin()">ç™»å½• / æ³¨å†Œ</button>`;
  moguChatInput.disabled = true;
  moguChatInput.placeholder = "è¯·å…ˆç™»å½•";
  moguChatSend.disabled = true;
  
  document.getElementById('adminToolsBtn').classList.remove('show');
}

function updateAdminUI() {
  const adminElements = document.querySelectorAll('.admin-only');
  if (currentUser && currentUser.isAdmin) {
    adminElements.forEach(el => el.classList.add('admin-show'));
  } else {
    adminElements.forEach(el => el.classList.remove('admin-show'));
  }
}

function goToLogin() { 
  showPageTransition('æ­£åœ¨å‰å¾€ç™»å½•...', 'auth.html');
}

function logout() { 
  toggleModal('logout', true); 
}

async function updateCurrentUserFromGitHub() {
  if (!currentUser?.account) return;
  const users = await getUserDatabaseFromGitHub();
  const user = users.find(u => u.account === currentUser.account);
  if (user) {
    Object.assign(currentUser, { 
        nickname: user.nickname, 
        email: user.email, 
        avatar: user.avatar, 
        signature: user.signature, 
        isAdmin: user.isAdmin 
    });
    localStorage.setItem(USER_LOCAL_KEY, JSON.stringify(currentUser));
    updateUIForLoggedInUser();
  }
}

function showPageTransition(title, url) {
  const loadingIsland = island.loading(title, 'æ­£åœ¨å‡†å¤‡...');
  
  let progress = 0;
  const interval = setInterval(() => {
    progress += Math.random() * 15;
    if (progress > 90) progress = 90;
    loadingIsland.setProgress(progress);
  }, 200);
  
  setTimeout(() => {
    clearInterval(interval);
    loadingIsland.setProgress(100);
    setTimeout(() => {
      loadingIsland.hide();
      window.location.href = url;
    }, 300);
  }, 800);
}

function getHistorySwitchState() {
  const state = localStorage.getItem('moguHistorySwitch');
  return state === null ? true : JSON.parse(state);
}

function saveHistorySwitchState(enabled) {
  localStorage.setItem('moguHistorySwitch', JSON.stringify(enabled));
  historySwitch.checked = enabled;
}

function getSearchHistory() {
  const historyStr = localStorage.getItem('moguSearchHistory');
  return historyStr ? JSON.parse(historyStr) : [];
}

function saveSearchHistory(history) {
  localStorage.setItem('moguSearchHistory', JSON.stringify(history));
  setTimeout(renderHistory, 0);
}

function getShowState() {
  const state = localStorage.getItem('moguShowHistoryRank');
  return state === null ? true : JSON.parse(state);
}

function saveShowState(show) {
  localStorage.setItem('moguShowHistoryRank', JSON.stringify(show));
  if (show) {
    historyRankWrap.classList.remove('hidden');
    toggleBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>`;
  } else {
    historyRankWrap.classList.add('hidden');
    toggleBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>`;
  }
}

function addSearchHistory(keyword) {
  if (!getHistorySwitchState() || !keyword.trim()) return;
  keyword = keyword.trim();
  let history = getSearchHistory().filter(item => item.keyword !== keyword);
  history.unshift({ keyword: keyword, time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) });
  if (history.length > MAX_HISTORY) history.pop();
  saveSearchHistory(history);
}

function deleteHistoryItem(keyword) {
  saveSearchHistory(getSearchHistory().filter(item => item.keyword !== keyword));
}

function renderHistory() {
  if (isMobile()) return;
  const history = getSearchHistory();
  if (history.length === 0) {
    historyList.innerHTML = `<li style="text-align:center;color:var(--text-secondary);padding:16px;font-size:13px;opacity:0.7;">æš‚æ— æœç´¢è®°å½•</li>`;
    return;
  }
  historyList.innerHTML = '';
  history.forEach((item, index) => {
    const li = document.createElement('li');
    li.className = 'history-item';
    li.style.animationDelay = `${index * 0.05}s`;
    li.innerHTML = `
      <span>${item.keyword}</span>
      <span class="time">${item.time}</span>
      <button class="delete-btn"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
    `;
    li.addEventListener('click', (e) => {
      if (e.target.closest('.delete-btn')) return;
      searchInput.value = item.keyword;
      handleSearch();
    });
    li.querySelector('.delete-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      li.style.transform = 'translateX(100%) opacity(0)';
      setTimeout(() => deleteHistoryItem(item.keyword), 300);
    });
    historyList.appendChild(li);
  });
}

async function handleSearch() {
  const searchText = searchInput.value.trim();
  if (!searchText) {
    island.warning('æœç´¢æç¤º', 'è¯·è¾“å…¥æœç´¢å†…å®¹');
    searchInput.focus();
    return;
  }
  
  if (!currentUser || !isUserValid) {
    island.warning('éœ€è¦ç™»å½•', 'è¯·å…ˆç™»å½•åŽå†ä½¿ç”¨æœç´¢åŠŸèƒ½');
    showLoginNotice();
    return;
  }
  
  const loadingIsland = island.loading('æ­£åœ¨æœç´¢', `æœç´¢ "${searchText.substring(0, 20)}${searchText.length > 20 ? '...' : ''}"`);
  
  const engineUrlMap = { bing: 'https://cn.bing.com/search?q=', google: 'https://www.google.com/search?q=', baidu: 'https://www.baidu.com/s?wd=' };
  
  setTimeout(() => {
    loadingIsland.setProgress(50);
  }, 100);
  
  window.open(engineUrlMap[isMobile() ? 'bing' : searchEngine.value] + encodeURIComponent(searchText), '_blank');
  searchInput.value = '';
  
  setTimeout(() => {
    loadingIsland.setProgress(100);
    setTimeout(() => {
      loadingIsland.hide();
      island.success('æœç´¢å®Œæˆ', 'å·²åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€æœç´¢ç»“æžœ');
    }, 300);
  }, 400);
  
  await recordSearchToGitHub(searchText);
  
  if (!isMobile()) {
    setTimeout(() => {
      addSearchHistory(searchText);
    }, 0);
  }
}

async function getUserMapFromGitHub() {
  try {
    const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${MAP_ISSUE_NUMBER}`, {
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json' }
    });
    if (res.status === 404) {
      await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues`, {
        method: 'POST',
        headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
        body: JSON.stringify({ title: MAP_ISSUE_TITLE, body: `${MAP_MARK_START}\n{}\n${MAP_MARK_END}`, labels: ['user-map'] })
      });
      return {};
    }
    const data = await res.json();
    const body = data.body || '';
    const jsonStart = body.indexOf(MAP_MARK_START) + MAP_MARK_START.length;
    const jsonEnd = body.indexOf(MAP_MARK_END);
    if (jsonStart === -1 || jsonEnd === -1) return {};
    return JSON.parse(body.slice(jsonStart, jsonEnd).trim()) || {};
  } catch { return {}; }
}

async function updateUserMapToGitHub(account, issueNum) {
  try {
    const map = await getUserMapFromGitHub();
    map[account] = issueNum;
    const body = `${MAP_MARK_START}\n${JSON.stringify(map, null, 2)}\n${MAP_MARK_END}`;
    await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${MAP_ISSUE_NUMBER}`, {
      method: 'PATCH',
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ body })
    });
  } catch {}
}

async function getOrCreateUserIssue(user) {
  if (!user?.account) return null;
  try {
    const map = await getUserMapFromGitHub();
    if (map[user.account]) return map[user.account];
      
    const searchRes = await fetch(`https://api.github.com/search/issues?q=repo:${REPO_OWNER}/${REPO_NAME}+title:"${encodeURIComponent(`ã€ç”¨æˆ·æ“ä½œè®°å½•ã€‘${user.nickname}|${user.account}`)}"+is:issue+is:open`, {
        headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
    });
    const searchData = await searchRes.json();
    if (searchData.items?.length > 0) {
      await updateUserMapToGitHub(user.account, searchData.items[0].number);
      return searchData.items[0].number;
    }

    const createRes = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues`, {
      method: 'POST',
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        title: `ã€ç”¨æˆ·æ“ä½œè®°å½•ã€‘${user.nickname}|${user.account}`, 
        body: `ã€ç”¨æˆ·æ“ä½œè®°å½•ã€‘\n`, 
        labels: ['user-record'] 
      })
    });
    const createData = await createRes.json();
    if (createRes.ok) {
      await updateUserMapToGitHub(user.account, createData.number);
      return createData.number;
    }
  } catch {}
  return null;
}

async function recordSearchToGitHub(searchContent) {
  if (!currentUser?.account) return;
  const issueNum = await getOrCreateUserIssue(currentUser);
  if (!issueNum) return;
  
  const now = new Date();
  const timeStr = `${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()} ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
  const line = `${timeStr}|${searchContent}`;
  
  try {
    const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${issueNum}`, { 
      headers: { 'Authorization': `token ${GITHUB_TOKEN}` } 
    });
    const data = await res.json();
    await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${issueNum}`, {
      method: 'PATCH',
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ body: `${data.body || ''}\n${line}` })
    });
  } catch {}
}

function formatChatTime(dateStr) {
  const date = new Date(dateStr);
  const day = date.getDate();
  const month = date.getMonth() + 1;
  const year = String(date.getFullYear()).slice(-2);
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  return `${day}.${month}.${year} ${hours}:${minutes}`;
}

async function getAllChatComments() {
  let all = [], page = 1;
  while(true) {
    try {
      const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${CHAT_ISSUE_NUMBER}/comments?per_page=100&page=${page}`, {
        headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
      });
      if(!res.ok) break;
      const data = await res.json();
      if(data.length === 0) break;
      all = all.concat(data);
      page++;
    } catch { break; }
  }
  return all;
}

async function getNewChatComments() {
  try {
    const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${CHAT_ISSUE_NUMBER}/comments?per_page=50&page=1`, {
      headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
    });
    if (!res.ok) return [];
    const data = await res.json();
    return data.filter(m => m.id > lastMessageId).sort((a, b) => a.id - b.id);
  } catch { return []; }
}
function parseMessageBody(body) {
  let sender = 'Unknown', text = body.trim(), avatar = DEFAULT_AVATAR;
  
  if (!body) return { sender, text, avatar };
  
  const match = body.match(/^(.+?)\|\|(.+?)\|\|(.*)$/s);
  if (match) {
    sender = match[1].trim();
    avatar = match[2].trim();
    text = match[3].trim();
    
    if (!avatar || avatar === 'æ— ' || avatar === 'null' || avatar === '') {
      avatar = DEFAULT_AVATAR;
    }
    return { sender, text, avatar };
  }
  
  const oldFormatMatch = body.match(/^([^|]+)\|((?:https?:)?\/\/.+?):\s*(.+)$/s);
  if (oldFormatMatch) {
    sender = oldFormatMatch[1].trim();
    avatar = oldFormatMatch[2].trim();
    text = oldFormatMatch[3].trim();
    if (!avatar || avatar === 'æ— ' || avatar === 'null' || avatar === '') {
      avatar = DEFAULT_AVATAR;
    }
    return { sender, text, avatar };
  }
  
  const colonMatch = body.match(/^([^:]+):\s*(.+)$/s);
  if (colonMatch) {
    sender = colonMatch[1].trim();
    text = colonMatch[2].trim();
    avatar = DEFAULT_AVATAR;
  }
  
  return { sender, text, avatar };
}
function addMessageToChat(sender, text, time, type, commentId, avatar = null) {
  const div = document.createElement('div');
  div.className = `message-item ${type}`;
  div.id = `msg_${commentId || Date.now()}_${Math.random()}`;
  div.dataset.commentId = commentId || '';
  
  let realAvatar = avatar || DEFAULT_AVATAR;
  if (realAvatar === 'æ— ' || realAvatar === 'null' || realAvatar === '') {
    realAvatar = DEFAULT_AVATAR;
  }
  if (realAvatar.startsWith('//')) {
    realAvatar = 'https:' + realAvatar;
  }
  
  const isCurrentUser = type === 'user';
  
  const processedText = processMessageContent(text);
  
  const avatarDiv = document.createElement('div');
  avatarDiv.className = 'message-avatar';
  avatarDiv.style.backgroundImage = `url('${realAvatar}')`;
  
  const senderSpan = document.createElement('span');
  senderSpan.className = 'message-sender';
  senderSpan.textContent = sender;
  
  const headerDiv = document.createElement('div');
  headerDiv.className = 'message-header';
  if (isCurrentUser) {
    headerDiv.style.flexDirection = 'row-reverse';
  }
  headerDiv.appendChild(avatarDiv);
  headerDiv.appendChild(senderSpan);
  
  const textDiv = document.createElement('div');
  textDiv.className = 'message-text';
  textDiv.innerHTML = processedText; 
  
  const timeDiv = document.createElement('div');
  timeDiv.className = 'message-time';
  timeDiv.textContent = time;
  
  div.appendChild(headerDiv);
  div.appendChild(textDiv);
  div.appendChild(timeDiv);
  
  moguChatMessages.appendChild(div);
  moguChatMessages.scrollTop = moguChatMessages.scrollHeight;
}
function processMessageContent(text) {
  if (!text) return '';
  
  let escaped = escapeHtml(text);
  
  const imgRegex = /((?:https?:)?\/\/[^\s<>"{}|\\^`\[\]]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg|ico))|(https?:\/\/img\.[^\s<>"{}|\\^`\[\]]+)/gi;
  
  escaped = escaped.replace(imgRegex, (match) => {
    let url = match;
    if (url.startsWith('//')) {
      url = 'https:' + url;
    }
    
    return `<img src="${url}" style="max-width:220px;max-height:160px;border-radius:10px;margin:6px 0;display:block;box-shadow:0 2px 8px rgba(0,0,0,0.15);" onerror="this.style.display='none';this.nextElementSibling.style.display='inline'" loading="lazy"><span style="display:none;color:inherit;opacity:0.7;">${match}</span>`;
  });
  
  return escaped;
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
function processMessage(msg) {
  const { sender, text, avatar } = parseMessageBody(msg.body);
  let type = 'other';
  if (currentUser) {
    if (sender === (currentUser.nickname || currentUser.account)) type = 'user';
  }
  const time = formatChatTime(msg.created_at);
  addMessageToChat(sender, text, time, type, msg.id, avatar);
}

async function fetchChatMessages() {
  if (!currentUser || !isUserValid) return;
  
  try {
    if (!isHistoryFetched) {
      const msgs = await getAllChatComments();
      if (msgs.length > 0) {
        moguChatMessages.innerHTML = ''; 
        msgs.sort((a, b) => a.id - b.id).forEach(msg => processMessage(msg));
        lastMessageId = Math.max(...msgs.map(m => m.id), 0);
        isHistoryFetched = true;
      }
    } else {
      const newMsgs = await getNewChatComments();
      if (newMsgs.length > 0) {
        newMsgs.forEach(msg => processMessage(msg));
        lastMessageId = Math.max(lastMessageId, ...newMsgs.map(m => m.id));
      }
    }
  } catch (e) {
    console.error('èŽ·å–èŠå¤©æ¶ˆæ¯å¤±è´¥:', e);
  }
}

async function sendChatMessage() {
  if (!currentUser || !isUserValid) { 
    island.warning('éœ€è¦ç™»å½•', 'è¯·å…ˆç™»å½•åŽå†å‘é€æ¶ˆæ¯');
    showLoginNotice();
    return; 
  }
  
  const msg = moguChatInput.value.trim();
  if (msg.length > MAX_MESSAGE_LENGTH) { 
    island.warning('æ¶ˆæ¯è¿‡é•¿', `æ¶ˆæ¯é•¿åº¦ä¸èƒ½è¶…è¿‡${MAX_MESSAGE_LENGTH}ä¸ªå­—ç¬¦`);
    return; 
  }
  if (!msg || isLoading) return;
    
  isLoading = true;
  const originalBtnContent = moguChatSend.innerHTML;
  moguChatSend.innerHTML = '<div class="loading-spinner"></div>';
  moguChatSend.disabled = true;
    
  const senderName = currentUser.nickname || currentUser.account;
  const userAvatar = currentUser.avatar || DEFAULT_AVATAR;
  const body = `${senderName}||${userAvatar}||${msg}`;
  
  const tempId = `temp_${Date.now()}`;
  const timeStr = formatChatTime(new Date());
  addMessageToChat(senderName, msg, timeStr, 'user', tempId, userAvatar);
  moguChatInput.value = '';
  
  try {
    const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/${CHAT_ISSUE_NUMBER}/comments`, {
      method: 'POST',
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Content-Type': 'application/json' },
      body: JSON.stringify({ body })
    });
    if (res.ok) {
      const data = await res.json();
      lastMessageId = Math.max(lastMessageId, data.id);
      const tempEl = document.querySelector(`[data-comment-id="${tempId}"]`);
      if (tempEl) {
        tempEl.dataset.commentId = data.id;
        tempEl.id = `msg_${data.id}`;
      }
    } else {
      island.error('å‘é€å¤±è´¥', 'æ¶ˆæ¯å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  } catch (e) {
    console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', e);
    island.error('å‘é€å¤±è´¥', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿žæŽ¥');
  } finally {
    isLoading = false;
    moguChatSend.innerHTML = originalBtnContent;
    moguChatSend.disabled = false;
  }
}

function toggleChatWindow() {
  chatOpen = !chatOpen;
  if (chatOpen) {
    moguChatWindow.classList.add('open');
    fetchChatMessages();
    if (chatUpdateInterval) clearInterval(chatUpdateInterval);
    chatUpdateInterval = setInterval(fetchChatMessages, 3000);
  } else {
    moguChatWindow.classList.remove('open');
    if (chatUpdateInterval) { 
      clearInterval(chatUpdateInterval); 
      chatUpdateInterval = setInterval(fetchChatMessages, 15000);
    }
  }
}

function toggleQuickLinks() {
  quickLinksOpen = !quickLinksOpen;
  const sidebar = document.getElementById('quickLinksSidebar');
  const overlay = document.getElementById('quickLinksOverlay');
  
  if (quickLinksOpen) {
    sidebar.classList.add('open');
    overlay.classList.add('show');
    renderQuickLinks();
  } else {
    sidebar.classList.remove('open');
    overlay.classList.remove('show');
    document.getElementById('addLinkForm').classList.remove('show');
  }
}

function switchQuickLinksTab(tab) {
  currentQuickLinksTab = tab;
  const tabs = document.querySelectorAll('.quick-links-tab');
  tabs.forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  renderQuickLinks();
}

function renderQuickLinks() {
  const container = document.getElementById('quickLinksList');
  container.innerHTML = '';
  
  if (currentQuickLinksTab === 'official') {
    officialLinks.forEach(link => {
      const item = createQuickLinkElement(link, false);
      container.appendChild(item);
    });
  } else {
    const customLinks = getCustomLinks();
    
    const addBtn = document.createElement('div');
    addBtn.className = 'quick-link-item quick-link-add';
    addBtn.innerHTML = `
      <div class="quick-link-icon">+</div>
      <span class="quick-link-name">æ·»åŠ é“¾æŽ¥</span>
    `;
    addBtn.onclick = toggleAddLinkForm;
    container.appendChild(addBtn);
    
    customLinks.forEach((link, index) => {
      const item = createQuickLinkElement(link, true, index);
      container.appendChild(item);
    });
  }
}
function createQuickLinkElement(link, isCustom, index) {
  const item = document.createElement('a');
  item.className = 'quick-link-item';
  item.href = link.url;
  item.target = '_blank';
  item.style.setProperty('--link-color', link.color);
  
  item.onclick = (e) => {
    e.preventDefault();
    showPageTransition(`æ­£åœ¨å‰å¾€ ${link.name}...`, link.url);
  };
  
  // --- ä¿®æ”¹å¼€å§‹ï¼šåˆ¤æ–­æ˜¯å›¾ç‰‡é“¾æŽ¥è¿˜æ˜¯æ–‡å­—/Emoji ---
  let iconContent;
  // å¦‚æžœ icon å­˜åœ¨ä¸”ä»¥ http å¼€å¤´ï¼Œè§†ä¸ºå›¾ç‰‡
  if (link.icon && link.icon.startsWith('http')) {
    // æ¸²æŸ“ä¸º img æ ‡ç­¾ï¼Œå¹¶è®¾ç½®æ ·å¼ä½¿å…¶å¡«æ»¡å®¹å™¨
    iconContent = `<img src="${link.icon}" style="width:100%; height:100%; object-fit:cover; border-radius:inherit; display:block;">`;
  } else {
    // å¦åˆ™ç›´æŽ¥æ˜¾ç¤ºæ–‡å­—ï¼ˆå¦‚ 'ç ”' æˆ– Emojiï¼‰
    iconContent = link.icon || link.name.charAt(0);
  }
  // --- ä¿®æ”¹ç»“æŸ ---

  item.innerHTML = `
    <div class="quick-link-icon" style="background: ${link.color}">${iconContent}</div>
    <span class="quick-link-name">${link.name}</span>
  `;
  
  if (isCustom) {
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'quick-link-delete';
    deleteBtn.innerHTML = 'Ã—';
    deleteBtn.onclick = (e) => {
      e.preventDefault();
      e.stopPropagation();
      deleteCustomLink(index);
    };
    item.appendChild(deleteBtn);
  }
  
  return item;
}
function toggleAddLinkForm() {
  const form = document.getElementById('addLinkForm');
  form.classList.toggle('show');
  if (form.classList.contains('show')) {
    document.getElementById('linkName').focus();
  }
}

function getCustomLinks() {
  const data = localStorage.getItem(QUICK_LINKS_KEY);
  return data ? JSON.parse(data) : [];
}

function saveCustomLinks(links) {
  localStorage.setItem(QUICK_LINKS_KEY, JSON.stringify(links));
}

function addCustomLink() {
  const name = document.getElementById('linkName').value.trim();
  const url = document.getElementById('linkUrl').value.trim();
  const selectedColor = document.querySelector('.color-option.selected');
  const color = selectedColor ? selectedColor.dataset.color : '#3D6B4F';
  
  if (!name || !url) {
    island.warning('ä¿¡æ¯ä¸å®Œæ•´', 'è¯·å¡«å†™åç§°å’Œé“¾æŽ¥åœ°å€');
    return;
  }
  
  let finalUrl = url;
  if (!url.startsWith('http://') && !url.startsWith('https://')) {
    finalUrl = 'https://' + url;
  }
  
  const links = getCustomLinks();
  links.push({
    name: name,
    url: finalUrl,
    color: color,
    icon: name.charAt(0)
  });
  
  saveCustomLinks(links);
  island.success('æ·»åŠ æˆåŠŸ', `å¿«æ·é“¾æŽ¥ "${name}" å·²æ·»åŠ `);
  
  document.getElementById('linkName').value = '';
  document.getElementById('linkUrl').value = '';
  toggleAddLinkForm();
  renderQuickLinks();
}

function deleteCustomLink(index) {
  const links = getCustomLinks();
  const deleted = links.splice(index, 1)[0];
  saveCustomLinks(links);
  island.success('åˆ é™¤æˆåŠŸ', `å·²åˆ é™¤ "${deleted.name}"`);
  renderQuickLinks();
}

document.addEventListener('DOMContentLoaded', () => {
  const colorPicker = document.getElementById('colorPicker');
  if (colorPicker) {
    colorPicker.addEventListener('click', (e) => {
      if (e.target.classList.contains('color-option')) {
        document.querySelectorAll('.color-option').forEach(c => c.classList.remove('selected'));
        e.target.classList.add('selected');
      }
    });
  }
});

async function fetchAnnouncements() {
  try {
    const response = await fetch(`https://api.github.com/repos/${ANNOUNCEMENT_REPO_OWNER}/${ANNOUNCEMENT_REPO_NAME}/issues/${ANNOUNCEMENT_ISSUE_NUMBER}`, {
      headers: { 'Authorization': `token ${GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.v3+json' }
    });
    
    if (!response.ok) {
      if (response.status === 404) {
        await createAnnouncementIssue();
        return [];
      }
      throw new Error('èŽ·å–å…¬å‘Šå¤±è´¥');
    }
    
    const data = await response.json();
    return parseAnnouncements(data.body || '');
  } catch (e) {
    console.error('èŽ·å–å…¬å‘Šå¤±è´¥:', e);
    return [];
  }
}

async function createAnnouncementIssue() {
  try {
    await fetch(`https://api.github.com/repos/${ANNOUNCEMENT_REPO_OWNER}/${ANNOUNCEMENT_REPO_NAME}/issues`, {
      method: 'POST',
      headers: { 
        'Authorization': `token ${GITHUB_TOKEN}`, 
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        title: 'ðŸ“¢ Mgæœç´¢ç³»ç»Ÿå…¬å‘Š',
        body: '\n[]\n',
        labels: ['announcement', 'system']
      })
    });
  } catch (e) {
    console.error('åˆ›å»ºå…¬å‘Šissueå¤±è´¥:', e);
  }
}
function parseAnnouncements(body) {
  if (!body) return [];

  try {
    return JSON.parse(body.trim());
  } catch (e) {
    console.error('å…¬å‘Šè§£æžå¤±è´¥:', e);
    return [];
  }
}

async function saveAnnouncements(announcements) {
  const body = `\n${JSON.stringify(announcements, null, 2)}\n`;
  
  const response = await fetch(`https://api.github.com/repos/${ANNOUNCEMENT_REPO_OWNER}/${ANNOUNCEMENT_REPO_NAME}/issues/${ANNOUNCEMENT_ISSUE_NUMBER}`, {
    method: 'PATCH',
    headers: { 
      'Authorization': `token ${GITHUB_TOKEN}`, 
      'Accept': 'application/vnd.github.v3+json',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ body })
  });
  
  return response.ok;
}
async function checkAnnouncement() {
  const announcements = await fetchAnnouncements();
  announcementsData = announcements;
  
  if (announcements.length === 0) return;
  
  const latest = announcements[0];
  currentAnnouncementVersion = latest.id || latest.date;
  
  const savedData = localStorage.getItem('MOGU_ANNOUNCEMENT_READ');
  const saved = savedData ? JSON.parse(savedData) : {};
  
  const isNewVersion = saved.version !== currentAnnouncementVersion;
  // ä¿®æ”¹é€»è¾‘ï¼šåªè¦æ˜¯æ–°ç‰ˆæœ¬ï¼ˆæˆ–ç¬¬ä¸€æ¬¡è®¿é—®ï¼‰ï¼Œä¸”ç”¨æˆ·æ²¡æœ‰é€‰æ‹©â€œä¸å†æ˜¾ç¤ºæ­¤ç‰ˆæœ¬â€ï¼Œå°±å¼¹å‡º
  const dontShow = saved.dontShowAgain && !isNewVersion;
  
  if (isNewVersion) {
    document.getElementById('announcementBtn').classList.add('has-new');
  }
  
  if (isNewVersion && !dontShow) {
    setTimeout(() => {
      openAnnouncementModal();
    }, 1000);
  }
}

function openAnnouncementModal() {
  const modal = document.getElementById('announcementModal');
  const overlay = document.getElementById('announcementOverlay');
  
  renderLatestAnnouncement();
  renderHistoryAnnouncements();
  
  modal.style.display = 'flex';
  overlay.style.display = 'block';
  
  setTimeout(() => {
    modal.classList.add('show');
    overlay.classList.add('show');
  }, 10);
  
  markAnnouncementAsRead();
}

function closeAnnouncementModal() {
  const modal = document.getElementById('announcementModal');
  const overlay = document.getElementById('announcementOverlay');
  
  modal.classList.remove('show');
  overlay.classList.remove('show');
  
  setTimeout(() => {
    modal.style.display = 'none';
    overlay.style.display = 'none';
  }, 300);
}

function renderLatestAnnouncement() {
  const container = document.getElementById('announcementBody');
  
  if (announcementsData.length === 0) {
    container.innerHTML = '<p style="text-align:center;color:var(--text-secondary);padding:40px 0;">æš‚æ— å…¬å‘Š</p>';
    return;
  }
  
  const latest = announcementsData[0];
  container.innerHTML = formatAnnouncementContent(latest.content);
}

function formatAnnouncementContent(content) {
  let html = content
    .replace(/^# (.*$)/gim, '<h1>$1</h1>')
    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
    .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
    .replace(/\*(.*)\*/gim, '<em>$1</em>')
    .replace(/!\[(.*?)\]\((.*?)\)/gim, '<img src="$2" alt="$1" style="max-width:100%;border-radius:12px;margin:12px 0;">')
    .replace(/\[(.*?)\]\((.*?)\)/gim, '<a href="$2" target="_blank" style="color:var(--peach);text-decoration:none;">$1</a>')
    .replace(/^- (.*$)/gim, '<li>$1</li>')
    .replace(/^\d+\. (.*$)/gim, '<li>$1</li>');
  
  if (html.includes('<li>')) {
    html = html.replace(/(<li>.*<\/li>)/s, '<ul style="margin:12px 0;padding-left:20px;">$1</ul>');
  }
  
  html = html.split('\n\n').map(p => {
    if (!p.startsWith('<')) return `<p>${p}</p>`;
    return p;
  }).join('');
  
  return html;
}

function renderHistoryAnnouncements() {
  const container = document.getElementById('historyListContainer');
  
  if (announcementsData.length <= 1) {
    container.innerHTML = '<p style="text-align:center;color:var(--text-secondary);padding:20px 0;">æš‚æ— å¾€æœŸå…¬å‘Š</p>';
    return;
  }
  
  const history = announcementsData.slice(1);
  container.innerHTML = history.map((ann, idx) => `
    <div class="announcement-item" onclick="viewHistoryAnnouncement(${idx + 1})">
      <div class="announcement-item-info">
        <div class="announcement-item-title">${ann.title || 'æ— æ ‡é¢˜'}</div>
        <div class="announcement-item-date">${ann.date}</div>
      </div>
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color:var(--text-secondary);opacity:0.5;">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    </div>
  `).join('');
}

// æ›¿æ¢åŽŸæœ‰çš„ viewHistoryAnnouncement å‡½æ•°
function viewHistoryAnnouncement(index) {
  const ann = announcementsData[index];
  const detailBody = document.getElementById('historyDetailBody');
  const listContainer = document.getElementById('historyListContainer');
  const detailContainer = document.getElementById('historyDetailContainer');

  // æ¸²æŸ“å†…å®¹åˆ°è¯¦æƒ…å®¹å™¨
  detailBody.innerHTML = `
    <h1 style="margin-top:0; border-bottom:none;">${ann.title}</h1>
    <div style="font-size:12px; color:var(--text-secondary); margin-bottom:20px; opacity:0.8;">
      å‘å¸ƒäºŽ ${ann.date} Â· ${ann.author || 'ç®¡ç†å‘˜'}
    </div>
    ${formatAnnouncementContent(ann.content)}
  `;

  // åˆ‡æ¢è§†å›¾ï¼šéšè—åˆ—è¡¨ï¼Œæ˜¾ç¤ºè¯¦æƒ…
  listContainer.style.display = 'none';
  detailContainer.style.display = 'block';
  
  // æ»šåŠ¨åˆ°é¡¶éƒ¨
  document.querySelector('.announcement-content-wrapper').scrollTop = 0;
}
// æ–°å¢žæ­¤å‡½æ•°
function backToHistoryList() {
  document.getElementById('historyListContainer').style.display = 'block';
  document.getElementById('historyDetailContainer').style.display = 'none';
}
// æ›¿æ¢åŽŸæœ‰çš„ switchAnnouncementTab å‡½æ•°
function switchAnnouncementTab(tab) {
  const tabs = document.querySelectorAll('.announcement-nav-btn');
  tabs.forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  
  const latestSection = document.getElementById('latestAnnouncement');
  const historySection = document.getElementById('historyAnnouncements');
  
  latestSection.classList.remove('active');
  historySection.classList.remove('active');
  
  if (tab === 'latest') {
    latestSection.classList.add('active');
    // å¦‚æžœå›žåˆ°æœ€æ–°å…¬å‘Šï¼Œé‡æ–°æ¸²æŸ“ä¸€ä¸‹ç¡®ä¿æ˜¯æœ€æ–°çš„ï¼ˆä¿®å¤ä¹‹å‰çš„è¦†ç›–bugï¼‰
    renderLatestAnnouncement(); 
  } else {
    historySection.classList.add('active');
    // åˆ‡æ¢åˆ°å¾€æœŸå…¬å‘Šæ—¶ï¼Œå¼ºåˆ¶æ˜¾ç¤ºåˆ—è¡¨ï¼Œéšè—è¯¦æƒ…
    backToHistoryList();
  }
}

function toggleDontShowAgain() {
  const checkbox = document.getElementById('dontShowCheckbox');
  checkbox.classList.toggle('checked');
}

function markAnnouncementAsRead() {
  const checkbox = document.getElementById('dontShowCheckbox');
  const dontShow = checkbox.classList.contains('checked');
  
  localStorage.setItem('MOGU_ANNOUNCEMENT_READ', JSON.stringify({
    version: currentAnnouncementVersion,
    dontShowAgain: dontShow,
    readAt: new Date().toISOString()
  }));
  
  document.getElementById('announcementBtn').classList.remove('has-new');
}

function openAdminPanel(type) {
  currentAdminPanel = type;
  const modal = document.getElementById('adminPanelModal');
  const overlay = document.getElementById('adminPanelOverlay');
  const title = document.getElementById('adminPanelTitle');
  const content = document.getElementById('adminPanelContent');
  
  const titles = {
    announcement: 'ðŸ“¢ å…¬å‘Šç®¡ç†',
  };
  title.textContent = titles[type] || 'ç®¡ç†é¢æ¿';
  
  if (type === 'announcement') {
    renderAnnouncementEditor(content);
  }
  
  modal.style.display = 'flex';
  overlay.style.display = 'block';
  
  setTimeout(() => {
    modal.classList.add('show');
    overlay.classList.add('show');
  }, 10);
}

function closeAdminPanel() {
  const modal = document.getElementById('adminPanelModal');
  const overlay = document.getElementById('adminPanelOverlay');
  
  modal.classList.remove('show');
  overlay.classList.remove('show');
  
  setTimeout(() => {
    modal.style.display = 'none';
    overlay.style.display = 'none';
  }, 300);
}
// æ›¿æ¢åŽŸæœ‰çš„ renderAnnouncementEditor å‡½æ•°
function renderAnnouncementEditor(container) {
  container.innerHTML = `
    <div class="announcement-editor">
      <div style="display:flex;gap:12px;margin-bottom:16px;">
        <button class="editor-btn secondary" onclick="switchEditorTab('new')" id="tab-new">å‘å¸ƒæ–°å…¬å‘Š</button>
        <button class="editor-btn secondary" onclick="switchEditorTab('manage')" id="tab-manage">ç®¡ç†å¾€æœŸ</button>
      </div>
      
      <div id="editor-new" class="editor-section">
        <input type="hidden" id="editIndex" value="-1"> <div class="editor-field">
          <input type="text" class="editor-input" id="annTitle" placeholder="è¯·è¾“å…¥å…¬å‘Šæ ‡é¢˜..." style="font-size:16px; font-weight:bold;">
        </div>
        
        <div class="editor-wrapper">
          <div class="editor-toolbar">
            <button class="toolbar-btn" onclick="insertMarkdown('**', '**')" title="åŠ ç²—">B</button>
            <button class="toolbar-btn" onclick="insertMarkdown('*', '*')" title="æ–œä½“">I</button>
            <button class="toolbar-btn" onclick="insertMarkdown('# ', '')" title="ä¸€çº§æ ‡é¢˜">H1</button>
            <button class="toolbar-btn" onclick="insertMarkdown('## ', '')" title="äºŒçº§æ ‡é¢˜">H2</button>
            <div style="width:1px; height:20px; background:rgba(0,0,0,0.1); margin:0 4px;"></div>
            <button class="toolbar-btn" onclick="insertMarkdown('[', '](url)')" title="é“¾æŽ¥">ðŸ”—</button>
            <button class="toolbar-btn" onclick="insertMarkdown('![å›¾ç‰‡æè¿°](', ')')" title="å›¾ç‰‡">ðŸ–¼ï¸</button>
            <button class="toolbar-btn" onclick="insertMarkdown('- ', '')" title="åˆ—è¡¨">ðŸ“</button>
            <button class="toolbar-btn editor-mode-switch" onclick="toggleEditorPreview()" id="previewBtn">é¢„è§ˆ</button>
          </div>
          
          <textarea class="editor-textarea" id="annContent" placeholder="åœ¨è¿™é‡Œè¾“å…¥å†…å®¹..."></textarea>
          <div class="editor-preview-area announcement-body" id="annPreview"></div>
        </div>
        
        <div class="editor-actions" style="margin-top:16px;">
          <button class="editor-btn secondary" onclick="closeAdminPanel()">å–æ¶ˆ</button>
          <button class="editor-btn primary" onclick="publishAnnouncement()" id="publishBtn">ç«‹å³å‘å¸ƒ</button>
        </div>
      </div>
      
      <div id="editor-manage" class="editor-section" style="display:none;">
        <div class="history-announcements-list" id="manageHistoryList"></div>
      </div>
    </div>
  `;
  
  renderManageHistoryList();
}
// [æ–°å¢ž] æ’å…¥ Markdown è¯­æ³•çš„å‡½æ•°
function insertMarkdown(prefix, suffix) {
  const textarea = document.getElementById('annContent');
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  const text = textarea.value;
  const before = text.substring(0, start);
  const selected = text.substring(start, end);
  const after = text.substring(end);

  textarea.value = before + prefix + selected + suffix + after;
  textarea.selectionStart = start + prefix.length;
  textarea.selectionEnd = end + prefix.length + selected.length;
  textarea.focus();
}

// [æ–°å¢ž] åˆ‡æ¢é¢„è§ˆæ¨¡å¼
function toggleEditorPreview() {
  const textarea = document.getElementById('annContent');
  const preview = document.getElementById('annPreview');
  const btn = document.getElementById('previewBtn');
  
  if (preview.classList.contains('show')) {
    preview.classList.remove('show');
    textarea.style.display = 'block';
    btn.textContent = 'é¢„è§ˆ';
    btn.style.background = 'var(--peach)';
  } else {
    preview.innerHTML = formatAnnouncementContent(textarea.value || 'æ— å†…å®¹');
    preview.classList.add('show');
    textarea.style.display = 'none';
    btn.textContent = 'ç¼–è¾‘';
    btn.style.background = 'var(--forest)';
  }
}
function switchEditorTab(tab) {
  document.getElementById('editor-new').style.display = tab === 'new' ? 'block' : 'none';
  document.getElementById('editor-manage').style.display = tab === 'manage' ? 'block' : 'none';
  
  document.getElementById('tab-new').classList.toggle('primary', tab === 'new');
  document.getElementById('tab-manage').classList.toggle('primary', tab === 'manage');
}

// æ›¿æ¢åŽŸæœ‰çš„ publishAnnouncement å‡½æ•°
async function publishAnnouncement() {
  const title = document.getElementById('annTitle').value.trim();
  const content = document.getElementById('annContent').value.trim();
  const editIndexStr = document.getElementById('editIndex').value;
  const editIndex = parseInt(editIndexStr);

  if (!title || !content) {
    island.warning('ä¿¡æ¯ä¸å®Œæ•´', 'è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹');
    return;
  }

  const loading = island.loading('æ­£åœ¨å¤„ç†', 'ä¿å­˜åˆ° GitHub...');

  try {
    // é‡æ–°èŽ·å–æœ€æ–°æ•°æ®ï¼Œé˜²æ­¢å†²çª
    let announcements = await fetchAnnouncements();
    
    if (editIndex > -1 && editIndex < announcements.length) {
      // === ä¿®æ”¹çŽ°æœ‰å…¬å‘Š ===
      announcements[editIndex].title = title;
      announcements[editIndex].content = content;
      // å¯é€‰ï¼šæ›´æ–°ä¿®æ”¹äººä¸ºå½“å‰ç”¨æˆ·
      // announcements[editIndex].author = currentUser.nickname || currentUser.account; 
    } else {
      // === å‘å¸ƒæ–°å…¬å‘Š ===
      const newAnnouncement = {
        id: Date.now().toString(),
        title: title,
        content: content,
        date: new Date().toLocaleDateString('zh-CN'),
        author: currentUser.nickname || currentUser.account
      };
      announcements.unshift(newAnnouncement);
    }

    const success = await saveAnnouncements(announcements);

    if (success) {
      loading.hide();
      island.success(editIndex > -1 ? 'ä¿®æ”¹æˆåŠŸ' : 'å‘å¸ƒæˆåŠŸ', 'å…¬å‘Šå·²æ›´æ–°');
      announcementsData = announcements; // æ›´æ–°æœ¬åœ°ç¼“å­˜
      closeAdminPanel();
      checkAnnouncement(); // åˆ·æ–°é¡µé¢ä¸Šçš„å…¬å‘Šæ˜¾ç¤º
    } else {
      throw new Error('ä¿å­˜å¤±è´¥');
    }
  } catch (e) {
    console.error(e);
    loading.hide();
    island.error('æ“ä½œå¤±è´¥', 'è¯·æ£€æŸ¥ç½‘ç»œè¿žæŽ¥åŽé‡è¯•');
  }
}

async function renderManageHistoryList() {
  const container = document.getElementById('manageHistoryList');
  if (!container) return;
  
  if (announcementsData.length === 0) {
    container.innerHTML = '<p style="text-align:center;color:var(--text-secondary);padding:20px;">æš‚æ— å…¬å‘Š</p>';
    return;
  }
  
  container.innerHTML = announcementsData.map((ann, idx) => `
    <div class="history-announcement-item">
      <div class="history-ann-info">
        <div class="history-ann-title">${ann.title || 'æ— æ ‡é¢˜'}</div>
        <div class="history-ann-date">${ann.date} Â· ${ann.author || 'ç®¡ç†å‘˜'}</div>
      </div>
      <div class="history-ann-actions">
        <button class="history-ann-btn edit" onclick="editAnnouncement(${idx})">ç¼–è¾‘</button>
        <button class="history-ann-btn delete" onclick="deleteAnnouncement(${idx})">åˆ é™¤</button>
      </div>
    </div>
  `).join('');
}
// æ›¿æ¢åŽŸæœ‰çš„ editAnnouncement å‡½æ•°
function editAnnouncement(index) {
  const ann = announcementsData[index];
  
  // 1. åˆ‡æ¢åˆ°â€œå‘å¸ƒæ–°å…¬å‘Šâ€æ ‡ç­¾é¡µï¼ˆè¿™é‡Œå…¶å®žæ˜¯ç”¨ä½œç¼–è¾‘ï¼‰
  switchEditorTab('new');
  
  // 2. å›žå¡«æ•°æ®
  document.getElementById('annTitle').value = ann.title;
  document.getElementById('annContent').value = ann.content;
  
  // 3. è®°å½•æ­£åœ¨ç¼–è¾‘çš„ç´¢å¼•ï¼ˆåˆ©ç”¨æˆ‘ä»¬åœ¨HTMLé‡ŒåŠ çš„ hidden inputï¼‰
  document.getElementById('editIndex').value = index;
  
  // 4. ä¿®æ”¹æŒ‰é’®æ–‡å­—ï¼Œæç¤ºç”¨æˆ·è¿™æ˜¯åœ¨æ›´æ–°
  const pubBtn = document.getElementById('publishBtn');
  pubBtn.textContent = 'ä¿å­˜ä¿®æ”¹';
  pubBtn.style.background = 'var(--peach)';
  
  // 5. æç¤º
  island.info('è¿›å…¥ç¼–è¾‘æ¨¡å¼', 'ä¿®æ”¹å®ŒæˆåŽç‚¹å‡»ä¿å­˜');
}

async function deleteAnnouncement(index) {
  if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å…¬å‘Šå—ï¼Ÿ')) return;
  
  const loading = island.loading('æ­£åœ¨åˆ é™¤', 'å¤„ç†ä¸­...');
  
  try {
    announcementsData.splice(index, 1);
    const success = await saveAnnouncements(announcementsData);
    
    if (success) {
      loading.hide();
      island.success('åˆ é™¤æˆåŠŸ', 'å…¬å‘Šå·²åˆ é™¤');
      renderManageHistoryList();
      await checkAnnouncement();
    } else {
      throw new Error('åˆ é™¤å¤±è´¥');
    }
  } catch (e) {
    loading.hide();
    island.error('åˆ é™¤å¤±è´¥', 'è¯·é‡è¯•');
  }
}

function incrementVisitCount() {
  const count = parseInt(localStorage.getItem('MOGU_VISIT_COUNT') || '0');
  localStorage.setItem('MOGU_VISIT_COUNT', (count + 1).toString());
}

document.getElementById('logoutCancel').addEventListener('click', () => toggleModal('logout', false));
document.getElementById('logoutConfirm').addEventListener('click', () => {
  toggleModal('logout', false);
  localStorage.removeItem(USER_LOCAL_KEY);
  currentUser = null;
  isUserValid = false;
  updateUIForGuest();
  island.success('å·²é€€å‡ºç™»å½•', 'æœŸå¾…æ‚¨çš„å†æ¬¡è®¿é—®');
  showLoginNotice();
});

document.getElementById('clearMsgCancel').addEventListener('click', () => toggleModal('clearMsg', false));

document.getElementById('clearMsgConfirm').addEventListener('click', async () => {
  toggleModal('clearMsg', false);
  if (!currentUser?.isAdmin || isLoading) return;
  
  isLoading = true;
  const items = document.querySelectorAll('.message-item');
  const totalItems = items.length;
  
  const progressIsland = island.progress('æ­£åœ¨æ¸…ç©ºèŠå¤©è®°å½•', `å‡†å¤‡åˆ é™¤ ${totalItems} æ¡æ¶ˆæ¯...`, 0);
  
  try {
    let processed = 0;
    let successCount = 0;
    
    for (const el of items) {
      processed++;
      const progress = Math.round((processed / totalItems) * 100);
      
      progressIsland.setProgress(progress);
      progressIsland.update({
        subtitle: `æ­£åœ¨åˆ é™¤ç¬¬ ${processed}/${totalItems} æ¡æ¶ˆæ¯...`
      });
      
      await new Promise(resolve => setTimeout(resolve, 100));
      
      if (el.dataset.commentId && !el.dataset.commentId.startsWith('temp_')) {
        try {
          const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/issues/comments/${el.dataset.commentId}`, {
            method: 'DELETE', 
            headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
          });
          if (res.ok) successCount++;
        } catch (err) {
          console.error('åˆ é™¤æ¶ˆæ¯å¤±è´¥:', err);
        }
      }
      el.remove();
    }
    
    progressIsland.setProgress(100);
    progressIsland.update({
      subtitle: 'æ¸…ç†å®Œæˆ'
    });
    
    setTimeout(() => {
      progressIsland.hide();
      island.success('æ¸…ç©ºå®Œæˆ', `æˆåŠŸåˆ é™¤ ${successCount} æ¡èŠå¤©è®°å½•`);
    }, 500);
    
    isHistoryFetched = false;
    lastMessageId = 0;
  } catch { 
    progressIsland.hide();
    island.error('æ¸…ç©ºå¤±è´¥', 'åˆ é™¤è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯');
  } finally { 
    isLoading = false;
  }
});

document.getElementById('clearAllMessages').addEventListener('click', () => {
    if(!currentUser?.isAdmin) return;
    toggleModal('clearMsg', true);
});

searchBtn.addEventListener('click', handleSearch);
searchInput.addEventListener('keydown', e => e.key === 'Enter' && handleSearch());
moguChatBtn.addEventListener('click', toggleChatWindow);
moguChatSend.addEventListener('click', sendChatMessage);
moguChatInput.addEventListener('keydown', e => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), sendChatMessage()));

// ä¿®æ”¹ Toggle Button äº‹ä»¶ç›‘å¬å™¨
toggleBtn.addEventListener('click', () => {
    document.body.classList.toggle('clean-mode');
});

if (!isMobile()) {
  historySwitch.addEventListener('change', e => saveHistorySwitchState(e.target.checked));
}

document.addEventListener('click', e => {
  if (chatOpen && !moguChatWindow.contains(e.target) && !moguChatBtn.contains(e.target)) toggleChatWindow();
  
  if (quickLinksOpen && !e.target.closest('#quickLinksSidebar') && !e.target.closest('#quickLinksBtn')) {
    toggleQuickLinks();
  }
});

window.addEventListener('DOMContentLoaded', async () => {
  incrementVisitCount();
  
  // ç¡®ä¿æ— è®ºæ˜¯å¦ç™»å½•ï¼Œéƒ½æ£€æŸ¥å¹¶å°è¯•å¼¹å‡ºå…¬å‘Š
  checkAnnouncement();
  
  const isLoggedIn = await checkLoginStatus();
  
  if (isLoggedIn && currentUser) {
    chatUpdateInterval = setInterval(fetchChatMessages, 15000);
    fetchChatMessages();
  }
  
  if (isMobile()) {
    searchInput.focus();
  } else {
    // ç§»é™¤ saveShowState è°ƒç”¨ï¼Œå› ä¸ºä¸å†éœ€è¦åˆå§‹åŒ–åŽ†å²æ˜¾ç¤ºçŠ¶æ€çš„æ˜¾ç¤ºéšè—ï¼Œè€Œæ˜¯é€šè¿‡clean-modeæŽ§åˆ¶
    saveHistorySwitchState(getHistorySwitchState());
    renderHistory();
    searchInput.focus();
  }
  updateAdminUI();
});
</script>
</body>
</html>
