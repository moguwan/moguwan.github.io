<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="description" content="MY HOME ‰∏™‰∫∫‰∏ªÈ°µ">
<title>MoGuOne | ËÆ∞ÂΩïÁîüÊ¥ª</title>
<link rel="stylesheet" type="text/css" href="https://unpkg.com/dmego-home-page@latest/assets/css/iconfont.css">
<style>
/* --- Ê†∏ÂøÉÂèòÈáèÂÆö‰πâ --- */
:root {
  --bg-body: #f3f4f6;
  --bg-card: #ffffff;
  --text-main: #2c3e50;
  --text-sub: #7f8c8d;
  --accent: #607d8b;
  --accent-hover: #455a64;
  --highlight: #e74c3c;
  --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
  --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02);
  --radius-lg: 24px;
  --radius-pill: 50px;
  --font-serif: "Merriweather", "Georgia", serif;
  --ease-out-back: cubic-bezier(0.34, 1.56, 0.64, 1);
}

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  background-color: var(--bg-body);
  color: var(--text-main);
  line-height: 1.6;
  min-height: 100vh;
  overflow-x: hidden;
}

/* --- Loader --- */
#loader {
  position: fixed; inset: 0; background: #fff; z-index: 99999;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  transition: opacity 0.6s ease, visibility 0.6s ease;
}
#loader.loaded { opacity: 0; visibility: hidden; }
.loader-circle {
  width: 50px; height: 50px; border: 3px solid rgba(0,0,0,0.1);
  border-top-color: var(--accent); border-radius: 50%;
  animation: spin 1s infinite linear;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* --- È°∂ÈÉ®ÂØºËà™ --- */
.nav-container {
  position: fixed; top: 0; left: 0; right: 0; z-index: 100;
  padding: 20px; display: flex; justify-content: space-between; align-items: center;
  pointer-events: none;
}
.nav-logo {
  font-family: var(--font-serif); font-weight: 900; font-size: 20px;
  color: var(--text-main); pointer-events: auto; opacity: 0.8;
  background: rgba(255,255,255,0.8); backdrop-filter: blur(10px);
  padding: 8px 20px; border-radius: var(--radius-pill);
  box-shadow: var(--shadow-sm);
}

.user-area { pointer-events: auto; position: relative; }
.login-btn, .user-btn {
  background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
  border: 1px solid rgba(0,0,0,0.05); padding: 8px 20px;
  border-radius: var(--radius-pill); cursor: pointer;
  font-size: 14px; font-weight: 600; color: var(--text-main);
  box-shadow: var(--shadow-sm); transition: transform 0.2s var(--ease-out-back);
  display: flex; align-items: center; gap: 8px;
}
.login-btn:hover, .user-btn:hover { transform: scale(1.05); background: #fff; }
.user-dropdown {
  position: absolute; top: 120%; right: 0; width: 140px; background: #fff;
  border-radius: 16px; padding: 6px; box-shadow: var(--shadow-lg);
  opacity: 0; visibility: hidden; transform: translateY(10px);
  transition: all 0.2s ease;
}
.user-dropdown.show { opacity: 1; visibility: visible; transform: translateY(0); }
.dropdown-item {
  padding: 10px 16px; font-size: 13px; color: var(--text-main);
  border-radius: 10px; cursor: pointer; transition: background 0.2s;
}
.dropdown-item:hover { background: #f8fafc; color: var(--accent); }

/* --- Ê†∏ÂøÉÂå∫Âüü --- */
.main-container {
  max-width: 800px; margin: 0 auto; padding: 120px 20px 60px;
  position: relative;
}

/* --- Hero Section --- */
.hero-section {
  text-align: center; margin-bottom: 80px;
  display: flex; flex-direction: column; align-items: center;
}
.avatar-wrapper {
  position: relative; width: 120px; height: 120px; margin-bottom: 25px;
}
.profile-avatar {
  width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
  border: 4px solid #fff; box-shadow: var(--shadow-lg);
  transition: transform 0.5s var(--ease-out-back);
}
.profile-avatar:hover { transform: rotate(10deg) scale(1.05); }

.status-badge {
  position: absolute; bottom: 5px; right: 5px; width: 24px; height: 24px;
  background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.status-dot { width: 12px; height: 12px; background: #10b981; border-radius: 50%; animation: pulse 2s infinite; }
@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }

.hero-title {
  font-family: var(--font-serif); font-size: 32px; font-weight: 700;
  color: var(--text-main); margin-bottom: 10px; letter-spacing: -0.5px;
}
.hero-bio { font-size: 15px; color: var(--text-sub); margin-bottom: 30px; max-width: 500px; }

.search-wrapper {
  position: relative; width: 100%; max-width: 400px; margin-bottom: 30px;
}
.search-input {
  width: 100%; padding: 16px 50px 16px 24px; border: none;
  background: #fff; border-radius: var(--radius-pill);
  box-shadow: var(--shadow-sm); font-size: 15px;
  transition: all 0.3s ease;
}
.search-input:focus {
  box-shadow: 0 8px 30px rgba(0,0,0,0.08); transform: translateY(-2px);
}
.search-btn {
  position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
  width: 36px; height: 36px; background: var(--accent); border: none;
  border-radius: 50%; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: all 0.3s var(--ease-out-back);
}
.search-btn:hover { background: var(--accent-hover); transform: translateY(-50%) scale(1.1); }

.mini-stats {
  display: flex; gap: 20px; font-size: 12px; color: #aab7b8;
  background: rgba(255,255,255,0.5); padding: 8px 20px; border-radius: 20px;
}
.stat-item b { color: var(--text-main); font-weight: 600; margin-left: 4px; }
.update-log { display: none; } 

/* --- Êó•ËÆ∞ÂàóË°® --- */
.news-grid { display: flex; flex-direction: column; gap: 40px; }
.news-card {
  background: var(--bg-card); border-radius: var(--radius-lg);
  overflow: hidden; box-shadow: var(--shadow-sm);
  transition: all 0.4s var(--ease-out-back);
  opacity: 0; transform: translateY(40px);
  cursor: pointer; position: relative; border: 1px solid rgba(0,0,0,0.02);
}
.news-card.visible { opacity: 1; transform: translateY(0); }
.news-card:hover { transform: translateY(-8px) scale(1.01); box-shadow: 0 20px 40px rgba(0,0,0,0.08); }

.news-cover-box {
  position: relative; width: 100%; height: 0; padding-bottom: 50%;
  background: #f1f5f9; overflow: hidden;
}
.news-cover-box img, .news-cover-box video {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  object-fit: cover; transition: transform 0.8s ease;
}
.news-card:hover .news-cover-box img { transform: scale(1.08); }

.news-content { padding: 30px; position: relative; }
.news-date {
  font-family: monospace; font-size: 12px; color: var(--accent);
  background: rgba(96, 125, 139, 0.1); padding: 4px 10px; border-radius: 4px;
  display: inline-block; margin-bottom: 12px; font-weight: 600;
}
.news-title {
  font-size: 22px; font-weight: 700; color: var(--text-main);
  margin-bottom: 12px; line-height: 1.4;
}
.news-desc {
  font-size: 15px; color: var(--text-sub); line-height: 1.8;
  display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;
  overflow: hidden; margin-bottom: 20px;
}
.news-footer {
  display: flex; justify-content: space-between; align-items: center;
  border-top: 1px solid #f0f0f0; padding-top: 20px;
}
.read-more { font-size: 13px; font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }

/* --- Èü≥‰πêÊí≠ÊîæÂô® --- */
#footer {
  position: fixed; bottom: 30px; left: 30px; z-index: 900;
  background: #fff; padding: 6px; border-radius: 50px;
  box-shadow: var(--shadow-lg); display: flex; align-items: center;
  transition: width 0.4s var(--ease-out-back); width: 44px; overflow: hidden; cursor: pointer;
}
#footer.playing { width: 220px; padding-right: 20px; }
.music-cover {
  width: 32px; height: 32px; background: var(--text-main); border-radius: 50%;
  flex-shrink: 0; display: flex; align-items: center; justify-content: center; color: #fff;
}
.music-info {
  margin-left: 12px; font-size: 12px; white-space: nowrap; font-weight: 600;
  opacity: 0; transition: opacity 0.3s;
}
#footer.playing .music-info { opacity: 1; }
.play-icon { width: 0; height: 0; border-style: solid; border-width: 5px 0 5px 8px; border-color: transparent transparent transparent #fff; margin-left: 2px; }
.pause-icon { width: 8px; height: 10px; border-left: 3px solid #fff; border-right: 3px solid #fff; }

/* --- ÂõûÂà∞È°∂ÈÉ®ÊåâÈíÆ --- */
.scroll-top-btn {
  position: fixed; bottom: 30px; right: 30px; width: 44px; height: 44px;
  background: #fff; border-radius: 50%; box-shadow: var(--shadow-lg);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; opacity: 0; visibility: hidden;
  transition: all 0.3s var(--ease-out-back); z-index: 800;
  color: var(--text-main);
  transform: translateY(20px);
}
.scroll-top-btn.show { opacity: 1; visibility: visible; transform: translateY(0); }
.scroll-top-btn:hover { background: var(--text-main); color: #fff; transform: translateY(-5px); }
.scroll-top-btn svg { width: 20px; height: 20px; fill: currentColor; }

/* --- Ê®°ÊÄÅÊ°Ü --- */
.modal-mask {
  position: fixed; inset: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
  z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s;
  display: flex; align-items: center; justify-content: center;
}
.modal-mask.show { opacity: 1; pointer-events: auto; }
.modal-box {
  width: 90%; max-width: 900px; height: 80vh; background: #fff;
  border-radius: var(--radius-lg); box-shadow: var(--shadow-lg);
  display: flex; overflow: hidden; transform: scale(0.95); transition: transform 0.4s var(--ease-out-back);
  border: 1px solid #eee;
}
.modal-mask.show .modal-box { transform: scale(1); }
.modal-close {
  position: absolute; top: 20px; right: 20px; width: 36px; height: 36px;
  background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center;
  cursor: pointer; border: none; font-size: 18px; transition: all 0.2s; z-index: 10;
}
.modal-close:hover { background: var(--highlight); color: #fff; transform: rotate(90deg); }
.modal-left { flex: 3; padding: 50px; overflow-y: auto; background: #fff; }
.modal-right { flex: 2; background: #fcfcfc; border-left: 1px solid #f0f0f0; padding: 30px; display: flex; flex-direction: column; }

.comment-input {
  background: #fff; border: 1px solid #e2e8f0; padding: 15px; border-radius: 12px;
  width: 100%; min-height: 80px; font-family: inherit; margin-bottom: 10px;
}
.comment-input:focus { border-color: var(--accent); }
.comment-btn {
  background: var(--text-main); color: #fff; border: none; padding: 8px 20px;
  border-radius: 8px; font-weight: 600; cursor: pointer; align-self: flex-end;
}
.comment-item { display: flex; gap: 12px; margin-bottom: 20px; }
.comment-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
.comment-user { font-size: 13px; font-weight: 700; margin-bottom: 4px; }
.comment-text { font-size: 14px; color: #555; }

.access-modal-content {
  background: #fff; padding: 40px; border-radius: 20px; text-align: center;
  box-shadow: 0 20px 60px rgba(0,0,0,0.1); border: 1px solid #eee;
}
.btn-primary-btn { background: var(--text-main); color: #fff; border: none; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; }
.btn-outline { background: transparent; border: 1px solid #ddd; padding: 10px 24px; border-radius: 8px; cursor: pointer; margin-right: 10px; }

/* Toast */
.toast {
  position: fixed; top: 30px; left: 50%; transform: translateX(-50%) translateY(-100%);
  background: #333; color: #fff; padding: 10px 24px; border-radius: 30px;
  font-size: 14px; font-weight: 600; box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  transition: all 0.4s var(--ease-out-back); z-index: 9999;
  opacity: 0; visibility: hidden; pointer-events: none;
}
.toast.show { 
  transform: translateX(-50%) translateY(0); 
  opacity: 1; visibility: visible; pointer-events: auto; 
}

.lightbox {
  position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 10000;
  display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s;
}
.lightbox.active { opacity: 1; pointer-events: auto; }
.lightbox img { max-width: 90%; max-height: 90%; box-shadow: var(--shadow-lg); border-radius: 8px; }

@media (max-width: 768px) {
  .modal-box { flex-direction: column; height: 100%; border-radius: 0; }
  .modal-left { padding: 20px; flex: 1; }
  .modal-right { flex: 1; border-left: none; border-top: 1px solid #eee; }
  .hero-title { font-size: 26px; }
  .nav-logo { display: none; }
  .search-wrapper { max-width: 90%; }
}
</style>
</head>
<body>

<div id="loader">
  <div class="loader-circle"></div>
</div>

<div class="nav-container">
  <div class="nav-logo">MoGuOne</div>
  <div class="user-area" id="userArea">
    <button class="login-btn" id="loginBtn">ÁôªÂΩï</button>
    <div class="user-btn" id="userBtn" style="display: none;">
      <span id="userName">User</span>
      <div class="user-dropdown">
        <div class="dropdown-item" id="goProfile">Ë¥¶Âè∑ËÆæÁΩÆ</div>
        <div class="dropdown-item" id="goAdmin" style="display:none;">ÂêéÂè∞ÁÆ°ÁêÜ</div>
        <div class="dropdown-item" id="doLogout">ÈÄÄÂá∫ÁôªÂΩï</div>
      </div>
    </div>
  </div>
</div>

<div class="main-container">
  
  <section class="hero-section">
    <div class="avatar-wrapper">
      <img src="https://img.wjwj.top/2026/01/16/a27c17b713d7998cebb06b1dde372d64.jpg" class="profile-avatar" alt="Avatar">
      <div class="status-badge"><div class="status-dot"></div></div>
    </div>
    
    <div class="hero-title">MY HOME</div>
    <div class="hero-bio">ÁÉ≠Áà±ÊòØÊâÄÊúâÁöÑÁêÜÁî±ÂíåÁ≠îÊ°à„ÄÇ</div>
    
    <div class="search-wrapper">
      <input type="text" class="search-input" id="searchInput" placeholder="Search daily notes...">
      <button class="search-btn" id="searchBtn"><i class="iconfont icon-search"></i></button>
    </div>

    <div class="mini-stats">
      <span class="stat-item">Visits <b id="totalCount">0</b></span>
      <span style="opacity:0.3">|</span>
      <span class="stat-item">Status <b style="color:#10b981">Online</b></span>
      <div class="update-log sidebar-update-log"></div>
    </div>
  </section>

  <div class="news-grid" id="newsContainer"></div>

</div>

<div id="footer">
  <div class="music-cover" id="playBtn"><div class="play-icon"></div></div>
  <div class="music-info">Top Barry - ‰∏ÄÂçä‰∏ÄÂçä</div>
  <audio id="music" loop preload="auto" src="moguone/song/‰∏ÄÂçä‰∏ÄÂçä.mp3"></audio>
</div>

<div class="scroll-top-btn" id="scrollTopBtn">
  <svg viewBox="0 0 1024 1024"><path d="M519.85 292.096l314.496 363.648a27.52 27.52 0 0 1-1.344 37.952 27.52 27.52 0 0 1-37.952-1.344l-282.88-327.232-283.456 327.68a27.648 27.648 0 0 1-40.448-1.536 27.648 27.648 0 0 1 1.536-40.448l314.944-364.096a27.584 27.584 0 0 1 15.104-5.568z" /></svg>
</div>

<div class="modal-mask" id="newsModal">
  <div class="modal-box">
    <button class="modal-close" id="modalClose">‚úï</button>
    <div class="modal-left" id="modalContent"></div>
    <div class="modal-right" id="modalComments">
      <div style="flex:1;overflow-y:auto;margin-bottom:15px;" id="commentList"></div>
      <div style="border-top:1px solid #eee;padding-top:15px;">
        <textarea class="comment-input" id="commentInput" placeholder="Write a comment..."></textarea>
        <button class="comment-btn" id="submitComment">ÂèëÈÄÅ</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-mask" id="accessModal" style="z-index: 99999;">
  <div class="access-modal-content">
    <div style="font-size: 40px; margin-bottom: 20px;">üîí</div>
    <h3 style="margin-bottom: 10px;">Private Space</h3>
    <p style="color:#7f8c8d; margin-bottom: 30px; font-size:14px;">Ê≠§È°µÈù¢‰ªÖÈôêÁÆ°ÁêÜÂëòËÆøÈóÆ„ÄÇ<br>This page is private.</p>
    <div>
      <button class="btn-outline" onclick="window.location.href='moguone/search.html'">Leave</button>
      <button class="btn-primary-btn" onclick="window.location.href='moguone/login.html'">Login</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">
  <div class="toast-text">Êìç‰ΩúÊàêÂäü</div>
</div>

<div class="lightbox" id="lightbox" onclick="closeLightbox()">
  <img id="lightboxImg" src="" alt="Full view" onclick="event.stopPropagation()">
</div>

<script>
const CONFIG = {
  token: ["gh","p_p","VX","lo","0HQ","PmMx","Ic","eM","HB","uMzm","EON","LPX","700","10","M","SL"].join(''),
  repo: "moguwan/moguwan.github.io",
  newsIssue: 322,
  countIssue: 7,
  userIssue: 11,
  commentMapIssue: 299
};

const DEFAULT_AVATAR = "https://img.wjwj.top/2026/01/20/d6346e9c8e93165079c5ab74f856358c.png";
const DEFAULT_SIGNATURE = "Êó†";

let state = { user: null, news: [], likes: {}, bgList: [], isPlaying: false };

function init() {
  const loader = document.getElementById('loader');
  setTimeout(() => loader.classList.add('loaded'), 800);
  checkLogin();
  loadNews();
  loadStats();
  initMusic();
  loadLogs();
  initScrollToTop();
  
  document.getElementById('searchBtn').addEventListener('click', doSearch);
  document.getElementById('searchInput').addEventListener('keyup', (e) => { if(e.key === 'Enter') doSearch(); });
}

function initScrollToTop() {
    const btn = document.getElementById('scrollTopBtn');
    window.addEventListener('scroll', () => {
        if (window.scrollY > 300 || document.documentElement.scrollTop > 300) {
            btn.classList.add('show');
        } else {
            btn.classList.remove('show');
        }
    });
    btn.onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });
}

function doSearch() {
  const val = document.getElementById('searchInput').value.trim().toLowerCase();
  const container = document.getElementById('newsContainer');
  const filtered = state.news.filter(item => item.title.toLowerCase().includes(val) || item.content.toLowerCase().includes(val));
  
  container.innerHTML = filtered.map((item, idx) => `
    <div class="news-card" onclick="openModal(${idx})" style="animation-delay:${idx * 0.1}s">
      ${item.imgs.length ? `
        <div class="news-cover-box">
           <img src="${item.imgs[0]}" loading="lazy">
        </div>
      ` : (item.videos.length ? `
        <div class="news-cover-box">
           <video src="${item.videos[0]}#t=1" muted></video>
        </div>
      ` : '')}
      
      <div class="news-content">
        <div class="news-date">${item.date}</div>
        <div class="news-title">${item.title}</div>
        <div class="news-desc">${item.content}</div>
        <div class="news-footer">
           <span class="read-more">Read Journal</span>
        </div>
      </div>
    </div>
  `).join('');
  
  setTimeout(() => { document.querySelectorAll('.news-card').forEach(el => el.classList.add('visible')); }, 50);
  if(filtered.length === 0) container.innerHTML = '<div style="text-align:center;width:100%;color:#999;padding:60px;">Nothing found in the journal.</div>';
}

function checkLogin() {
  const localUser = localStorage.getItem('MY_CUSTOM_USER_INFO');
  if (localUser) {
    state.user = JSON.parse(localUser);
    if (!state.user.isAdmin) {
        showAccessDenied();
        return; 
    }
    document.getElementById('loginBtn').style.display = 'none';
    document.getElementById('userBtn').style.display = 'flex';
    document.getElementById('userName').textContent = state.user.nickname;
    document.getElementById('goAdmin').style.display = 'block';

    // ÈùôÈªòÊõ¥Êñ∞Áî®Êà∑‰ø°ÊÅØ (Avatar, Signature etc.)
    updateUserInfoFromRemote();
  } else {
    showAccessDenied();
    return;
  }
  document.getElementById('loginBtn').onclick = () => window.location.href = 'moguone/login.html';
  document.getElementById('userBtn').onclick = (e) => { e.stopPropagation(); document.querySelector('.user-dropdown').classList.toggle('show'); };
  document.addEventListener('click', () => document.querySelector('.user-dropdown').classList.remove('show'));
  document.getElementById('doLogout').onclick = logout;
  document.getElementById('goProfile').onclick = () => window.location.href = 'moguone/setting.html';
  document.getElementById('goAdmin').onclick = () => window.location.href = 'moguone/admin.html';
}

async function updateUserInfoFromRemote() {
    try {
        const res = await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${CONFIG.userIssue}`, { headers: { Authorization: `token ${CONFIG.token}` } });
        const data = await res.json();
        const lines = data.body.split('\n');
        const userLine = lines.find(l => l.startsWith(state.user.account + '|'));
        
        if(userLine) {
            const parts = userLine.split('|').map(s => s.trim());
            // Account|Password|Email|Nickname|IsAdmin|Avatar|Signature
            // We only update non-critical display info here to avoid overwriting auth token logic if any
            state.user.nickname = parts[3] || state.user.nickname;
            state.user.email = parts[2] || state.user.email;
            state.user.avatar = parts[5] || DEFAULT_AVATAR;
            state.user.signature = parts[6] || DEFAULT_SIGNATURE;
            
            localStorage.setItem('MY_CUSTOM_USER_INFO', JSON.stringify(state.user));
            document.getElementById('userName').textContent = state.user.nickname;
        }
    } catch(e) { console.error('Silent update failed', e); }
}

function showAccessDenied() {
    document.getElementById('accessModal').classList.add('show');
    document.body.style.overflow = 'hidden';
}

function logout() {
    localStorage.removeItem('MY_CUSTOM_USER_INFO');
    location.reload();
}

async function loadNews() {
  try {
    const res = await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${CONFIG.newsIssue}`, { headers: { Authorization: `token ${CONFIG.token}` } });
    const data = await res.json();
    const rawList = data.body.split('---').map(s => s.trim()).filter(s => s);
    state.news = rawList.map((str, i) => {
      const lines = str.split('\n');
      let item = { id: i, title: '', content: '', date: '', imgs: [], videos: [] };
      lines.forEach(l => {
        l = l.trim();
        if(l.startsWith('„Äê')) item.title = l.slice(1,-1);
        else if(l.startsWith('id::')) item.id = parseInt(l.slice(4)); 
        else if(l.startsWith('date::')) item.date = l.slice(6);
        else if(l.startsWith('img::')) item.imgs.push(l.slice(5));
        else if(l.startsWith('video::')) item.videos.push(l.slice(7));
        else if(l !== '') item.content += l + '\n';
      });
      return item;
    }).sort((a, b) => b.id - a.id);
    doSearch(); 
  } catch(e) { console.error(e); }
}

async function loadStats() {
  try {
    const res = await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${CONFIG.countIssue}`, { headers: { Authorization: `token ${CONFIG.token}` } });
    const data = await res.json();
    const countMatch = data.body.match(/ÊÄªËÆøÈóÆÈáèÔºö(\d+)/);
    const count = countMatch ? parseInt(countMatch[1]) + 1 : 1;
    document.getElementById('totalCount').textContent = count;
    const newBody = data.body.replace(/ÊÄªËÆøÈóÆÈáèÔºö\d+/, `ÊÄªËÆøÈóÆÈáèÔºö${count}`);
    fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${CONFIG.countIssue}`, { method: 'PATCH', headers: { Authorization: `token ${CONFIG.token}` }, body: JSON.stringify({ body: newBody }) });
  } catch(e) { console.error(e); }
}

function initMusic() {
  const audio = document.getElementById('music');
  const btn = document.getElementById('playBtn');
  const footer = document.getElementById('footer');
  const icon = btn.querySelector('div');
  btn.onclick = () => {
    if(state.isPlaying) { audio.pause(); footer.classList.remove('playing'); icon.className = 'play-icon'; } 
    else { audio.play(); footer.classList.add('playing'); icon.className = 'pause-icon'; }
    state.isPlaying = !state.isPlaying;
  };
}

function openModal(idx) {
  const item = state.news[idx]; 
  const modal = document.getElementById('newsModal');
  const content = document.getElementById('modalContent');
  let mediaHtml = item.imgs.map(src => `<img src="${src}" onclick="viewImg('${src}')" style="width:100%;border-radius:12px;margin-bottom:15px;cursor:zoom-in;box-shadow:0 4px 12px rgba(0,0,0,0.1);">`).join('');
  mediaHtml += item.videos.map(src => `<video src="${src}" controls style="width:100%;border-radius:12px;margin-bottom:15px;box-shadow:0 4px 12px rgba(0,0,0,0.1);"></video>`).join('');
  
  content.innerHTML = `
    <div style="font-size:13px;color:#999;margin-bottom:10px;">${item.date}</div>
    <h2 style="font-size:28px;margin-bottom:25px;color:#2c3e50;font-family:serif;">${item.title}</h2>
    <div style="font-size:16px;line-height:1.8;color:#4a5568;margin-bottom:30px;white-space:pre-wrap;">${item.content}</div>
    ${mediaHtml}
  `;
  modal.classList.add('show');
  document.body.style.overflow = 'hidden';
  loadComments(item.id);
  document.getElementById('modalClose').onclick = () => { modal.classList.remove('show'); document.body.style.overflow = ''; };
}

function viewImg(src) {
  const box = document.getElementById('lightbox');
  const img = document.getElementById('lightboxImg');
  img.src = src;
  box.classList.add('active');
}
function closeLightbox() { document.getElementById('lightbox').classList.remove('active'); }

async function loadComments(newsId) {
  const list = document.getElementById('commentList');
  list.innerHTML = '<div style="text-align:center;padding:20px;color:#94a3b8;">Âä†ËΩΩ‰∏≠...</div>';
  const issueMap = await getCommentMap();
  const issueId = issueMap[newsId];
  if(!issueId) {
    list.innerHTML = '<div style="text-align:center;padding:20px;color:#94a3b8;">ÊöÇÊó†ËØÑËÆ∫ÔºåÊù•ÂùêÊ≤ôÂèë</div>';
    document.getElementById('submitComment').onclick = () => createCommentIssue(newsId);
    return;
  }
  const res = await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${issueId}/comments`, { headers: { Authorization: `token ${CONFIG.token}` } });
  const comments = await res.json();
  
  list.innerHTML = comments.map(c => {
    let parts = c.body.split('|');
    let uid, name, avatar, text;
    // Handle standard User struct or Legacy comment struct
    // We assume comment body stored as: Account|Nickname|Avatar|Content
    if (parts.length >= 4) { [uid, name, avatar, text] = parts; } 
    else { [uid, name, text] = parts; avatar = DEFAULT_AVATAR; }
    const content = text ? text.replace(/[„Äê„Äë]/g, '') : c.body;
    
    return `
      <div class="comment-item">
        <img src="${avatar || DEFAULT_AVATAR}" class="comment-avatar" alt="${name}" onerror="this.src='${DEFAULT_AVATAR}'">
        <div style="flex:1;">
            <div class="comment-user">${name || 'Guest'}</div>
            <div class="comment-text">${content}</div>
        </div>
      </div>
    `;
  }).join('') || '<div style="text-align:center;padding:20px;color:#94a3b8;">ÊöÇÊó†ËØÑËÆ∫</div>';
  document.getElementById('submitComment').onclick = () => postComment(issueId);
}

async function getCommentMap() {
  const res = await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${CONFIG.commentMapIssue}`, { headers: { Authorization: `token ${CONFIG.token}` } });
  const data = await res.json();
  const map = {};
  data.body.split('\n').forEach(l => { 
      const m = l.match(/news_(-?\d+):\s*(\d+)/); 
      if(m) map[m[1]] = m[2]; 
  });
  return map;
}

async function postComment(issueId) {
  if(!state.user) { showToast('ËØ∑ÂÖàÁôªÂΩï'); return; }
  const input = document.getElementById('commentInput');
  const val = input.value.trim();
  if(!val) return;
  const avatar = state.user.avatar || DEFAULT_AVATAR;
  const body = `${state.user.account}|${state.user.nickname}|${avatar}|„Äê${val}„Äë`;
  
  await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${issueId}/comments`, { method: 'POST', headers: { Authorization: `token ${CONFIG.token}` }, body: JSON.stringify({ body }) });
  input.value = '';
  showToast('ËØÑËÆ∫ÊàêÂäü');
  loadComments(state.news.find(n => n.id).id || state.news[0].id);
}

function loadLogs() { fetch('moguone/log.txt').then(r => r.text()).then(t => { document.querySelector('.sidebar-update-log').innerHTML = t.split('\n').map(l => `<div>${l}</div>`).join(''); }); }

function showToast(msg) { 
    const t = document.getElementById('toast'); 
    t.querySelector('.toast-text').textContent = msg; 
    t.classList.add('show'); 
    setTimeout(() => t.classList.remove('show'), 2000); 
}

async function createCommentIssue(newsId) {
    if(!state.user) { showToast('ËØ∑ÂÖàÁôªÂΩï'); return; }
    const newIssueRes = await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues`, { method: 'POST', headers: { Authorization: `token ${CONFIG.token}` }, body: JSON.stringify({ title: `comment_#${newsId}`, body: `Comment storage for news ${newsId}` }) });
    const newIssue = await newIssueRes.json();
    const mapRes = await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${CONFIG.commentMapIssue}`, { headers: { Authorization: `token ${CONFIG.token}` } });
    const mapData = await mapRes.json();
    const newBody = mapData.body + `\nnews_${newsId}: ${newIssue.number}`;
    await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${CONFIG.commentMapIssue}`, { method: 'PATCH', headers: { Authorization: `token ${CONFIG.token}` }, body: JSON.stringify({ body: newBody }) });
    postComment(newIssue.number);
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
