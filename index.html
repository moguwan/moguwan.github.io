<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="description" content="MY HOME ä¸ªäººä¸»é¡µ">
<title>MoGuOne | è®°å½•ç”Ÿæ´»</title>
<style>
/* --- æ ¸å¿ƒå˜é‡å®šä¹‰ --- */
:root {
  --bg-body: #f3f4f6;
  --bg-card: #ffffff;
  --text-main: #2c3e50;
  --text-sub: #7f8c8d;
  --accent: #607d8b;
  --accent-hover: #455a64;
  --highlight: #e74c3c;
  --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
  --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02);
  --radius-lg: 24px;
  --radius-pill: 50px;
  --font-serif: "Merriweather", "Georgia", serif;
  --ease-out-back: cubic-bezier(0.34, 1.56, 0.64, 1);
  --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
}

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  background-color: var(--bg-body);
  color: var(--text-main);
  line-height: 1.6;
  min-height: 100vh;
  overflow-x: hidden;
  transition: background-image 0.5s ease;
  background-size: cover;
  background-position: center;
  background-attachment: fixed;
}

/* é®ç½©å±‚ï¼Œç”¨äºèƒŒæ™¯å›¾å¤ªäº®æ—¶å¢åŠ æ–‡å­—å¯è¯»æ€§ */
body::before {
    content: ''; position: fixed; inset: 0; background: rgba(243, 244, 246, 0.85); z-index: -1;
    transition: opacity 0.3s;
}
body.has-custom-bg::before { background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(3px); }

/* --- é¼ æ ‡ç‰¹æ•ˆ Canvas --- */
#particleCanvas {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none; z-index: 999999;
}

/* --- Loader --- */
#loader {
  position: fixed; inset: 0; background: #fff; z-index: 99999;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  transition: opacity 0.6s ease, visibility 0.6s ease;
}
#loader.loaded { opacity: 0; visibility: hidden; }
.loader-circle {
  width: 50px; height: 50px; border: 3px solid rgba(0,0,0,0.1);
  border-top-color: var(--accent); border-radius: 50%;
  animation: spin 1s infinite linear;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* --- é¡¶éƒ¨å¯¼èˆª --- */
.nav-container {
  position: fixed; top: 0; left: 0; right: 0; z-index: 100;
  padding: 20px; display: flex; justify-content: space-between; align-items: center;
  pointer-events: none;
}
.nav-logo {
  font-family: var(--font-serif); font-weight: 900; font-size: 20px;
  color: var(--text-main); pointer-events: auto; opacity: 0.8;
  background: rgba(255,255,255,0.8); backdrop-filter: blur(10px);
  padding: 8px 20px; border-radius: var(--radius-pill);
  box-shadow: var(--shadow-sm);
}

.nav-right-group {
    display: flex; gap: 10px; pointer-events: auto; align-items: center;
}

.icon-btn {
    width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.9);
    display: flex; align-items: center; justify-content: center; cursor: pointer;
    box-shadow: var(--shadow-sm); border: 1px solid rgba(0,0,0,0.05);
    transition: transform 0.2s var(--ease-out-back); color: #333; /* å¼ºåˆ¶å›¾æ ‡é¢œè‰²ä¸ºæ·±ç° */
}
.icon-btn:hover { transform: scale(1.1); background: #fff; }
.icon-btn svg { width: 20px; height: 20px; fill: #333; } /* SVGé¢œè‰² */

.user-area { position: relative; }
.login-btn, .user-btn {
  background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
  border: 1px solid rgba(0,0,0,0.05); padding: 8px 20px; height: 40px;
  border-radius: var(--radius-pill); cursor: pointer;
  font-size: 14px; font-weight: 600; color: var(--text-main);
  box-shadow: var(--shadow-sm); transition: transform 0.2s var(--ease-out-back);
  display: flex; align-items: center; gap: 8px;
}
.login-btn:hover, .user-btn:hover { transform: scale(1.05); background: #fff; }
.user-dropdown {
  position: absolute; top: 120%; right: 0; width: 140px; background: #fff;
  border-radius: 16px; padding: 6px; box-shadow: var(--shadow-lg);
  opacity: 0; visibility: hidden; transform: translateY(10px);
  transition: all 0.2s ease;
}
.user-dropdown.show { opacity: 1; visibility: visible; transform: translateY(0); }
.dropdown-item {
  padding: 10px 16px; font-size: 13px; color: var(--text-main);
  border-radius: 10px; cursor: pointer; transition: background 0.2s;
}
.dropdown-item:hover { background: #f8fafc; color: var(--accent); }

/* --- æ ¸å¿ƒåŒºåŸŸ Layout --- */
.main-wrapper {
    width: 100%; min-height: 100vh;
    /* ç§»é™¤ä¹‹å‰çš„ transition: all 0.5s ease; é¿å…å¸ƒå±€åˆ‡æ¢æ—¶å¤–å±‚å®¹å™¨çš„æ€ªå¼‚å½¢å˜ */
    /* æ”¹ç”±å†…éƒ¨ container åšé€æ˜åº¦åŠ¨ç”» */
}

/* æ ¸å¿ƒå®¹å™¨å¢åŠ è¿‡æ¸¡åŠ¨ç”» */
.main-container {
    transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    opacity: 1;
    transform: scale(1);
}
/* åˆ‡æ¢æ—¶çš„éšè—çŠ¶æ€ */
.main-container.switching-hidden {
    opacity: 0;
    transform: scale(0.96) translateY(10px);
    pointer-events: none;
}

/* å‚ç›´æ¨¡å¼ (é»˜è®¤) */
.main-wrapper.vertical-mode .main-container {
  max-width: 800px; margin: 0 auto; padding: 120px 20px 60px;
}
.main-wrapper.vertical-mode .news-grid { display: flex; flex-direction: column; gap: 30px; }

/* æ°´å¹³æ¨¡å¼ (Horizontal) */
.main-wrapper.horizontal-mode {
    display: flex; align-items: center; height: 100vh; overflow: hidden;
    padding-left: 5vw;
}
.main-wrapper.horizontal-mode .main-container {
    display: flex; align-items: center; gap: 60px;
    height: 100%; padding: 0;
}
.main-wrapper.horizontal-mode .hero-section {
    width: 350px; flex-shrink: 0; margin-bottom: 0; text-align: left; align-items: flex-start;
}
.main-wrapper.horizontal-mode .news-grid {
    display: flex; flex-direction: row; gap: 40px;
    height: 70vh; align-items: center;
    padding-right: 100px; /* End padding */
}
/* æ°´å¹³æ¨¡å¼ä¸‹çš„å¡ç‰‡æ ·å¼å¾®è°ƒ */
.main-wrapper.horizontal-mode .news-card {
    width: 400px; flex-shrink: 0; height: auto; max-height: 100%;
    opacity: 0.5; transform: scale(0.95); transition: all 0.5s ease;
}
.main-wrapper.horizontal-mode .news-card.in-view {
    opacity: 1; transform: scale(1);
}

/* --- Hero Section --- */
.hero-section {
  text-align: center; margin-bottom: 60px;
  display: flex; flex-direction: column; align-items: center;
  transition: all 0.5s ease;
}
.avatar-wrapper {
  position: relative; width: 120px; height: 120px; margin-bottom: 25px;
}
.profile-avatar {
  width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
  border: 4px solid #fff; box-shadow: var(--shadow-lg);
  transition: transform 0.5s var(--ease-out-back);
}
.profile-avatar:hover { transform: rotate(10deg) scale(1.05); }

.status-badge {
  position: absolute; bottom: 5px; right: 5px; width: 24px; height: 24px;
  background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.status-dot { width: 12px; height: 12px; background: #10b981; border-radius: 50%; animation: pulse 2s infinite; }
@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }

.hero-title {
  font-family: var(--font-serif); font-size: 32px; font-weight: 700;
  color: var(--text-main); margin-bottom: 10px; letter-spacing: -0.5px;
}
.hero-bio { font-size: 15px; color: var(--text-sub); margin-bottom: 30px; max-width: 500px; }

.search-wrapper {
  position: relative; width: 100%; max-width: 400px; margin-bottom: 30px;
}
.search-input {
  width: 100%; padding: 16px 50px 16px 24px; border: none;
  background: #fff; border-radius: var(--radius-pill);
  box-shadow: var(--shadow-sm); font-size: 15px;
  transition: all 0.3s ease;
}
.search-input:focus {
  box-shadow: 0 8px 30px rgba(0,0,0,0.08); transform: translateY(-2px);
}
.search-btn {
  position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
  width: 36px; height: 36px; background: var(--accent); border: none;
  border-radius: 50%; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: all 0.3s var(--ease-out-back);
}
.search-btn:hover { background: var(--accent-hover); transform: translateY(-50%) scale(1.1); }
.search-btn i { font-style: normal; } /* ä¸´æ—¶ä¿®å¤icon */

.mini-stats {
  display: flex; gap: 20px; font-size: 12px; color: #aab7b8;
  background: rgba(255,255,255,0.5); padding: 8px 20px; border-radius: 20px;
}
.stat-item b { color: var(--text-main); font-weight: 600; margin-left: 4px; }
.update-log { display: none; } 

/* --- æ—¥è®°åˆ—è¡¨ (Card Styling) --- */
/* æ”¹ä¸ºé•¿æ–¹å½¢ï¼Œæ‰å¹³åŒ– */
.news-card {
  background: var(--bg-card); border-radius: var(--radius-lg);
  overflow: hidden; box-shadow: var(--shadow-sm);
  transition: all 0.4s var(--ease-out-back);
  opacity: 0; transform: translateY(40px);
  cursor: pointer; position: relative; border: 1px solid rgba(0,0,0,0.02);
  display: flex; flex-direction: column;
}
.news-card.visible { opacity: 1; transform: translateY(0); }
.news-card:hover { transform: translateY(-5px) scale(1.01); box-shadow: 0 15px 30px rgba(0,0,0,0.08); }

/* å›¾ç‰‡åŒºåŸŸå˜çŸ® */
.news-cover-box {
  position: relative; width: 100%; height: 0; padding-bottom: 45%; /* 45% é«˜åº¦ï¼Œä½¿å…¶æ›´æ‰ */
  background: #f1f5f9; overflow: hidden;
}
.news-cover-box img, .news-cover-box video {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  object-fit: cover; transition: transform 0.8s ease;
}
.news-card:hover .news-cover-box img { transform: scale(1.05); }

.news-content { padding: 25px; position: relative; flex: 1; display: flex; flex-direction: column; }
.news-date {
  font-family: monospace; font-size: 12px; color: var(--accent);
  background: rgba(96, 125, 139, 0.1); padding: 4px 10px; border-radius: 4px;
  display: inline-block; margin-bottom: 10px; font-weight: 600; align-self: flex-start;
}
.news-title {
  font-size: 20px; font-weight: 700; color: var(--text-main);
  margin-bottom: 8px; line-height: 1.4;
}
.news-desc {
  font-size: 14px; color: var(--text-sub); line-height: 1.6;
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
  overflow: hidden; margin-bottom: 15px;
}
.news-footer {
  display: flex; justify-content: space-between; align-items: center;
  border-top: 1px solid #f0f0f0; padding-top: 15px; margin-top: auto;
}
.read-more { font-size: 12px; font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }

/* --- ä¾§è¾¹è¿›åº¦æ¡ (æ‹‰é“¾) --- */
.zipper-progress {
    position: fixed; right: 10px; top: 50%; transform: translateY(-50%);
    width: 6px; height: 300px; background: rgba(0,0,0,0.05); border-radius: 10px;
    overflow: hidden; z-index: 90;
}
.zipper-bar {
    width: 100%; background: var(--accent); height: 0%;
    border-radius: 10px; transition: height 0.1s linear;
}

/* --- éŸ³ä¹æ’­æ”¾å™¨ (å¢å¼ºç‰ˆ) --- */
#footer {
  position: fixed; bottom: 30px; left: 30px; z-index: 900;
  background: #fff; padding: 6px; border-radius: 50px;
  box-shadow: var(--shadow-lg); display: flex; align-items: center;
  transition: width 0.4s var(--ease-out-back); width: 44px; overflow: hidden;
}
#footer.playing { width: 300px; padding-right: 15px; }

.music-cover {
  width: 32px; height: 32px; background: var(--text-main); border-radius: 50%;
  flex-shrink: 0; display: flex; align-items: center; justify-content: center; color: #fff;
  cursor: pointer;
}
.music-controls {
    display: flex; align-items: center; flex: 1; margin-left: 12px; opacity: 0; transition: opacity 0.3s;
    justify-content: space-between; overflow: hidden;
}
#footer.playing .music-controls { opacity: 1; }

.music-info {
    font-size: 12px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px;
    margin-right: 10px;
}

.player-btn { background: none; border: none; cursor: pointer; color: var(--text-sub); padding: 4px; transition: color 0.2s; }
.player-btn:hover { color: var(--accent); }
.player-btn svg { width: 14px; height: 14px; fill: currentColor; }

.play-icon { width: 0; height: 0; border-style: solid; border-width: 5px 0 5px 8px; border-color: transparent transparent transparent #fff; margin-left: 2px; }
.pause-icon { width: 8px; height: 10px; border-left: 3px solid #fff; border-right: 3px solid #fff; }

/* --- å›åˆ°é¡¶éƒ¨æŒ‰é’® --- */
.scroll-top-btn {
  position: fixed; bottom: 30px; right: 30px; width: 44px; height: 44px;
  background: #fff; border-radius: 50%; box-shadow: var(--shadow-lg);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; opacity: 0; visibility: hidden;
  transition: all 0.3s var(--ease-out-back); z-index: 800;
  color: var(--text-main);
  transform: translateY(20px);
}
.scroll-top-btn.show { opacity: 1; visibility: visible; transform: translateY(0); }
.scroll-top-btn:hover { background: var(--text-main); color: #fff; transform: translateY(-5px); }

/* --- æ¨¡æ€æ¡† (Journal Detail) --- */
.modal-mask {
  position: fixed; inset: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(5px);
  z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s;
  display: flex; align-items: center; justify-content: center;
}
.modal-mask.show { opacity: 1; pointer-events: auto; }

/* 85% å±å¹•å°ºå¯¸ */
.modal-box {
  width: 85vw; height: 85vh; background: #fff;
  border-radius: var(--radius-lg); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  display: flex; overflow: hidden; transform: scale(0.95); transition: transform 0.4s var(--ease-out-back);
  border: 1px solid #eee; position: relative;
}
.modal-mask.show .modal-box { transform: scale(1); }

/* é¡¶éƒ¨æ“ä½œæ  */
.modal-actions {
    position: absolute; top: 20px; right: 20px; z-index: 100;
    display: flex; gap: 10px;
}
.modal-action-btn {
    width: 36px; height: 36px; background: #f1f5f9; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; border: none; font-size: 16px; transition: all 0.2s;
    color: #333; /* ç¡®ä¿å›¾æ ‡æ·±è‰² */
}
.modal-action-btn:hover { background: var(--accent); color: #fff; }
.modal-action-btn svg { width: 18px; height: 18px; fill: currentColor; }
.btn-close:hover { background: var(--highlight); transform: rotate(90deg); }

/* å·¦å³å¸ƒå±€å®¹å™¨ */
.modal-inner { display: flex; width: 100%; height: 100%; position: relative; }

/* å†…å®¹åŒº (é»˜è®¤å æ»¡) */
.modal-left {
    flex: 1; padding: 60px 80px; overflow-y: auto; background: #fff;
    transition: all 0.5s var(--ease-smooth);
    min-width: 0; /* é˜²æ­¢flexå­é¡¹æº¢å‡º */
}

/* è¯„è®ºåŒº (é»˜è®¤éšè—ï¼Œå®½åº¦ä¸º0) */
.modal-right {
    width: 0; background: #fcfcfc; border-left: 1px solid #f0f0f0;
    display: flex; flex-direction: column;
    overflow: hidden; opacity: 0;
    transition: all 0.5s var(--ease-smooth);
    transform: translateX(20px);
}
/* æ¿€æ´»è¯„è®ºåŒºæ—¶çš„çŠ¶æ€ */
.modal-box.show-comments .modal-left { padding-right: 40px; } /* ç¨å¾®æŒ¤å‹å·¦ä¾§ */
.modal-box.show-comments .modal-right { width: 350px; opacity: 1; transform: translateX(0); padding: 30px; }

/* è¯¦æƒ…é¡µå†…çš„ç¼©ç•¥å›¾ */
.detail-media-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 20px;
}
.detail-thumb {
    width: 100%; height: 120px; object-fit: cover; border-radius: 8px; cursor: zoom-in;
    transition: transform 0.2s; box-shadow: var(--shadow-sm);
}
.detail-thumb:hover { transform: scale(1.05); }

/* è¯„è®ºæ ·å¼ */
.comment-input {
  background: #fff; border: 1px solid #e2e8f0; padding: 15px; border-radius: 12px;
  width: 100%; min-height: 80px; font-family: inherit; margin-bottom: 10px;
}
.comment-input:focus { border-color: var(--accent); }
.comment-btn {
  background: var(--text-main); color: #fff; border: none; padding: 8px 20px;
  border-radius: 8px; font-weight: 600; cursor: pointer; align-self: flex-end;
}
.comment-item { display: flex; gap: 12px; margin-bottom: 20px; animation: fadeIn 0.3s; }
.comment-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
.comment-user { font-size: 13px; font-weight: 700; margin-bottom: 4px; }
.comment-text { font-size: 14px; color: #555; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* Lightbox (é«˜çº§ç¯ç®±) */
.lightbox {
  position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000;
  display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s;
}
.lightbox.active { opacity: 1; pointer-events: auto; }
.lightbox img {
    max-width: 90%; max-height: 85%; box-shadow: 0 0 50px rgba(0,0,0,0.5); border-radius: 4px;
    transform: scale(0.9); transition: transform 0.4s var(--ease-out-back); user-select: none;
}
.lightbox.active img { transform: scale(1); }

.lb-btn {
    position: absolute; top: 50%; transform: translateY(-50%);
    background: rgba(255,255,255,0.1); color: #fff; border: none;
    width: 50px; height: 50px; border-radius: 50%; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: background 0.2s;
}
.lb-btn:hover { background: rgba(255,255,255,0.3); }
.lb-prev { left: 30px; }
.lb-next { right: 30px; }
.lb-close { position: absolute; top: 30px; right: 30px; background: none; font-size: 30px; color: #fff; border: none; cursor: pointer; }

/* Access Modal & Toast */
.access-modal-content {
  background: #fff; padding: 40px; border-radius: 20px; text-align: center;
  box-shadow: 0 20px 60px rgba(0,0,0,0.1); border: 1px solid #eee;
}
.btn-primary-btn { background: var(--text-main); color: #fff; border: none; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; }
.btn-outline { background: transparent; border: 1px solid #ddd; padding: 10px 24px; border-radius: 8px; cursor: pointer; margin-right: 10px; }
.toast {
  position: fixed; top: 30px; left: 50%; transform: translateX(-50%) translateY(-100%);
  background: #333; color: #fff; padding: 10px 24px; border-radius: 30px;
  font-size: 14px; font-weight: 600; box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  transition: all 0.4s var(--ease-out-back); z-index: 9999;
  opacity: 0; visibility: hidden; pointer-events: none;
}
.toast.show { transform: translateX(-50%) translateY(0); opacity: 1; visibility: visible; pointer-events: auto; }

/* Mobile Adaption */
@media (max-width: 768px) {
  .modal-box { width: 100%; height: 100%; border-radius: 0; }
  .modal-inner { flex-direction: column; }
  .modal-left { padding: 20px; flex: 1; }
  .modal-right {
      position: absolute; bottom: 0; left: 0; right: 0; height: 60%; width: 100% !important;
      transform: translateY(110%); border-left: none; border-top: 1px solid #eee;
      background: #fff; z-index: 200;
  }
  .modal-box.show-comments .modal-right { transform: translateY(0); }
  .hero-title { font-size: 26px; }
  .nav-logo { display: none; }
  .main-wrapper.horizontal-mode { flex-direction: column; padding: 20px; height: auto; overflow: visible; }
  .main-wrapper.horizontal-mode .main-container { flex-direction: column; height: auto; }
  .main-wrapper.horizontal-mode .news-grid { flex-direction: column; height: auto; width: 100%; padding: 0; }
  .main-wrapper.horizontal-mode .news-card { width: 100%; opacity: 1; transform: none; }
  .nav-right-group { gap: 5px; }
}
</style>
</head>
<body>

<canvas id="particleCanvas"></canvas>

<div id="loader">
  <div class="loader-circle"></div>
</div>

<div class="zipper-progress" id="scrollProgress">
    <div class="zipper-bar"></div>
</div>

<div class="nav-container">
  <div class="nav-logo">MoGuOne</div>
  
  <div class="nav-right-group">
      <div class="icon-btn" id="layoutBtn" title="Change Layout">
        <svg viewBox="0 0 24 24"><path d="M3 3h8v8H3zm10 0h8v8h-8zM3 13h8v8H3zm10 0h8v8h-8z"/></svg>
      </div>
      <div class="icon-btn" id="bgBtn" style="display:none;" title="Change Background">
        <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
      </div>
      <input type="file" id="bgInput" accept="image/*" style="display:none;">

      <div class="user-area" id="userArea">
        <button class="login-btn" id="loginBtn">ç™»å½•</button>
        <div class="user-btn" id="userBtn" style="display: none;">
          <span id="userName">User</span>
          <div class="user-dropdown">
            <div class="dropdown-item" id="goProfile">è´¦å·è®¾ç½®</div>
            <div class="dropdown-item" id="goAdmin" style="display:none;">åå°ç®¡ç†</div>
            <div class="dropdown-item" id="doLogout">é€€å‡ºç™»å½•</div>
          </div>
        </div>
      </div>
  </div>
</div>

<div class="main-wrapper vertical-mode" id="mainWrapper">
    <div class="main-container">
      
      <section class="hero-section">
        <div class="avatar-wrapper">
          <img src="https://img.wjwj.top/2026/01/16/a27c17b713d7998cebb06b1dde372d64.jpg" class="profile-avatar" alt="Avatar">
          <div class="status-badge"><div class="status-dot"></div></div>
        </div>
        
        <div class="hero-title">MY HOME</div>
        <div class="hero-bio">çƒ­çˆ±æ˜¯æ‰€æœ‰çš„ç†ç”±å’Œç­”æ¡ˆã€‚</div>
        
        <div class="search-wrapper">
          <input type="text" class="search-input" id="searchInput" placeholder="Search daily notes...">
          <button class="search-btn" id="searchBtn">
             <svg style="width:18px;height:18px;fill:#fff;" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
          </button>
        </div>

        <div class="mini-stats">
          <span class="stat-item">Visits <b id="totalCount">0</b></span>
          <span style="opacity:0.3">|</span>
          <span class="stat-item">Status <b style="color:#10b981">Online</b></span>
          <div class="update-log sidebar-update-log"></div>
        </div>
      </section>

      <div class="news-grid" id="newsContainer"></div>
    </div>
</div>

<div id="footer">
  <div class="music-cover" id="playBtn"><div class="play-icon"></div></div>
  <div class="music-controls">
      <div class="music-info" id="musicTitle">Top Barry - ä¸€åŠä¸€åŠ</div>
      <div style="display:flex;gap:5px;">
        <button class="player-btn" id="prevSongBtn"><svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
        <button class="player-btn" id="nextSongBtn"><svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
        <button class="player-btn" id="modeBtn" title="Loop List"><svg id="modeIcon" viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg></button>
      </div>
  </div>
  <audio id="music" preload="auto"></audio>
</div>

<div class="scroll-top-btn" id="scrollTopBtn">
  <svg viewBox="0 0 1024 1024"><path d="M519.85 292.096l314.496 363.648a27.52 27.52 0 0 1-1.344 37.952 27.52 27.52 0 0 1-37.952-1.344l-282.88-327.232-283.456 327.68a27.648 27.648 0 0 1-40.448-1.536 27.648 27.648 0 0 1 1.536-40.448l314.944-364.096a27.584 27.584 0 0 1 15.104-5.568z" /></svg>
</div>

<div class="modal-mask" id="newsModal">
  <div class="modal-box" id="modalBox">
    <div class="modal-actions">
        <button class="modal-action-btn" id="toggleCommentBtn" title="Chat/Comments">
            <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>
        </button>
        <button class="modal-action-btn btn-close" id="modalClose">âœ•</button>
    </div>
    
    <div class="modal-inner">
        <div class="modal-left" id="modalContent"></div>
        <div class="modal-right" id="modalComments">
          <div style="flex:1;overflow-y:auto;margin-bottom:15px;" id="commentList"></div>
          <div style="border-top:1px solid #eee;padding-top:15px;">
            <textarea class="comment-input" id="commentInput" placeholder="Write a comment..."></textarea>
            <button class="comment-btn" id="submitComment">å‘é€</button>
          </div>
        </div>
    </div>
  </div>
</div>

<div class="modal-mask" id="accessModal" style="z-index: 99999;">
  <div class="access-modal-content">
    <div style="font-size: 40px; margin-bottom: 20px;">ğŸ”’</div>
    <h3 style="margin-bottom: 10px;">Private Space</h3>
    <p style="color:#7f8c8d; margin-bottom: 30px; font-size:14px;">æ­¤é¡µé¢ä»…é™ç®¡ç†å‘˜è®¿é—®ã€‚<br>This page is private.</p>
    <div>
      <button class="btn-outline" onclick="window.location.href='moguone/search.html'">Leave</button>
      <button class="btn-primary-btn" onclick="window.location.href='moguone/login.html'">Login</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">
  <div class="toast-text">æ“ä½œæˆåŠŸ</div>
</div>

<div class="lightbox" id="lightbox">
    <button class="lb-close" onclick="closeLightbox()">âœ•</button>
    <button class="lb-btn lb-prev" onclick="changeLightbox(-1)">â®</button>
    <img id="lightboxImg" src="" alt="Full view">
    <button class="lb-btn lb-next" onclick="changeLightbox(1)">â¯</button>
</div>

<script>
const CONFIG = {
  token: ["gh","p_p","VX","lo","0HQ","PmMx","Ic","eM","HB","uMzm","EON","LPX","700","10","M","SL"].join(''),
  repo: "moguwan/moguwan.github.io",
  newsIssue: 322,
  countIssue: 7,
  userIssue: 11,
  commentMapIssue: 299
};

/* --- éŸ³ä¹åˆ—è¡¨é…ç½® --- */
const MUSIC_LIST = [
	"åæ–¹å‘çš„é’Ÿ.mp3",
    "ä¸€åŠä¸€åŠ.mp3",
    "å‡ åˆ†ä¹‹å‡ .mp3"
];
let musicState = {
    index: 0,
    mode: 0, 
    isPlaying: false
};

const DEFAULT_AVATAR = "https://img.wjwj.top/2026/01/20/d6346e9c8e93165079c5ab74f856358c.png";
const DEFAULT_SIGNATURE = "æ— ";

let state = { user: null, news: [], likes: {}, currentNewsIdx: 0, isHorizontal: false };
let currentLightboxImgs = [];
let currentLightboxIdx = 0;

function init() {
  const loader = document.getElementById('loader');
  setTimeout(() => loader.classList.add('loaded'), 800);
  
  initParticles(); // é¼ æ ‡ç‰¹æ•ˆ
  checkLogin();
  loadNews();
  loadStats();
  initMusicPlayer();
  loadLogs();
  initScrollLogic();
  
  // èƒŒæ™¯åŠŸèƒ½
  const savedBg = localStorage.getItem('customBg');
  if(savedBg) {
      document.body.style.backgroundImage = `url(${savedBg})`;
      document.body.classList.add('has-custom-bg');
  }
  document.getElementById('bgBtn').onclick = () => document.getElementById('bgInput').click();
  document.getElementById('bgInput').onchange = handleBgUpload;

  // å¸ƒå±€åˆ‡æ¢
  document.getElementById('layoutBtn').onclick = toggleLayout;

  // æœç´¢
  document.getElementById('searchBtn').addEventListener('click', doSearch);
  document.getElementById('searchInput').addEventListener('keyup', (e) => { if(e.key === 'Enter') doSearch(); });

  // é”®ç›˜æ§åˆ¶ç¯ç®±
  document.addEventListener('keydown', (e) => {
      if(!document.getElementById('lightbox').classList.contains('active')) return;
      if(e.key === 'ArrowLeft') changeLightbox(-1);
      if(e.key === 'ArrowRight') changeLightbox(1);
      if(e.key === 'Escape') closeLightbox();
  });
}

/* --- å¸ƒå±€ä¸æ»šåŠ¨é€»è¾‘ (Silky Smooth Version) --- */
function toggleLayout() {
    // 1. è·å–æ ¸å¿ƒå…ƒç´ 
    const container = document.querySelector('.main-container');
    const wrapper = document.getElementById('mainWrapper');
    const btn = document.getElementById('layoutBtn');
    
    // 2. ç¬¬ä¸€æ­¥ï¼šé€€åœºåŠ¨ç”» (Fade Out & Scale Down)
    // åŠ ä¸Š switching-hidden ç±»ï¼ŒCSSä¼šè‡ªåŠ¨å¤„ç† opacity å’Œ transform
    container.classList.add('switching-hidden');

    // 3. ç­‰å¾…é€€åœºåŠ¨ç”»å®Œæˆ (400ms ä¸ CSS transition ä¸€è‡´)
    setTimeout(() => {
        state.isHorizontal = !state.isHorizontal;
        
        // 4. åœ¨å¹•åè¿›è¡Œ DOM Class åˆ‡æ¢å’Œæ»šåŠ¨é‡ç½® (ç”¨æˆ·æ­¤åˆ»çœ‹ä¸åˆ°)
        if(state.isHorizontal) {
            wrapper.classList.remove('vertical-mode');
            wrapper.classList.add('horizontal-mode');
            
            // åˆ‡æ¢ä¸ºåˆ—è¡¨å›¾æ ‡
            btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>';
            window.addEventListener('wheel', handleHorizontalScroll, { passive: false });
        } else {
            wrapper.classList.remove('horizontal-mode');
            wrapper.classList.add('vertical-mode');
            
            // åˆ‡æ¢ä¸ºç½‘æ ¼å›¾æ ‡
            btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M3 3h8v8H3zm10 0h8v8h-8zM3 13h8v8H3zm10 0h8v8h-8z"/></svg>';
            window.removeEventListener('wheel', handleHorizontalScroll);
        }

        // é‡ç½®æ»šåŠ¨ä½ç½®ï¼Œé¿å…è·³åŠ¨
        window.scrollTo(0,0);
        wrapper.scrollLeft = 0;
        updateProgress();

        // 5. å‡†å¤‡è¿›åœºï¼šå…ˆå¼ºåˆ¶é‡ç½®æ‰€æœ‰å¡ç‰‡çš„åŠ¨ç”»çŠ¶æ€
        const cards = document.querySelectorAll('.news-card');
        cards.forEach(card => {
            card.style.transition = 'none'; // æš‚æ—¶å…³é—­å¡ç‰‡è‡ªèº«çš„ transition
            card.style.opacity = '0';
            card.classList.remove('visible', 'in-view');
        });

        // 6. ç¬¬äºŒæ­¥ï¼šè¿›åœºåŠ¨ç”» (Fade In & Scale Up)
        // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿æµè§ˆå™¨æ¸²æŸ“äº†ä¸Šè¿°å˜åŒ–
        requestAnimationFrame(() => {
            container.classList.remove('switching-hidden');
            
            // 7. å¡ç‰‡æ³¢æµªå¼å…¥åœº (Staggered Animation)
            // æ¢å¤å¡ç‰‡çš„ transition å±æ€§ï¼Œå¹¶ä¾æ¬¡æ˜¾ç¤º
            setTimeout(() => {
                cards.forEach((card, index) => {
                    card.style.transition = ''; // æ¢å¤ CSS ä¸­çš„ transition
                    
                    // åˆ¶é€ æ³¢æµªæ•ˆæœï¼šæ¯ä¸ªå¡ç‰‡å»¶è¿Ÿ 50ms å‡ºç°
                    setTimeout(() => {
                        card.style.opacity = ''; // ã€ä¿®å¤å…³é”®ã€‘ï¼šæ¸…é™¤è¡Œå†… opacity æ ·å¼ï¼Œè®© CSS ç±»ç”Ÿæ•ˆ
                        card.classList.add('visible');
                        if(state.isHorizontal) card.classList.add('in-view');
                    }, index * 50); 
                });
            }, 100); // ç¨å¾®ç­‰å¾…å®¹å™¨å¼€å§‹æ”¾å¤§åå†æ˜¾ç¤ºå¡ç‰‡
        });

    }, 400); // ç­‰å¾…é€€åœºåŠ¨ç”»ç»“æŸ
}

function handleHorizontalScroll(e) {
    if(!state.isHorizontal) return;
    if(document.getElementById('newsModal').classList.contains('show')) return;
    
    e.preventDefault();
    const container = document.querySelector('.main-wrapper'); 
    container.scrollLeft += e.deltaY;
    
    updateProgress();
    checkHorizontalVisibility();
}

function initScrollToTop() {
    const btn = document.getElementById('scrollTopBtn');
    window.addEventListener('scroll', () => {
        if(!state.isHorizontal) {
            updateProgress();
            if (window.scrollY > 300) btn.classList.add('show');
            else btn.classList.remove('show');
        }
    });
    btn.onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });
}

function initScrollLogic() {
    initScrollToTop();
    window.addEventListener('scroll', updateProgress);
}

function updateProgress() {
    const bar = document.querySelector('.zipper-bar');
    let pct = 0;
    
    if(state.isHorizontal) {
        const el = document.querySelector('.main-wrapper');
        const w = el.scrollWidth - el.clientWidth;
        pct = w > 0 ? (el.scrollLeft / w) * 100 : 0;
    } else {
        const h = document.documentElement.scrollHeight - document.documentElement.clientHeight;
        pct = h > 0 ? (window.scrollY / h) * 100 : 0;
    }
    bar.style.height = `${Math.min(100, Math.max(0, pct))}%`;
}

function checkHorizontalVisibility() {
    const cards = document.querySelectorAll('.news-card');
    const viewW = window.innerWidth;
    cards.forEach(card => {
        const rect = card.getBoundingClientRect();
        // ç¨å¾®æ”¾å®½åˆ¤å®šèŒƒå›´
        if(rect.left < viewW + 50 && rect.right > -50) {
            card.classList.add('in-view');
        } else {
            card.classList.remove('in-view');
        }
    });
}

/* --- èƒŒæ™¯ä¸Šä¼  --- */
function handleBgUpload(e) {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(evt) {
        const res = evt.target.result;
        localStorage.setItem('customBg', res);
        document.body.style.backgroundImage = `url(${res})`;
        document.body.classList.add('has-custom-bg');
        showToast('èƒŒæ™¯å·²æ›´æ¢');
    };
    reader.readAsDataURL(file);
}

/* --- éŸ³ä¹æ’­æ”¾å™¨é€»è¾‘ --- */
function initMusicPlayer() {
    const audio = document.getElementById('music');
    const playBtn = document.getElementById('playBtn');
    const footer = document.getElementById('footer');
    const playIcon = playBtn.querySelector('div');
    const title = document.getElementById('musicTitle');
    const prevBtn = document.getElementById('prevSongBtn');
    const nextBtn = document.getElementById('nextSongBtn');
    const modeBtn = document.getElementById('modeBtn');
    const modeIcon = document.getElementById('modeIcon');

    const BASE_PATH = 'moguone/song/';

    function loadSong(idx) {
        if(idx < 0) idx = MUSIC_LIST.length - 1;
        if(idx >= MUSIC_LIST.length) idx = 0;
        musicState.index = idx;
        const name = MUSIC_LIST[idx];
        audio.src = BASE_PATH + name;
        title.textContent = name.replace('.mp3', '');
        if(musicState.isPlaying) audio.play().catch(()=>{});
    }

    loadSong(0);

    playBtn.onclick = () => {
        if(musicState.isPlaying) {
            audio.pause();
            footer.classList.remove('playing');
            playIcon.className = 'play-icon';
        } else {
            audio.play();
            footer.classList.add('playing');
            playIcon.className = 'pause-icon';
        }
        musicState.isPlaying = !musicState.isPlaying;
    };

    nextBtn.onclick = () => {
        if(musicState.mode === 2) {
            let next = Math.floor(Math.random() * MUSIC_LIST.length);
            loadSong(next);
        } else {
            loadSong(musicState.index + 1);
        }
    };
    prevBtn.onclick = () => loadSong(musicState.index - 1);

    audio.onended = () => {
        if(musicState.mode === 1) {
            audio.play(); 
        } else {
            nextBtn.click();
        }
    };

    const modes = [
        { id: 0, name: 'åˆ—è¡¨å¾ªç¯', path: "M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z" },
        { id: 1, name: 'å•æ›²å¾ªç¯', path: "M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z" }, 
        { id: 2, name: 'éšæœºæ’­æ”¾', path: "M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z" }
    ];

    modeBtn.onclick = () => {
        musicState.mode = (musicState.mode + 1) % 3;
        modeIcon.querySelector('path').setAttribute('d', modes[musicState.mode].path);
        modeBtn.title = modes[musicState.mode].name;
        if(musicState.mode === 1) showToast('å•æ›²å¾ªç¯');
        if(musicState.mode === 2) showToast('éšæœºæ’­æ”¾');
        if(musicState.mode === 0) showToast('åˆ—è¡¨å¾ªç¯');
    };
}

/* --- Search & Render --- */
function doSearch() {
  const val = document.getElementById('searchInput').value.trim().toLowerCase();
  const container = document.getElementById('newsContainer');
  const filtered = state.news.filter(item => item.title.toLowerCase().includes(val) || item.content.toLowerCase().includes(val));
  
  container.innerHTML = filtered.map((item, idx) => `
    <div class="news-card" onclick="openModal(${idx})" style="animation-delay:${idx * 0.1}s">
      ${item.imgs.length ? `
        <div class="news-cover-box">
           <img src="${item.imgs[0]}" loading="lazy">
        </div>
      ` : (item.videos.length ? `
        <div class="news-cover-box">
           <video src="${item.videos[0]}#t=1" muted></video>
        </div>
      ` : '')}
      
      <div class="news-content">
        <div class="news-date">${item.date}</div>
        <div class="news-title">${item.title}</div>
        <div class="news-desc">${item.content}</div>
        <div class="news-footer">
           <span class="read-more">Read Journal</span>
        </div>
      </div>
    </div>
  `).join('');
  
  setTimeout(() => { 
      document.querySelectorAll('.news-card').forEach(el => el.classList.add('visible'));
      if(state.isHorizontal) checkHorizontalVisibility();
  }, 50);
  if(filtered.length === 0) container.innerHTML = '<div style="text-align:center;width:100%;color:#999;padding:60px;">Nothing found in the journal.</div>';
}

/* --- Modal Logic --- */
function openModal(idx) {
  state.currentNewsIdx = idx;
  const item = state.news[idx]; 
  const modal = document.getElementById('newsModal');
  const content = document.getElementById('modalContent');
  const box = document.getElementById('modalBox');

  box.classList.remove('show-comments');
  
  let mediaHtml = '';
  if(item.imgs.length > 0) {
      mediaHtml += '<div class="detail-media-grid">';
      item.imgs.forEach((src, imgIdx) => {
          mediaHtml += `<img src="${src}" class="detail-thumb" onclick="viewLightbox(${idx}, ${imgIdx})">`;
      });
      mediaHtml += '</div>';
  }
  
  content.innerHTML = `
    <div style="font-size:13px;color:#999;margin-bottom:10px;">${item.date}</div>
    <h2 style="font-size:28px;margin-bottom:25px;color:#2c3e50;font-family:serif;">${item.title}</h2>
    <div style="font-size:16px;line-height:1.8;color:#4a5568;margin-bottom:30px;white-space:pre-wrap;">${item.content}</div>
    ${mediaHtml}
  `;
  
  modal.classList.add('show');
  document.body.style.overflow = 'hidden';
  
  document.getElementById('toggleCommentBtn').onclick = () => {
      box.classList.toggle('show-comments');
  };

  loadComments(item.id);
  document.getElementById('modalClose').onclick = () => { 
      modal.classList.remove('show'); 
      document.body.style.overflow = ''; 
  };
}

/* --- Lightbox Logic --- */
function viewLightbox(newsIdx, imgIdx) {
    const item = state.news[newsIdx];
    currentLightboxImgs = item.imgs;
    currentLightboxIdx = imgIdx;
    updateLightboxImage();
    document.getElementById('lightbox').classList.add('active');
}

function updateLightboxImage() {
    const img = document.getElementById('lightboxImg');
    img.style.opacity = 0.5;
    setTimeout(() => {
        img.src = currentLightboxImgs[currentLightboxIdx];
        img.style.opacity = 1;
    }, 100);
}

function changeLightbox(dir) {
    const newIdx = currentLightboxIdx + dir;
    if(newIdx >= 0 && newIdx < currentLightboxImgs.length) {
        currentLightboxIdx = newIdx;
        updateLightboxImage();
    }
}

function closeLightbox() { 
    document.getElementById('lightbox').classList.remove('active'); 
}

/* --- Particles Effect (Canvas) - Modified: Click Only --- */
function initParticles() {
    const canvas = document.getElementById('particleCanvas');
    const ctx = canvas.getContext('2d');
    let width, height;
    let particles = [];

    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    class Particle {
        constructor(x, y) {
            this.x = x;
            this.y = y;
            this.size = Math.random() * 5 + 2;
            this.speedX = Math.random() * 6 - 3; // æ‰©å¤§æ¨ªå‘æ•£å¼€èŒƒå›´
            this.speedY = Math.random() * -6 - 2; // å‘ä¸Šå–·å‘åŠ›åº¦å¢åŠ 
            this.gravity = 0.2;
            this.color = `hsl(${Math.random() * 360}, 70%, 60%)`;
            this.life = 60; // ç¼©çŸ­ç”Ÿå‘½å‘¨æœŸï¼Œå®ç°ç¬é—´æ¶ˆå¤±
        }
        update() {
            this.speedY += this.gravity;
            this.x += this.speedX;
            this.y += this.speedY;
            this.life--;
            this.size *= 0.95;
        }
        draw() {
            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fill();
        }
    }

    // ä¿®æ”¹ï¼šæ”¹ä¸ºç‚¹å‡»è§¦å‘çƒŸèŠ±æ•ˆæœ
    window.addEventListener('mousedown', (e) => {
        // æ¯æ¬¡ç‚¹å‡»ç”Ÿæˆ 20 ä¸ªç²’å­ï¼Œå½¢æˆçˆ†ç‚¸æ•ˆæœ
        for(let i=0; i<20; i++) {
            particles.push(new Particle(e.clientX, e.clientY));
        }
    });

    function animate() {
        ctx.clearRect(0, 0, width, height);
        for(let i = 0; i < particles.length; i++) {
            particles[i].update();
            particles[i].draw();
            if(particles[i].life <= 0 || particles[i].size < 0.5) {
                particles.splice(i, 1);
                i--;
            }
        }
        requestAnimationFrame(animate);
    }
    animate();
}

/* --- API & Login Logic (ä¿ç•™åŸæ ·) --- */
function checkLogin() {
  const localUser = localStorage.getItem('MY_CUSTOM_USER_INFO');
  if (localUser) {
    state.user = JSON.parse(localUser);
    if (!state.user.isAdmin) { showAccessDenied(); return; }
    document.getElementById('loginBtn').style.display = 'none';
    document.getElementById('userBtn').style.display = 'flex';
    document.getElementById('bgBtn').style.display = 'flex'; // æ˜¾ç¤ºæ¢è‚¤æŒ‰é’®
    document.getElementById('userName').textContent = state.user.nickname;
    document.getElementById('goAdmin').style.display = 'block';
    updateUserInfoFromRemote();
  } else {
    showAccessDenied();
    return;
  }
  document.getElementById('loginBtn').onclick = () => window.location.href = 'moguone/login.html';
  document.getElementById('userBtn').onclick = (e) => { e.stopPropagation(); document.querySelector('.user-dropdown').classList.toggle('show'); };
  document.addEventListener('click', () => document.querySelector('.user-dropdown').classList.remove('show'));
  document.getElementById('doLogout').onclick = logout;
  document.getElementById('goProfile').onclick = () => window.location.href = 'moguone/setting.html';
  document.getElementById('goAdmin').onclick = () => window.location.href = 'moguone/admin.html';
}

async function updateUserInfoFromRemote() {
    try {
        const res = await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${CONFIG.userIssue}`, { headers: { Authorization: `token ${CONFIG.token}` } });
        const data = await res.json();
        const lines = data.body.split('\n');
        const userLine = lines.find(l => l.startsWith(state.user.account + '|'));
        if(userLine) {
            const parts = userLine.split('|').map(s => s.trim());
            state.user.nickname = parts[3] || state.user.nickname;
            state.user.email = parts[2] || state.user.email;
            state.user.avatar = parts[5] || DEFAULT_AVATAR;
            state.user.signature = parts[6] || DEFAULT_SIGNATURE;
            localStorage.setItem('MY_CUSTOM_USER_INFO', JSON.stringify(state.user));
            document.getElementById('userName').textContent = state.user.nickname;
        }
    } catch(e) { console.error('Silent update failed', e); }
}

function showAccessDenied() {
    document.getElementById('accessModal').classList.add('show');
    document.body.style.overflow = 'hidden';
}
function logout() { localStorage.removeItem('MY_CUSTOM_USER_INFO'); location.reload(); }

async function loadNews() {
  try {
    const res = await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${CONFIG.newsIssue}`, { headers: { Authorization: `token ${CONFIG.token}` } });
    const data = await res.json();
    const rawList = data.body.split('---').map(s => s.trim()).filter(s => s);
    state.news = rawList.map((str, i) => {
      const lines = str.split('\n');
      let item = { id: i, title: '', content: '', date: '', imgs: [], videos: [] };
      lines.forEach(l => {
        l = l.trim();
        if(l.startsWith('ã€')) item.title = l.slice(1,-1);
        else if(l.startsWith('id::')) item.id = parseInt(l.slice(4)); 
        else if(l.startsWith('date::')) item.date = l.slice(6);
        else if(l.startsWith('img::')) item.imgs.push(l.slice(5));
        else if(l.startsWith('video::')) item.videos.push(l.slice(7));
        else if(l !== '') item.content += l + '\n';
      });
      return item;
    }).sort((a, b) => b.id - a.id);
    doSearch(); 
  } catch(e) { console.error(e); }
}

async function loadStats() {
  try {
    const res = await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${CONFIG.countIssue}`, { headers: { Authorization: `token ${CONFIG.token}` } });
    const data = await res.json();
    const countMatch = data.body.match(/æ€»è®¿é—®é‡ï¼š(\d+)/);
    const count = countMatch ? parseInt(countMatch[1]) + 1 : 1;
    document.getElementById('totalCount').textContent = count;
    const newBody = data.body.replace(/æ€»è®¿é—®é‡ï¼š\d+/, `æ€»è®¿é—®é‡ï¼š${count}`);
    fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${CONFIG.countIssue}`, { method: 'PATCH', headers: { Authorization: `token ${CONFIG.token}` }, body: JSON.stringify({ body: newBody }) });
  } catch(e) { console.error(e); }
}

async function loadComments(newsId) {
  const list = document.getElementById('commentList');
  list.innerHTML = '<div style="text-align:center;padding:20px;color:#94a3b8;">åŠ è½½ä¸­...</div>';
  const issueMap = await getCommentMap();
  const issueId = issueMap[newsId];
  if(!issueId) {
    list.innerHTML = '<div style="text-align:center;padding:20px;color:#94a3b8;">æš‚æ— è¯„è®ºï¼Œæ¥åæ²™å‘</div>';
    document.getElementById('submitComment').onclick = () => createCommentIssue(newsId);
    return;
  }
  const res = await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${issueId}/comments`, { headers: { Authorization: `token ${CONFIG.token}` } });
  const comments = await res.json();
  
  list.innerHTML = comments.map(c => {
    let parts = c.body.split('|');
    let uid, name, avatar, text;
    if (parts.length >= 4) { [uid, name, avatar, text] = parts; } 
    else { [uid, name, text] = parts; avatar = DEFAULT_AVATAR; }
    const content = text ? text.replace(/[ã€ã€‘]/g, '') : c.body;
    
    return `
      <div class="comment-item">
        <img src="${avatar || DEFAULT_AVATAR}" class="comment-avatar" alt="${name}" onerror="this.src='${DEFAULT_AVATAR}'">
        <div style="flex:1;">
            <div class="comment-user">${name || 'Guest'}</div>
            <div class="comment-text">${content}</div>
        </div>
      </div>
    `;
  }).join('') || '<div style="text-align:center;padding:20px;color:#94a3b8;">æš‚æ— è¯„è®º</div>';
  document.getElementById('submitComment').onclick = () => postComment(issueId);
}

async function getCommentMap() {
  const res = await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${CONFIG.commentMapIssue}`, { headers: { Authorization: `token ${CONFIG.token}` } });
  const data = await res.json();
  const map = {};
  data.body.split('\n').forEach(l => { 
      const m = l.match(/news_(-?\d+):\s*(\d+)/); 
      if(m) map[m[1]] = m[2]; 
  });
  return map;
}

async function postComment(issueId) {
  if(!state.user) { showToast('è¯·å…ˆç™»å½•'); return; }
  const input = document.getElementById('commentInput');
  const val = input.value.trim();
  if(!val) return;
  const avatar = state.user.avatar || DEFAULT_AVATAR;
  const body = `${state.user.account}|${state.user.nickname}|${avatar}|ã€${val}ã€‘`;
  
  await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${issueId}/comments`, { method: 'POST', headers: { Authorization: `token ${CONFIG.token}` }, body: JSON.stringify({ body }) });
  input.value = '';
  showToast('è¯„è®ºæˆåŠŸ');
  loadComments(state.news.find(n => n.id === state.currentNewsIdx).id || state.news[state.currentNewsIdx].id);
}

async function createCommentIssue(newsId) {
    if(!state.user) { showToast('è¯·å…ˆç™»å½•'); return; }
    const newIssueRes = await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues`, { method: 'POST', headers: { Authorization: `token ${CONFIG.token}` }, body: JSON.stringify({ title: `comment_#${newsId}`, body: `Comment storage for news ${newsId}` }) });
    const newIssue = await newIssueRes.json();
    const mapRes = await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${CONFIG.commentMapIssue}`, { headers: { Authorization: `token ${CONFIG.token}` } });
    const mapData = await mapRes.json();
    const newBody = mapData.body + `\nnews_${newsId}: ${newIssue.number}`;
    await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${CONFIG.commentMapIssue}`, { method: 'PATCH', headers: { Authorization: `token ${CONFIG.token}` }, body: JSON.stringify({ body: newBody }) });
    postComment(newIssue.number);
}

function loadLogs() { fetch('moguone/log.txt').then(r => r.text()).then(t => { document.querySelector('.sidebar-update-log').innerHTML = t.split('\n').map(l => `<div>${l}</div>`).join(''); }); }

function showToast(msg) { 
    const t = document.getElementById('toast'); 
    t.querySelector('.toast-text').textContent = msg; 
    t.classList.add('show'); 
    setTimeout(() => t.classList.remove('show'), 2000); 
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
