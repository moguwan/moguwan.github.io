<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="description" content="MY HOME ‰∏™‰∫∫‰∏ªÈ°µ">
<title>MoGuOne | ËÆ∞ÂΩïÁîüÊ¥ª</title>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
/* --- ÂéüÊúâÊ†∑Âºè‰øùÊåÅ‰∏çÂèò --- */
.main-wrapper.vertical-mode .news-cover-box {
  padding-bottom: 30% !important;
}
.main-wrapper.vertical-mode .news-title {
  font-size: 24px !important;
}
.main-wrapper.vertical-mode .news-desc {
  font-size: 16px !important;
  line-height: 1.7 !important;
}
html::-webkit-scrollbar, body::-webkit-scrollbar { display: none; }
html { scrollbar-width: none; }
body { -ms-overflow-style: none; }
:root {
  --bg-body: #f3f4f6;
  --bg-card: #ffffff;
  --text-main: #2c3e50;
  --text-sub: #7f8c8d;
  --accent: #607d8b;
  --accent-hover: #455a64;
  --highlight: #e74c3c;
  --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
  --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02);
  --radius-lg: 24px;
  --radius-pill: 50px;
  --font-serif: "Merriweather", "Georgia", serif;
  --ease-out-back: cubic-bezier(0.34, 1.56, 0.64, 1);
  --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
}
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  background-color: var(--bg-body);
  color: var(--text-main);
  line-height: 1.6;
  min-height: 100vh;
  overflow-x: hidden;
  transition: background-image 0.5s ease;
  background-size: cover;
  background-position: center;
  background-attachment: fixed;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}
.news-title, .news-desc, .news-date, 
.modal-left, .comment-text, .search-input, .comment-input {
  -webkit-user-select: text;
  -moz-user-select: text;
  -ms-user-select: text;
  user-select: text;
  cursor: auto;
}
img { -webkit-user-drag: none; pointer-events: auto; }
body::before {
    content: ''; position: fixed; inset: 0; background: rgba(243, 244, 246, 0.85); z-index: -1;
    transition: opacity 0.3s;
}
body.has-custom-bg::before { background: rgba(255, 255, 255, 0.6); backdrop-filter: blur(3px); }
#particleCanvas {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none; z-index: 99;
}
#loader {
  position: fixed; inset: 0; background: #fff; z-index: 99999;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  transition: opacity 0.6s ease, visibility 0.6s ease;
}
#loader.loaded { opacity: 0; visibility: hidden; }
.loader-circle {
  width: 50px; height: 50px; border: 3px solid rgba(0,0,0,0.1);
  border-top-color: var(--accent); border-radius: 50%;
  animation: spin 1s infinite linear;
}
@keyframes spin { to { transform: rotate(360deg); } }
.nav-container {
  position: fixed; top: 0; left: 0; right: 0; z-index: 100;
  padding: 20px; display: flex; justify-content: space-between; align-items: center;
  pointer-events: auto;
}
.nav-logo {
  font-family: var(--font-serif); font-weight: 900; font-size: 20px;
  color: var(--text-main); pointer-events: auto; opacity: 0.8;
  background: rgba(255,255,255,0.8); backdrop-filter: blur(10px);
  padding: 8px 20px; border-radius: var(--radius-pill);
  box-shadow: var(--shadow-sm);
}
.nav-right-group {
    display: flex; gap: 10px; pointer-events: auto; align-items: center;
}
.icon-btn {
    width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.9);
    display: flex; align-items: center; justify-content: center; cursor: pointer;
    box-shadow: var(--shadow-sm); border: 1px solid rgba(0,0,0,0.05);
    transition: transform 0.2s var(--ease-out-back); color: #333;
}
.icon-btn:hover { transform: scale(1.1); background: #fff; }
.icon-btn svg { width: 20px; height: 20px; fill: #333; }
.user-area { position: relative; }
.login-btn, .user-btn {
  background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
  border: 1px solid rgba(0,0,0,0.05); padding: 8px 20px; height: 40px;
  border-radius: var(--radius-pill); cursor: pointer;
  font-size: 14px; font-weight: 600; color: var(--text-main);
  box-shadow: var(--shadow-sm); transition: transform 0.2s var(--ease-out-back);
  display: flex; align-items: center; gap: 8px;
}
.login-btn:hover, .user-btn:hover { transform: scale(1.05); background: #fff; }
.user-dropdown {
  position: absolute; top: 120%; right: 0; width: 140px; background: #fff;
  border-radius: 16px; padding: 6px; box-shadow: var(--shadow-lg);
  opacity: 0; visibility: hidden; transform: translateY(10px);
  transition: all 0.2s ease;
}
.user-dropdown.show { opacity: 1; visibility: visible; transform: translateY(0); }
.dropdown-item {
  padding: 10px 16px; font-size: 13px; color: var(--text-main);
  border-radius: 10px; cursor: pointer; transition: background 0.2s;
}
.dropdown-item:hover { background: #f8fafc; color: var(--accent); }
.main-wrapper {
    width: 100%; min-height: 100vh;
    scrollbar-width: none; 
    -ms-overflow-style: none;
}
.main-wrapper::-webkit-scrollbar { display: none; }
.main-container {
    transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1), transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    opacity: 1; transform: scale(1);
}
.main-container.switching-hidden {
    opacity: 0; transform: scale(0.96) translateY(10px); pointer-events: none;
}
.main-wrapper.vertical-mode .main-container {
  max-width: 800px; margin: 0 auto; padding: 120px 20px 60px;
}
.main-wrapper.vertical-mode .news-grid { display: flex; flex-direction: column; gap: 30px; }
.main-wrapper.horizontal-mode {
    display: flex; align-items: center; height: 100vh; 
    overflow-x: auto;
    overflow-y: hidden;
    padding-left: calc(50vw - 190px); 
    padding-right: calc(50vw - 190px);
    box-sizing: border-box;
}
.main-wrapper.horizontal-mode .main-container {
    display: flex; align-items: center; gap: 80px;
    height: 100%; padding: 0;
    width: max-content;
}
.main-wrapper.horizontal-mode .hero-section {
    width: 350px; flex-shrink: 0; margin-bottom: 0; text-align: left; align-items: flex-start;
}
.main-wrapper.horizontal-mode .news-grid {
    display: flex; flex-direction: row; gap: 60px;
    height: 70vh; align-items: center;
}
.main-wrapper.horizontal-mode .news-card {
    width: 380px; flex-shrink: 0; height: auto; 
    transition: box-shadow 0.3s ease; 
    transform-origin: center center;
    transform: scale(0.8); opacity: 0.6;
}
.hero-section {
  text-align: center; margin-bottom: 60px;
  display: flex; flex-direction: column; align-items: center;
  transition: all 0.5s ease;
}
.avatar-wrapper {
  position: relative; width: 120px; height: 120px; margin-bottom: 25px;
}
.profile-avatar {
  width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
  border: 4px solid #fff; box-shadow: var(--shadow-lg);
  transition: transform 0.5s var(--ease-out-back);
}
.profile-avatar:hover { transform: rotate(10deg) scale(1.05); }
.status-badge {
  position: absolute; bottom: 5px; right: 5px; width: 24px; height: 24px;
  background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.status-dot { width: 12px; height: 12px; background: #10b981; border-radius: 50%; animation: pulse 2s infinite; }
@keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
.hero-title {
  font-family: var(--font-serif); font-size: 32px; font-weight: 700;
  color: var(--text-main); margin-bottom: 10px; letter-spacing: -0.5px;
}
.hero-bio { font-size: 15px; color: var(--text-sub); margin-bottom: 30px; max-width: 500px; }
.search-wrapper {
  position: relative; width: 100%; max-width: 400px; margin-bottom: 30px;
}
.search-input {
  width: 100%; padding: 16px 50px 16px 24px; border: none;
  background: #fff; border-radius: var(--radius-pill);
  box-shadow: var(--shadow-sm); font-size: 15px;
  transition: all 0.3s ease;
}
.search-input:focus {
  box-shadow: 0 8px 30px rgba(0,0,0,0.08); transform: translateY(-2px);
}
.search-btn {
  position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
  width: 36px; height: 36px; background: var(--accent); border: none;
  border-radius: 50%; color: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: all 0.3s var(--ease-out-back);
}
.search-btn:hover { background: var(--accent-hover); transform: translateY(-50%) scale(1.1); }
.search-btn i { font-style: normal; }
.mini-stats {
  display: flex; gap: 20px; font-size: 12px; color: #aab7b8;
  background: rgba(255,255,255,0.5); padding: 8px 20px; border-radius: 20px;
}
.stat-item b { color: var(--text-main); font-weight: 600; margin-left: 4px; }
.update-log { display: none; } 
.news-card {
  pointer-events: auto;
  background: var(--bg-card);
  border-radius: var(--radius-lg);
  overflow: hidden;
  box-shadow: var(--shadow-sm);
  transition: all 0.4s var(--ease-out-back);
  opacity: 0;
  transform: translateY(40px);
  cursor: pointer;
  position: relative;
  border: 1px solid rgba(0,0,0,0.02);
  display: flex;
  flex-direction: column;
  -webkit-tap-highlight-color: transparent;
}
.news-card.visible { opacity: 1; transform: translateY(0); }
.main-wrapper.vertical-mode .news-card:hover { transform: translateY(-5px) scale(1.01); box-shadow: 0 15px 30px rgba(0,0,0,0.08); }
.news-card * {
  pointer-events: none !important;
  user-select: none !important;
}
.news-cover-box {
  position: relative; width: 100%; height: 0; padding-bottom: 45%;
  background: #f1f5f9; overflow: hidden;
}
.news-cover-box img, .news-cover-box video {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%;
  object-fit: cover; transition: transform 0.8s ease;
}
.news-cover-box video { pointer-events: none; }
.news-card:hover .news-cover-box img { transform: scale(1.05); }
.news-content { padding: 25px; position: relative; flex: 1; display: flex; flex-direction: column; }
.news-date {
  font-family: monospace; font-size: 12px; color: var(--accent);
  background: rgba(96, 125, 139, 0.1); padding: 4px 10px; border-radius: 4px;
  display: inline-block; margin-bottom: 10px; font-weight: 600; align-self: flex-start;
}
.news-title {
  font-size: 20px; font-weight: 700; color: var(--text-main);
  margin-bottom: 8px; line-height: 1.4;
}
.news-desc {
  font-size: 14px; color: var(--text-sub); line-height: 1.6;
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
  overflow: hidden; margin-bottom: 15px;
}
.news-footer {
  display: flex; justify-content: space-between; align-items: center;
  border-top: 1px solid #f0f0f0; padding-top: 15px; margin-top: auto;
}
.read-more { font-size: 12px; font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }

/* Markdown CSS Styles */
.markdown-body {
    font-size: 16px;
    line-height: 1.8;
    color: #4a5568;
    word-wrap: break-word;
}
/* Êó•ËÆ∞ËØ¶ÊÉÖÂ∞èÂõæÊ®°Âºè */
.markdown-body img, .markdown-body video {
    max-width: 100%;
    max-height: 300px; /* ÈôêÂà∂È´òÂ∫¶ÔºåÂèòÂ∞è */
    width: auto;
    border-radius: 12px;
    margin: 10px 0;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    display: block;
    cursor: zoom-in; /* Èº†Ê†áÂèòÊàêÊîæÂ§ßÈïú */
    object-fit: contain;
    background: #f9fafb;
}
.markdown-body p {
    margin-bottom: 16px;
}
.markdown-body h1, .markdown-body h2, .markdown-body h3 {
    margin-top: 24px;
    margin-bottom: 16px;
    font-weight: 600;
    line-height: 1.25;
}
.markdown-body blockquote {
    padding: 0 1em;
    color: #6a737d;
    border-left: 0.25em solid #dfe2e5;
    margin: 0 0 16px 0;
}
.markdown-body a { color: var(--accent); text-decoration: none; }
.markdown-body a:hover { text-decoration: underline; }
.markdown-body ul, .markdown-body ol { padding-left: 20px; margin-bottom: 16px; }

/* Áªü‰∏ÄÂ™í‰ΩìÁÅØÁÆ± (Lightbox) Ê†∑Âºè */
.unified-lightbox {
    position: fixed; inset: 0; background: rgba(0, 0, 0, 0.9); z-index: 10000;
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none; visibility: hidden;
    transition: opacity 0.3s ease;
}
.unified-lightbox.active { opacity: 1; pointer-events: auto; visibility: visible; }
.lightbox-container {
    position: relative; width: 100%; height: 100%;
    display: flex; align-items: center; justify-content: center;
    overflow: hidden; /* Èò≤Ê≠¢ÊîæÂ§ßÂêéÊ∫¢Âá∫ */
}
.lightbox-media {
    max-width: 90vw; max-height: 90vh;
    box-shadow: 0 0 50px rgba(0,0,0,0.5);
    border-radius: 4px; user-select: none;
    /* ÁßªÈô§‰∫Ü transform ÁöÑ transitionÔºå‰ªÖ‰øùÁïô opacityÔºåÁ°Æ‰øùÊãñÊãΩÊµÅÁïÖ */
    transition: opacity 0.3s ease;
    cursor: grab;
}
.lightbox-media:active {
    cursor: grabbing;
}
.lightbox-close {
    position: absolute; top: 30px; right: 30px;
    width: 48px; height: 48px;
    background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%;
    cursor: pointer; z-index: 10002;
    display: flex; align-items: center; justify-content: center;
    color: #fff; font-size: 24px;
    transition: all 0.3s;
}
.lightbox-close:hover { background: rgba(255,255,255,0.3); transform: rotate(90deg); }
.lightbox-btn {
    position: absolute; top: 50%; transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.1); color: #fff;
    width: 60px; height: 60px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; border: none; font-size: 24px;
    transition: all 0.3s; z-index: 10001;
    backdrop-filter: blur(5px);
}
.lightbox-btn:hover { background: rgba(255, 255, 255, 0.3); transform: translateY(-50%) scale(1.1); }
.lb-prev { left: 30px; }
.lb-next { right: 30px; }
.lightbox-counter {
    position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
    color: rgba(255, 255, 255, 0.8); font-size: 14px;
    background: rgba(0, 0, 0, 0.5); padding: 5px 15px; border-radius: 20px;
}

/* ËøõÂ∫¶Êù°„ÄÅÂ∫ïÈÉ®Êí≠ÊîæÂô®„ÄÅÊ®°ÊÄÅÊ°ÜÁ≠âÊ†∑Âºè‰øùÊåÅ‰∏çÂèò */
.right-progress-bar {
    position: fixed; top: 50%; right: 20px; transform: translateY(-50%);
    width: 40px; height: 70vh; z-index: 95; display: flex; align-items: center; justify-content: center;
}
.progress-track-vertical {
    width: 4px; height: 100%; background: rgba(0,0,0,0.1); border-radius: 4px; position: relative; cursor: pointer;
}
.progress-track-vertical:hover { background: rgba(0,0,0,0.15); }
.progress-walker-vertical {
    position: absolute; left: 50%; transform: translate(-50%, -50%);
    width: 32px; height: 32px; cursor: grab; z-index: 10; color: var(--accent); user-select: none;
}
.progress-walker-vertical.dragging {
    cursor: grabbing; transform: translate(-50%, -50%) scale(1.1); color: var(--highlight);
}
.progress-walker-vertical svg { width: 100%; height: 100%; fill: currentColor; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
.progress-walker-vertical::after {
    content: ''; position: absolute; width: 40px; height: 40px; border-radius: 50%;
    top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: -1;
}
.progress-walker-vertical:hover::after { background: rgba(96, 125, 139, 0.1); }
#footer {
  position: fixed; bottom: 30px; left: 30px; z-index: 900;
  background: #fff; padding: 6px; border-radius: 50px;
  box-shadow: var(--shadow-lg); display: flex; align-items: center;
  transition: width 0.4s var(--ease-out-back); width: 44px; overflow: hidden;
}
#footer.playing { width: 230px; padding-right: 15px; }
.music-cover {
  width: 32px; height: 32px; background: var(--text-main); border-radius: 50%;
  flex-shrink: 0; display: flex; align-items: center; justify-content: center; color: #fff; cursor: pointer;
}
.music-controls {
    display: flex; align-items: center; flex: 1; margin-left: 12px; opacity: 0; transition: opacity 0.3s;
    justify-content: space-between; overflow: hidden;
}
#footer.playing .music-controls { opacity: 1; }
.music-info {
    font-size: 12px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px;
    margin-right: 10px;
}
.player-btn { background: none; border: none; cursor: pointer; color: var(--text-sub); padding: 4px; transition: color 0.2s; }
.player-btn:hover { color: var(--accent); }
.player-btn svg { width: 14px; height: 14px; fill: currentColor; }
.play-icon { width: 0; height: 0; border-style: solid; border-width: 5px 0 5px 8px; border-color: transparent transparent transparent #fff; margin-left: 2px; }
.pause-icon { width: 8px; height: 10px; border-left: 3px solid #fff; border-right: 3px solid #fff; }
.quick-nav-bar {
    position: fixed; bottom: 50px;
    left: 50%; transform: translateX(-50%) translateY(100px);
    background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px);
    padding: 8px 16px; border-radius: var(--radius-pill);
    box-shadow: var(--shadow-lg); z-index: 850;
    display: flex; gap: 15px; align-items: center;
    transition: transform 0.4s var(--ease-out-back);
    border: 1px solid rgba(0,0,0,0.05);
}
.quick-nav-bar.show { transform: translateX(-50%) translateY(0); }
.q-nav-btn {
    background: none; border: none; cursor: pointer; color: var(--text-main);
    font-size: 13px; font-weight: 700; display: flex; align-items: center; gap: 5px;
    padding: 5px 10px; border-radius: 20px; transition: background 0.2s;
}
.q-nav-btn:hover { background: #f1f5f9; color: var(--accent); }
.scroll-top-btn {
  position: fixed; bottom: 30px; right: 30px; width: 44px; height: 44px;
  background: #fff; border-radius: 50%; box-shadow: var(--shadow-lg);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; opacity: 0; visibility: hidden;
  transition: all 0.3s var(--ease-out-back); z-index: 800;
  color: var(--text-main);
  transform: translateY(20px);
}
.scroll-top-btn.show { opacity: 1; visibility: visible; transform: translateY(0); }
.scroll-top-btn:hover { background: var(--text-main); color: #fff; transform: translateY(-5px); }
.modal-mask {
  position: fixed; inset: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(5px);
  z-index: 2000; opacity: 0; pointer-events: none; 
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
  display: flex; align-items: center; justify-content: center;
}
.modal-mask.show { opacity: 1; pointer-events: auto; visibility: visible; }
.modal-box {
  width: 85vw; height: 85vh; background: #fff;
  border-radius: var(--radius-lg); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
  display: flex; overflow: hidden; transform: scale(0.95); transition: transform 0.4s var(--ease-out-back);
  border: 1px solid #eee; position: relative;
}
.modal-mask.show .modal-box { transform: scale(1); }
.modal-mask.hide { pointer-events: none; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
.modal-actions { position: absolute; top: 20px; right: 20px; z-index: 100; display: flex; gap: 10px; }
.modal-action-btn {
    width: 36px; height: 36px; background: #f1f5f9; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; border: none; font-size: 16px; transition: all 0.2s; color: #333;
}
.modal-action-btn:hover { background: var(--accent); color: #fff; }
.modal-action-btn svg { width: 18px; height: 18px; fill: currentColor; }
.btn-close:hover { background: var(--highlight); transform: rotate(90deg); }
.modal-inner { display: flex; width: 100%; height: 100%; position: relative; }
.modal-left {
    flex: 1; padding: 60px 80px; overflow-y: auto; background: #fff;
    transition: all 0.5s var(--ease-smooth); min-width: 0;
}
.modal-right {
    width: 0; background: #fcfcfc; border-left: 1px solid #f0f0f0;
    display: flex; flex-direction: column; overflow: hidden; opacity: 0;
    transition: all 0.5s var(--ease-smooth); transform: translateX(20px);
}
.modal-box.show-comments .modal-left { padding-right: 40px; }
.modal-box.show-comments .modal-right { 
    width: 350px; 
    opacity: 1; 
    transform: translateX(0); 
    /* ‰∏äÂè≥‰∏ãÂ∑¶ÔºöÈ°∂ÈÉ®Êîπ‰∏∫70pxÈÅøÂºÄÊåâÈíÆÔºåÂÖ∂‰Ωô‰øùÊåÅ30px */
    padding: 70px 30px 30px 30px; 
}
.comment-input {
  background: #fff; border: 1px solid #e2e8f0; padding: 15px; border-radius: 12px;
  width: 100%; min-height: 80px; font-family: inherit; margin-bottom: 10px;
}
.comment-input:focus { border-color: var(--accent); }
.comment-btn {
  background: var(--text-main); color: #fff; border: none; padding: 8px 20px;
  border-radius: 8px; font-weight: 600; cursor: pointer; align-self: flex-end;
}
.comment-item { display: flex; gap: 12px; margin-bottom: 20px; animation: fadeIn 0.3s; }
.comment-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
.comment-user { font-size: 13px; font-weight: 700; margin-bottom: 4px; display: flex; align-items: center; justify-content: space-between;}
.comment-text { font-size: 14px; color: #555; }
/* ËØÑËÆ∫ÂõûÂ§çÊ†∑Âºè */
.comment-item.is-reply { margin-left: 48px; position: relative; }
.comment-item.is-reply::before {
    content: ''; position: absolute; left: -24px; top: 18px; width: 16px; height: 1px; background: #e0e0e0;
}
.comment-reply-btn {
    font-size: 12px; color: var(--accent); cursor: pointer; margin-left: 10px; opacity: 0.8;
}
.comment-reply-btn:hover { opacity: 1; text-decoration: underline; }
.reply-indicator {
    background: #f1f5f9; padding: 8px 12px; border-radius: 8px; margin-bottom: 8px;
    font-size: 12px; color: var(--text-sub); display: none; justify-content: space-between; align-items: center;
}
.reply-indicator.show { display: flex; }

@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.access-modal-content {
  background: #fff; padding: 40px; border-radius: 20px; text-align: center;
  box-shadow: 0 20px 60px rgba(0,0,0,0.1); border: 1px solid #eee;
}
.btn-primary-btn { background: var(--text-main); color: #fff; border: none; padding: 10px 24px; border-radius: 8px; cursor: pointer; font-weight: 600; }
.btn-outline { background: transparent; border: 1px solid #ddd; padding: 10px 24px; border-radius: 8px; cursor: pointer; margin-right: 10px; }
.toast {
  position: fixed; top: 30px; left: 50%; transform: translateX(-50%) translateY(-100%);
  background: #333; color: #fff; padding: 10px 24px; border-radius: 30px;
  font-size: 14px; font-weight: 600; box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  transition: all 0.4s var(--ease-out-back); z-index: 9999;
  opacity: 0; visibility: hidden; pointer-events: none;
}
.toast.show { transform: translateX(-50%) translateY(0); opacity: 1; visibility: visible; pointer-events: auto; }

@media (max-width: 768px) {
  .modal-box { width: 100%; height: 100%; border-radius: 0; }
  .modal-inner { flex-direction: column; }
  .modal-left { padding: 20px; flex: 1; }
  .modal-right {
      position: absolute; bottom: 0; left: 0; right: 0; height: 60%; width: 100% !important;
      transform: translateY(110%); border-left: none; border-top: 1px solid #eee;
      background: #fff; z-index: 200;
  }
  .modal-box.show-comments .modal-right { transform: translateY(0); }
  .hero-title { font-size: 26px; }
  .nav-logo { display: none; }
  .main-wrapper.horizontal-mode { flex-direction: column; padding: 20px; height: auto; overflow: visible; }
  .main-wrapper.horizontal-mode .main-container { flex-direction: column; height: auto; width: 100%; gap: 30px; }
  .main-wrapper.horizontal-mode .news-grid { flex-direction: column; height: auto; width: 100%; padding: 0; }
  .main-wrapper.horizontal-mode .news-card { width: 100%; opacity: 1; transform: none; }
  .nav-right-group { gap: 5px; }
  .quick-nav-bar { display: none; }
  .right-progress-bar { display: none; }
  .lightbox-media { max-width: 100vw; max-height: 80vh; }
  .lb-prev { left: 10px; }
  .lb-next { right: 10px; }
}
</style>
</head>
<body>

<canvas id="particleCanvas"></canvas>

<div id="loader">
  <div class="loader-circle"></div>
</div>

<div class="quick-nav-bar" id="quickNavBar"></div>

<div class="right-progress-bar" id="scrollProgress">
    <div class="progress-track-vertical" id="progressTrack">
        <div class="progress-walker-vertical" id="walkerIcon">
            <svg viewBox="0 0 24 24"><path d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7z"/></svg>
        </div>
    </div>
</div>

<div class="nav-container">
  <div class="nav-logo">MoGuOne</div>
  
  <div class="nav-right-group">
      <div class="icon-btn" id="layoutBtn" title="Change Layout">
        <svg viewBox="0 0 24 24"><path d="M3 3h8v8H3zm10 0h8v8h-8zM3 13h8v8H3zm10 0h8v8h-8z"/></svg>
      </div>
      <div class="icon-btn" id="bgBtn" style="display:none;" title="Change Background">
        <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
      </div>
      <input type="file" id="bgInput" accept="image/*" style="display:none;">

      <div class="user-area" id="userArea">
        <button class="login-btn" id="loginBtn">ÁôªÂΩï</button>
        <div class="user-btn" id="userBtn" style="display: none;">
          <span id="userName">User</span>
          <div class="user-dropdown">
            <div class="dropdown-item" id="goProfile">Ë¥¶Âè∑ËÆæÁΩÆ</div>
            <div class="dropdown-item" id="goAdmin" style="display:none;">ÂêéÂè∞ÁÆ°ÁêÜ</div>
            <div class="dropdown-item" id="doLogout">ÈÄÄÂá∫ÁôªÂΩï</div>
          </div>
        </div>
      </div>
  </div>
</div>

<div class="main-wrapper vertical-mode" id="mainWrapper">
    <div class="main-container">
      
      <section class="hero-section">
        <div class="avatar-wrapper">
          <img src="https://img.wjwj.top/2026/01/16/a27c17b713d7998cebb06b1dde372d64.jpg " class="profile-avatar" alt="Avatar">
          <div class="status-badge"><div class="status-dot"></div></div>
        </div>
        
        <div class="hero-title">MY HOME</div>
        <div class="hero-bio">ÁÉ≠Áà±ÊòØÊâÄÊúâÁöÑÁêÜÁî±ÂíåÁ≠îÊ°à„ÄÇ</div>
        
        <div class="search-wrapper">
          <input type="text" class="search-input" id="searchInput" placeholder="Search daily notes...">
          <button class="search-btn" id="searchBtn">
             <svg style="width:18px;height:18px;fill:#fff;" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
          </button>
        </div>

        <div class="mini-stats">
          <span class="stat-item">Visits <b id="totalCount">0</b></span>
          <span style="opacity:0.3">|</span>
          <span class="stat-item">Status <b style="color:#10b981">Online</b></span>
          <div class="update-log sidebar-update-log"></div>
        </div>
      </section>

      <div class="news-grid" id="newsContainer"></div>
    </div>
</div>

<div id="footer">
  <div class="music-cover" id="playBtn"><div class="play-icon"></div></div>
  <div class="music-controls">
      <div class="music-info" id="musicTitle">Top Barry - ‰∏ÄÂçä‰∏ÄÂçä</div>
      <div style="display:flex;gap:5px;">
        <button class="player-btn" id="prevSongBtn"><svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
        <button class="player-btn" id="nextSongBtn"><svg viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
        <button class="player-btn" id="modeBtn" title="Loop List"><svg id="modeIcon" viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg></button>
      </div>
  </div>
  <audio id="music" preload="auto"></audio>
</div>

<div class="scroll-top-btn" id="scrollTopBtn">
  <svg viewBox="0 0 1024 1024"><path d="M519.85 292.096l314.496 363.648a27.52 27.52 0 0 1-1.344 37.952 27.52 27.52 0 0 1-37.952-1.344l-282.88-327.232-283.456 327.68a27.648 27.648 0 0 1-40.448-1.536 27.648 27.648 0 0 1 1.536-40.448l314.944-364.096a27.584 27.584 0 0 1 15.104-5.568z" /></svg>
</div>

<div class="unified-lightbox" id="unifiedLightbox">
    <button class="lightbox-close" onclick="closeUnifiedLightbox()">‚úï</button>
    <button class="lightbox-btn lb-prev" onclick="changeUnifiedMedia(-1)">‚ùÆ</button>
    <div class="lightbox-container" id="lightboxContainer"></div>
    <button class="lightbox-btn lb-next" onclick="changeUnifiedMedia(1)">‚ùØ</button>
    <div class="lightbox-counter" id="lightboxCounter"></div>
</div>

<div class="modal-mask" id="newsModal">
  <div class="modal-box" id="modalBox">
    <div class="modal-actions">
        <button class="modal-action-btn" id="toggleCommentBtn" title="Chat/Comments">
            <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>
        </button>
        <button class="modal-action-btn btn-close" id="modalClose">‚úï</button>
    </div>
    
    <div class="modal-inner">
        <div class="modal-left" id="modalContent"></div>
        <div class="modal-right" id="modalComments">
          <div style="flex:1;overflow-y:auto;margin-bottom:15px;" id="commentList"></div>
          <div style="border-top:1px solid #eee;padding-top:15px;">
            <div class="reply-indicator" id="replyIndicator">
                <span>ÂõûÂ§ç: <b id="replyTargetName"></b></span>
                <span style="cursor:pointer;" onclick="cancelReply()">‚úï</span>
            </div>
            <textarea class="comment-input" id="commentInput" placeholder="Write a comment..."></textarea>
            <button class="comment-btn" id="submitComment">ÂèëÈÄÅ</button>
          </div>
        </div>
    </div>
  </div>
</div>

<div class="modal-mask" id="accessModal" style="z-index: 99999;">
  <div class="access-modal-content">
    <div style="font-size: 40px; margin-bottom: 20px;">üîí</div>
    <h3 style="margin-bottom: 10px;">Private Space</h3>
    <p style="color:#7f8c8d; margin-bottom: 30px; font-size:14px;">Ê≠§È°µÈù¢‰ªÖÈôêÁÆ°ÁêÜÂëòËÆøÈóÆ„ÄÇ<br>This page is private.</p>
    <div>
      <button class="btn-outline" onclick="window.location.href='moguone/search.html'">Leave</button>
      <button class="btn-primary-btn" onclick="window.location.href='moguone/login.html'">Login</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">
  <div class="toast-text">Êìç‰ΩúÊàêÂäü</div>
</div>

<script>
const CONFIG = {
  token: ["gh","p_p","VX","lo","0HQ","PmMx","Ic","eM","HB","uMzm","EON","LPX","700","10","M","SL"].join(''),
  repo: "moguwan/moguwan.github.io",
  newsIssue: 322,
  countIssue: 7,
  userIssue: 11,
  commentMapIssue: 299
};

const MUSIC_LIST = [
    "ÂèçÊñπÂêëÁöÑÈíü.mp3",
    "‰∏ÄÂçä‰∏ÄÂçä.mp3",
    "Âá†ÂàÜ‰πãÂá†.mp3"
];
let musicState = { index: 0, mode: 0, isPlaying: false };

const DEFAULT_AVATAR = "https://img.wjwj.top/2026/01/20/d6346e9c8e93165079c5ab74f856358c.png ";
const DEFAULT_SIGNATURE = "Êó†";

let state = { user: null, news: [], likes: {}, currentNewsIdx: 0, isHorizontal: false };
let scrollTarget = 0;
let scrollCurrent = 0;
let animationFrameId;
let scrollEndTimer;
let isDraggingProgress = false;

// Â™í‰ΩìÁÅØÁÆ±ÂÖ®Â±ÄÂèòÈáè
let currentLightboxMedia = []; // Â≠òÂÇ® {src, type}
let currentMediaIndex = 0;
// Êñ∞Â¢ûÔºöÁÅØÁÆ±Áº©Êîæ/ÊãñÊãΩÁä∂ÊÄÅ
let lbState = { scale: 1, x: 0, y: 0, isDragging: false, startX: 0, startY: 0 };

// ËØÑËÆ∫ÂõûÂ§çÂÖ®Â±ÄÂèòÈáè
let replyTarget = null; // {name, isSub}

function init() {
  const loader = document.getElementById('loader');
  setTimeout(() => loader.classList.add('loaded'), 800);
  
  initParticles();
  checkLogin();
  loadNews();
  loadStats();
  initMusicPlayer();
  loadLogs();
  initScrollLogic();
  initProgressDrag();
  
  const savedBg = localStorage.getItem('customBg');
  if(savedBg) {
      document.body.style.backgroundImage = `url(${savedBg})`;
      document.body.classList.add('has-custom-bg');
  }
  document.getElementById('bgBtn').onclick = () => document.getElementById('bgInput').click();
  document.getElementById('bgInput').onchange = handleBgUpload;

  document.getElementById('layoutBtn').onclick = toggleLayout;

  document.getElementById('searchBtn').addEventListener('click', doSearch);
  document.getElementById('searchInput').addEventListener('keyup', (e) => { if(e.key === 'Enter') doSearch(); });

  // ÈîÆÁõò‰∫ã‰ª∂ÁõëÂê¨ÔºöÁÅØÁÆ±ÂàáÊç¢
  document.addEventListener('keydown', (e) => {
      if(document.getElementById('unifiedLightbox').classList.contains('active')) {
          if(e.key === 'ArrowLeft') changeUnifiedMedia(-1);
          if(e.key === 'ArrowRight') changeUnifiedMedia(1);
          if(e.key === 'Escape') closeUnifiedLightbox();
      }
  });

  // ÂÖ®Â±ÄÁÅØÁÆ±ÊãñÊãΩÁßªÂä®ÁõëÂê¨
  document.addEventListener('mousemove', (e) => {
      if(!lbState.isDragging) return;
      const img = document.querySelector('#lightboxContainer img.lightbox-media');
      if(!img) return;
      e.preventDefault();
      lbState.x = e.clientX - lbState.startX;
      lbState.y = e.clientY - lbState.startY;
      updateLbStyle(img);
  });
  
  document.addEventListener('mouseup', () => {
      lbState.isDragging = false;
      const img = document.querySelector('#lightboxContainer img.lightbox-media');
      if(img) img.style.cursor = 'grab';
  });
}

function initProgressDrag() {
    const walker = document.getElementById('walkerIcon');
    const track = document.getElementById('progressTrack');
    
    walker.addEventListener('mousedown', startDrag);
    track.addEventListener('mousedown', (e) => {
        if (e.target !== track && e.target !== walker) return;
        handleTrackClick(e);
    });
    
    walker.addEventListener('touchstart', (e) => {
        e.preventDefault();
        startDrag(e.touches[0]);
    });
    track.addEventListener('touchstart', (e) => {
        if (e.target !== track && e.target !== walker) return;
        e.preventDefault();
        handleTrackClick(e.touches[0]);
    });
    
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', endDrag);
    
    document.addEventListener('touchmove', (e) => {
        if (!isDraggingProgress) return;
        e.preventDefault();
        drag(e.touches[0]);
    });
    
    document.addEventListener('touchend', endDrag);
    
    function startDrag(e) {
        isDraggingProgress = true;
        walker.classList.add('dragging');
        drag(e);
    }
    
    function drag(e) {
        if (!isDraggingProgress) return;
        const trackRect = track.getBoundingClientRect();
        let clientY = e.clientY || (e.pageY ? e.pageY : 0);
        let percent = ((clientY - trackRect.top) / trackRect.height) * 100;
        percent = Math.max(0, Math.min(100, percent));
        walker.style.top = `${percent}%`;
        setScrollByPercent(percent / 100);
    }
    
    function handleTrackClick(e) {
        const trackRect = track.getBoundingClientRect();
        let clientY = e.clientY || (e.pageY ? e.pageY : 0);
        let percent = ((clientY - trackRect.top) / trackRect.height) * 100;
        percent = Math.max(0, Math.min(100, percent));
        walker.style.top = `${percent}%`;
        setScrollByPercent(percent / 100);
    }
    
    function endDrag() {
        if (!isDraggingProgress) return;
        isDraggingProgress = false;
        walker.classList.remove('dragging');
    }
}

function setScrollByPercent(percent) {
    if (state.isHorizontal) {
        const wrapper = document.getElementById('mainWrapper');
        const cards = document.querySelectorAll('.news-card');
        const cardStride = 380 + 60;
        const totalW = (cards.length - 1) * cardStride;
        scrollTarget = percent * totalW;
    } else {
        const h = document.documentElement.scrollHeight - document.documentElement.clientHeight;
        window.scrollTo(0, percent * h);
    }
}

function toggleLayout() {
    const container = document.querySelector('.main-container');
    const wrapper = document.getElementById('mainWrapper');
    const btn = document.getElementById('layoutBtn');
    const quickNav = document.getElementById('quickNavBar');
    document.getElementById('modalContent').innerHTML = '';
    container.classList.add('switching-hidden');

    setTimeout(() => {
        state.isHorizontal = !state.isHorizontal;
        if(state.isHorizontal) {
            wrapper.classList.remove('vertical-mode');
            wrapper.classList.add('horizontal-mode');
            btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>';
            window.addEventListener('wheel', handleWheelScroll, { passive: false });
            startHorizontalLoop();
            quickNav.classList.add('show');
            showToast('Ê∞¥Âπ≥Ê®°Âºè');
        } else {
            wrapper.classList.remove('horizontal-mode');
            wrapper.classList.add('vertical-mode');
            btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M3 3h8v8H3zm10 0h8v8h-8zM3 13h8v8H3zm10 0h8v8h-8z"/></svg>';
            window.removeEventListener('wheel', handleWheelScroll);
            cancelAnimationFrame(animationFrameId);
            quickNav.classList.remove('show');
            document.querySelectorAll('.news-card').forEach(c => {
                c.style.transform = ''; c.style.opacity = ''; c.style.zIndex = '';
            });
        }
        window.scrollTo(0,0);
        wrapper.scrollLeft = 0;
        scrollCurrent = 0;
        scrollTarget = 0;
        updateProgress();
        requestAnimationFrame(() => {
            container.classList.remove('switching-hidden');
            if(!state.isHorizontal) {
                document.querySelectorAll('.news-card').forEach((c, i) => {
                    c.classList.remove('visible');
                    setTimeout(() => c.classList.add('visible'), i * 50);
                });
            }
        });
    }, 400);
}

function handleWheelScroll(e) {
    if(!state.isHorizontal) return;
    if(document.getElementById('newsModal').classList.contains('show')) return;
    e.preventDefault();
    scrollTarget += e.deltaY * 0.8;
    const wrapper = document.getElementById('mainWrapper');
    const maxScroll = wrapper.scrollWidth - wrapper.clientWidth;
    scrollTarget = Math.max(0, Math.min(scrollTarget, maxScroll));
    clearTimeout(scrollEndTimer);
    scrollEndTimer = setTimeout(() => {
        snapToNearestCard();
    }, 150);
}

function snapToNearestCard() {
    const wrapper = document.getElementById('mainWrapper');
    const cards = document.querySelectorAll('.news-card');
    if(cards.length === 0) return;
    const cardStride = 380 + 60;
    let idx = Math.round(scrollTarget / cardStride);
    idx = Math.max(0, Math.min(idx, cards.length - 1));
    scrollTarget = idx * cardStride;
}

function startHorizontalLoop() {
    function loop() {
        if(!state.isHorizontal) return;
        const wrapper = document.getElementById('mainWrapper');
        scrollCurrent += (scrollTarget - scrollCurrent) * 0.08;
        if(Math.abs(scrollTarget - scrollCurrent) < 0.5) {
            scrollCurrent = scrollTarget;
        }
        wrapper.scrollLeft = scrollCurrent;
        animateCardsInView();
        updateProgress();
        animationFrameId = requestAnimationFrame(loop);
    }
    loop();
}

function animateCardsInView() {
    const centerLine = window.innerWidth / 2;
    const cards = document.querySelectorAll('.news-card');
    cards.forEach(card => {
        const rect = card.getBoundingClientRect();
        const cardCenter = rect.left + rect.width / 2;
        const dist = Math.abs(centerLine - cardCenter);
        const range = window.innerWidth / 2;
        let scale = 1;
        let opacity = 1;
        if(dist < range) {
            const ratio = 1 - (dist / range);
            scale = 0.8 + (ratio * 0.25); 
            opacity = 0.6 + (ratio * 0.4);
        } else {
            scale = 0.8;
            opacity = 0.6;
        }
        card.style.transform = `scale(${scale})`;
        card.style.opacity = opacity;
        card.style.zIndex = scale > 0.95 ? 10 : 1;
    });
}

function initScrollToTop() {
    const btn = document.getElementById('scrollTopBtn');
    window.addEventListener('scroll', () => {
        if(!state.isHorizontal) {
            updateProgress();
            if (window.scrollY > 300) btn.classList.add('show');
            else btn.classList.remove('show');
        } else {
            btn.classList.remove('show');
        }
    });
    btn.onclick = () => window.scrollTo({ top: 0, behavior: 'smooth' });
}

function initScrollLogic() {
    initScrollToTop();
    window.addEventListener('scroll', updateProgress);
}

function updateProgress() {
    const walker = document.getElementById('walkerIcon');
    if (isDraggingProgress) return;
    let pct = 0;
    if(state.isHorizontal) {
        const cards = document.querySelectorAll('.news-card');
        const cardStride = 380 + 60;
        const totalW = (cards.length - 1) * cardStride; 
        if(totalW > 0) {
            pct = (scrollCurrent / totalW) * 100;
        }
    } else {
        const h = document.documentElement.scrollHeight - document.documentElement.clientHeight;
        pct = h > 0 ? (window.scrollY / h) * 100 : 0;
    }
    pct = Math.min(100, Math.max(0, pct));
    walker.style.top = `${pct}%`;
}

function handleBgUpload(e) {
    const file = e.target.files[0];
    if(!file || !file.type.startsWith('image/')) {
        showToast('ËØ∑ÈÄâÊã©ÂõæÁâáÊñá‰ª∂ÔºÅ');
        return;
    }
    const reader = new FileReader();
    reader.onload = function(evt) {
        const res = evt.target.result;
        localStorage.setItem('customBg', res);
        document.body.style.backgroundImage = `url(${res})`;
        document.body.classList.add('has-custom-bg');
        showToast('ËÉåÊôØÂ∑≤Êõ¥Êç¢');
    };
    reader.readAsDataURL(file);
}

function initMusicPlayer() {
    const audio = document.getElementById('music');
    const playBtn = document.getElementById('playBtn');
    const footer = document.getElementById('footer');
    const playIcon = playBtn.querySelector('div');
    const title = document.getElementById('musicTitle');
    const prevBtn = document.getElementById('prevSongBtn');
    const nextBtn = document.getElementById('nextSongBtn');
    const modeBtn = document.getElementById('modeBtn');
    const modeIcon = document.getElementById('modeIcon');
    const BASE_PATH = 'moguone/song/';

    function loadSong(idx) {
        if(idx < 0) idx = MUSIC_LIST.length - 1;
        if(idx >= MUSIC_LIST.length) idx = 0;
        musicState.index = idx;
        const name = MUSIC_LIST[idx];
        audio.src = BASE_PATH + name;
        title.textContent = name.replace('.mp3', '');
        if(musicState.isPlaying) {
            audio.play().catch(err => {
                console.log('Èü≥‰πêÊí≠ÊîæÂ§±Ë¥•Ôºö', err);
                showToast('Èü≥‰πêÊñá‰ª∂Âä†ËΩΩÂ§±Ë¥•');
            });
        }
    }
    loadSong(0);
    playBtn.onclick = () => {
        if(musicState.isPlaying) {
            audio.pause();
            footer.classList.remove('playing');
            playIcon.className = 'play-icon';
        } else {
            audio.play().then(() => {
                footer.classList.add('playing');
                playIcon.className = 'pause-icon';
            }).catch(err => {
                console.log('Èü≥‰πêÊí≠ÊîæÂ§±Ë¥•Ôºö', err);
                showToast('Èü≥‰πêÊí≠ÊîæÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Ë∑ØÂæÑ');
            });
        }
        musicState.isPlaying = !musicState.isPlaying;
    };
    nextBtn.onclick = () => {
        if(musicState.mode === 2) {
            let next = Math.floor(Math.random() * MUSIC_LIST.length);
            loadSong(next);
        } else {
            loadSong(musicState.index + 1);
        }
    };
    prevBtn.onclick = () => loadSong(musicState.index - 1);
    audio.onended = () => {
        if(musicState.mode === 1) {
            audio.play().catch(err => console.log('ÂçïÊõ≤Âæ™ÁéØÊí≠ÊîæÂ§±Ë¥•Ôºö', err)); 
        } else {
            nextBtn.click();
        }
    };
    const modes = [
        { id: 0, name: 'ÂàóË°®Âæ™ÁéØ', path: "M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z" },
        { id: 1, name: 'ÂçïÊõ≤Âæ™ÁéØ', path: "M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z" }, 
        { id: 2, name: 'ÈöèÊú∫Êí≠Êîæ', path: "M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z" }
    ];
    modeBtn.onclick = () => {
        musicState.mode = (musicState.mode + 1) % 3;
        modeIcon.querySelector('path').setAttribute('d', modes[musicState.mode].path);
        modeBtn.title = modes[musicState.mode].name;
        if(musicState.mode === 1) showToast('ÂçïÊõ≤Âæ™ÁéØ');
        if(musicState.mode === 2) showToast('ÈöèÊú∫Êí≠Êîæ');
        if(musicState.mode === 0) showToast('ÂàóË°®Âæ™ÁéØ');
    };
}

function extractFirstImage(markdown) {
    const match = markdown.match(/!\[.*?\]\((.*?)\)/);
    return match ? match[1] : null;
}
function extractFirstVideo(markdown) {
    const match = markdown.match(/<video src="(.*?)"/);
    return match ? match[1] : null;
}
function stripMarkdown(markdown) {
    return markdown
        .replace(/!\[.*?\]\(.*?\)/g, '') 
        .replace(/<.*?>/g, '') 
        .replace(/#{1,6}\s/g, '') 
        .replace(/(\*\*|__)(.*?)\1/g, '$2') 
        .replace(/(\*|_)(.*?)\1/g, '$2') 
        .replace(/\[(.*?)\]\(.*?\)/g, '$1') 
        .trim();
}

function doSearch() {
  const val = document.getElementById('searchInput').value.trim().toLowerCase();
  const container = document.getElementById('newsContainer');
  const filtered = state.news.filter(item => item.title.toLowerCase().includes(val) || item.content.toLowerCase().includes(val));
  
  container.innerHTML = filtered.map((item, idx) => {
    const coverImg = extractFirstImage(item.content);
    const coverVideo = extractFirstVideo(item.content);
    const plainText = stripMarkdown(item.content);

    return `
      <div class="news-card" data-news-id="${item.id}" onclick="openModal(${item.id})" style="animation-delay:${idx * 0.1}s">
      ${coverImg ? `
        <div class="news-cover-box">
           <img src="${coverImg}" loading="lazy">
        </div>
      ` : (coverVideo ? `
        <div class="news-cover-box">
           <video src="${coverVideo}#t=0.1" preload="metadata" muted></video>
           <div class="video-play-icon" style="transform:translate(-50%,-50%) scale(0.6); position:absolute; top:50%; left:50%; width:30px; height:30px; background:rgba(0,0,0,0.5); border-radius:50%; border:2px solid #fff;"></div>
        </div>
      ` : '')}
      <div class="news-content">
        <div class="news-date">${item.date}</div>
        <div class="news-title">${item.title}</div>
        <div class="news-desc">${plainText}</div>
        <div class="news-footer">
           <span class="read-more">Read Journal</span>
        </div>
      </div>
    </div>
    `;
  }).join('');  
  
  setTimeout(() => { 
      document.querySelectorAll('.news-card').forEach(el => el.classList.add('visible'));
      if(state.isHorizontal) {
          const wrapper = document.getElementById('mainWrapper');
          scrollTarget = wrapper.scrollLeft;
          scrollCurrent = wrapper.scrollLeft;
          animateCardsInView();
          updateProgress();
      }
  }, 50);
  
  if(filtered.length === 0) container.innerHTML = '<div style="text-align:center;width:100%;color:#999;padding:60px;">Nothing found in the journal.</div>';
}

function openModal(newsId) {
    const modal = document.getElementById('newsModal');
    modal.classList.remove('hide');
    modal.classList.remove('show');
    
    const item = state.news.find(item => item.id === newsId);
    if (!item) {
        showToast('Êó•ËÆ∞‰∏çÂ≠òÂú®ÊàñÂ∑≤Âà†Èô§');
        return;
    }
    
    state.currentNewsIdx = state.news.findIndex(item => item.id === newsId);
    const content = document.getElementById('modalContent');
    const box = document.getElementById('modalBox');

    box.classList.remove('show-comments');
    content.innerHTML = '';
    
    // Ëß£Êûê Markdown
    const renderedContent = marked.parse(item.content);
    
    content.innerHTML = `
      <div style="font-size:13px;color:#999;margin-bottom:10px;">${item.date}</div>
      <h2 style="font-size:28px;margin-bottom:25px;color:#2c3e50;font-family:serif;">${item.title}</h2>
      <div class="markdown-body">${renderedContent}</div>
    `;
    
    // ÂàùÂßãÂåñÂ™í‰ΩìÂàóË°®‰æõÁÅØÁÆ±‰ΩøÁî®
    currentLightboxMedia = [];
    const mediaElements = content.querySelectorAll('.markdown-body img, .markdown-body video');
    mediaElements.forEach((el, index) => {
        const src = el.tagName === 'VIDEO' ? el.getAttribute('src') : el.src;
        const type = el.tagName === 'VIDEO' ? 'video' : 'image';
        currentLightboxMedia.push({ src, type });
        // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
        el.onclick = (e) => {
            e.preventDefault(); // ÈòªÊ≠¢ËßÜÈ¢ëÈªòËÆ§Êí≠ÊîæË°å‰∏∫
            openUnifiedLightbox(index);
        };
    });

    const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
    if(scrollbarWidth > 0) document.body.style.paddingRight = `${scrollbarWidth}px`;
    document.body.style.overflow = 'hidden';
    
    modal.classList.add('show');
    
    document.getElementById('toggleCommentBtn').onclick = () => {
        box.classList.toggle('show-comments');
    };

    loadComments(item.id);
    
    document.getElementById('modalClose').onclick = () => { 
        modal.classList.remove('show'); 
        modal.classList.add('hide');
        box.classList.remove('show-comments');
        document.getElementById('commentList').innerHTML = '';
        document.getElementById('commentInput').value = '';
        cancelReply();
        setTimeout(() => {
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
            content.innerHTML = '';
        }, 300); 
    };
}

// Áªü‰∏ÄÂ™í‰ΩìÁÅØÁÆ±ÈÄªËæë
function openUnifiedLightbox(index) {
    if(index < 0 || index >= currentLightboxMedia.length) return;
    currentMediaIndex = index;
    const lightbox = document.getElementById('unifiedLightbox');
    lightbox.classList.add('active');
    updateLightboxMedia();
}

function closeUnifiedLightbox() {
    const lightbox = document.getElementById('unifiedLightbox');
    lightbox.classList.remove('active');
    document.getElementById('lightboxContainer').innerHTML = '';
}

function changeUnifiedMedia(dir) {
    let newIndex = currentMediaIndex + dir;
    if(newIndex < 0) newIndex = currentLightboxMedia.length - 1;
    if(newIndex >= currentLightboxMedia.length) newIndex = 0;
    currentMediaIndex = newIndex;
    updateLightboxMedia();
}

// Êõ¥Êñ∞ÁÅØÁÆ±Â™í‰ΩìÂÜÖÂÆπÂèäÁªëÂÆöÁº©Êîæ‰∫ã‰ª∂
function updateLightboxMedia() {
    const container = document.getElementById('lightboxContainer');
    const counter = document.getElementById('lightboxCounter');
    const item = currentLightboxMedia[currentMediaIndex];
    
    container.innerHTML = ''; // Ê∏ÖÁ©∫
    
    if(item.type === 'video') {
        const video = document.createElement('video');
        video.src = item.src;
        video.controls = true;
        video.autoplay = true;
        video.className = 'lightbox-media';
        container.appendChild(video);
    } else {
        const img = document.createElement('img');
        img.src = item.src;
        img.className = 'lightbox-media';
        
        // ÈáçÁΩÆÁº©ÊîæÁä∂ÊÄÅ
        lbState = { scale: 1, x: 0, y: 0, isDragging: false, startX: 0, startY: 0 };
        img.style.transform = `translate(0px, 0px) scale(1)`;

        // ÁªëÂÆöÊªöËΩÆÁº©Êîæ‰∫ã‰ª∂
        img.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1; // Âêë‰∏ãÊªöÁº©Â∞èÔºåÂêë‰∏äÊªöÊîæÂ§ß
            lbState.scale *= delta;
            // ÈôêÂà∂Áº©ÊîæËåÉÂõ¥
            lbState.scale = Math.max(0.1, Math.min(lbState.scale, 10));
            updateLbStyle(img);
        });

        // ÁªëÂÆöÈº†Ê†áÊåâ‰∏ã‰∫ã‰ª∂(ÂºÄÂßãÊãñÊãΩ)
        img.addEventListener('mousedown', (e) => {
            e.preventDefault();
            lbState.isDragging = true;
            lbState.startX = e.clientX - lbState.x;
            lbState.startY = e.clientY - lbState.y;
            img.style.cursor = 'grabbing';
        });

        container.appendChild(img);
    }
    
    counter.textContent = `${currentMediaIndex + 1} / ${currentLightboxMedia.length}`;
}

function updateLbStyle(img) {
    if(!img) return;
    img.style.transform = `translate(${lbState.x}px, ${lbState.y}px) scale(${lbState.scale})`;
}

function initParticles() {
    const canvas = document.getElementById('particleCanvas');
    const ctx = canvas.getContext('2d');
    let width, height;
    let particles = [];
    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();
    class Particle {
        constructor(x, y) {
            this.x = x; this.y = y;
            this.size = Math.random() * 5 + 2;
            this.speedX = Math.random() * 6 - 3; 
            this.speedY = Math.random() * -6 - 2; 
            this.gravity = 0.2;
            this.color = `hsl(${Math.random() * 360}, 70%, 60%)`;
            this.life = 60;
        }
        update() {
            this.speedY += this.gravity;
            this.x += this.speedX;
            this.y += this.speedY;
            this.life--;
            this.size *= 0.95;
        }
        draw() {
            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fill();
        }
    }
    window.addEventListener('mousedown', (e) => {
        for(let i=0; i<70; i++) particles.push(new Particle(e.clientX, e.clientY));
    });
    function animate() {
        ctx.clearRect(0, 0, width, height);
        for(let i = 0; i < particles.length; i++) {
            particles[i].update();
            particles[i].draw();
            if(particles[i].life <= 0 || particles[i].size < 0.5) {
                particles.splice(i, 1);
                i--;
            }
        }
        requestAnimationFrame(animate);
    }
    animate();
}

function checkLogin() {
  const localUser = localStorage.getItem('MY_CUSTOM_USER_INFO');
  if (localUser) {
    state.user = JSON.parse(localUser);
    if (!state.user.isAdmin) { showAccessDenied(); return; }
    document.getElementById('loginBtn').style.display = 'none';
    document.getElementById('userBtn').style.display = 'flex';
    document.getElementById('bgBtn').style.display = 'flex';
    document.getElementById('userName').textContent = state.user.nickname;
    document.getElementById('goAdmin').style.display = 'block';
    updateUserInfoFromRemote();
  } else {
    showAccessDenied();
    return;
  }
  document.getElementById('loginBtn').onclick = () => window.location.href = 'moguone/login.html';
  document.getElementById('userBtn').onclick = (e) => { e.stopPropagation(); document.querySelector('.user-dropdown').classList.toggle('show'); };
  document.addEventListener('click', () => document.querySelector('.user-dropdown').classList.remove('show'));
  document.getElementById('doLogout').onclick = logout;
  document.getElementById('goProfile').onclick = () => window.location.href = 'moguone/setting.html';
  document.getElementById('goAdmin').onclick = () => window.location.href = 'moguone/admin.html';
}

async function updateUserInfoFromRemote() {
    try {
        const res = await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${CONFIG.userIssue}`, { headers: { Authorization: `token ${CONFIG.token}` } });
        const data = await res.json();
        const lines = data.body.split('\n');
        const userLine = lines.find(l => l.startsWith(state.user.account + '|'));
        if(userLine) {
            const parts = userLine.split('|').map(s => s.trim());
            state.user.nickname = parts[3] || state.user.nickname;
            state.user.email = parts[2] || state.user.email;
            state.user.avatar = parts[5] || DEFAULT_AVATAR;
            state.user.signature = parts[6] || DEFAULT_SIGNATURE;
            localStorage.setItem('MY_CUSTOM_USER_INFO', JSON.stringify(state.user));
            document.getElementById('userName').textContent = state.user.nickname;
        }
    } catch(e) { console.error('Silent update failed', e); }
}

function showAccessDenied() {
    document.getElementById('accessModal').classList.add('show');
    document.body.style.overflow = 'hidden';
}
function logout() { localStorage.removeItem('MY_CUSTOM_USER_INFO'); location.reload(); }

async function loadNews() {
  try {
    const res = await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${CONFIG.newsIssue}`, { headers: { Authorization: `token ${CONFIG.token}` } });
    const data = await res.json();
    try {
        state.news = JSON.parse(data.body);
    } catch(e) {
        console.error("JSON Ëß£ÊûêÂ§±Ë¥•ÔºåÂ∞ùËØïÊóßÊ†ºÂºèÊàñÊ†ºÂºèÈîôËØØ", e);
        state.news = [];
    }
    doSearch(); 
  } catch(e) { console.error('Âä†ËΩΩÊó•ËÆ∞Â§±Ë¥•Ôºö', e); showToast('Êó•ËÆ∞Âä†ËΩΩÂ§±Ë¥•'); }
}

async function loadStats() {
  try {
    const res = await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${CONFIG.countIssue}`, { headers: { Authorization: `token ${CONFIG.token}` } });
    const data = await res.json();
    const countMatch = data.body.match(/ÊÄªËÆøÈóÆÈáèÔºö(\d+)/);
    const count = countMatch ? parseInt(countMatch[1]) + 1 : 1;
    document.getElementById('totalCount').textContent = count;
    const newBody = data.body.replace(/ÊÄªËÆøÈóÆÈáèÔºö\d+/, `ÊÄªËÆøÈóÆÈáèÔºö${count}`);
    fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${CONFIG.countIssue}`, { method: 'PATCH', headers: { Authorization: `token ${CONFIG.token}` }, body: JSON.stringify({ body: newBody }) });
  } catch(e) { console.error('Âä†ËΩΩÁªüËÆ°Â§±Ë¥•Ôºö', e); }
}

// ËØÑËÆ∫ÂõûÂ§çÁõ∏ÂÖ≥ÈÄªËæë
function handleReply(name) {
    replyTarget = { name: name, isSub: true };
    document.getElementById('replyTargetName').textContent = name;
    document.getElementById('replyIndicator').classList.add('show');
    document.getElementById('commentInput').focus();
}

function cancelReply() {
    replyTarget = null;
    document.getElementById('replyIndicator').classList.remove('show');
    document.getElementById('commentInput').value = '';
}

// ‰øÆÊîπÂêéÁöÑËØÑËÆ∫Âä†ËΩΩÈÄªËæë
async function loadComments(newsId) {
  const list = document.getElementById('commentList');
  list.innerHTML = '<div style="text-align:center;padding:20px;color:#94a3b8;">Âä†ËΩΩ‰∏≠...</div>';
  
  try {
    let userAvatarMap = await getUserAvatarMap();
    const issueMap = await getCommentMap();
    const issueId = issueMap[newsId];
    
    if(!issueId) {
      list.innerHTML = '<div style="text-align:center;padding:20px;color:#94a3b8;">ÊöÇÊó†ËØÑËÆ∫ÔºåÊù•ÂùêÊ≤ôÂèë</div>';
      // ËøôÈáåÁöÑÂàõÂª∫Áî±ÂèëÈÄÅÊåâÈíÆËß¶ÂèëÔºå‰∏çÂÜç‰ªÖ‰æùËµñloadComments
      document.getElementById('submitComment').onclick = () => createCommentIssue(newsId);
      return;
    }
    
    const res = await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${issueId}/comments`, { 
      headers: { Authorization: `token ${CONFIG.token}` } 
    });
    const comments = await res.json();
    
    if (!comments || comments.length === 0) {
      list.innerHTML = '<div style="text-align:center;padding:20px;color:#94a3b8;">ÊöÇÊó†ËØÑËÆ∫</div>';
      document.getElementById('submitComment').onclick = () => postComment(issueId);
      return;
    }
    
    let commentsHTML = '';
    for (const c of comments) {
      const parts = c.body.split('|');
      if (parts.length >= 3) {
        const uid = parts[0]?.trim() || '';
        const username = parts[1]?.trim() || 'ÂåøÂêçÁî®Êà∑';
        let content = parts.slice(2).join('|').trim();
        
        // Ëß£ÊûêÂõûÂ§çÊ†áËÆ∞
        let isReply = false;
        if (content.match(/^ÂõûÂ§ç @.* : /)) {
            isReply = true;
        }
        
        content = content.replace(/^„Äê|„Äë$/g, '');
        const avatar = userAvatarMap[uid] || DEFAULT_AVATAR;
        
        commentsHTML += `
          <div class="comment-item ${isReply ? 'is-reply' : ''}">
            <img src="${avatar}" class="comment-avatar" alt="${username}" onerror="this.src='${DEFAULT_AVATAR}'">
            <div style="flex:1;">
              <div class="comment-user">
                  ${username}
                  <span class="comment-reply-btn" onclick="handleReply('${username}')">ÂõûÂ§ç</span>
              </div>
              <div class="comment-text">${content}</div>
            </div>
          </div>
        `;
      }
    }
    
    list.innerHTML = commentsHTML || '<div style="text-align:center;padding:20px;color:#94a3b8;">ÊöÇÊó†ËØÑËÆ∫</div>';
    document.getElementById('submitComment').onclick = () => postComment(issueId);
    
  } catch(e) {
    console.error('Âä†ËΩΩËØÑËÆ∫Â§±Ë¥•Ôºö', e);
    list.innerHTML = '<div style="text-align:center;padding:20px;color:#94a3b8;">ËØÑËÆ∫Âä†ËΩΩÂ§±Ë¥•</div>';
  }
}

async function getUserAvatarMap() {
  try {
    const res = await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${CONFIG.userIssue}`, {
      headers: { Authorization: `token ${CONFIG.token}` }
    });
    const data = await res.json();
    const lines = data.body.split('\n');
    const userMap = {};
    lines.forEach(line => {
      const parts = line.split('|');
      if (parts.length >= 7) {
        const account = parts[0]?.trim();
        const avatar = parts[5]?.trim();
        if (account && avatar) {
          userMap[account] = avatar;
        }
      }
    });
    return userMap;
  } catch(e) {
    console.error('Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•Ôºö', e);
    return {};
  }
}

async function getCommentMap() {
  try {
    const res = await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${CONFIG.commentMapIssue}`, { headers: { Authorization: `token ${CONFIG.token}` } });
    const data = await res.json();
    const map = {};
    data.body.split('\n').forEach(l => { 
        const m = l.match(/news_(-?\d+):\s*(\d+)/); 
        if(m) map[m[1]] = m[2]; 
    });
    return map;
  } catch(e) {
    console.error('Ëé∑ÂèñËØÑËÆ∫Êò†Â∞ÑÂ§±Ë¥•Ôºö', e);
    return {};
  }
}

// ËæÖÂä©ÂáΩÊï∞ÔºöÁ´ãÂàªÊ∏≤ÊüìÊú¨Âú∞ËØÑËÆ∫Ôºà‰πêËßÇÊõ¥Êñ∞Ôºâ
function renderCommentLocally(user, content, isReply) {
    const list = document.getElementById('commentList');
    if(list.innerText.includes('ÊöÇÊó†ËØÑËÆ∫') || list.innerText.includes('Âä†ËΩΩÂ§±Ë¥•')) {
        list.innerHTML = '';
    }
    const avatar = user.avatar || DEFAULT_AVATAR;
    const tempHtml = `
      <div class="comment-item ${isReply ? 'is-reply' : ''}" style="animation: fadeIn 0.3s; opacity: 0.7;">
        <img src="${avatar}" class="comment-avatar">
        <div style="flex:1;">
          <div class="comment-user">
            ${user.nickname} 
            <span style="font-weight:400;color:#999;font-size:12px;">(ÂèëÈÄÅ‰∏≠...)</span>
          </div>
          <div class="comment-text">${content}</div>
        </div>
      </div>
    `;
    list.insertAdjacentHTML('beforeend', tempHtml);
    const modalRight = document.querySelector('.modal-right');
    if(modalRight) modalRight.scrollTop = modalRight.scrollHeight;
    list.scrollTop = list.scrollHeight;
}

async function postComment(issueId) {
  if(!state.user) { showToast('ËØ∑ÂÖàÁôªÂΩï'); return; }
  
  const input = document.getElementById('commentInput');
  let val = input.value.trim();
  if(!val) return;
  
  // Â§ÑÁêÜÂõûÂ§çÂâçÁºÄ
  let displayContent = val;
  if(replyTarget) {
      displayContent = `ÂõûÂ§ç @${replyTarget.name} : ${val}`;
      val = displayContent; // ÂÆûÈôÖÊèê‰∫§ÁöÑÊï∞ÊçÆ‰πüÂ∏¶‰∏äÂâçÁºÄ
  }
  
  // 1. Á´ãÂç≥Ê∏ÖÈô§ËæìÂÖ•Ê°ÜÂíåÂõûÂ§çÁä∂ÊÄÅ
  input.value = '';
  const isReply = !!replyTarget;
  cancelReply();
  
  // 2. Á´ãÂç≥Âú®ÁïåÈù¢‰∏äÊòæÁ§∫ËØÑËÆ∫ (‰πêËßÇ UI)
  renderCommentLocally(state.user, displayContent, isReply);
  
  const body = `${state.user.account}|${state.user.nickname}|„Äê${val}„Äë`;
  
  try {
    await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${issueId}/comments`, { 
      method: 'POST', 
      headers: { 
        'Authorization': `token ${CONFIG.token}`,
        'Content-Type': 'application/json'
      }, 
      body: JSON.stringify({ body }) 
    });
    
    // ÊàêÂäüÂêéÔºåÈáçÊñ∞Âä†ËΩΩ‰∏ÄÊ¨°‰ª•Á°Æ‰øùÊï∞ÊçÆÂêåÊ≠•ÔºàÂèØÈÄâÔºåÊàñËÄÖÁõ¥Êé•ÊääÂàöÂàöÈÇ£‰∏™opacity 0.7ÁöÑÂéªÊéâÊ†∑ÂºèÔºâ
    // ‰∏∫‰∫ÜÁÆÄÂçïÔºåÊàë‰ª¨ËÆ©ÂÆÉ‰øùÊåÅÂú®È°µÈù¢‰∏äÔºå‰∏ãÊ¨°Âà∑Êñ∞Â∞±ÊòØÊ≠£ÂºèÁöÑ‰∫Ü
    showToast('ËØÑËÆ∫ÂèëÈÄÅÊàêÂäü');
  } catch(e) {
    console.error('ÂèëÈÄÅËØÑËÆ∫Â§±Ë¥•Ôºö', e);
    showToast('ËØÑËÆ∫ÂèëÈÄÅÂ§±Ë¥•Ôºå‰ΩÜÂ∑≤‰øùÂ≠òËá≥Êú¨Âú∞ÁºìÂ≠ò(ÂÅá)');
  }
}

async function createCommentIssue(newsId) {
  if(!state.user) { showToast('ËØ∑ÂÖàÁôªÂΩï'); return; }
  
  const input = document.getElementById('commentInput');
  const val = input.value.trim();
  if(!val) return;
  
  // 1. Á´ãÂç≥Ê∏ÖÈô§ËæìÂÖ•Ê°Ü
  input.value = '';
  
  // 2. Á´ãÂç≥ÊòæÁ§∫Êú¨Âú∞ËØÑËÆ∫ (‰πêËßÇ UI)
  renderCommentLocally(state.user, val, false);
  
  showToast('Ê≠£Âú®ÂêéÂè∞ÂàõÂª∫ËØÑËÆ∫Âå∫...');
  
  try {
    const newIssueRes = await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues`, { 
      method: 'POST', 
      headers: { 
        'Authorization': `token ${CONFIG.token}`,
        'Content-Type': 'application/json'
      }, 
      body: JSON.stringify({ 
        title: `ËØÑËÆ∫ - Êó•ËÆ∞ ${newsId}`, 
        body: `‰∏∫Êó•ËÆ∞ ${newsId} ÂàõÂª∫ÁöÑËØÑËÆ∫Âå∫Âüü`
      }) 
    });
    
    const newIssue = await newIssueRes.json();
    
    const mapRes = await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${CONFIG.commentMapIssue}`, { 
      headers: { Authorization: `token ${CONFIG.token}` } 
    });
    const mapData = await mapRes.json();
    const newBody = mapData.body + `\nnews_${newsId}: ${newIssue.number}`;
    
    await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${CONFIG.commentMapIssue}`, { 
      method: 'PATCH', 
      headers: { 
        'Authorization': `token ${CONFIG.token}`,
        'Content-Type': 'application/json'
      }, 
      body: JSON.stringify({ body: newBody }) 
    });
    
    const body = `${state.user.account}|${state.user.nickname}|„Äê${val}„Äë`;
    await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${newIssue.number}/comments`, { 
      method: 'POST', 
      headers: { 
        'Authorization': `token ${CONFIG.token}`,
        'Content-Type': 'application/json'
      }, 
      body: JSON.stringify({ body }) 
    });
    
    // Êõ¥Êñ∞ÊåâÈíÆ‰∫ã‰ª∂Ôºå‰∏ãÊ¨°Áõ¥Êé•ÂèëÈÄÅ
    document.getElementById('submitComment').onclick = () => postComment(newIssue.number);
    showToast('ËØÑËÆ∫Âå∫ÂàõÂª∫ÊàêÂäü');
    
  } catch(e) {
    console.error('ÂàõÂª∫ËØÑËÆ∫Âå∫Â§±Ë¥•Ôºö', e);
    showToast('Êìç‰ΩúÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞ÈáçËØï');
  }
}

function loadLogs() { 
  fetch('moguone/log.txt')
  .then(r => {
    if(!r.ok) throw new Error('Êó•ÂøóÊñá‰ª∂‰∏çÂ≠òÂú®');
    return r.text();
  })
  .then(t => { 
    document.querySelector('.sidebar-update-log').innerHTML = t.split('\n').map(l => `<div>${l}</div>`).join(''); 
  })
  .catch(err => {
    console.log('Êó•ÂøóÂä†ËΩΩÂ§±Ë¥•Ôºö', err);
  });
}

function showToast(msg) { 
    const t = document.getElementById('toast'); 
    t.querySelector('.toast-text').textContent = msg; 
    t.classList.add('show'); 
    setTimeout(() => t.classList.remove('show'), 2000); 
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
