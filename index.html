<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="description" content="MY HOME ä¸ªäººä¸»é¡µ">
<meta name="keywords" content="Homepage,JavaTool,ä¸ªäººä¸»é¡µ">
<meta name="author" content="MY HOME">
<title>MoGuOne</title>
<link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
<link rel="preload" href="//at.alicdn.com/t/c/font_4552607_0khxww3tj3q9.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="stylesheet" type="text/css" href="https://unpkg.com/dmego-home-page@latest/assets/css/iconfont.css">
<style>
:root {
  --primary: #0078d4;
  --primary-hover: #0066b8;
  --text-main: #1e293b;
  --text-sub: #64748b;
  --bg-base: #f8fafc;
  --glass-bg: rgba(255, 255, 255, 0.85);
  --glass-border: rgba(255, 255, 255, 0.8);
  --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.05);
  --card-radius: 20px;
  --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
  --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  user-select: none;
}

body {
  min-height: 100vh;
  color: var(--text-main);
  background-color: var(--bg-base);
  background-size: cover;
  background-repeat: no-repeat;
  background-attachment: fixed;
  background-position: center;
  transition: background 1s ease;
  overflow-x: hidden;
}

#loader {
  position: fixed;
  inset: 0;
  background: #fff;
  z-index: 99999;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  transition: opacity 0.8s ease, visibility 0.8s ease;
}
#loader.loaded { opacity: 0; visibility: hidden; pointer-events: none; }
.loading-icon svg { width: 60px; height: 60px; fill: var(--primary); animation: spin 2s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text { margin-top: 20px; font-size: 14px; letter-spacing: 2px; color: var(--text-sub); opacity: 0.8; animation: pulse 2s infinite; }
@keyframes pulse { 0%, 100% { opacity: 0.6; } 50% { opacity: 1; } }

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
  position: relative;
  z-index: 10;
}

#header-nav {
  position: sticky;
  top: 20px;
  z-index: 100;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 20px;
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: 50px;
  box-shadow: var(--glass-shadow);
  margin-bottom: 40px;
  transition: transform 0.3s var(--ease-smooth);
}

/* å¯¼èˆªæ ä¸»é¢˜æŒ‰é’®æ ·å¼ä¼˜åŒ– */
.bg-switch-btn {
  height: 40px;
  padding: 0 16px;
  border-radius: 20px;
  border: none;
  background: transparent;
  color: var(--text-main);
  cursor: pointer;
  transition: all 0.3s var(--ease-spring);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  font-size: 14px;
  font-weight: 600;
}
.bg-switch-btn:hover { background: rgba(0,0,0,0.05); }
.bg-switch-btn:hover .iconfont {
  transform: rotate(180deg);
  transition: transform 0.5s ease;
}

.nav-center { display: flex; gap: 8px; }
.nav-link {
  padding: 10px 24px;
  border-radius: 25px;
  text-decoration: none;
  color: var(--text-sub);
  font-weight: 600;
  font-size: 14px;
  transition: all 0.3s var(--ease-spring);
  position: relative;
}
.nav-link.active {
  background: var(--primary);
  color: #fff;
  box-shadow: 0 4px 12px rgba(0, 120, 212, 0.3);
}
.nav-link:not(.active):hover {
  background: rgba(255,255,255,0.5);
  color: var(--primary);
  transform: translateY(-2px);
}

.user-area { position: relative; }
.login-btn, .user-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  background: #fff;
  border: 1px solid rgba(0,0,0,0.05);
  border-radius: 30px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-main);
  transition: all 0.3s var(--ease-spring);
}
.login-btn:hover, .user-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  color: var(--primary);
}
.user-dropdown {
  position: absolute;
  top: 120%;
  right: 0;
  width: 140px;
  background: #fff;
  border-radius: 16px;
  padding: 6px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  opacity: 0;
  visibility: hidden;
  transform: translateY(10px) scale(0.95);
  transform-origin: top right;
  transition: all 0.2s var(--ease-spring);
}
.user-dropdown.show { opacity: 1; visibility: visible; transform: translateY(0) scale(1); }
.dropdown-item {
  padding: 10px 16px;
  font-size: 13px;
  color: var(--text-main);
  border-radius: 10px;
  cursor: pointer;
  transition: background 0.2s;
}
.dropdown-item:hover { background: #f1f5f9; color: var(--primary); }

.hero-dashboard {
  display: grid;
  grid-template-columns: 280px 1fr 280px;
  gap: 20px;
  margin-bottom: 50px;
}
.dashboard-card {
  background: var(--glass-bg);
  backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: var(--card-radius);
  padding: 24px;
  box-shadow: var(--glass-shadow);
  display: flex;
  flex-direction: column;
  justify-content: center;
}
.profile-card { align-items: center; text-align: center; }
.profile-avatar {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  border: 3px solid #fff;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  margin-bottom: 12px;
  transition: transform 0.4s var(--ease-spring);
}
.profile-avatar:hover { transform: scale(1.1) rotate(5deg); }
.profile-name { font-size: 18px; font-weight: 700; margin-bottom: 6px; }
.profile-bio { font-size: 13px; color: var(--text-sub); line-height: 1.5; }

.header-center {
  align-items: center;
  text-align: center;
  background: transparent;
  box-shadow: none;
  border: none;
  backdrop-filter: none;
}
.site-title {
  font-size: 42px;
  font-weight: 800;
  background: linear-gradient(135deg, #1e293b 0%, #475569 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 10px;
  letter-spacing: -1px;
}
.site-quote { font-size: 15px; color: var(--text-sub); margin-bottom: 30px; }

/* --- æœç´¢æ¡†æ ·å¼é‡æ„ START --- */
.search-box {
  position: relative;
  width: 100%;
  max-width: 500px; /* åŠ å®½ä¸€ç‚¹ */
  margin: 0 auto;
  transition: transform 0.3s var(--ease-spring);
}
.search-box:hover {
  transform: translateY(-2px); /* æ‚¬æµ®æ—¶è½»å¾®ä¸Šæµ® */
}

.search-input {
  width: 100%;
  height: 54px; /* å¢åŠ é«˜åº¦ */
  padding: 0 65px 0 24px; /* å³ä¾§ç•™å‡ºæŒ‰é’®ç©ºé—´ */
  border-radius: 27px;
  border: 2px solid rgba(255,255,255,0.5); /* æŸ”å’Œçš„è¾¹æ¡† */
  background: rgba(255,255,255,0.45); /* æ›´åŠ é€šé€ */
  backdrop-filter: blur(12px); /* ç£¨ç ‚æ„Ÿæ›´å¼º */
  font-size: 16px;
  color: var(--text-main);
  outline: none;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
  transition: all 0.3s ease;
}
.search-input::placeholder { color: #94a3b8; opacity: 0.8; }
.search-input:focus {
  background: rgba(255,255,255,0.9);
  border-color: var(--primary);
  box-shadow: 0 8px 30px rgba(0, 120, 212, 0.15); /* èšç„¦å…‰æ™• */
}

.search-btn {
  position: absolute;
  right: 6px;
  top: 6px;
  width: 42px; /* ç¨å¾®åŠ å¤§æŒ‰é’® */
  height: 42px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary) 0%, #3b82f6 100%); /* æ¸å˜è‰² */
  color: #fff;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 12px rgba(0, 120, 212, 0.3);
  transition: all 0.4s var(--ease-spring);
  z-index: 2;
}
.search-btn i { font-size: 18px; font-weight: bold; }
.search-btn:hover {
  transform: scale(1.1) rotate(15deg); /* æ‚¬åœåŠ¨æ•ˆ */
  background: linear-gradient(135deg, #0066b8 0%, #2563eb 100%);
  box-shadow: 0 6px 18px rgba(0, 120, 212, 0.45);
}
.search-btn:active { transform: scale(0.95); }
/* --- æœç´¢æ¡†æ ·å¼é‡æ„ END --- */

.stats-card { gap: 15px; }
.stat-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
.stat-row:last-child { border-bottom: none; }
.stat-label { font-size: 13px; color: var(--text-sub); }
.stat-value { font-size: 16px; font-weight: 700; color: var(--text-main); }
.update-log { max-height: 100px; overflow-y: auto; font-size: 12px; color: var(--text-sub); line-height: 1.6; margin-top: 10px; }

.news-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  gap: 24px;
  padding-bottom: 100px;
}
.news-card {
  background: #fff;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,0.04);
  transition: all 0.4s var(--ease-spring);
  opacity: 0;
  transform: translateY(20px);
  cursor: pointer;
  border: 1px solid rgba(0,0,0,0.02);
}
.news-card.visible { opacity: 1; transform: translateY(0); }
.news-card:hover { transform: translateY(-8px); box-shadow: 0 20px 40px rgba(0, 120, 212, 0.12); }
.news-cover {
  height: 200px;
  background: #f1f5f9;
  position: relative;
  overflow: hidden;
}
.news-cover img, .news-cover video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.6s ease;
}
.news-card:hover .news-cover img { transform: scale(1.08); }
.news-body { padding: 24px; }
.news-title { font-size: 18px; font-weight: 700; margin-bottom: 10px; line-height: 1.4; }
.news-desc { font-size: 14px; color: var(--text-sub); line-height: 1.6; height: 44px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; margin-bottom: 20px; }
.news-meta { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f1f5f9; padding-top: 15px; font-size: 12px; color: #94a3b8; }
.like-btn { display: flex; align-items: center; gap: 4px; transition: color 0.2s; cursor: pointer; }
.like-btn:hover { color: var(--primary); }

#footer {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(20px);
  padding: 6px;
  border-radius: 50px;
  display: flex;
  align-items: center;
  box-shadow: 0 10px 40px rgba(0,0,0,0.1);
  z-index: 900;
  border: 1px solid rgba(255,255,255,0.6);
  transition: all 0.4s var(--ease-spring);
  width: 54px;
  overflow: hidden;
}
#footer.playing { width: 280px; padding: 6px 20px 6px 6px; }
.music-cover {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  background: var(--text-main);
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  flex-shrink: 0;
}
.play-icon {
  width: 0; height: 0;
  border-style: solid;
  border-width: 6px 0 6px 10px;
  border-color: transparent transparent transparent #fff;
  margin-left: 3px; 
}
.pause-icon {
  width: 10px; height: 12px;
  border-left: 3px solid #fff;
  border-right: 3px solid #fff;
}
.music-info { margin-left: 15px; white-space: nowrap; opacity: 0; transition: opacity 0.3s; font-size: 13px; font-weight: 500; }
#footer.playing .music-info { opacity: 1; }

.modal-mask {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(8px);
  z-index: 2000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
}
.modal-mask.show { opacity: 1; pointer-events: auto; }
.modal-box {
  width: 90%;
  max-width: 1000px;
  height: 85vh;
  background: #fff;
  border-radius: 24px;
  box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
  transform: scale(0.95);
  transition: transform 0.4s var(--ease-spring);
  display: flex;
  overflow: hidden;
  position: relative;
}
.modal-mask.show .modal-box { transform: scale(1); }
.modal-close {
  position: absolute;
  top: 20px;
  right: 20px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: rgba(255,255,255,0.9);
  border: 1px solid rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 10;
  transition: all 0.3s var(--ease-spring);
  color: var(--text-main);
  font-size: 18px;
}
.modal-close:hover { transform: rotate(90deg) scale(1.1); background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

.modal-left { flex: 3; padding: 40px; overflow-y: auto; background: #fff; }
.modal-right { flex: 2; background: #f8fafc; border-left: 1px solid #e2e8f0; padding: 30px; display: flex; flex-direction: column; }

.comment-input {
  width: 100%;
  padding: 15px;
  border-radius: 12px;
  border: 1px solid transparent;
  background: #fff;
  box-shadow: 0 4px 10px rgba(0,0,0,0.03);
  font-size: 14px;
  transition: all 0.3s;
  outline: none;
  resize: none;
  min-height: 80px;
  user-select: text;
}
.comment-input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(0, 120, 212, 0.1); }
.comment-btn {
  margin-top: 15px;
  padding: 10px 24px;
  background: var(--primary);
  color: #fff;
  border: none;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  align-self: flex-end;
  transition: transform 0.2s;
}
.comment-btn:hover { transform: scale(1.05); background: var(--primary-hover); }

.bg-modal-content {
  background: #fff;
  padding: 30px;
  border-radius: 20px;
  max-width: 600px;
  width: 90%;
  text-align: center;
}
.bg-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; max-height: 400px; overflow-y: auto; }
.bg-item { height: 100px; border-radius: 10px; overflow: hidden; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
.bg-item:hover, .bg-item.active { border-color: var(--primary); transform: scale(1.05); }
.bg-item img { width: 100%; height: 100%; object-fit: cover; }

.toast {
  position: fixed;
  top: 100px;
  right: 30px;
  background: #fff;
  padding: 12px 24px;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  gap: 10px;
  z-index: 9999;
  transform: translateX(150%);
  transition: transform 0.4s var(--ease-spring);
}
.toast.show { transform: translateX(0); }
.toast-icon { color: #10b981; font-size: 18px; }

@media (max-width: 1024px) {
  .hero-dashboard { grid-template-columns: 1fr; gap: 30px; }
  .dashboard-card { width: 100%; }
  .header-center { order: -1; margin-bottom: 20px; }
}
@media (max-width: 768px) {
  .modal-box { flex-direction: column; height: 95vh; }
  .modal-left { flex: 1; padding: 25px; }
  .modal-right { flex: 1; border-left: none; border-top: 1px solid #e2e8f0; }
  .nav-center { display: none; }
  .news-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<div id="loader">
  <div class="loading-icon">
    <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"/><path d="M512 140c-205.4 0-372 166.6-372 372s166.6 372 372 372 372-166.6 372-372-166.6-372-372-372z" opacity=".5"/></svg>
  </div>
  <div class="loading-text">MOGU ONE</div>
</div>

<div class="container">
  
  <nav id="header-nav">
    <button class="bg-switch-btn" id="bgChangeBtn" title="åˆ‡æ¢èƒŒæ™¯ä¸»é¢˜">
      <i class="iconfont icon-refresh"></i>
      <span>Theme</span>
    </button>
    <div class="nav-center">
      <a href="moguone/search.html" class="nav-link">Search</a>
      <a href="index.html" class="nav-link active">Home</a>
      <a href="moguone/tool.html" class="nav-link">Tool</a>
    </div>
    <div class="user-area" id="userArea">
      <button class="login-btn" id="loginBtn">
        <i class="iconfont icon-user"></i> Login
      </button>
      <div class="user-btn" id="userBtn" style="display: none;">
        <span id="userName">User</span>
        <div class="user-dropdown">
          <div class="dropdown-item" id="goProfile">ä¸ªäººä¸­å¿ƒ</div>
          <div class="dropdown-item" id="goAdmin" style="display:none;">ç®¡ç†åå°</div>
          <div class="dropdown-item" id="doLogout">é€€å‡ºç™»å½•</div>
        </div>
      </div>
    </div>
  </nav>

  
  <section class="hero-dashboard">
    
    <div class="dashboard-card profile-card">
      <img src="https://img.wjwj.top/2026/01/16/a27c17b713d7998cebb06b1dde372d64.jpg" class="profile-avatar" alt="Avatar">
      <div class="profile-name">Mo GuOne</div>
      <div class="profile-bio">çƒ­çˆ±æ˜¯æ‰€æœ‰çš„ç†ç”±å’Œç­”æ¡ˆ</div>
      <div class="sidebar-social" style="display:flex;gap:15px;margin-top:15px;justify-content:center;">
        <a href="https://github.com" target="_blank" style="color:#64748b;"><i class="iconfont icon-github"></i></a>
        <a href="mailto:test@test.com" style="color:#64748b;"><i class="iconfont icon-email"></i></a>
      </div>
    </div>

    
    <div class="dashboard-card header-center">
      <div class="site-title">MY HOME</div>
      <div class="site-quote">ä½ ä¼šä¸ä¼šå¿½ç„¶çš„å‡ºç°ï¼Œåœ¨è¡—è§’çš„å’–å•¡åº—ã€‚</div>
      <div class="search-box">
        <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢æ—¥è®° / Search...">
        <button class="search-btn" id="searchBtn"><i class="iconfont icon-search"></i></button>
      </div>
    </div>

    
    <div class="dashboard-card stats-card">
      <div class="stat-row">
        <span class="stat-label">æ€»è®¿é—®é‡</span>
        <span class="stat-value" id="totalCount">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">çŠ¶æ€</span>
        <span class="stat-value" style="color:#10b981;">Active â—</span>
      </div>
      <div class="stat-label" style="margin-top:15px;">æ›´æ–°æ—¥å¿—</div>
      <div class="update-log sidebar-update-log"></div>
    </div>
  </section>

  
  <div class="news-grid" id="newsContainer"></div>

</div>


<div id="footer">
  <div class="music-cover" id="playBtn">
    <div class="play-icon"></div>
  </div>
  <div class="music-info">Top Barry - ä¸€åŠä¸€åŠ</div>
  <audio id="music" loop preload="auto" src="moguone/song/ä¸€åŠä¸€åŠ.mp3"></audio>
</div>


<div class="modal-mask" id="newsModal">
  <div class="modal-box">
    <button class="modal-close" id="modalClose">âœ•</button>
    <div class="modal-left" id="modalContent"></div>
    <div class="modal-right" id="modalComments">
      <div style="flex:1;overflow-y:auto;margin-bottom:15px;" id="commentList"></div>
      <div style="border-top:1px solid #eee;padding-top:15px;">
        <textarea class="comment-input" id="commentInput" placeholder="å†™ä¸‹ä½ çš„è¯„è®º..."></textarea>
        <button class="comment-btn" id="submitComment">å‘é€</button>
      </div>
    </div>
  </div>
</div>


<div class="modal-mask" id="bgModal">
  <div class="bg-modal-content">
    <div style="font-size:18px;font-weight:700;margin-bottom:15px;">åˆ‡æ¢èƒŒæ™¯</div>
    <div class="bg-grid" id="bgGrid"></div>
    <button class="comment-btn" style="margin-top:20px;background:#f1f5f9;color:#333;" onclick="document.getElementById('bgModal').classList.remove('show')">å…³é—­</button>
  </div>
</div>


<div class="toast" id="toast">
  <div class="toast-icon">âœ“</div>
  <div class="toast-text">æ“ä½œæˆåŠŸ</div>
</div>

<script>
const CONFIG = {
  token: ["gh","p_p","VX","lo","0HQ","PmMx","Ic","eM","HB","uMzm","EON","LPX","700","10","M","SL"].join(''),
  repo: "moguwan/moguwan.github.io",
  newsIssue: 322,
  countIssue: 7,
  userIssue: 11,
  commentMapIssue: 299
};

let state = {
  user: null,
  news: [],
  likes: {},
  bgList: [],
  isPlaying: false
};


function init() {
  
  const loader = document.getElementById('loader');
  setTimeout(() => loader.classList.add('loaded'), 800);

  checkLogin();
  loadNews();
  loadStats();
  initMusic();
  loadLogs();
  initBg();

  // æ·»åŠ æœç´¢åŠŸèƒ½ç›‘å¬
  document.getElementById('searchBtn').addEventListener('click', doSearch);
  document.getElementById('searchInput').addEventListener('keyup', (e) => {
    if(e.key === 'Enter') doSearch();
  });
}

// æœç´¢åŠŸèƒ½é€»è¾‘
function doSearch() {
  const val = document.getElementById('searchInput').value.trim().toLowerCase();
  const container = document.getElementById('newsContainer');
  
  // è¿‡æ»¤æ—¥è®°
  const filtered = state.news.filter(item => 
    item.title.toLowerCase().includes(val) || 
    item.content.toLowerCase().includes(val)
  );

  // é‡æ–°æ¸²æŸ“
  container.innerHTML = filtered.map((item, idx) => `
    <div class="news-card" onclick="openModal(${idx})" style="animation-delay:0s">
      <div class="news-cover">
        ${item.imgs.length ? `<img src="${item.imgs[0]}" loading="lazy">` : 
          (item.videos.length ? `<video src="${item.videos[0]}#t=1"></video>` : '')}
      </div>
      <div class="news-body">
        <div class="news-title">${item.title}</div>
        <div class="news-desc">${item.content}</div>
        <div class="news-meta">
          <span>${item.date}</span>
          <div class="like-btn" onclick="event.stopPropagation(); like(${item.id})">
            ğŸ‘ <span id="like-${item.id}">${state.likes[item.id] || 0}</span>
          </div>
        </div>
      </div>
    </div>
  `).join('');

  setTimeout(() => {
    document.querySelectorAll('.news-card').forEach(el => el.classList.add('visible'));
  }, 50);

  if(filtered.length === 0) {
    container.innerHTML = '<div style="text-align:center;width:100%;grid-column:1/-1;color:#64748b;padding:40px;">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ—¥è®° ~</div>';
  }
}


function checkLogin() {
  const localUser = localStorage.getItem('MY_CUSTOM_USER_INFO');
  if (localUser) {
    state.user = JSON.parse(localUser);
    document.getElementById('loginBtn').style.display = 'none';
    document.getElementById('userBtn').style.display = 'flex';
    document.getElementById('userName').textContent = state.user.nickname;
    if(state.user.isAdmin) document.getElementById('goAdmin').style.display = 'block';
  }
  
  document.getElementById('loginBtn').onclick = () => window.location.href = 'moguone/login.html';
  document.getElementById('userBtn').onclick = (e) => {
    e.stopPropagation();
    document.querySelector('.user-dropdown').classList.toggle('show');
  };
  document.addEventListener('click', () => document.querySelector('.user-dropdown').classList.remove('show'));
  document.getElementById('doLogout').onclick = () => {
    localStorage.removeItem('MY_CUSTOM_USER_INFO');
    location.reload();
  };
  document.getElementById('goProfile').onclick = () => window.location.href = 'moguone/setting.html';
  document.getElementById('goAdmin').onclick = () => window.location.href = 'moguone/admin.html';
}

async function loadNews() {
  try {
    const res = await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${CONFIG.newsIssue}`, {
      headers: { Authorization: `token ${CONFIG.token}` }
    });
    const data = await res.json();
    const rawList = data.body.split('---').map(s => s.trim()).filter(s => s);
    
    state.news = rawList.map((str, i) => {
      const lines = str.split('\n');
      // é»˜è®¤ id ä½¿ç”¨ç´¢å¼• iï¼Œä½†å¦‚æœå†…å®¹é‡Œæœ‰ id:: åˆ™ä¼šè¢«è¦†ç›–
      let item = { id: i, title: '', content: '', date: '', imgs: [], videos: [] };
      
      lines.forEach(l => {
        l = l.trim();
        if(l.startsWith('ã€')) item.title = l.slice(1,-1);
        // å…³é”®ä¿®æ”¹ï¼šè¯†åˆ«å¹¶è¯»å–ä½ å†™çš„ id:: ç¼–å·
        else if(l.startsWith('id::')) item.id = parseInt(l.slice(4)); 
        else if(l.startsWith('date::')) item.date = l.slice(6);
        else if(l.startsWith('img::')) item.imgs.push(l.slice(5));
        else if(l.startsWith('video::')) item.videos.push(l.slice(7));
        // æ’é™¤æ‰ id:: è¡Œï¼Œä¸è®©å®ƒæ˜¾ç¤ºåœ¨æ­£æ–‡é‡Œ
        else if(l !== '') item.content += l + '\n';
      });
      return item;
    }).sort((a, b) => b.id - a.id); // è¿™é‡Œç¡®ä¿ï¼šç¼–å·(id)æœ€å¤§çš„æ’åœ¨æœ€å‰é¢

    renderNews();
  } catch(e) { console.error(e); }
}

function renderNews() {
  const container = document.getElementById('newsContainer');
  container.innerHTML = state.news.map((item, idx) => `
    <div class="news-card" onclick="openModal(${idx})" style="animation-delay:${idx*0.1}s">
      <div class="news-cover">
        ${item.imgs.length ? `<img src="${item.imgs[0]}" loading="lazy">` : 
          (item.videos.length ? `<video src="${item.videos[0]}#t=1"></video>` : '')}
      </div>
      <div class="news-body">
        <div class="news-title">${item.title}</div>
        <div class="news-desc">${item.content}</div>
        <div class="news-meta">
          <span>${item.date}</span>
          <div class="like-btn" onclick="event.stopPropagation(); like(${item.id})">
            ğŸ‘ <span id="like-${item.id}">0</span>
          </div>
        </div>
      </div>
    </div>
  `).join('');
  
  
  setTimeout(() => {
    document.querySelectorAll('.news-card').forEach(el => el.classList.add('visible'));
  }, 100);
}


async function loadStats() {
  try {
    const res = await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${CONFIG.countIssue}`, {
      headers: { Authorization: `token ${CONFIG.token}` }
    });
    const data = await res.json();
    
    
    const countMatch = data.body.match(/æ€»è®¿é—®é‡ï¼š(\d+)/);
    const count = countMatch ? parseInt(countMatch[1]) + 1 : 1;
    document.getElementById('totalCount').textContent = count;

    
    const likeRegex = /ç‚¹èµ(\d+)æ•°é‡ï¼š(\d+)/g;
    let match;
    while ((match = likeRegex.exec(data.body)) !== null) {
      state.likes[match[1]] = parseInt(match[2]);
      const el = document.getElementById(`like-${match[1]}`);
      if(el) el.textContent = match[2];
    }

    
    const newBody = data.body.replace(/æ€»è®¿é—®é‡ï¼š\d+/, `æ€»è®¿é—®é‡ï¼š${count}`);
    fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${CONFIG.countIssue}`, {
      method: 'PATCH',
      headers: { Authorization: `token ${CONFIG.token}` },
      body: JSON.stringify({ body: newBody })
    });
  } catch(e) { console.error(e); }
}


function initMusic() {
  const audio = document.getElementById('music');
  const btn = document.getElementById('playBtn');
  const footer = document.getElementById('footer');
  const icon = btn.querySelector('div');

  btn.onclick = () => {
    if(state.isPlaying) {
      audio.pause();
      footer.classList.remove('playing');
      icon.className = 'play-icon';
    } else {
      audio.play();
      footer.classList.add('playing');
      icon.className = 'pause-icon';
    }
    state.isPlaying = !state.isPlaying;
  };
}


function openModal(idx) {
  const item = state.news[idx]; 
  const modal = document.getElementById('newsModal');
  const content = document.getElementById('modalContent');
  
  let mediaHtml = item.imgs.map(src => `<img src="${src}" style="width:100%;border-radius:12px;margin-bottom:10px;">`).join('');
  mediaHtml += item.videos.map(src => `<video src="${src}" controls style="width:100%;border-radius:12px;margin-bottom:10px;"></video>`).join('');

  content.innerHTML = `
    <h2 style="font-size:24px;margin-bottom:15px;">${item.title}</h2>
    <div style="font-size:15px;line-height:1.8;color:#475569;margin-bottom:20px;white-space:pre-wrap;">${item.content}</div>
    ${mediaHtml}
    <div style="margin-top:20px;color:#94a3b8;font-size:13px;">${item.date}</div>
  `;
  
  modal.classList.add('show');
  document.body.style.overflow = 'hidden';
  
  
  loadComments(item.id);
  
  document.getElementById('modalClose').onclick = () => {
    modal.classList.remove('show');
    document.body.style.overflow = '';
  };
}


async function loadComments(newsId) {
  const list = document.getElementById('commentList');
  list.innerHTML = '<div style="text-align:center;padding:20px;color:#94a3b8;">åŠ è½½è¯„è®ºä¸­...</div>';
  
  
  const issueMap = await getCommentMap();
  const issueId = issueMap[newsId];
  
  if(!issueId) {
    list.innerHTML = '<div style="text-align:center;padding:20px;color:#94a3b8;">æš‚æ— è¯„è®º</div>';
    
    document.getElementById('submitComment').onclick = () => createCommentIssue(newsId);
    return;
  }

  const res = await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${issueId}/comments`, {
    headers: { Authorization: `token ${CONFIG.token}` }
  });
  const comments = await res.json();
  
  list.innerHTML = comments.map(c => {
    const [uid, name, text] = c.body.split('|');
    const content = text ? text.replace(/[ã€ã€‘]/g, '') : c.body;
    return `
      <div style="padding:15px;border-bottom:1px solid #f1f5f9;">
        <div style="font-weight:600;color:#0078d4;margin-bottom:5px;">${name || 'åŒ¿å'}</div>
        <div style="font-size:14px;color:#334155;">${content}</div>
      </div>
    `;
  }).join('') || '<div style="text-align:center;padding:20px;color:#94a3b8;">æš‚æ— è¯„è®º</div>';

  
  document.getElementById('submitComment').onclick = () => postComment(issueId);
}

async function getCommentMap() {
  const res = await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${CONFIG.commentMapIssue}`, {
    headers: { Authorization: `token ${CONFIG.token}` }
  });
  const data = await res.json();
  const map = {};
  data.body.split('\n').forEach(l => {
    const m = l.match(/news_(\d+): (\d+)/);
    if(m) map[m[1]] = m[2];
  });
  return map;
}

async function postComment(issueId) {
  if(!state.user) { showToast('è¯·å…ˆç™»å½•'); return; }
  const input = document.getElementById('commentInput');
  const val = input.value.trim();
  if(!val) return;

  const body = `${state.user.account}|${state.user.nickname}|ã€${val}ã€‘`;
  await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${issueId}/comments`, {
    method: 'POST',
    headers: { Authorization: `token ${CONFIG.token}` },
    body: JSON.stringify({ body })
  });
  
  input.value = '';
  showToast('è¯„è®ºæˆåŠŸ');
  loadComments(state.news.find(n => n.id).id); 
}


function loadLogs() {
  fetch('moguone/log.txt').then(r => r.text()).then(t => {
    const div = document.querySelector('.sidebar-update-log');
    div.innerHTML = t.split('\n').map(l => `<div>${l}</div>`).join('');
  });
}


async function initBg() {
  const res = await fetch('moguone/background.txt');
  const txt = await res.text();
  state.bgList = txt.split('\n').filter(s => s.trim());
  
  const savedBg = localStorage.getItem('bg_idx');
  if(savedBg) document.body.style.backgroundImage = `url(${state.bgList[savedBg]})`;

  document.getElementById('bgChangeBtn').onclick = () => {
    document.getElementById('bgModal').classList.add('show');
    const grid = document.getElementById('bgGrid');
    grid.innerHTML = state.bgList.map((url, i) => `
      <div class="bg-item" onclick="setBg(${i}, '${url}')">
        <img src="${url}" loading="lazy">
      </div>
    `).join('');
  };
}

window.setBg = (i, url) => {
  document.body.style.backgroundImage = `url(${url})`;
  localStorage.setItem('bg_idx', i);
  document.getElementById('bgModal').classList.remove('show');
};

function showToast(msg) {
  const t = document.getElementById('toast');
  t.querySelector('.toast-text').textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}


async function createCommentIssue(newsId) {
    if(!state.user) { showToast('è¯·å…ˆç™»å½•'); return; }
    
    
    const newIssueRes = await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues`, {
        method: 'POST',
        headers: { Authorization: `token ${CONFIG.token}` },
        body: JSON.stringify({
            title: `comment_#${newsId}`,
            body: `Comment storage for news ${newsId}`
        })
    });
    const newIssue = await newIssueRes.json();
    
    
    const mapRes = await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${CONFIG.commentMapIssue}`, {
      headers: { Authorization: `token ${CONFIG.token}` }
    });
    const mapData = await mapRes.json();
    const newBody = mapData.body + `\nnews_${newsId}: ${newIssue.number}`;
    
    await fetch(`https://api.github.com/repos/${CONFIG.repo}/issues/${CONFIG.commentMapIssue}`, {
        method: 'PATCH',
        headers: { Authorization: `token ${CONFIG.token}` },
        body: JSON.stringify({ body: newBody })
    });
    
    postComment(newIssue.number);
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
